{% extends "base.html" %}

{% block title %}é€šä¹‰ä¸‡ç›¸ - è¯­éŸ³å¤åˆ»{% endblock %}

{% block body %}
<div class="workspace-container">
    <div class="workspace-header">
        <h1>ğŸ™ï¸ è¯­éŸ³å¤åˆ»</h1>
        <div>
            <button class="btn btn-secondary" onclick="window.location.href='/assets'" style="margin-right: 10px;">ğŸ“ èµ„äº§åº“</button>
            <button class="btn btn-secondary" onclick="window.location.href='/workspace'" style="margin-right: 10px;">å›¾ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2video'" style="margin-right: 10px;">æ–‡ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/kf2v'" style="margin-right: 10px;">é¦–å°¾å¸§ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/reference2video'" style="margin-right: 10px;">å‚è€ƒç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2image'" style="margin-right: 10px;">æ–‡ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/image2image'" style="margin-right: 10px;">å›¾ç”Ÿå›¾</button>
            <button class="btn btn-secondary active" style="margin-right: 10px;">è¯­éŸ³å¤åˆ»</button>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </div>
    </div>
    
    <div class="workspace-content">
        <!-- å·¦ä¾§ï¼šåˆ›å»ºéŸ³è‰² / è¯­éŸ³åˆæˆ -->
        <div class="create-panel">
            <!-- Tab åˆ‡æ¢ -->
            <div class="tab-container">
                <button class="tab-btn active" data-tab="create-voice" onclick="switchTab('create-voice')">åˆ›å»ºéŸ³è‰²</button>
                <button class="tab-btn" data-tab="synthesize" onclick="switchTab('synthesize')">è¯­éŸ³åˆæˆ</button>
            </div>
            
            <!-- åˆ›å»ºéŸ³è‰²è¡¨å• -->
            <div id="create-voice-tab" class="tab-content active">
                <h2>åˆ›å»ºæ–°éŸ³è‰²</h2>
                
                <div class="form-section">
                    <div class="form-group">
                        <label>ä¸Šä¼ è¯­éŸ³æ ·æœ¬</label>
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('audioFile').click()">
                            <div class="upload-placeholder">
                                <span class="upload-icon">ğŸ¤</span>
                                <p>ç‚¹å‡»ä¸Šä¼ è¯­éŸ³æ ·æœ¬</p>
                                <small>æ”¯æŒ WAVã€MP3 æ ¼å¼</small>
                            </div>
                            <div class="upload-preview" id="uploadPreview" style="display: none;">
                                <audio id="previewAudio" controls></audio>
                                <p id="uploadedFileName"></p>
                            </div>
                        </div>
                        <input type="file" id="audioFile" accept=".wav,.mp3,audio/wav,audio/mpeg" style="display: none;" onchange="handleAudioUpload(this)">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>éŸ³è‰²å‰ç¼€ *</label>
                            <input type="text" id="voicePrefix" placeholder="å¦‚: myvoice" maxlength="9">
                            <small>ä»…å…è®¸å°å†™å­—æ¯å’Œæ•°å­—ï¼Œå°‘äº10ä¸ªå­—ç¬¦</small>
                        </div>
                        
                        <div class="form-group">
                            <label>éŸ³è‰²åç§°ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" id="voiceName" placeholder="ä¾¿äºè¯†åˆ«çš„åç§°">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>æ¨¡å‹é€‰æ‹©</label>
                        <select id="voiceModel">
                            <option value="cosyvoice-v3-plus" selected>cosyvoice-v3-plus (æ¨è)</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary btn-large btn-generate" onclick="createVoice()" id="createVoiceBtn">
                        <span class="btn-icon">ğŸ™ï¸</span>
                        <span class="btn-text">åˆ›å»ºéŸ³è‰²</span>
                    </button>
                    
                    <div class="info-box">
                        <strong>æç¤ºï¼š</strong>
                        <ul>
                            <li>ä¸Šä¼ æ¸…æ™°çš„è¯­éŸ³æ ·æœ¬ï¼Œå»ºè®®æ—¶é•¿ 5-30 ç§’</li>
                            <li>éŸ³è‰²åˆ›å»ºéœ€è¦ 1-3 åˆ†é’Ÿå¤„ç†æ—¶é—´</li>
                            <li>åˆ›å»ºå®Œæˆåå¯åœ¨å³ä¾§åˆ—è¡¨æŸ¥çœ‹å’Œä½¿ç”¨</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- è¯­éŸ³åˆæˆè¡¨å• -->
            <div id="synthesize-tab" class="tab-content">
                <h2>è¯­éŸ³åˆæˆ</h2>
                
                <div class="form-section">
                    <div class="form-group">
                        <label>é€‰æ‹©éŸ³è‰²</label>
                        <div class="voice-select-row">
                            <div class="voice-select-item">
                                <label class="voice-select-label">ç³»ç»ŸéŸ³è‰²</label>
                                <select id="systemVoice" onchange="onVoiceSelectChange('system')">
                                    <option value="">-- é€‰æ‹©ç³»ç»ŸéŸ³è‰² --</option>
                                    <option value="longanyang">é˜³å…‰å¤§ç”·å­©</option>
                                    <option value="longanhuan">æ¬¢è„±å…ƒæ°”å¥³</option>
                                </select>
                            </div>
                            <div class="voice-select-item">
                                <label class="voice-select-label">è‡ªå®šä¹‰éŸ³è‰²</label>
                                <select id="customVoice" onchange="onVoiceSelectChange('custom')">
                                    <option value="">-- é€‰æ‹©è‡ªå®šä¹‰éŸ³è‰² --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>åˆæˆæ–‡æœ¬</label>
                        <textarea id="synthesizeText" rows="6" placeholder="è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬å†…å®¹..." maxlength="1000"></textarea>
                        <small><span id="textLength">0</span>/1000 å­—ç¬¦</small>
                    </div>
                    
                    <!-- åˆæˆå‚æ•° -->
                    <div class="synth-params-wrapper">
                        <div class="synth-params-header">
                            <span>åˆæˆå‚æ•°</span>
                            <button class="btn-reset" onclick="resetSynthParams()" title="æ¢å¤é»˜è®¤å€¼">â†º é»˜è®¤</button>
                        </div>
                        <div class="synth-params">
                            <div class="param-group">
                                <label>éŸ³é‡</label>
                                <input type="range" id="volumeParam" min="0" max="100" value="50" oninput="updateParamValue('volume')">
                                <span id="volumeValue">50</span>
                            </div>
                            <div class="param-group">
                                <label>è¯­é€Ÿ</label>
                                <input type="range" id="speechRateParam" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateParamValue('speechRate')">
                                <span id="speechRateValue">1.0</span>
                            </div>
                            <div class="param-group">
                                <label>éŸ³é«˜</label>
                                <input type="range" id="pitchRateParam" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateParamValue('pitchRate')">
                                <span id="pitchRateValue">1.0</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-large btn-generate" onclick="synthesizeSpeech()" id="synthesizeBtn">
                        <span class="btn-icon">ğŸ”Š</span>
                        <span class="btn-text">åˆæˆè¯­éŸ³</span>
                    </button>
                    
                    <!-- åˆæˆç»“æœé¢„è§ˆ -->
                    <div class="synthesis-result" id="synthesisResult" style="display: none;">
                        <h3>åˆæˆç»“æœ</h3>
                        <audio id="resultAudio" controls></audio>
                        <button class="btn btn-secondary" onclick="downloadResult()">ä¸‹è½½éŸ³é¢‘</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šéŸ³è‰²åˆ—è¡¨å’Œå†å²è®°å½• -->
        <div class="history-panel">
            <div class="history-header">
                <h2>æˆ‘çš„éŸ³è‰²</h2>
                <button class="btn btn-secondary btn-sm" onclick="loadVoices()">åˆ·æ–°</button>
            </div>
            
            <div id="voiceList" class="voice-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            
            <div id="loadMoreVoicesContainer" class="load-more-container" style="display: none;">
                <button class="btn btn-secondary" id="loadMoreVoicesBtn" onclick="loadMoreVoices()">åŠ è½½æ›´å¤š</button>
            </div>
            
            <div class="history-header" style="margin-top: 20px;">
                <h2>åˆæˆå†å²</h2>
                <button class="btn btn-secondary btn-sm" onclick="loadSynthesisTasks()">åˆ·æ–°</button>
            </div>
            
            <div id="taskList" class="task-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            
            <div id="loadMoreTasksContainer" class="load-more-container" style="display: none;">
                <button class="btn btn-secondary" id="loadMoreTasksBtn" onclick="loadMoreTasks()">åŠ è½½æ›´å¤š</button>
            </div>
        </div>
    </div>
</div>

<style>
/* è¯­éŸ³å¤åˆ»é¡µé¢ç‰¹æœ‰æ ·å¼ */

.tab-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
}

.tab-btn {
    padding: 8px 16px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.tab-btn:hover {
    color: var(--primary-color);
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    font-weight: 500;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-secondary);
}

.upload-area:hover {
    border-color: var(--primary-color);
    background: #f0f7ff;
}

.upload-icon {
    font-size: 48px;
    display: block;
    margin-bottom: 10px;
}

.upload-placeholder p {
    margin: 0;
    color: var(--text-primary);
    font-weight: 500;
}

.upload-placeholder small {
    color: var(--text-secondary);
}

.upload-preview {
    padding: 10px;
}

.upload-preview audio {
    width: 100%;
    margin-bottom: 10px;
}

.info-box {
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    padding: 15px;
    margin-top: 20px;
    font-size: 13px;
    color: var(--text-secondary);
}

.info-box ul {
    margin: 8px 0 0 20px;
    padding: 0;
}

.info-box li {
    margin-bottom: 5px;
}

.voice-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
}

.voice-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 15px;
    transition: all 0.2s;
}

.voice-card:hover {
    box-shadow: var(--shadow-md);
}

.voice-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.voice-name {
    font-weight: 500;
    color: var(--text-primary);
}

.voice-status {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 4px;
}

.voice-status.deploying {
    background: #fff7e6;
    color: #d46b08;
}

.voice-status.ok {
    background: #f6ffed;
    color: #389e0d;
}

.voice-status.failed {
    background: #fff1f0;
    color: #d32029;
}

.voice-card-info {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.voice-card-actions {
    display: flex;
    gap: 8px;
}

.voice-card-actions .btn {
    font-size: 12px;
    padding: 4px 10px;
}

.synthesis-result {
    margin-top: 20px;
    padding: 15px;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
}

.synthesis-result h3 {
    margin-bottom: 10px;
    font-size: 14px;
}

.synthesis-result audio {
    width: 100%;
    margin-bottom: 10px;
}

.task-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
}

.task-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 12px;
}

.task-card-text {
    font-size: 13px;
    color: var(--text-primary);
    margin-bottom: 8px;
    word-break: break-all;
}

.task-card-audio {
    width: 100%;
}

.load-more-container {
    text-align: center;
    padding: 15px 0;
}

.load-more-container .btn {
    min-width: 120px;
}

.empty-state {
    text-align: center;
    padding: 30px;
    color: var(--text-secondary);
}

.voice-select-row {
    display: flex;
    gap: 15px;
}

.voice-select-item {
    flex: 1;
}

.voice-select-label {
    display: block;
    font-size: 11px;
    color: #999;
    margin-bottom: 5px;
}

.voice-select-item select {
    width: 100%;
}

.synth-params {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    padding: 15px;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
}

.param-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.param-group label {
    font-size: 12px;
    color: var(--text-secondary);
}

.param-group input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 4px;
    background: #ddd;
    border-radius: 2px;
    cursor: pointer;
    outline: none;
}

.param-group input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: #333;
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.param-group input[type="range"]::-webkit-slider-thumb:hover {
    background: #000;
}

.param-group input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #333;
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.param-group input[type="range"]::-moz-range-track {
    height: 4px;
    background: #ddd;
    border-radius: 2px;
}

.param-group span {
    font-size: 12px;
    color: var(--text-primary);
    text-align: center;
}

.synth-params-wrapper {
    margin-bottom: 15px;
}

.synth-params-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.synth-params-header span {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
}

.btn-reset {
    padding: 4px 10px;
    font-size: 12px;
    color: var(--text-secondary);
    background: transparent;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-reset:hover {
    color: var(--primary-color);
    border-color: var(--primary-color);
    background: rgba(24, 144, 255, 0.05);
}
</style>

<script>
// å…¨å±€å˜é‡
let uploadedAudioFilename = null;
let currentResultAudioUrl = null;
let pollingIntervals = {};

// åˆæˆå†å²åˆ†é¡µçŠ¶æ€
let tasksPage = 1;
let tasksHasMore = false;
const tasksLimit = 20;

// éŸ³è‰²åˆ—è¡¨åˆ†é¡µçŠ¶æ€
let voicesPage = 1;
let voicesHasMore = false;
const voicesLimit = 20;

// Tab åˆ‡æ¢
function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadVoices();
    loadSynthesisTasks();
    
    // æ–‡æœ¬é•¿åº¦è®¡æ•°
    document.getElementById('synthesizeText').addEventListener('input', function() {
        document.getElementById('textLength').textContent = this.value.length;
    });
});

// ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
async function handleAudioUpload(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const formData = new FormData();
    formData.append('audio', file);
    
    try {
        const response = await fetch('/api/voice/upload-audio', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            uploadedAudioFilename = data.filename;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            document.querySelector('.upload-placeholder').style.display = 'none';
            document.getElementById('uploadPreview').style.display = 'block';
            document.getElementById('previewAudio').src = data.url;
            document.getElementById('uploadedFileName').textContent = file.name;
            
            showToast('è¯­éŸ³æ ·æœ¬ä¸Šä¼ æˆåŠŸ', 'success');
        } else {
            showToast(data.message || 'ä¸Šä¼ å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        showToast('ä¸Šä¼ å¤±è´¥', 'error');
    }
}

// åˆ›å»ºéŸ³è‰²
async function createVoice() {
    const prefix = document.getElementById('voicePrefix').value.trim().toLowerCase();
    const name = document.getElementById('voiceName').value.trim();
    const model = document.getElementById('voiceModel').value;
    
    if (!uploadedAudioFilename) {
        showToast('è¯·å…ˆä¸Šä¼ è¯­éŸ³æ ·æœ¬', 'error');
        return;
    }
    
    if (!prefix) {
        showToast('è¯·è¾“å…¥éŸ³è‰²å‰ç¼€', 'error');
        return;
    }
    
    if (!/^[a-z0-9]+$/.test(prefix)) {
        showToast('å‰ç¼€åªèƒ½åŒ…å«å°å†™å­—æ¯å’Œæ•°å­—', 'error');
        return;
    }
    
    if (prefix.length >= 10) {
        showToast('å‰ç¼€å¿…é¡»å°‘äº10ä¸ªå­—ç¬¦', 'error');
        return;
    }
    
    const btn = document.getElementById('createVoiceBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-icon">â³</span><span class="btn-text">åˆ›å»ºä¸­...</span>';
    
    try {
        const response = await fetch('/api/voice/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                audio_filename: uploadedAudioFilename,
                prefix: prefix,
                name: name,
                model: model
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('éŸ³è‰²åˆ›å»ºå·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­...', 'success');
            
            // å¼€å§‹è½®è¯¢çŠ¶æ€
            startPolling(data.voice.voice_id);
            
            // åˆ·æ–°åˆ—è¡¨
            loadVoices();
            
            // æ¸…ç©ºè¡¨å•
            uploadedAudioFilename = null;
            document.querySelector('.upload-placeholder').style.display = 'block';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('voicePrefix').value = '';
            document.getElementById('voiceName').value = '';
        } else {
            showToast(data.message || 'åˆ›å»ºå¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åˆ›å»ºå¤±è´¥:', error);
        showToast('åˆ›å»ºå¤±è´¥', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">ğŸ™ï¸</span><span class="btn-text">åˆ›å»ºéŸ³è‰²</span>';
    }
}

// è½®è¯¢éŸ³è‰²çŠ¶æ€
function startPolling(voiceId) {
    const maxAttempts = 30;
    const pollInterval = 10000; // 10ç§’
    let attempts = 0;
    
    pollingIntervals[voiceId] = setInterval(async () => {
        attempts++;
        
        try {
            const response = await fetch(`/api/voice/status/${voiceId}`);
            const data = await response.json();
            
            if (data.success) {
                const status = data.voice.status;
                
                if (status === 'OK') {
                    clearInterval(pollingIntervals[voiceId]);
                    delete pollingIntervals[voiceId];
                    showToast('éŸ³è‰²åˆ›å»ºæˆåŠŸï¼', 'success');
                    loadVoices();
                    updateVoiceSelect();
                } else if (status === 'UNDEPLOYED') {
                    clearInterval(pollingIntervals[voiceId]);
                    delete pollingIntervals[voiceId];
                    showToast('éŸ³è‰²åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘è´¨é‡', 'error');
                    loadVoices();
                }
                // DEPLOYING ç»§ç»­è½®è¯¢
            }
        } catch (error) {
            console.error('è½®è¯¢å¤±è´¥:', error);
        }
        
        if (attempts >= maxAttempts) {
            clearInterval(pollingIntervals[voiceId]);
            delete pollingIntervals[voiceId];
            showToast('è½®è¯¢è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°æŸ¥çœ‹çŠ¶æ€', 'warning');
        }
    }, pollInterval);
}

// åŠ è½½éŸ³è‰²åˆ—è¡¨
async function loadVoices(append = false) {
    const listEl = document.getElementById('voiceList');
    const loadMoreContainer = document.getElementById('loadMoreVoicesContainer');
    const loadMoreBtn = document.getElementById('loadMoreVoicesBtn');
    
    if (!append) {
        voicesPage = 1;
        listEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    } else {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'åŠ è½½ä¸­...';
    }
    
    try {
        const response = await fetch(`/api/voice/list?page=${voicesPage}&limit=${voicesLimit}`);
        const data = await response.json();
        
        if (data.success) {
            voicesHasMore = data.has_more;
            
            if (data.voices.length > 0) {
                const voicesHtml = data.voices.map(voice => `
                    <div class="voice-card">
                        <div class="voice-card-header">
                            <span class="voice-name">${voice.name || voice.prefix}</span>
                            <span class="voice-status ${getStatusClass(voice.status)}">${getStatusText(voice.status)}</span>
                        </div>
                        <div class="voice-card-info">
                            <div>ID: ${voice.voice_id}</div>
                            <div>åˆ›å»ºæ—¶é—´: ${formatDate(voice.created_at)}</div>
                        </div>
                        <div class="voice-card-actions">
                            ${voice.status === 'OK' ? `<button class="btn btn-primary" onclick="useVoice('${voice.voice_id}')">ä½¿ç”¨</button>` : ''}
                            ${voice.status === 'DEPLOYING' ? `<button class="btn btn-secondary" onclick="checkStatus('${voice.voice_id}')">æŸ¥è¯¢çŠ¶æ€</button>` : ''}
                            <button class="btn btn-secondary" onclick="deleteVoice('${voice.voice_id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
                
                if (append) {
                    listEl.insertAdjacentHTML('beforeend', voicesHtml);
                } else {
                    listEl.innerHTML = voicesHtml;
                }
                
                // æ›´æ–°åˆæˆé¡µçš„éŸ³è‰²é€‰æ‹©
                if (!append) {
                    updateVoiceSelect();
                }
            } else if (!append) {
                listEl.innerHTML = '<div class="empty-state">æš‚æ— éŸ³è‰²ï¼Œè¯·å…ˆåˆ›å»º</div>';
            }
            
            // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
            loadMoreContainer.style.display = voicesHasMore ? 'block' : 'none';
        } else {
            if (!append) {
                listEl.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }
    } catch (error) {
        console.error('åŠ è½½éŸ³è‰²å¤±è´¥:', error);
        if (!append) {
            listEl.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
        }
    } finally {
        if (append) {
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = 'åŠ è½½æ›´å¤š';
        }
    }
}

// åŠ è½½æ›´å¤šéŸ³è‰²
function loadMoreVoices() {
    voicesPage++;
    loadVoices(true);
}

function getStatusClass(status) {
    switch (status) {
        case 'OK': return 'ok';
        case 'DEPLOYING': return 'deploying';
        case 'UNDEPLOYED': return 'failed';
        default: return '';
    }
}

function getStatusText(status) {
    switch (status) {
        case 'OK': return 'å·²å°±ç»ª';
        case 'DEPLOYING': return 'å¤„ç†ä¸­';
        case 'UNDEPLOYED': return 'å·²å¤±è´¥';
        default: return status;
    }
}

// æ›´æ–°éŸ³è‰²é€‰æ‹©ä¸‹æ‹‰æ¡†
async function updateVoiceSelect() {
    try {
        const response = await fetch('/api/voice/list');
        const data = await response.json();
        
        // æ›´æ–°è‡ªå®šä¹‰éŸ³è‰²ä¸‹æ‹‰æ¡†
        const customSelect = document.getElementById('customVoice');
        customSelect.innerHTML = '<option value="">-- é€‰æ‹©è‡ªå®šä¹‰éŸ³è‰² --</option>';
        
        if (data.success && data.voices.length > 0) {
            const readyVoices = data.voices.filter(v => v.status === 'OK');
            readyVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.voice_id;
                option.textContent = voice.name || voice.prefix;
                customSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('æ›´æ–°éŸ³è‰²é€‰æ‹©å¤±è´¥:', error);
    }
}

// éŸ³è‰²é€‰æ‹©åˆ‡æ¢ï¼ˆäº’æ–¥ï¼‰
function onVoiceSelectChange(type) {
    if (type === 'system') {
        document.getElementById('customVoice').value = '';
    } else {
        document.getElementById('systemVoice').value = '';
    }
}

// è·å–å½“å‰é€‰ä¸­çš„éŸ³è‰²ID
function getSelectedVoiceId() {
    const systemVoice = document.getElementById('systemVoice').value;
    const customVoice = document.getElementById('customVoice').value;
    return systemVoice || customVoice;
}

// ä½¿ç”¨éŸ³è‰²ï¼ˆåˆ‡æ¢åˆ°åˆæˆtabï¼‰
function useVoice(voiceId) {
    switchTab('synthesize');
    document.getElementById('systemVoice').value = '';
    document.getElementById('customVoice').value = voiceId;
}

// æŸ¥è¯¢çŠ¶æ€
async function checkStatus(voiceId) {
    try {
        const response = await fetch(`/api/voice/status/${voiceId}`);
        const data = await response.json();
        
        if (data.success) {
            showToast(`çŠ¶æ€: ${getStatusText(data.voice.status)}`, 'info');
            loadVoices();
        } else {
            showToast(data.message || 'æŸ¥è¯¢å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('æŸ¥è¯¢å¤±è´¥:', error);
        showToast('æŸ¥è¯¢å¤±è´¥', 'error');
    }
}

// åˆ é™¤éŸ³è‰²
async function deleteVoice(voiceId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªéŸ³è‰²å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/api/voice/delete/${voiceId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('éŸ³è‰²å·²åˆ é™¤', 'success');
            loadVoices();
        } else {
            showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥', 'error');
    }
}

// æ›´æ–°å‚æ•°æ˜¾ç¤ºå€¼
function updateParamValue(type) {
    if (type === 'volume') {
        document.getElementById('volumeValue').textContent = document.getElementById('volumeParam').value;
    } else if (type === 'speechRate') {
        document.getElementById('speechRateValue').textContent = parseFloat(document.getElementById('speechRateParam').value).toFixed(1);
    } else if (type === 'pitchRate') {
        document.getElementById('pitchRateValue').textContent = parseFloat(document.getElementById('pitchRateParam').value).toFixed(1);
    }
}

// æ¢å¤åˆæˆå‚æ•°é»˜è®¤å€¼
function resetSynthParams() {
    // éŸ³é‡é»˜è®¤50
    document.getElementById('volumeParam').value = 50;
    document.getElementById('volumeValue').textContent = '50';
    
    // è¯­é€Ÿé»˜è®¤1.0
    document.getElementById('speechRateParam').value = 1.0;
    document.getElementById('speechRateValue').textContent = '1.0';
    
    // éŸ³é«˜é»˜è®¤1.0
    document.getElementById('pitchRateParam').value = 1.0;
    document.getElementById('pitchRateValue').textContent = '1.0';
    
    showToast('å·²æ¢å¤é»˜è®¤å€¼', 'success');
}

// è¯­éŸ³åˆæˆ
async function synthesizeSpeech() {
    const voiceId = getSelectedVoiceId();
    const text = document.getElementById('synthesizeText').value.trim();
    const volume = parseInt(document.getElementById('volumeParam').value);
    const speechRate = parseFloat(document.getElementById('speechRateParam').value);
    const pitchRate = parseFloat(document.getElementById('pitchRateParam').value);
    
    if (!voiceId) {
        showToast('è¯·é€‰æ‹©éŸ³è‰²', 'error');
        return;
    }
    
    if (!text) {
        showToast('è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬', 'error');
        return;
    }
    
    const btn = document.getElementById('synthesizeBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-icon">â³</span><span class="btn-text">åˆæˆä¸­...</span>';
    
    try {
        const response = await fetch('/api/voice/synthesize', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                voice_id: voiceId,
                text: text,
                volume: volume,
                speech_rate: speechRate,
                pitch_rate: pitchRate
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentResultAudioUrl = data.audio_url;
            
            // æ˜¾ç¤ºç»“æœ
            document.getElementById('resultAudio').src = data.audio_url;
            document.getElementById('synthesisResult').style.display = 'block';
            
            showToast('è¯­éŸ³åˆæˆæˆåŠŸ', 'success');
            
            // åˆ·æ–°å†å²è®°å½•
            loadSynthesisTasks();
        } else {
            showToast(data.message || 'åˆæˆå¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åˆæˆå¤±è´¥:', error);
        showToast('åˆæˆå¤±è´¥', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">ğŸ”Š</span><span class="btn-text">åˆæˆè¯­éŸ³</span>';
    }
}

// ä¸‹è½½ç»“æœ
function downloadResult() {
    if (currentResultAudioUrl) {
        const a = document.createElement('a');
        a.href = currentResultAudioUrl;
        a.download = 'synthesized_voice.mp3';
        a.click();
    }
}

// åŠ è½½åˆæˆå†å²
async function loadSynthesisTasks(append = false) {
    const listEl = document.getElementById('taskList');
    const loadMoreContainer = document.getElementById('loadMoreTasksContainer');
    const loadMoreBtn = document.getElementById('loadMoreTasksBtn');
    
    if (!append) {
        tasksPage = 1;
        listEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    } else {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'åŠ è½½ä¸­...';
    }
    
    try {
        const response = await fetch(`/api/voice/tasks?page=${tasksPage}&limit=${tasksLimit}`);
        const data = await response.json();
        
        if (data.success) {
            tasksHasMore = data.has_more;
            
            if (data.tasks.length > 0) {
                const tasksHtml = data.tasks.map(task => `
                    <div class="task-card">
                        <div class="task-card-text">${escapeHtml(task.text.substring(0, 100))}${task.text.length > 100 ? '...' : ''}</div>
                        <audio class="task-card-audio" controls src="${task.audio_url}"></audio>
                    </div>
                `).join('');
                
                if (append) {
                    listEl.insertAdjacentHTML('beforeend', tasksHtml);
                } else {
                    listEl.innerHTML = tasksHtml;
                }
            } else if (!append) {
                listEl.innerHTML = '<div class="empty-state">æš‚æ— åˆæˆè®°å½•</div>';
            }
            
            // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
            loadMoreContainer.style.display = tasksHasMore ? 'block' : 'none';
        } else {
            if (!append) {
                listEl.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }
    } catch (error) {
        console.error('åŠ è½½å†å²å¤±è´¥:', error);
        if (!append) {
            listEl.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
        }
    } finally {
        if (append) {
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = 'åŠ è½½æ›´å¤š';
        }
    }
}

// åŠ è½½æ›´å¤šä»»åŠ¡
function loadMoreTasks() {
    tasksPage++;
    loadSynthesisTasks(true);
}

// å·¥å…·å‡½æ•°
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#52c41a' : type === 'error' ? '#ff4d4f' : '#1890ff'};
        color: white;
        border-radius: 4px;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function logout() {
    fetch('/api/logout', { method: 'POST' })
        .then(() => window.location.href = '/');
}
</script>
{% endblock %}
