{% extends "base.html" %}

{% block title %}é€šä¹‰ä¸‡ç›¸ - å›¾ç”Ÿå›¾{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
{% endblock %}

{% block body %}
<div class="workspace-container">
    <div class="workspace-header">
        <h1>ğŸ¨ é€šä¹‰ä¸‡ç›¸å›¾ç”Ÿå›¾</h1>
        <div>
            <button class="btn btn-secondary" onclick="window.location.href='/assets'" style="margin-right: 10px;">ğŸ“ èµ„äº§åº“</button>
            <button class="btn btn-secondary" onclick="window.location.href='/workspace'" style="margin-right: 10px;">å›¾ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2video'" style="margin-right: 10px;">æ–‡ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/kf2v'" style="margin-right: 10px;">é¦–å°¾å¸§ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/reference2video'" style="margin-right: 10px;">å‚è€ƒç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2image'" style="margin-right: 10px;">æ–‡ç”Ÿå›¾</button>
            <button class="btn btn-secondary active" style="margin-right: 10px;">å›¾ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/voice-clone'" style="margin-right: 10px;">è¯­éŸ³å¤åˆ»</button>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </div>
    </div>
    
    <div class="workspace-content">
        <!-- å·¦ä¾§ï¼šåˆ›å»ºä»»åŠ¡ -->
        <div class="create-panel">
            <h2>åˆ›å»ºæ–°ä»»åŠ¡</h2>
            
            <div class="form-section">
                <div class="form-group">
                    <label>å‚è€ƒå›¾ç‰‡ï¼ˆå¿…å¡«ï¼Œæœ€å¤š3å¼ ï¼‰</label>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å‚è€ƒå›¾ç‰‡</p>
                            <small>æ”¯æŒ JPGã€PNGã€BMPã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MBï¼Œæœ€å¤š3å¼ </small>
                        </div>
                        <div id="imagePreviewContainer" style="display: none; display: flex; gap: 10px; flex-wrap: wrap;"></div>
                    </div>
                    <div class="upload-actions" style="margin-top: 8px; text-align: center;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="openAssetPicker({ title: 'ä»èµ„äº§åº“é€‰æ‹©å›¾ç‰‡', targetType: 'i2i', multiple: true, maxSelect: 3, onSelect: handleI2IAssetSelect })">
                            ğŸ“ ä»èµ„äº§åº“é€‰æ‹©
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>æç¤ºè¯ï¼ˆå¿…å¡«ï¼‰</label>
                    <textarea id="prompt" rows="6" placeholder="æè¿°æ‚¨æƒ³è¦çš„å›¾ç‰‡å˜åŒ–ï¼Œä¾‹å¦‚ï¼šå‚è€ƒè¿™ä¸ªé£æ ¼çš„å›¾ç‰‡ï¼Œç”Ÿæˆç•ªèŒ„ç‚’è›‹ï¼›æˆ–è€…ï¼šå°†èŠ±å‰è¿è¡£è£™æ¢æˆä¸€ä»¶å¤å¤é£æ ¼çš„è•¾ä¸é•¿è£™ã€‚å›¾æ–‡æ··æ’æ¨¡å¼ä¾‹å¦‚ï¼šç»™æˆ‘ä¸€ä¸ª3å¼ å›¾è¾£æ¤’ç‚’è‚‰æ•™ç¨‹ã€‚"></textarea>
                    <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                        <strong>wan2.6-image</strong>ï¼š<br/>
                        Â Â Â· <strong>å›¾åƒç¼–è¾‘æ¨¡å¼</strong>ï¼šæ”¯æŒå¤šå›¾è¾“å…¥ï¼ˆæœ€å¤š3å¼ ï¼‰ï¼Œæ€»åƒç´ [768Ã—768, 1280Ã—1280]ï¼Œå®½é«˜æ¯”[1:4, 4:1]<br/>
                        Â Â Â· <strong>å›¾æ–‡æ··æ’æ¨¡å¼</strong>ï¼šç”Ÿæˆå›¾æ–‡æ··åˆå†…å®¹ï¼ˆå¦‚æ•™ç¨‹ï¼‰ï¼Œæœ€å¤š1å¼ å‚è€ƒå›¾æˆ–ä¸ä½¿ç”¨å‚è€ƒå›¾ï¼Œç”Ÿæˆ1-5å¼ å›¾<br/>
                        <strong>wan2.5-i2i-preview</strong>ï¼šæ”¯æŒå¤šå›¾è¾“å…¥å’Œè‡ªå®šä¹‰åˆ†è¾¨ç‡<br/>
                        <strong>qwen-image-edit-plus</strong>ï¼šä»…æ”¯æŒå•å›¾è¾“å…¥ï¼Œä¿æŒåŸå›¾æ¯”ä¾‹
                    </small>
                </div>

                <div class="form-group">
                    <label>åå‘æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="negativePrompt" placeholder="ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹...">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>æ¨¡å‹é€‰æ‹©</label>
                        <select id="model" onchange="onModelChange()">
                            <option value="wan2.6-image">wan2.6-image (æœ€æ–°æ¨è)</option>
                            <option value="wan2.5-i2i-preview">wan2.5-i2i-preview</option>
                            <option value="qwen-image-edit-plus">qwen-image-edit-plus</option>
                        </select>
                    </div>

                    <div class="form-group" id="sizeGroup">
                        <label>å›¾ç‰‡å°ºå¯¸</label>
                        <select id="size">
                            <option value="">é»˜è®¤ï¼ˆä¿æŒåŸå›¾æ¯”ä¾‹ï¼‰</option>
                            <option value="1024*1024">1024Ã—1024 (1:1 æ­£æ–¹å½¢)</option>
                            <option value="1280*1280">1280Ã—1280 (1:1 å¤§æ­£æ–¹å½¢)</option>
                            <option value="800*1200">800Ã—1200 (2:3 ç«–ç‰ˆ)</option>
                            <option value="1200*800">1200Ã—800 (3:2 æ¨ªç‰ˆ)</option>
                            <option value="960*1280">960Ã—1280 (3:4 ç«–ç‰ˆ)</option>
                            <option value="1280*960">1280Ã—960 (4:3 æ¨ªç‰ˆ)</option>
                            <option value="720*1280">720Ã—1280 (9:16 ç«–ç‰ˆ)</option>
                            <option value="1280*720">1280Ã—720 (16:9 æ¨ªç‰ˆ)</option>
                            <option value="1344*576">1344Ã—576 (21:9 è¶…å®½)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>ç”Ÿæˆæ•°é‡</label>
                    <select id="batchCount">
                        <option value="1" selected>1å¼ å›¾ç‰‡</option>
                        <option value="2">2å¼ å›¾ç‰‡</option>
                        <option value="3">3å¼ å›¾ç‰‡</option>
                        <option value="4">4å¼ å›¾ç‰‡ï¼ˆæœ€å¤šï¼‰</option>
                    </select>
                    <small>ä¸€æ¬¡ç”Ÿæˆå¤šå¼ å›¾ç‰‡ï¼Œå¯ä»ä¸­æŒ‘é€‰æœ€ä½³æ•ˆæœ</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="promptExtend" checked>
                        å¯ç”¨æ™ºèƒ½æ”¹å†™
                    </label>
                    <small style="color: #888; margin-left: 8px;">ï¼ˆä»…wan2.6-imageå›¾åƒç¼–è¾‘æ¨¡å¼å’Œwan2.5-i2i-previewæ”¯æŒï¼‰</small>
                </div>
                
                <!-- wan2.6-image å›¾æ–‡æ··æ’æ¨¡å¼é€‰é¡¹ -->
                <div class="form-group" id="interleaveGroup" style="display: none;">
                    <label>
                        <input type="checkbox" id="enableInterleave">
                        å¯ç”¨å›¾æ–‡æ··æ’æ¨¡å¼
                    </label>
                    <small style="color: #666; display: block; margin-top: 4px;">
                        å›¾æ–‡æ··æ’æ¨¡å¼ï¼šå¯ç”ŸæˆåŒ…å«å›¾æ–‡æ··åˆçš„å†…å®¹ï¼ˆå¦‚æ•™ç¨‹ç±»å›¾æ–‡ï¼‰ï¼Œæœ€å¤šä½¿ç”¨1å¼ å‚è€ƒå›¾æˆ–ä¸ä½¿ç”¨å‚è€ƒå›¾
                    </small>
                </div>
                
                <div class="form-group" id="maxImagesGroup" style="display: none;">
                    <label>æœ€å¤šç”Ÿæˆå›¾ç‰‡æ•°ï¼ˆå›¾æ–‡æ··æ’æ¨¡å¼ï¼‰</label>
                    <select id="maxImages">
                        <option value="1">1å¼ å›¾ç‰‡</option>
                        <option value="2">2å¼ å›¾ç‰‡</option>
                        <option value="3">3å¼ å›¾ç‰‡</option>
                        <option value="4">4å¼ å›¾ç‰‡</option>
                        <option value="5" selected>5å¼ å›¾ç‰‡ï¼ˆé»˜è®¤ï¼‰</option>
                    </select>
                    <small style="color: #888;">æ³¨æ„ï¼šå®é™…ç”Ÿæˆæ•°é‡å¯èƒ½å°‘äºè®¾å®šå€¼ï¼Œå–å†³äºæ¨¡å‹æ¨ç†ç»“æœ</small>
                </div>
                
                <button class="btn btn-primary btn-large btn-generate" onclick="createI2ITask()" id="createBtn">
                    <span class="btn-icon">âœ¨</span>
                    <span class="btn-text">å¼€å§‹ç”Ÿæˆ</span>
                </button>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå†å²è®°å½• -->
        <div class="history-panel">
            <div class="history-header">
                <h2>å†å²è®°å½•</h2>
                <div class="history-actions">
                    <button class="btn btn-secondary btn-sm" onclick="toggleBatchMode()" id="batchModeBtn">
                        æ‰¹é‡é€‰æ‹©
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadSelected()" id="downloadBtn" style="display:none;">
                        ä¸‹è½½é€‰ä¸­ (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="saveSelectedImagesToAssets()" id="saveToAssetBtn" style="display:none;">
                        ğŸ“ ä¿å­˜åˆ°èµ„äº§åº“
                    </button>
                </div>
            </div>
            <div class="history-panel-wrapper">
                <div class="task-list-container">
                    <div id="taskList" class="task-list">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <!-- å³ä¾§ç¼©ç•¥å›¾å¿«é€Ÿå¯¼èˆª -->
                <div class="thumbnail-nav" id="thumbnailNav">
                    <div class="thumbnail-nav-header">å¿«é€Ÿå¯¼èˆª (<span id="thumbNavCount">0</span>)</div>
                    <div class="thumbnail-nav-list" id="thumbnailNavList">
                        <div class="thumbnail-nav-empty">æš‚æ— å·²å®Œæˆ<br>çš„å›¾ç‰‡</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡æ”¾å¤§æµ®å±‚ -->
<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <div class="image-modal-content" onclick="event.stopPropagation()">
        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
        <img id="modalImage" src="" alt="ç”Ÿæˆçš„å›¾ç‰‡">
    </div>
</div>

<!-- å›¾ç‰‡è£å‰ªæ¨¡æ€æ¡† -->
<div class="custom-cropper-modal" id="cropperModal">
    <div class="cropper-modal-content">
        <div class="cropper-toolbar">
            <h3>è£å‰ªå›¾ç‰‡</h3>
            <div class="aspect-ratio-group">
                <button class="aspect-ratio-btn" data-ratio="free">è‡ªå®šä¹‰</button>
                <button class="aspect-ratio-btn" data-ratio="16:9">16:9</button>
                <button class="aspect-ratio-btn" data-ratio="9:16">9:16</button>
                <button class="aspect-ratio-btn" data-ratio="4:3">4:3</button>
                <button class="aspect-ratio-btn" data-ratio="3:4">3:4</button>
                <button class="aspect-ratio-btn" data-ratio="1:1">1:1</button>
            </div>
        </div>
        <div class="cropper-container">
            <img id="cropperImage" src="" alt="å¾…è£å‰ªå›¾ç‰‡">
        </div>
        <div class="cropper-actions">
            <button class="btn btn-secondary" id="cropperCancelBtn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="cropperConfirmBtn">ç¡®è®¤è£å‰ª</button>
        </div>
    </div>
</div>

<style>
/* image2image é¡µé¢ç‰¹æœ‰æ ·å¼ */

.custom-cropper-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}

.custom-cropper-modal.active {
    display: flex;
}

.cropper-modal-content {
    background: #fff;
    border-radius: 12px;
    width: 90vw;
    max-width: 1100px;
    height: 85vh;
    max-height: 800px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

.cropper-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 25px;
    border-bottom: 1px solid #eee;
    background: #fff;
    z-index: 10;
}

.cropper-toolbar h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.cropper-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background-color: #2b2b2b;
    background-image:
        linear-gradient(45deg, #333 25%, transparent 25%),
        linear-gradient(-45deg, #333 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #333 75%),
        linear-gradient(-45deg, transparent 75%, #333 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cropper-container img {
    max-width: 100%;
    max-height: 100%;
    display: block;
}

.cropper-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    padding: 15px 25px;
    border-top: 1px solid #eee;
    background: #fff;
    z-index: 10;
}

.aspect-ratio-group {
    display: flex;
    gap: 8px;
    background: #f0f2f5;
    padding: 4px;
    border-radius: 8px;
}

.aspect-ratio-btn {
    padding: 6px 14px;
    border: none;
    background: transparent;
    color: #666;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
}

.aspect-ratio-btn:hover {
    background: rgba(0,0,0,0.05);
    color: #333;
}

.aspect-ratio-btn.active {
    background: white;
    color: #667eea;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    font-weight: 600;
}

.cropper-modal {
    background-color: rgba(0, 0, 0, 0.65) !important;
    opacity: 1 !important;
}

.cropper-view-box {
    outline: 2px solid #667eea !important;
    outline-offset: 0;
    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.35);
}

.cropper-dashed {
    border-color: rgba(255, 255, 255, 0.6) !important;
}

.cropper-center::before,
.cropper-center::after {
    background-color: rgba(255, 255, 255, 0.8) !important;
}

.cropper-point {
    width: 12px !important;
    height: 12px !important;
    background-color: #667eea !important;
    border-radius: 50%;
    opacity: 1 !important;
    border: 2px solid #fff !important;
    z-index: 1000 !important;
}

.cropper-point.point-ne,
.cropper-point.point-nw,
.cropper-point.point-se,
.cropper-point.point-sw {
    width: 16px !important;
    height: 16px !important;
}

.cropper-bg {
    background: transparent !important;
}

/* åŠ è½½æ›´å¤šæŒ‰é’®æ ·å¼ */
.load-more-container {
    padding: 20px;
    text-align: center;
    border-top: 1px solid #eee;
}

.load-more-container .btn {
    min-width: 120px;
}

/* æ‰¹é‡ä»»åŠ¡ä¸‹æ‹‰å¼æ˜¾ç¤ºæ ·å¼ */
.batch-task-dropdown {
    position: relative;
}

.batch-dropdown-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 6px 10px;
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
    border-radius: 8px;
    border: 1px solid #e0e4ff;
    transition: all 0.2s;
    user-select: none;
}

.batch-dropdown-toggle:hover {
    background: linear-gradient(135deg, #f0f2ff 0%, #e8ebff 100%);
    border-color: #667eea;
}

.dropdown-arrow {
    font-size: 10px;
    color: #667eea;
    transition: transform 0.2s;
}

.batch-dropdown-toggle.expanded .dropdown-arrow {
    transform: rotate(90deg);
}

.batch-summary {
    font-weight: 600;
    color: #333;
    font-size: 13px;
}

.batch-status-summary {
    font-size: 12px;
    color: #888;
    margin-left: auto;
}

.batch-dropdown-content {
    margin-top: 8px;
    padding: 8px;
    background: #fafbff;
    border-radius: 8px;
    border: 1px solid #e8ebff;
}

.batch-task-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 8px;
    border-radius: 6px;
    transition: background 0.15s;
}

.batch-task-row:hover {
    background: #f0f2ff;
}

.batch-task-row .task-index {
    font-size: 11px;
    font-weight: 600;
    color: #667eea;
    min-width: 24px;
}

.batch-task-row .task-id {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 11px;
    color: #555;
    cursor: pointer;
    padding: 2px 6px;
    background: #fff;
    border: 1px solid #e0e4ff;
    border-radius: 4px;
    transition: all 0.2s;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.batch-task-row .task-id:hover {
    background: #667eea;
    color: #fff;
    border-color: #667eea;
}

.batch-task-row .task-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    min-width: 50px;
    text-align: center;
}

/* å‚è€ƒå›¾ç‰‡æ ·å¼ */
.reference-images {
    margin-top: 10px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 6px;
}

.reference-image-grid {
    display: flex;
    gap: 10px;
    margin-top: 5px;
}

.reference-image-thumbnail {
    width: 80px;
    height: 80px;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid #ddd;
}

.reference-image-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="/static/image-cropper.js"></script>
<script src="/static/asset-picker.js"></script>
<script src="/static/thumbnail-nav.js"></script>

<script>
let currentImageFilenames = [];
let i2iPollingIntervals = new Map();
let batchModeEnabled = false;
let selectedImages = new Set();
let taskStatusCache = new Map();
let currentPage = 1;
let hasMoreTasks = true;
let isLoadingMore = false;
const TASKS_PER_PAGE = 50;  // å¢åŠ æ¯é¡µåŠ è½½æ•°é‡ï¼Œç¡®ä¿èƒ½çœ‹åˆ°æ›´å¤šå†å²è®°å½•
let loadedTaskIds = new Set();

// æ¨¡å‹åˆ‡æ¢æ—¶æ›´æ–°å°ºå¯¸é€‰é¡¹
function onModelChange() {
    const model = document.getElementById('model').value;
    const sizeSelect = document.getElementById('size');
    const interleaveGroup = document.getElementById('interleaveGroup');
    const maxImagesGroup = document.getElementById('maxImagesGroup');
    const enableInterleave = document.getElementById('enableInterleave');
    
    if (model === 'qwen-image-edit-plus') {
        // qwen-image-edit-plus åªæ”¯æŒé»˜è®¤é€‰é¡¹
        sizeSelect.innerHTML = '<option value="">é»˜è®¤ï¼ˆä¿æŒåŸå›¾æ¯”ä¾‹ï¼‰</option>';
        interleaveGroup.style.display = 'none';
        maxImagesGroup.style.display = 'none';
    } else if (model === 'wan2.6-image') {
        // wan2.6-image æ”¯æŒè‡ªå®šä¹‰å°ºå¯¸ï¼Œæ€»åƒç´ åœ¨[768*768, 1280*1280]ä¹‹é—´ï¼Œå®½é«˜æ¯”[1:4, 4:1]
        sizeSelect.innerHTML = `
            <option value="">é»˜è®¤ï¼ˆæ ¹æ®è¾“å…¥å›¾è‡ªåŠ¨è®¡ç®—ï¼‰</option>
            <option value="1024*1024">1024Ã—1024 (1:1 æ­£æ–¹å½¢)</option>
            <option value="1280*1280">1280Ã—1280 (1:1 å¤§æ­£æ–¹å½¢)</option>
            <option value="800*1200">800Ã—1200 (2:3 ç«–ç‰ˆ)</option>
            <option value="1200*800">1200Ã—800 (3:2 æ¨ªç‰ˆ)</option>
            <option value="960*1280">960Ã—1280 (3:4 ç«–ç‰ˆ)</option>
            <option value="1280*960">1280Ã—960 (4:3 æ¨ªç‰ˆ)</option>
            <option value="720*1280">720Ã—1280 (9:16 ç«–ç‰ˆ)</option>
            <option value="1280*720">1280Ã—720 (16:9 æ¨ªç‰ˆ)</option>
            <option value="1344*576">1344Ã—576 (21:9 è¶…å®½)</option>
        `;
        // æ˜¾ç¤ºå›¾æ–‡æ··æ’æ¨¡å¼é€‰é¡¹
        interleaveGroup.style.display = 'block';
        // æ ¹æ®å½“å‰checkboxçŠ¶æ€æ˜¾ç¤º/éšè—max_imagesé€‰é¡¹
        if (enableInterleave.checked) {
            maxImagesGroup.style.display = 'block';
        }
    } else {
        // wan2.5-i2i-preview æ”¯æŒæ‰€æœ‰å°ºå¯¸é€‰é¡¹
        sizeSelect.innerHTML = `
            <option value="">é»˜è®¤ï¼ˆä¿æŒåŸå›¾æ¯”ä¾‹ï¼‰</option>
            <option value="1024*1024">1024Ã—1024 (1:1 æ­£æ–¹å½¢)</option>
            <option value="1280*1280">1280Ã—1280 (1:1 å¤§æ­£æ–¹å½¢)</option>
            <option value="800*1200">800Ã—1200 (2:3 ç«–ç‰ˆ)</option>
            <option value="1200*800">1200Ã—800 (3:2 æ¨ªç‰ˆ)</option>
            <option value="960*1280">960Ã—1280 (3:4 ç«–ç‰ˆ)</option>
            <option value="1280*960">1280Ã—960 (4:3 æ¨ªç‰ˆ)</option>
            <option value="720*1280">720Ã—1280 (9:16 ç«–ç‰ˆ)</option>
            <option value="1280*720">1280Ã—720 (16:9 æ¨ªç‰ˆ)</option>
            <option value="1344*576">1344Ã—576 (21:9 è¶…å®½)</option>
        `;
        interleaveGroup.style.display = 'none';
        maxImagesGroup.style.display = 'none';
    }
}

// å›¾æ–‡æ··æ’æ¨¡å¼åˆ‡æ¢
document.addEventListener('DOMContentLoaded', function() {
    const enableInterleave = document.getElementById('enableInterleave');
    const maxImagesGroup = document.getElementById('maxImagesGroup');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    
    if (enableInterleave) {
        enableInterleave.addEventListener('change', function() {
            if (this.checked) {
                maxImagesGroup.style.display = 'block';
                
                // æ›´æ–°ä¸Šä¼ æç¤ºæ–‡æœ¬
                const uploadText = uploadPlaceholder.querySelector('p');
                const uploadHint = uploadPlaceholder.querySelector('small');
                if (uploadText) uploadText.textContent = 'ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼ˆå¯é€‰ï¼‰';
                if (uploadHint) uploadHint.textContent = 'å›¾æ–‡æ··æ’æ¨¡å¼ï¼šæœ€å¤š1å¼ å›¾ç‰‡æˆ–ä¸ä½¿ç”¨å›¾ç‰‡ï¼Œæ”¯æŒ JPGã€PNGã€BMPã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MB';
                
                // å›¾æ–‡æ··æ’æ¨¡å¼ï¼šæ£€æŸ¥å‚è€ƒå›¾ç‰‡æ•°é‡ï¼Œæœ€å¤šåªèƒ½æœ‰1å¼ 
                if (currentImageFilenames.length > 1) {
                    showAlert('å›¾æ–‡æ··æ’æ¨¡å¼æœ€å¤šåªèƒ½ä½¿ç”¨1å¼ å‚è€ƒå›¾ç‰‡ï¼Œå·²è‡ªåŠ¨ä¿ç•™ç¬¬ä¸€å¼ ', 'warning');
                    // åªä¿ç•™ç¬¬ä¸€å¼ å›¾ç‰‡
                    const firstImage = currentImageFilenames[0];
                    currentImageFilenames = [firstImage];
                    
                    // æ›´æ–°UIï¼šç§»é™¤å¤šä½™çš„å›¾ç‰‡é¢„è§ˆ
                    const previewContainer = document.getElementById('imagePreviewContainer');
                    const previewItems = previewContainer.querySelectorAll('.image-preview-item');
                    previewItems.forEach((item, index) => {
                        if (index > 0) {
                            item.remove();
                        }
                    });
                }
            } else {
                maxImagesGroup.style.display = 'none';
                
                // æ¢å¤é»˜è®¤ä¸Šä¼ æç¤ºæ–‡æœ¬
                const uploadText = uploadPlaceholder.querySelector('p');
                const uploadHint = uploadPlaceholder.querySelector('small');
                if (uploadText) uploadText.textContent = 'ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å‚è€ƒå›¾ç‰‡';
                if (uploadHint) uploadHint.textContent = 'æ”¯æŒ JPGã€PNGã€BMPã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MBï¼Œæœ€å¤š3å¼ ';
            }
        });
    }
});

// èµ„äº§åº“é€‰æ‹©å›è°ƒ - å›¾ç”Ÿå›¾
function handleI2IAssetSelect(results) {
    // results å¯èƒ½æ˜¯æ•°ç»„(å¤šé€‰)æˆ–å•ä¸ªå¯¹è±¡(å•é€‰)
    const items = Array.isArray(results) ? results : [results];
    
    const model = document.getElementById('model').value;
    const enableInterleave = document.getElementById('enableInterleave');
    
    // å›¾æ–‡æ··æ’æ¨¡å¼ï¼šæœ€å¤š1å¼ å›¾ç‰‡
    if (model === 'wan2.6-image' && enableInterleave && enableInterleave.checked) {
        const maxAllowed = 1;
        if (currentImageFilenames.length + items.length > maxAllowed) {
            showAlert('å›¾æ–‡æ··æ’æ¨¡å¼æœ€å¤šåªèƒ½ä½¿ç”¨1å¼ å‚è€ƒå›¾ç‰‡', 'error');
            return;
        }
    } else {
        // å…¶ä»–æ¨¡å¼ï¼šæœ€å¤š3å¼ å›¾ç‰‡
        if (currentImageFilenames.length + items.length > 3) {
            showAlert('æœ€å¤šåªèƒ½ä¸Šä¼ 3å¼ å›¾ç‰‡', 'error');
            return;
        }
    }
    
    const previewContainer = document.getElementById('imagePreviewContainer');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    
    items.forEach(item => {
        if (item && item.filename && item.url) {
            currentImageFilenames.push(item.filename);
            
            // åˆ›å»ºé¢„è§ˆå…ƒç´ 
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-image-wrapper';
            wrapper.style.cssText = 'position: relative; display: inline-block;';
            wrapper.innerHTML = `
                <img src="${item.url}" class="preview-image" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                <button type="button" class="remove-image-btn" style="position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: 50%; background: #dc3545; color: white; border: none; cursor: pointer; font-size: 12px; line-height: 1;" onclick="removeImage('${item.filename}', this.parentElement)">Ã—</button>
            `;
            previewContainer.appendChild(wrapper);
        }
    });
    
    if (currentImageFilenames.length > 0) {
        previewContainer.style.display = 'flex';
        uploadPlaceholder.style.display = 'none';
    }
    
    showAlert(`å·²é€‰æ‹© ${items.length} å¼ å›¾ç‰‡`, 'success');
}

window.addEventListener('load', function() {
    initInfiniteScroll();
    loadI2ITasks();
    onModelChange(); // åˆå§‹åŒ–æ¨¡å‹ç›¸å…³çš„UIæ˜¾ç¤º
    
    // åˆå§‹åŒ–ç¼©ç•¥å›¾å¯¼èˆª
    ThumbnailNav.init({
        apiEndpoint: '/api/i2i-thumbnails',
        mediaType: 'image',
        itemsPerPage: 50,
        enableBatchSupport: true,
        emptyText: 'æš‚æ— å·²å®Œæˆ<br>çš„å›¾ç‰‡',
        virtualScrollEnabled: false  // å›¾ç‰‡æ¨¡å—ä½¿ç”¨ä¼ ç»Ÿæ¸²æŸ“
    });
});

function initInfiniteScroll() {
    const taskList = document.getElementById('taskList');

    if (taskList) {
        taskList.addEventListener('scroll', function() {
            const scrollTop = taskList.scrollTop;
            const scrollHeight = taskList.scrollHeight;
            const clientHeight = taskList.clientHeight;
            const distanceToBottom = scrollHeight - scrollTop - clientHeight;

            // æ»šåŠ¨åˆ°åº•éƒ¨é™„è¿‘æ—¶è‡ªåŠ¨åŠ è½½
            if (distanceToBottom < 300 && hasMoreTasks && !isLoadingMore) {
                console.log('[DEBUG] è§¦å‘åŠ è½½æ›´å¤š I2Iï¼Œè·ç¦»åº•éƒ¨:', distanceToBottom);
                loadMoreI2ITasks();
            }
        });
        
        console.log('[DEBUG] I2I æ— é™æ»šåŠ¨å·²åˆå§‹åŒ–');
        
        // é¡µé¢åŠ è½½åæ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½æ›´å¤šï¼ˆå†…å®¹ä¸è¶³ä»¥æ»šåŠ¨æ—¶ï¼‰
        setTimeout(() => {
            if (taskList.scrollHeight <= taskList.clientHeight && hasMoreTasks) {
                console.log('[DEBUG] å†…å®¹ä¸è¶³ä»¥æ»šåŠ¨ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤š');
                loadMoreI2ITasks();
            }
        }, 500);
    }
}

async function loadMoreI2ITasks() {
    if (isLoadingMore || !hasMoreTasks) {
        console.log('[DEBUG] è·³è¿‡åŠ è½½æ›´å¤š:', { isLoadingMore, hasMoreTasks });
        return;
    }

    isLoadingMore = true;
    currentPage++;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    if (loadMoreBtn) {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'åŠ è½½ä¸­...';
    }

    try {
        const response = await fetch(`/api/i2i-tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        console.log('[DEBUG] åŠ è½½æ›´å¤šä»»åŠ¡:', {
            page: currentPage,
            tasks_count: data.tasks ? data.tasks.length : 0,
            has_more: data.has_more
        });

        if (data.success && data.tasks.length > 0) {
            appendI2ITasks(data.tasks);
            hasMoreTasks = data.has_more;

            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startI2IPolling(task.task_id);
                }
            });
        } else {
            hasMoreTasks = false;
        }
        
        updateLoadMoreButton();
    } catch (error) {
        console.error('åŠ è½½æ›´å¤šä»»åŠ¡å¤±è´¥:', error);
        currentPage--;
    } finally {
        isLoadingMore = false;
        if (loadMoreBtn) {
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = 'åŠ è½½æ›´å¤š';
        }
    }
}

function updateLoadMoreButton() {
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    if (loadMoreContainer) {
        if (hasMoreTasks) {
            loadMoreContainer.style.display = 'block';
        } else {
            loadMoreContainer.style.display = 'none';
        }
    }
}

const uploadArea = document.getElementById('uploadArea');
const imageInput = document.getElementById('imageInput');
const imagePreview = document.getElementById('imagePreview');
const uploadPlaceholder = document.getElementById('uploadPlaceholder');

uploadArea.addEventListener('click', () => imageInput.click());

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) {
        handleMultipleFiles(files);
    }
});

imageInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    if (files.length > 0) {
        handleMultipleFiles(files);
    }
});

function handleMultipleFiles(files) {
    const model = document.getElementById('model').value;
    const enableInterleave = document.getElementById('enableInterleave');
    
    // å›¾æ–‡æ··æ’æ¨¡å¼ï¼šæœ€å¤šåªèƒ½æœ‰1å¼ å›¾ç‰‡
    if (model === 'wan2.6-image' && enableInterleave && enableInterleave.checked) {
        const maxAllowed = 1;
        if (currentImageFilenames.length + files.length > maxAllowed) {
            showAlert('å›¾æ–‡æ··æ’æ¨¡å¼æœ€å¤šåªèƒ½ä½¿ç”¨1å¼ å‚è€ƒå›¾ç‰‡', 'error');
            return;
        }
    } else {
        // å…¶ä»–æ¨¡å¼ï¼šæœ€å¤š3å¼ å›¾ç‰‡
        if (currentImageFilenames.length + files.length > 3) {
            showAlert('æœ€å¤šåªèƒ½ä¸Šä¼ 3å¼ å›¾ç‰‡', 'error');
            return;
        }
    }

    files.forEach(file => {
        window.imageCropper.open(file, handleImageUpload);
    });
}

async function handleImageUpload(file) {
    const formData = new FormData();
    formData.append('image', file);

    try {
        // å›¾ç”Ÿå›¾ä¸“ç”¨ä¸Šä¼ æ¥å£
        const response = await fetch('/api/upload-i2i-image', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            currentImageFilenames.push(data.filename);

            const reader = new FileReader();
            reader.onload = (e) => {
                updateImagePreview(e.target.result, data.filename);
            };
            reader.readAsDataURL(file);

            showAlert(`å›¾ç‰‡ä¸Šä¼ æˆåŠŸ (${currentImageFilenames.length}/3)`, 'success');
        } else {
            showAlert(data.message || 'ä¸Šä¼ å¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
    }
}

function updateImagePreview(src, filename) {
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const previewContainer = document.getElementById('imagePreviewContainer');

    uploadPlaceholder.style.display = 'none';
    previewContainer.style.display = 'flex';

    const previewItem = document.createElement('div');
    previewItem.className = 'image-preview-item';
    previewItem.style.cssText = 'position: relative; width: 150px; height: 150px;';

    const img = document.createElement('img');
    img.src = src;
    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 8px;';

    const removeBtn = document.createElement('button');
    removeBtn.innerHTML = 'Ã—';
    removeBtn.className = 'btn btn-danger';
    removeBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; padding: 0; border-radius: 50%; font-size: 18px; line-height: 1;';
    removeBtn.onclick = () => removeImage(filename, previewItem);

    previewItem.appendChild(img);
    previewItem.appendChild(removeBtn);
    previewContainer.appendChild(previewItem);
}

function removeImage(filename, previewItem) {
    const index = currentImageFilenames.indexOf(filename);
    if (index > -1) {
        currentImageFilenames.splice(index, 1);
    }

    previewItem.remove();

    const previewContainer = document.getElementById('imagePreviewContainer');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');

    if (currentImageFilenames.length === 0) {
        previewContainer.style.display = 'none';
        uploadPlaceholder.style.display = 'block';
    }

    showAlert('å›¾ç‰‡å·²ç§»é™¤', 'info');
}

async function createI2ITask() {
    const model = document.getElementById('model').value;
    const enableInterleave = document.getElementById('enableInterleave');
    
    // å›¾æ–‡æ··æ’æ¨¡å¼å…è®¸ä¸ä¼ å›¾ç‰‡
    if (model === 'wan2.6-image' && enableInterleave && enableInterleave.checked) {
        // å›¾æ–‡æ··æ’æ¨¡å¼ï¼šå…è®¸ä¸ä¼ å›¾ç‰‡ï¼Œä½†å¿…é¡»æœ‰æç¤ºè¯
    } else {
        // å…¶ä»–æ¨¡å¼ï¼šå¿…é¡»ä¼ å›¾ç‰‡
        if (currentImageFilenames.length === 0) {
            showAlert('è¯·å…ˆä¸Šä¼ å‚è€ƒå›¾ç‰‡', 'error');
            return;
        }
    }

    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt) {
        showAlert('è¯·è¾“å…¥æç¤ºè¯', 'error');
        return;
    }

    const sizeValue = document.getElementById('size').value;
    
    const requestBody = {
        image_filenames: currentImageFilenames,
        prompt: prompt,
        model: model,
        batch_count: parseInt(document.getElementById('batchCount').value),
        prompt_extend: document.getElementById('promptExtend').checked,
        negative_prompt: document.getElementById('negativePrompt').value
    };
    
    // wan2.6-image å›¾æ–‡æ··æ’æ¨¡å¼å‚æ•°
    if (model === 'wan2.6-image' && enableInterleave && enableInterleave.checked) {
        requestBody.enable_interleave = true;
        requestBody.max_images = parseInt(document.getElementById('maxImages').value);
    }
    
    // åªæœ‰é€‰æ‹©äº†å…·ä½“å°ºå¯¸æ—¶æ‰ä¼ é€’ size å‚æ•°
    if (sizeValue) {
        requestBody.size = sizeValue;
    }
    
    const btn = document.getElementById('createBtn');
    const btnIcon = btn.querySelector('.btn-icon');
    const btnText = btn.querySelector('.btn-text');
    
    btn.disabled = true;
    btnIcon.textContent = 'â³';
    btnText.textContent = 'åˆ›å»ºä¸­...';
    
    try {
        const response = await fetch('/api/create-i2i-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'ä»»åŠ¡åˆ›å»ºæˆåŠŸ', 'success');
            loadI2ITasks();
            
            // åªå¯¹æœªå®Œæˆçš„ä»»åŠ¡å¯åŠ¨è½®è¯¢ï¼ˆåŒæ­¥ä»»åŠ¡å·²ç»æ˜¯SUCCEEDEDï¼Œæ— éœ€è½®è¯¢ï¼‰
            if (data.tasks) {
                data.tasks.forEach(task => {
                    if (task.task_status !== 'SUCCEEDED' && task.task_status !== 'FAILED') {
                        startI2IPolling(task.task_id);
                    }
                });
            }
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btnIcon.textContent = 'âœ¨';
        btnText.textContent = 'å¼€å§‹ç”Ÿæˆ';    
    }
}

async function loadI2ITasks(reset = true) {
    try {
        if (reset) {
            currentPage = 1;
            hasMoreTasks = true;
            loadedTaskIds.clear();
        }
        
        const response = await fetch(`/api/i2i-tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        console.log('[DEBUG] åŠ è½½å›¾ç”Ÿå›¾ä»»åŠ¡:', {
            page: currentPage,
            limit: TASKS_PER_PAGE,
            total: data.total,
            tasks_count: data.tasks ? data.tasks.length : 0,
            has_more: data.has_more
        });
        
        if (data.success) {
            if (reset) {
                renderI2ITasks(data.tasks);
            } else {
                appendI2ITasks(data.tasks);
            }
            
            hasMoreTasks = data.has_more;
            
            // æ›´æ–°"åŠ è½½æ›´å¤š"æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            updateLoadMoreButton();
            
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startI2IPolling(task.task_id);
                }
            });
        }
    } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
    }
}

function renderI2ITasks(tasks) {
    const taskList = document.getElementById('taskList');
    
    console.log('[DEBUG] æ¸²æŸ“å›¾ç”Ÿå›¾ä»»åŠ¡:', {
        tasks_count: tasks.length,
        task_ids: tasks.map(t => t.task_id)
    });
    
    if (tasks.length === 0) {
        taskList.innerHTML = '<div class="loading">æš‚æ— å†å²è®°å½•</div>';
        return;
    }
    
    tasks.forEach(t => loadedTaskIds.add(t.task_id));
    const batchGroups = groupI2ITasksByBatch(tasks);
    
    console.log('[DEBUG] æ‰¹æ¬¡åˆ†ç»„ç»“æœ:', {
        groups_count: Object.keys(batchGroups).length,
        batch_ids: Object.keys(batchGroups)
    });
    
    taskList.innerHTML = renderI2ITaskGroups(batchGroups);
}

function appendI2ITasks(tasks) {
    const taskList = document.getElementById('taskList');
    const newTasks = tasks.filter(t => !loadedTaskIds.has(t.task_id));
    if (newTasks.length === 0) return;
    
    newTasks.forEach(t => loadedTaskIds.add(t.task_id));
    
    // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦åˆå¹¶åˆ°ç°æœ‰æ‰¹æ¬¡çš„ä»»åŠ¡
    const tasksToMerge = [];
    const tasksToAppend = [];
    
    newTasks.forEach(task => {
        const batchId = task.batch_id;
        if (batchId) {
            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨åŒä¸€æ‰¹æ¬¡çš„ä»»åŠ¡å®¹å™¨
            const existingBatchContainer = findExistingBatchContainer(batchId);
            if (existingBatchContainer) {
                tasksToMerge.push({ task, container: existingBatchContainer, batchId });
            } else {
                tasksToAppend.push(task);
            }
        } else {
            tasksToAppend.push(task);
        }
    });
    
    // åˆå¹¶åˆ°ç°æœ‰æ‰¹æ¬¡
    if (tasksToMerge.length > 0) {
        console.log('[DEBUG] å‘ç°éœ€è¦åˆå¹¶çš„æ‰¹æ¬¡ä»»åŠ¡:', tasksToMerge.map(t => t.task.task_id));
        tasksToMerge.forEach(({ task, container, batchId }) => {
            mergeTaskIntoBatch(task, container, batchId);
        });
    }
    
    // è¿½åŠ æ–°çš„ç‹¬ç«‹ä»»åŠ¡æˆ–æ‰¹æ¬¡
    if (tasksToAppend.length > 0) {
        const batchGroups = groupI2ITasksByBatch(tasksToAppend);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = renderI2ITaskGroups(batchGroups);
        
        while (tempDiv.firstChild) {
            taskList.appendChild(tempDiv.firstChild);
        }
    }
}

// æŸ¥æ‰¾ç°æœ‰çš„æ‰¹æ¬¡å®¹å™¨
function findExistingBatchContainer(batchId) {
    const taskItems = document.querySelectorAll('.task-item');
    for (const item of taskItems) {
        const batchTaskIds = item.querySelector('.batch-task-ids');
        if (batchTaskIds) {
            // æ£€æŸ¥å®¹å™¨ä¸­æ˜¯å¦æœ‰ç›¸åŒbatch_idçš„ä»»åŠ¡
            const taskRows = batchTaskIds.querySelectorAll('.batch-task-row');
            for (const row of taskRows) {
                const taskId = row.querySelector('.task-id')?.textContent?.trim();
                if (taskId && loadedTaskIds.has(taskId)) {
                    // ä»ç¼“å­˜æˆ–å…¨å±€æ•°æ®ä¸­è·å–è¯¥ä»»åŠ¡çš„batch_id
                    // ç®€åŒ–æ–¹æ¡ˆï¼šé€šè¿‡dataå±æ€§æ ‡è®°
                    if (item.dataset.batchId === batchId) {
                        return item;
                    }
                }
            }
        }
    }
    return null;
}

// åˆå¹¶ä»»åŠ¡åˆ°ç°æœ‰æ‰¹æ¬¡
function mergeTaskIntoBatch(task, container, batchId) {
    console.log('[DEBUG] åˆå¹¶ä»»åŠ¡åˆ°æ‰¹æ¬¡:', { taskId: task.task_id, batchId });
    
    // 1. æ·»åŠ ä»»åŠ¡IDè¡Œåˆ°batch-task-ids
    const batchTaskIds = container.querySelector('.batch-task-ids');
    if (batchTaskIds) {
        const taskRow = document.createElement('div');
        taskRow.className = 'batch-task-row';
        const taskIndex = batchTaskIds.querySelectorAll('.batch-task-row').length + 1;
        taskRow.innerHTML = `
            <span class="task-index">#${taskIndex}</span>
            <span class="task-id" onclick="copyToClipboard('${task.request_id || task.task_id}')" title="ç‚¹å‡»å¤åˆ¶">${task.request_id || task.task_id}</span>
            <span class="task-status status-${(task.task_status || 'PENDING').toLowerCase()}">${getStatusText(task.task_status || 'PENDING')}</span>
        `;
        batchTaskIds.appendChild(taskRow);
    }
    
    // 2. å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œæ·»åŠ å›¾ç‰‡åˆ°image-grid
    if (task.task_status === 'SUCCEEDED') {
        const urls = task.local_image_urls || task.image_urls;
        if (urls && Array.isArray(urls) && urls.length > 0) {
            let imageGrid = container.querySelector('.image-grid');
            if (!imageGrid) {
                // å¦‚æœæ²¡æœ‰image-gridï¼Œåˆ›å»ºä¸€ä¸ª
                imageGrid = document.createElement('div');
                imageGrid.className = 'image-grid';
                container.appendChild(imageGrid);
            }
            
            // è®¡ç®—å½“å‰å·²æœ‰çš„å›¾ç‰‡æ•°é‡
            const currentImageCount = imageGrid.querySelectorAll('.image-thumbnail').length;
            
            urls.forEach((url, index) => {
                const imageId = `${task.task_id}_${index}`;
                const globalIndex = currentImageCount + index + 1;
                const clickHandler = batchModeEnabled ? `toggleImageSelection('${imageId}')` : `openImageModal('${url}')`;
                const thumbnailClass = batchModeEnabled ? 'image-thumbnail batch-mode' : 'image-thumbnail';
                
                const imgDiv = document.createElement('div');
                imgDiv.className = thumbnailClass;
                imgDiv.id = `image-${imageId}`;
                imgDiv.setAttribute('onclick', clickHandler);
                imgDiv.innerHTML = `
                    ${batchModeEnabled ? `
                        <input type="checkbox" 
                               class="batch-checkbox" 
                               data-image-id="${imageId}" 
                               data-image-url="${url}"
                               onclick="event.stopPropagation(); toggleImageCheckbox('${imageId}');">
                    ` : ''}
                    <div class="image-index">#${globalIndex}</div>
                    <img src="${url}" alt="ç”Ÿæˆçš„å›¾ç‰‡" loading="lazy" onerror="handleImageError(this, '${url}')">
                `;
                imageGrid.appendChild(imgDiv);
            });
        }
    }
}

function groupI2ITasksByBatch(tasks) {
    const batchGroups = {};
    tasks.forEach(task => {
        const batchId = task.batch_id || task.task_id;
        if (!batchGroups[batchId]) {
            batchGroups[batchId] = [];
        }
        batchGroups[batchId].push(task);
    });
    return batchGroups;
}

function renderI2ITaskGroups(batchGroups) {
    return Object.values(batchGroups).map(batch => {
        const mainTask = batch[0];
        const isBatch = batch.length > 1;
        const batchId = mainTask.batch_id || mainTask.task_id;
        
        const allImageUrls = [];
        batch.forEach(task => {
            if (task.task_status === 'SUCCEEDED') {
                // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°å›¾ç‰‡URLï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨è¿œç¨‹URL
                const urls = task.local_image_urls || task.image_urls;
                if (urls && Array.isArray(urls) && urls.length > 0) {
                    urls.forEach(url => {
                        allImageUrls.push({
                            url: url,
                            taskIndex: batch.indexOf(task),
                            taskId: task.task_id
                        });
                    });
                } else if (task.results && Array.isArray(task.results)) {
                    task.results.forEach(result => {
                        if (result.url) {
                            allImageUrls.push({
                                url: result.url,
                                taskIndex: batch.indexOf(task),
                                taskId: task.task_id
                            });
                        }
                    });
                }
            }
        });
        
        return `
        <div class="task-item" id="task-${mainTask.task_id}" data-batch-id="${batchId}">
            <div class="task-header">
                <div class="batch-task-ids">
                    ${batch.map((task, idx) => `
                        <div class="batch-task-row">
                            <span class="task-index">#${idx + 1}</span>
                            <span class="task-id" onclick="copyToClipboard('${task.request_id || task.task_id}')" title="ç‚¹å‡»å¤åˆ¶">${task.request_id || task.task_id}</span>
                            <span class="task-status status-${(task.task_status || 'PENDING').toLowerCase()}">${getStatusText(task.task_status || 'PENDING')}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="task-actions">
                    <button class="btn btn-secondary btn-sm icon-only" onclick="event.stopPropagation(); regenerateI2ITask('${mainTask.task_id}')" title="ä½¿ç”¨ç›¸åŒé…ç½®é‡æ–°ç”Ÿæˆ">ğŸ”„</button>
                </div>
            </div>
            
            <div class="task-info">
                <p><strong>æç¤ºè¯:</strong> ${mainTask.prompt}</p>
                <p><strong>æ¨¡å‹:</strong> ${mainTask.model}</p>
                <p><strong>å°ºå¯¸:</strong> ${mainTask.size}</p>
                ${mainTask.created_at ? `<p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(mainTask.created_at).toLocaleString('zh-CN')}</p>` : ''}
                ${mainTask.task_status === 'FAILED' && mainTask.message ? 
                    `<div class="error-message">âš  é”™è¯¯ä¿¡æ¯: ${mainTask.message}</div>` : ''}
            </div>
            
            ${mainTask.reference_image_urls && mainTask.reference_image_urls.length > 0 ? `
            <div class="reference-images">
                <p><strong>å‚è€ƒå›¾ç‰‡:</strong></p>
                <div class="reference-image-grid">
                    ${mainTask.reference_image_urls.map(url => `
                        <div class="reference-image-thumbnail">
                            <img src="${url}" alt="å‚è€ƒå›¾ç‰‡" loading="lazy" onerror="this.style.display='none'">
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            ${allImageUrls.length > 0 ? `
                <div class="image-grid">
                    ${allImageUrls.map((imgData, index) => {
                        const imageId = `${imgData.taskId}_${index}`;
                        const clickHandler = batchModeEnabled ? `toggleImageSelection('${imageId}')` : `openImageModal('${imgData.url}')`;
                        const thumbnailClass = batchModeEnabled ? 'image-thumbnail batch-mode' : 'image-thumbnail';
                        const isChecked = selectedImages.has(imageId) ? 'checked' : '';
                        
                        return `
                            <div class="${thumbnailClass}" id="image-${imageId}" onclick="${clickHandler}">
                                ${batchModeEnabled ? `
                                    <input type="checkbox" 
                                           class="batch-checkbox" 
                                           data-image-id="${imageId}" 
                                           data-image-url="${imgData.url}"
                                           ${isChecked}
                                           onclick="event.stopPropagation(); toggleImageCheckbox('${imageId}');">
                                ` : ''}
                                ${allImageUrls.length > 1 ? `<div class="image-index">#${index + 1}</div>` : ''}
                                <img src="${imgData.url}" alt="ç”Ÿæˆçš„å›¾ç‰‡" loading="lazy" onerror="handleImageError(this, '${imgData.url}')">
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : mainTask.task_status === 'SUCCEEDED' ? `
                <div class="loading">å›¾ç‰‡ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</div>
            ` : ''}
        </div>
        `;
    }).join('');
}

function toggleBatchDropdown(toggleElement) {
    const dropdown = toggleElement.parentElement;
    const content = dropdown.querySelector('.batch-dropdown-content');
    const isExpanded = toggleElement.classList.contains('expanded');
    
    if (isExpanded) {
        toggleElement.classList.remove('expanded');
        content.style.display = 'none';
    } else {
        toggleElement.classList.add('expanded');
        content.style.display = 'block';
    }
}

// è·å–ä»»åŠ¡çš„æ˜¾ç¤ºIDï¼Œqwen-image-editä¼˜å…ˆæ˜¾ç¤ºrequest_id
function getDisplayId(task) {
    if (task.model === 'qwen-image-edit-plus' && task.request_id) {
        return task.request_id;
    }
    return task.task_id;
}

function getStatusText(status) {
    const statusMap = {
        'PENDING': 'ç­‰å¾…ä¸­',
        'RUNNING': 'å¤„ç†ä¸­',
        'SUCCEEDED': 'æˆåŠŸ',
        'FAILED': 'å¤±è´¥'
    };
    return statusMap[status] || status;
}

function startI2IPolling(taskId) {
    if (i2iPollingIntervals.has(taskId)) {
        return;
    }
    
    let consecutiveFailures = 0;  // è¿ç»­å¤±è´¥è®¡æ•°
    const MAX_FAILURES = 3;  // æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°
    
    const intervalId = setInterval(async () => {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);  // 8ç§’è¶…æ—¶
            
            const response = await fetch(`/api/i2i-task/${taskId}`, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            const data = await response.json();
            
            if (data.success && data.task) {
                consecutiveFailures = 0;  // æˆåŠŸåé‡ç½®å¤±è´¥è®¡æ•°
                const task = data.task;
                const status = task.task_status;
                const oldStatus = taskStatusCache.get(taskId);
                
                if (oldStatus !== status) {
                    taskStatusCache.set(taskId, status);
                    updateI2ITaskStatus(taskId, task);
                }
                
                if (status === 'SUCCEEDED' || status === 'FAILED') {
                    clearInterval(intervalId);
                    i2iPollingIntervals.delete(taskId);
                    loadI2ITasks();
                }
            } else {
                consecutiveFailures++;
                if (consecutiveFailures >= MAX_FAILURES) {
                    console.error(`ä»»åŠ¡ ${taskId} è¿ç»­æŸ¥è¯¢å¤±è´¥ ${MAX_FAILURES} æ¬¡ï¼Œåœæ­¢è½®è¯¢`);
                    clearInterval(intervalId);
                    i2iPollingIntervals.delete(taskId);
                    
                    // åœ¨UIä¸Šæ ‡è®°ä¸ºæŸ¥è¯¢å¤±è´¥
                    const taskElement = document.getElementById(`task-${taskId}`);
                    if (taskElement) {
                        const statusSpan = taskElement.querySelector('.task-status');
                        if (statusSpan) {
                            statusSpan.className = 'task-status status-failed';
                            statusSpan.textContent = 'æŸ¥è¯¢å¤±è´¥';
                        }
                    }
                }
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error('æŸ¥è¯¢ä»»åŠ¡è¶…æ—¶:', taskId);
            } else {
                console.error('è½®è¯¢ä»»åŠ¡å¤±è´¥:', error);
            }
            
            consecutiveFailures++;
            if (consecutiveFailures >= MAX_FAILURES) {
                console.error(`ä»»åŠ¡ ${taskId} è¿ç»­æŸ¥è¯¢å¤±è´¥ ${MAX_FAILURES} æ¬¡ï¼Œåœæ­¢è½®è¯¢`);
                clearInterval(intervalId);
                i2iPollingIntervals.delete(taskId);
                
                // åœ¨UIä¸Šæ ‡è®°ä¸ºæŸ¥è¯¢å¤±è´¥
                const taskElement = document.getElementById(`task-${taskId}`);
                if (taskElement) {
                    const statusSpan = taskElement.querySelector('.task-status');
                    if (statusSpan) {
                        statusSpan.className = 'task-status status-failed';
                        statusSpan.textContent = 'æŸ¥è¯¢å¤±è´¥';
                    }
                }
            }
        }
    }, 5000);
    
    i2iPollingIntervals.set(taskId, intervalId);
}

function updateI2ITaskStatus(taskId, task) {
    const taskItem = document.getElementById(`task-${taskId}`);
    if (!taskItem) return;
    
    const statusSpan = taskItem.querySelector('.task-status');
    if (statusSpan) {
        statusSpan.className = 'task-status';
        statusSpan.classList.add(`status-${(task.task_status || 'unknown').toLowerCase()}`);
        statusSpan.textContent = getStatusText(task.task_status);
    }
    
    if (task.task_status === 'FAILED' && task.message) {
        const taskInfo = taskItem.querySelector('.task-info');
        if (taskInfo && !taskInfo.querySelector('.error-message')) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `âš  é”™è¯¯ä¿¡æ¯: ${task.message}`;
            taskInfo.appendChild(errorDiv);
        }
    }
    
    if (task.task_status === 'SUCCEEDED') {
        // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°å›¾ç‰‡URL
        const imageUrls = task.local_image_urls || task.image_urls;
        if (imageUrls && imageUrls.length > 0) {
        const loadingDiv = taskItem.querySelector('.loading');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        
        let imageGrid = taskItem.querySelector('.image-grid');
        if (!imageGrid) {
            imageGrid = document.createElement('div');
            imageGrid.className = 'image-grid';
            taskItem.appendChild(imageGrid);
            
            imageUrls.forEach((url, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'image-thumbnail';
                thumbnail.onclick = () => openImageModal(url);
                
                if (imageUrls.length > 1) {
                    const indexDiv = document.createElement('div');
                    indexDiv.className = 'image-index';
                    indexDiv.textContent = `#${index + 1}`;
                    thumbnail.appendChild(indexDiv);
                }
                
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'ç”Ÿæˆçš„å›¾ç‰‡';
                img.onerror = () => handleImageError(img, url);
                thumbnail.appendChild(img);
                
                imageGrid.appendChild(thumbnail);
            });
        }
        }
    }
}

// ä½¿ç”¨common.jsä¸­çš„é€šç”¨å‡½æ•°:
// - copyToClipboard(text)
// - openImageModal(imageUrl)
// - closeImageModal()
// - handleImageError(imgElement, url)
// - logout()
// - showAlert(message, type)

// æ‰¹é‡é€‰æ‹©ç›¸å…³å‡½æ•°
function toggleBatchMode() {
    batchModeEnabled = !batchModeEnabled;
    const btn = document.getElementById('batchModeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const saveToAssetBtn = document.getElementById('saveToAssetBtn');
    
    if (batchModeEnabled) {
        btn.textContent = 'å–æ¶ˆé€‰æ‹©';
        btn.classList.add('active');
        downloadBtn.style.display = 'inline-block';
        if (saveToAssetBtn) saveToAssetBtn.style.display = 'inline-block';
    } else {
        btn.textContent = 'æ‰¹é‡é€‰æ‹©';
        btn.classList.remove('active');
        downloadBtn.style.display = 'none';
        if (saveToAssetBtn) saveToAssetBtn.style.display = 'none';
        selectedImages.clear();
    }
    
    loadI2ITasks(); // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
}

// ä¿å­˜é€‰ä¸­çš„å›¾ç‰‡åˆ°èµ„äº§åº“
function saveSelectedImagesToAssets() {
    if (selectedImages.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¿å­˜çš„å›¾ç‰‡', 'error');
        return;
    }
    
    // æ”¶é›†é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶ä¿¡æ¯
    const files = [];
    for (const imageId of selectedImages) {
        const checkbox = document.querySelector(`.batch-checkbox[data-image-id="${imageId}"]`);
        if (checkbox && checkbox.dataset.imageUrl) {
            const imageUrl = checkbox.dataset.imageUrl;
            const filename = imageUrl.split('/').pop();
            files.push({
                filename: filename,
                source_type: 'i2i',
                file_type: 'image'
            });
        }
    }
    
    if (files.length === 0) {
        showAlert('æ²¡æœ‰æ‰¾åˆ°å¯ä¿å­˜çš„å›¾ç‰‡', 'error');
        return;
    }
    
    openSaveToAssetModal({
        files: files,
        fileType: 'image',
        onComplete: (count) => {
            if (count > 0) {
                selectedImages.clear();
                updateSelectedCount();
            }
        }
    });
}

function updateSelectedCount() {
    selectedImages.clear();
    document.querySelectorAll('.batch-checkbox:checked').forEach(checkbox => {
        selectedImages.add(checkbox.dataset.imageId);
    });
    document.getElementById('selectedCount').textContent = selectedImages.size;
}

function toggleImageCheckbox(imageId) {
    const checkbox = document.querySelector(`.batch-checkbox[data-image-id="${imageId}"]`);
    if (!checkbox) return;
    
    if (checkbox.checked) {
        selectedImages.add(imageId);
    } else {
        selectedImages.delete(imageId);
    }
    
    const thumbnail = document.getElementById(`image-${imageId}`);
    if (thumbnail) {
        if (checkbox.checked) {
            thumbnail.classList.add('selected');
        } else {
            thumbnail.classList.remove('selected');
        }
    }
    
    updateSelectedCount();
}

function toggleImageSelection(imageId) {
    const checkbox = document.querySelector(`.batch-checkbox[data-image-id="${imageId}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        
        if (checkbox.checked) {
            selectedImages.add(imageId);
        } else {
            selectedImages.delete(imageId);
        }
        
        const thumbnail = document.getElementById(`image-${imageId}`);
        if (thumbnail) {
            if (checkbox.checked) {
                thumbnail.classList.add('selected');
            } else {
                thumbnail.classList.remove('selected');
            }
        }
        
        updateSelectedCount();
    }
}

function downloadImage(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// é‡æ–°ç”Ÿæˆå›¾ç”Ÿå›¾ä»»åŠ¡
async function regenerateI2ITask(taskId) {
    if (!taskId) {
        showAlert('æ— æ•ˆçš„ä»»åŠ¡ID', 'error');
        return;
    }
    
    try {
        showAlert('æ­£åœ¨é‡æ–°ç”Ÿæˆä»»åŠ¡...', 'info');
        
        const response = await fetch('/api/regenerate-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                task_id: taskId,
                task_type: 'i2i'  // å›¾ç”Ÿå›¾ä»»åŠ¡
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡', 'success');
            
            // å¯åŠ¨æ–°ä»»åŠ¡çš„è½®è¯¢
            if (data.tasks && data.tasks.length > 0) {
                data.tasks.forEach(task => {
                    if (task.task_id) {
                        startI2IPolling(task.task_id);
                    }
                });
            }
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°ä»»åŠ¡
            loadI2ITasks();
        } else {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥:', error);
        showAlert('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
    }
}

async function downloadSelected() {
    if (selectedImages.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„å›¾ç‰‡', 'error');
        return;
    }
    
    showAlert(`å¼€å§‹ä¸‹è½½ ${selectedImages.size} å¼ å›¾ç‰‡...`, 'success');
    
    let downloadCount = 0;
    for (const imageId of selectedImages) {
        const checkbox = document.querySelector(`.batch-checkbox[data-image-id="${imageId}"]`);
        if (checkbox && checkbox.dataset.imageUrl) {
            const imageUrl = checkbox.dataset.imageUrl;
            downloadImage(imageUrl, `image_${imageId}.jpg`);
            downloadCount++;
            await new Promise(resolve => setTimeout(resolve, 300));
        }
    }
    
    if (downloadCount > 0) {
        showAlert(`å·²å¯åŠ¨ ${downloadCount} å¼ å›¾ç‰‡ä¸‹è½½`, 'success');
    }
}
// - getStatusText(status)

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endblock %}
