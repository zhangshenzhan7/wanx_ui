{% extends "base.html" %}

{% block title %}é€šä¹‰ä¸‡ç›¸ - å‚è€ƒç”Ÿè§†é¢‘{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/common.css">
{% endblock %}

{% block body %}
<div class="workspace-container">
    <div class="workspace-header">
        <h1>ğŸ¥ é€šä¹‰ä¸‡ç›¸å‚è€ƒç”Ÿè§†é¢‘</h1>
        <div>
            <button class="btn btn-secondary" onclick="window.location.href='/assets'" style="margin-right: 10px;">ğŸ“ èµ„äº§åº“</button>
            <button class="btn btn-secondary" onclick="window.location.href='/workspace'" style="margin-right: 10px;">å›¾ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2video'" style="margin-right: 10px;">æ–‡ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/kf2v'" style="margin-right: 10px;">é¦–å°¾å¸§ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary active" style="margin-right: 10px;">å‚è€ƒç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2image'" style="margin-right: 10px;">æ–‡ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/image2image'" style="margin-right: 10px;">å›¾ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/voice-clone'" style="margin-right: 10px;">è¯­éŸ³å¤åˆ»</button>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </div>
    </div>
    
    <div class="workspace-content">
        <!-- å·¦ä¾§ï¼šåˆ›å»ºä»»åŠ¡ -->
        <div class="create-panel">
            <h2>åˆ›å»ºæ–°ä»»åŠ¡</h2>
            
            <div class="form-section">
                <!-- å‚è€ƒè§†é¢‘ä¸Šä¼  -->
                <div class="form-group">
                    <label>å‚è€ƒè§†é¢‘ï¼ˆå¿…å¡«ï¼Œæœ€å¤š3ä¸ªï¼‰</label>
                    <div class="upload-area" id="videoUploadArea">
                        <input type="file" id="videoInput" accept="video/mp4,video/mov" multiple style="display: none;">
                        <div class="upload-placeholder" id="videoPlaceholder">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å‚è€ƒè§†é¢‘</p>
                            <small>æ”¯æŒ MP4ã€MOV æ ¼å¼ï¼Œæ—¶é•¿2-30ç§’ï¼Œå•ä¸ªæ–‡ä»¶â‰¤100MB</small>
                        </div>
                        <div id="videoPreviewList" class="video-preview-list" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- æç¤ºè¯ -->
                <div class="form-group">
                    <label>æç¤ºè¯ï¼ˆå¿…å¡«ï¼‰</label>
                    <textarea id="prompt" rows="4" placeholder="ä½¿ç”¨ character1 æŒ‡ä»£å‚è€ƒè§†é¢‘ä¸­çš„ä¸»ä½“ï¼Œä¾‹å¦‚ï¼šcharacter1åœ¨æ²™å‘ä¸Šå¼€å¿ƒçš„çœ‹ç”µå½±"></textarea>
                    <small style="color: #888;">ğŸ’¡ æç¤ºï¼šä½¿ç”¨ character1 æŒ‡ä»£å‚è€ƒè§†é¢‘ä¸­çš„ä¸»ä½“è§’è‰²</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ¨¡å‹é€‰æ‹©</label>
                        <select id="model">
                            <option value="wan2.6-r2v">wan2.6-r2vï¼ˆæ¨èï¼‰</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>åˆ†è¾¨ç‡</label>
                        <select id="size">
                            <optgroup label="720P æ¡£ä½ï¼ˆè´¹ç”¨è¾ƒä½ï¼‰">
                                <option value="1280*720" selected>720P 16:9 (1280*720)</option>
                                <option value="720*1280">720P 9:16 (720*1280)</option>
                                <option value="960*960">720P 1:1 (960*960)</option>
                                <option value="1088*832">720P 4:3 (1088*832)</option>
                                <option value="832*1088">720P 3:4 (832*1088)</option>
                            </optgroup>
                            <optgroup label="1080P æ¡£ä½ï¼ˆè´¹ç”¨æ›´é«˜ï¼‰">
                                <option value="1920*1080">1080P 16:9 (1920*1080)</option>
                                <option value="1080*1920">1080P 9:16 (1080*1920)</option>
                                <option value="1440*1440">1080P 1:1 (1440*1440)</option>
                                <option value="1632*1248">1080P 4:3 (1632*1248)</option>
                                <option value="1248*1632">1080P 3:4 (1248*1632)</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>è§†é¢‘æ—¶é•¿</label>
                        <select id="duration">
                            <option value="5">5ç§’</option>
                            <option value="10">10ç§’</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>é•œå¤´ç±»å‹</label>
                        <select id="shotType">
                            <option value="single">å•é•œå¤´</option>
                            <option value="multi">å¤šé•œå¤´</option>
                        </select>
                    </div>
                </div>
                
                <!-- åå‘æç¤ºè¯ -->
                <div class="form-group">
                    <label>åå‘æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="negativePrompt" placeholder="ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹...">
                </div>
                
                <div class="form-group">
                    <label>æ‰¹é‡ç”Ÿæˆæ•°é‡</label>
                    <select id="batchCount">
                        <option value="1" selected>1ä¸ªè§†é¢‘ï¼ˆæ¨èï¼‰</option>
                        <option value="2">2ä¸ªè§†é¢‘</option>
                        <option value="3">3ä¸ªè§†é¢‘</option>
                        <option value="4">4ä¸ªè§†é¢‘ï¼ˆæœ€å¤šï¼‰</option>
                    </select>
                    <small>ä¸€æ¬¡ç”Ÿæˆå¤šä¸ªç›¸åŒå‚æ•°çš„è§†é¢‘ï¼Œå¯ä»ä¸­æŒ‘é€‰æœ€ä½³æ•ˆæœ</small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="audio" checked>
                        å¯ç”¨éŸ³é¢‘è‡ªåŠ¨é…éŸ³
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="watermark">
                        æ·»åŠ æ°´å°
                    </label>
                </div>
                
                <button class="btn btn-primary btn-large btn-generate" onclick="createR2vTask()" id="createBtn">
                    <span class="btn-icon">âœ¨</span>
                    <span class="btn-text">å¼€å§‹ç”Ÿæˆ</span>
                </button>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šå†å²è®°å½• -->
        <div class="history-panel">
            <div class="history-header">
                <h2>å†å²è®°å½•</h2>
                <div class="history-actions">
                    <button class="btn btn-secondary btn-sm" onclick="toggleBatchMode()" id="batchModeBtn">
                        æ‰¹é‡é€‰æ‹©
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadSelected()" id="downloadBtn" style="display:none;">
                        ä¸‹è½½é€‰ä¸­ (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="saveSelectedToAssets()" id="saveToAssetBtn" style="display:none;">
                        ğŸ“ ä¿å­˜åˆ°èµ„äº§åº“
                    </button>
                </div>
            </div>
            <div class="history-panel-wrapper">
                <div class="task-list-container">
                    <div id="taskList" class="task-list">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <!-- å³ä¾§ç¼©ç•¥å›¾å¿«é€Ÿå¯¼èˆª -->
                <div class="thumbnail-nav" id="thumbnailNav">
                    <div class="thumbnail-nav-header">å¿«é€Ÿå¯¼èˆª (<span id="thumbNavCount">0</span>)</div>
                    <div class="thumbnail-nav-list" id="thumbnailNavList">
                        <div class="thumbnail-nav-empty">æš‚æ— å·²å®Œæˆ<br>çš„è§†é¢‘</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è§†é¢‘æ”¾å¤§æµ®å±‚ -->
<div class="video-modal" id="videoModal" onclick="closeVideoModal()">
    <div class="video-modal-content" onclick="event.stopPropagation()">
        <button class="video-modal-close" onclick="closeVideoModal()">&times;</button>
        <video id="modalVideo" controls autoplay></video>
    </div>
</div>

<style>
.video-preview-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.video-preview-item {
    position: relative;
    border: 2px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.video-preview-item video {
    width: 100%;
    display: block;
}

.video-preview-item .remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    padding: 0;
}

.video-preview-item .remove-btn:hover {
    background: rgba(255, 0, 0, 1);
}

/* æ‰¹é‡ä»»åŠ¡IDæ˜¾ç¤ºæ ·å¼ */
.batch-task-ids {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 8px;
}

.batch-task-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 8px;
    border-radius: 6px;
    transition: background 0.15s;
}

.batch-task-row:hover {
    background: #f0f2ff;
}

.batch-task-row .task-index {
    font-size: 11px;
    font-weight: 600;
    color: #667eea;
    min-width: 24px;
}

.batch-task-row .task-id {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 11px;
    color: #555;
    cursor: pointer;
    padding: 2px 6px;
    background: #fff;
    border: 1px solid #e0e4ff;
    border-radius: 4px;
    transition: all 0.2s;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.batch-task-row .task-id:hover {
    background: #667eea;
    color: #fff;
    border-color: #667eea;
}

.batch-task-row .task-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    min-width: 50px;
    text-align: center;
}

/* è§†é¢‘ç½‘æ ¼å’Œç¼©ç•¥å›¾æ ·å¼ */
.video-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
}

.video-thumbnail {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    aspect-ratio: 16 / 9;
    background: #f0f0f0;
    transition: transform 0.2s, box-shadow 0.2s;
}

.video-thumbnail:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.video-thumbnail.selected {
    box-shadow: 0 0 0 3px #667eea;
}

.video-thumbnail .video-poster-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.video-thumbnail .video-index {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 4px;
}

.video-thumbnail .batch-checkbox {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    cursor: pointer;
    z-index: 10;
}

/* æŒ‰é’®æ ·å¼ */
.btn.icon-only {
    padding: 4px 8px;
    min-width: auto;
}

/* å‚è€ƒè§†é¢‘ç¼©ç•¥å›¾å®¹å™¨æ ·å¼ */
.r2v-ref-videos-container {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.r2v-ref-video-item {
    flex: 0 0 auto;
    max-width: 120px;
    text-align: center;
}

.r2v-ref-video-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 6px;
    font-weight: 500;
}

.r2v-ref-video-poster {
    width: 100%;
    max-width: 120px;
    max-height: 90px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid #e0e0e0;
    background: #f5f5f5;
}

.r2v-ref-video-poster:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* å‚è€ƒè§†é¢‘æ’­æ”¾æŒ‰é’®è§†è§‰æç¤º */
.r2v-ref-video-item {
    position: relative;
}

.r2v-ref-video-item::after {
    content: 'â–¶';
    position: absolute;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%);
    width: 28px;
    height: 28px;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
    pointer-events: none;
    transition: all 0.2s;
}

.r2v-ref-video-item:hover::after {
    background: rgba(22, 100, 255, 0.8);
}
</style>

<!-- Batch video processing script -->
<script src="/static/batch-video.js"></script>
<script src="/static/asset-picker.js"></script>
<script src="/static/common.js"></script>
<!-- ç¼©ç•¥å›¾å¯¼èˆªç»„ä»¶ -->
<script src="/static/thumbnail-nav.js"></script>
<script>
// é¡µé¢çŠ¶æ€
let uploadedVideoFilenames = [];
let r2vPollingIntervals = new Map();
let batchModeEnabled = false;
let selectedVideos = new Set();

// è§†é¢‘æ‡’åŠ è½½Intersection Observer
let videoObserver = null;

// ç”¨äºé˜²æ­¢é¢‘ç¹åˆ·æ–°çš„èŠ‚æµæ§åˆ¶
let pendingRefresh = false;
let lastRefreshTime = 0;
const REFRESH_THROTTLE_MS = 2000;

// ç¼“å­˜ä»»åŠ¡çŠ¶æ€
let taskStatusCache = new Map();

// åˆ†é¡µåŠ è½½çŠ¶æ€
let currentPage = 1;
let hasMoreTasks = true;
let isLoadingMore = false;
const TASKS_PER_PAGE = 10;
let loadedTaskIds = new Set();

// åˆå§‹åŒ–è§†é¢‘æ‡’åŠ è½½Observer
function initVideoLazyLoad() {
    if (videoObserver) {
        videoObserver.disconnect();
    }
    
    videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const video = entry.target;
                const dataSrc = video.getAttribute('data-src');
                if (dataSrc && video.src !== dataSrc) {
                    video.src = dataSrc;
                    video.load();
                    video.removeAttribute('data-src');
                }
                videoObserver.unobserve(video);
            }
        });
    }, {
        rootMargin: '100px',
        threshold: 0.1
    });
}

// è§‚å¯Ÿæ‰€æœ‰æ‡’åŠ è½½è§†é¢‘
function observeLazyVideos() {
    if (!videoObserver) {
        initVideoLazyLoad();
    }
    document.querySelectorAll('video[data-src]').forEach(video => {
        videoObserver.observe(video);
    });
}

// é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
window.addEventListener('load', function() {
    initVideoLazyLoad();
    initInfiniteScroll();
    loadR2vTasks();
    
    // åˆå§‹åŒ–ç¼©ç•¥å›¾å¯¼èˆª
    ThumbnailNav.init({
        apiEndpoint: '/api/r2v-thumbnails',
        mediaType: 'video',
        itemsPerPage: 50,
        enableBatchSupport: true,
        virtualScrollEnabled: false  // ç¦ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ»šåŠ¨
    });
});

// åˆå§‹åŒ–æ— é™æ»šåŠ¨
function initInfiniteScroll() {
    const taskList = document.getElementById('taskList');
    
    if (taskList) {
        taskList.addEventListener('scroll', function() {
            const scrollTop = taskList.scrollTop;
            const scrollHeight = taskList.scrollHeight;
            const clientHeight = taskList.clientHeight;
            const distanceToBottom = scrollHeight - scrollTop - clientHeight;
            
            if (distanceToBottom < 300 && hasMoreTasks && !isLoadingMore) {
                console.log('[DEBUG] è§¦å‘åŠ è½½æ›´å¤š R2Vï¼Œè·ç¦»åº•éƒ¨:', distanceToBottom);
                loadMoreR2vTasks();
            }
        });
        console.log('[DEBUG] R2V æ— é™æ»šåŠ¨å·²åˆå§‹åŒ–');
    }
}

// åŠ è½½æ›´å¤šä»»åŠ¡
async function loadMoreR2vTasks() {
    if (isLoadingMore || !hasMoreTasks) {
        console.log('[DEBUG] R2V è·³è¿‡åŠ è½½: isLoadingMore=', isLoadingMore, 'hasMoreTasks=', hasMoreTasks);
        return;
    }
    
    isLoadingMore = true;
    currentPage++;
    
    console.log('[DEBUG] R2V å¼€å§‹åŠ è½½ç¬¬', currentPage, 'é¡µ');
    
    try {
        const response = await fetch(`/api/r2v-tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        console.log('[DEBUG] R2V åŠ è½½ç»“æœ: success=', data.success, 'tasks=', data.tasks?.length, 'has_more=', data.has_more);
        
        if (data.success && data.tasks && data.tasks.length > 0) {
            appendR2vTasks(data.tasks);
            hasMoreTasks = data.has_more;
            
            setTimeout(() => {
                observeLazyVideos();
            }, 100);
            
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startR2vPolling(task.task_id);
                }
            });
        } else {
            hasMoreTasks = false;
        }
    } catch (error) {
        console.error('åŠ è½½æ›´å¤šä»»åŠ¡å¤±è´¥:', error);
        currentPage--;
    } finally {
        isLoadingMore = false;
    }
}

// è§†é¢‘ä¸Šä¼ å¤„ç†
const videoUploadArea = document.getElementById('videoUploadArea');
const videoInput = document.getElementById('videoInput');
const videoPlaceholder = document.getElementById('videoPlaceholder');
const videoPreviewList = document.getElementById('videoPreviewList');

videoUploadArea.addEventListener('click', () => {
    if (uploadedVideoFilenames.length < 3) {
        videoInput.click();
    }
});

videoUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    videoUploadArea.classList.add('dragover');
});

videoUploadArea.addEventListener('dragleave', () => {
    videoUploadArea.classList.remove('dragover');
});

videoUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    videoUploadArea.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('video/'));
    handleVideoFiles(files);
});

videoInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    handleVideoFiles(files);
});

async function handleVideoFiles(files) {
    const remainingSlots = 3 - uploadedVideoFilenames.length;
    const filesToUpload = files.slice(0, remainingSlots);
    
    for (const file of filesToUpload) {
        if (file.size > 100 * 1024 * 1024) {
            showAlert(`æ–‡ä»¶ ${file.name} è¶…è¿‡100MBé™åˆ¶`, 'error');
            continue;
        }
        
        await uploadVideo(file);
    }
    
    updateVideoPreview();
}

async function uploadVideo(file) {
    const formData = new FormData();
    formData.append('video', file);
    
    try {
        const response = await fetch('/api/upload-r2v-video', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            uploadedVideoFilenames.push(data.filename);
            showAlert('è§†é¢‘ä¸Šä¼ æˆåŠŸ', 'success');
        } else {
            showAlert(data.message || 'ä¸Šä¼ å¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
    }
}

function updateVideoPreview() {
    if (uploadedVideoFilenames.length === 0) {
        videoPlaceholder.style.display = 'flex';
        videoPreviewList.style.display = 'none';
        videoPreviewList.innerHTML = '';
        return;
    }
    
    videoPlaceholder.style.display = 'none';
    videoPreviewList.style.display = 'grid';
    
    videoPreviewList.innerHTML = uploadedVideoFilenames.map((filename, index) => `
        <div class="video-preview-item">
            <video src="/api/video/r2v/{{ session.get('api_key_hash', '') }}/${filename}" controls></video>
            <button class="remove-btn" onclick="removeVideo(${index})">&times;</button>
        </div>
    `).join('');
}

function removeVideo(index) {
    uploadedVideoFilenames.splice(index, 1);
    updateVideoPreview();
}

// åˆ›å»ºR2Vä»»åŠ¡
async function createR2vTask() {
    if (uploadedVideoFilenames.length === 0) {
        showAlert('è¯·å…ˆä¸Šä¼ å‚è€ƒè§†é¢‘', 'error');
        return;
    }
    
    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt) {
        showAlert('è¯·è¾“å…¥æç¤ºè¯', 'error');
        return;
    }
    
    const requestBody = {
        reference_video_filenames: uploadedVideoFilenames,
        prompt: prompt,
        model: document.getElementById('model').value,
        size: document.getElementById('size').value,
        duration: parseInt(document.getElementById('duration').value),
        shot_type: document.getElementById('shotType').value,
        negative_prompt: document.getElementById('negativePrompt').value,
        audio: document.getElementById('audio').checked,
        watermark: document.getElementById('watermark').checked,
        batch_count: parseInt(document.getElementById('batchCount').value)
    };
    
    const btn = document.getElementById('createBtn');
    const btnIcon = btn.querySelector('.btn-icon');
    const btnText = btn.querySelector('.btn-text');
    
    btn.disabled = true;
    btnIcon.textContent = 'â³';
    btnText.textContent = 'åˆ›å»ºä¸­...';
    
    try {
        const response = await fetch('/api/create-r2v-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'ä»»åŠ¡åˆ›å»ºæˆåŠŸ', 'success');
            loadR2vTasks();
            
            // ä¸ºæ‰¹é‡ä»»åŠ¡å¼€å§‹è½®è¯¢
            if (data.tasks) {
                data.tasks.forEach(task => {
                    startR2vPolling(task.task_id);
                });
            }
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btnIcon.textContent = 'âœ¨';
        btnText.textContent = 'å¼€å§‹ç”Ÿæˆ';   
    }
}

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
async function loadR2vTasks(reset = true) {
    try {
        // é‡ç½®åˆ†é¡µçŠ¶æ€
        if (reset) {
            currentPage = 1;
            hasMoreTasks = true;
            loadedTaskIds.clear();
        }
        
        const response = await fetch(`/api/r2v-tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        if (data.success) {
            if (reset) {
                renderR2vTasks(data.tasks);
            } else {
                appendR2vTasks(data.tasks);
            }
            
            hasMoreTasks = data.has_more;
            
            // æ¸²æŸ“åå¯ç”¨æ‡’åŠ è½½
            setTimeout(() => {
                observeLazyVideos();
            }, 100);
            
            // æ›´æ–°ç¼©ç•¥å›¾å¯¼èˆª
            updateThumbnailNav();
            
            // ä¸ºè¿›è¡Œä¸­çš„ä»»åŠ¡å¯åŠ¨è½®è¯¢
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startR2vPolling(task.task_id);
                }
            });
        }
    } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
    }
}

// æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
function renderR2vTasks(tasks) {
    const taskList = document.getElementById('taskList');
    
    if (tasks.length === 0) {
        taskList.innerHTML = '<div class="loading">æš‚æ— å†å²è®°å½•</div>';
        return;
    }
    
    // è®°å½•å·²åŠ è½½çš„ä»»åŠ¡ID
    tasks.forEach(t => loadedTaskIds.add(t.task_id));
    
    // æŒ‰batch_idåˆ†ç»„
    const batchGroups = groupR2vTasksByBatch(tasks);
    
    taskList.innerHTML = renderR2vTaskGroups(batchGroups);
}

// è¿½åŠ ä»»åŠ¡
function appendR2vTasks(tasks) {
    const taskList = document.getElementById('taskList');
    
    // è¿‡æ»¤å·²åŠ è½½çš„ä»»åŠ¡
    const newTasks = tasks.filter(t => !loadedTaskIds.has(t.task_id));
    if (newTasks.length === 0) return;
    
    // è®°å½•æ–°åŠ è½½çš„ä»»åŠ¡ID
    newTasks.forEach(t => loadedTaskIds.add(t.task_id));
    
    // æŒ‰batch_idåˆ†ç»„
    const batchGroups = groupR2vTasksByBatch(newTasks);
    
    // è¿½åŠ åˆ°åˆ—è¡¨
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = renderR2vTaskGroups(batchGroups);
    
    while (tempDiv.firstChild) {
        taskList.appendChild(tempDiv.firstChild);
    }
}

// æŒ‰batch_idåˆ†ç»„ä»»åŠ¡
function groupR2vTasksByBatch(tasks) {
    const batchGroups = {};
    tasks.forEach(task => {
        const batchId = task.batch_id || task.task_id;
        if (!batchGroups[batchId]) {
            batchGroups[batchId] = [];
        }
        batchGroups[batchId].push(task);
    });
    return batchGroups;
}

// æ¸²æŸ“ä»»åŠ¡åˆ†ç»„ä¸ºHTML
function renderR2vTaskGroups(batchGroups) {
    let html = '';
    Object.keys(batchGroups).forEach(batchId => {
        const groupTasks = batchGroups[batchId];
        const firstTask = groupTasks[0];
        const isBatch = groupTasks.length > 1;
        
        html += `<div class="task-item" id="task-${firstTask.task_id}" data-batch-id="${batchId}">`;
        
        // ä»»åŠ¡å¤´éƒ¨ - æ˜¾ç¤ºæ‰€æœ‰task_id
        html += '<div class="task-header">';
        html += '<div class="batch-task-ids">';
        groupTasks.forEach((task, idx) => {
            const statusClass = `status-${(task.task_status || 'PENDING').toLowerCase()}`;
            const statusText = getStatusText(task.task_status || 'PENDING');
            html += `<div class="batch-task-row">`;
            html += `<span class="task-index">#${idx + 1}</span>`;
            html += `<span class="task-id" onclick="copyToClipboard('${task.task_id}')" title="ç‚¹å‡»å¤åˆ¶">${task.task_id}</span>`;
            html += `<span class="task-status ${statusClass}">${statusText}</span>`;
            html += '</div>';
        });
        html += '</div>';
        html += '<div class="task-actions">';
        html += `<button class="btn btn-secondary btn-sm icon-only" onclick="event.stopPropagation(); regenerateR2vTask('${firstTask.task_id}')" title="ä½¿ç”¨ç›¸åŒé…ç½®é‡æ–°ç”Ÿæˆ">ğŸ”„</button>`;
        html += '</div>';
        html += '</div>';
        
        // ä»»åŠ¡å†…å®¹
        html += '<div class="task-content">';
        
        // å‚è€ƒè§†é¢‘ç¼©ç•¥å›¾å±•ç¤º
        if (firstTask.reference_video_filenames && firstTask.reference_video_filenames.length > 0) {
            html += '<div class="r2v-ref-videos-container">';
            firstTask.reference_video_filenames.forEach((filename, index) => {
                const posterUrl = `/api/r2v-ref-video-poster/{{ session.get('api_key_hash', '') }}/${filename}`;
                const videoUrl = `/api/video/r2v/{{ session.get('api_key_hash', '') }}/${filename}`;
                const label = firstTask.reference_video_filenames.length > 1 ? `å‚è€ƒ${index + 1}` : 'å‚è€ƒè§†é¢‘';
                html += '<div class="r2v-ref-video-item">';
                html += `<div class="r2v-ref-video-label">${label}</div>`;
                html += `<img src="${posterUrl}" class="r2v-ref-video-poster" alt="å‚è€ƒè§†é¢‘" onclick="openVideoModal('${videoUrl}')" loading="lazy">`;
                html += '</div>';
            });
            html += '</div>';
        }
        
        // ä»»åŠ¡ä¿¡æ¯
        html += '<div class="task-info">';
        html += `<p><strong>æ¨¡å‹:</strong> ${firstTask.model || 'wan2.6-r2v'}</p>`;
        html += `<p><strong>åˆ†è¾¨ç‡:</strong> ${firstTask.size || '1280*720'}</p>`;
        html += `<p><strong>æ—¶é•¿:</strong> ${firstTask.duration || 5}ç§’</p>`;
        html += `<p><strong>é•œå¤´:</strong> ${firstTask.shot_type === 'multi' ? 'å¤šé•œå¤´' : 'å•é•œå¤´'}</p>`;
        
        if (firstTask.prompt) {
            html += `<p><strong>æç¤ºè¯:</strong> ${firstTask.prompt}</p>`;
        }
        
        if (firstTask.created_at) {
            html += `<p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(firstTask.created_at).toLocaleString('zh-CN')}</p>`;
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (firstTask.task_status === 'FAILED' && firstTask.message) {
            html += `<div class="error-message">âš  é”™è¯¯ä¿¡æ¯: ${firstTask.message}</div>`;
        }
        
        html += '</div>';
        html += '</div>';
        
        // è§†é¢‘ç½‘æ ¼ï¼ˆæ‰¹é‡æˆ–å•ä¸ªï¼‰- ä½¿ç”¨ç¼©ç•¥å›¾
        const succeededTasks = groupTasks.filter(t => t.task_status === 'SUCCEEDED' && t.local_video_path);
        if (succeededTasks.length > 0) {
            html += '<div class="video-grid" style="margin-top: 15px;">';
            succeededTasks.forEach((task, index) => {
                const videoId = `${task.task_id}_${index}`;
                const clickHandler = batchModeEnabled ? `toggleVideoSelection('${videoId}')` : `openVideoModal('${task.local_video_path}')`;
                const thumbnailClass = batchModeEnabled ? 'video-thumbnail batch-mode' : 'video-thumbnail';
                
                html += `<div class="${thumbnailClass}" id="video-${videoId}" onclick="${clickHandler}">`;
                
                // æ‰¹é‡æ¨¡å¼ä¸‹æ˜¾ç¤ºå¤é€‰æ¡†
                if (batchModeEnabled) {
                    const isChecked = selectedVideos.has(videoId) ? 'checked' : '';
                    html += `<input type="checkbox" 
                                    class="batch-checkbox" 
                                    data-video-id="${videoId}" 
                                    data-video-url="${task.local_video_path}"
                                    ${isChecked}
                                    onclick="event.stopPropagation(); toggleVideoCheckbox('${videoId}');">`;
                }
                
                html += `<div class="video-index">${isBatch ? index + 1 : ''}</div>`;
                // ä½¿ç”¨è§†é¢‘å°é¢å›¾
                const posterUrl = `/api/video-poster/{{ session.get('api_key_hash', '') }}/${task.task_id}`;
                html += `<img class="video-poster-img" src="${posterUrl}" alt="è§†é¢‘å°é¢" loading="lazy">`;
                html += '</div>';
            });
            html += '</div>';
        }
        
        html += '</div>';
    });
    
    return html;
}

// å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
function startR2vPolling(taskId) {
    if (r2vPollingIntervals.has(taskId)) {
        return;
    }
    
    let consecutiveFailures = 0;  // è¿ç»­å¤±è´¥è®¡æ•°
    const MAX_FAILURES = 3;  // æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°
    
    const intervalId = setInterval(async () => {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);  // 8ç§’è¶…æ—¶
            
            const response = await fetch(`/api/r2v-task/${taskId}`, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            const data = await response.json();
            
            if (data.success && data.task) {
                const task = data.task;
                const status = task.task_status;
                const oldStatus = taskStatusCache.get(taskId);
                
                // åªæœ‰çŠ¶æ€å˜åŒ–æ—¶æ‰æ›´æ–°UI
                if (oldStatus !== status) {
                    taskStatusCache.set(taskId, status);
                    updateR2vTaskStatus(taskId, task);
                }
                
                // å¦‚æœä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢
                if (status === 'SUCCEEDED' || status === 'FAILED') {
                    clearInterval(intervalId);
                    r2vPollingIntervals.delete(taskId);
                    
                    // ä»»åŠ¡å®Œæˆæ—¶æ‰åˆ·æ–°åˆ—è¡¨
                    throttledRefresh();
                }
            } else {
                consecutiveFailures++;
                if (consecutiveFailures >= MAX_FAILURES) {
                    console.error(`ä»»åŠ¡ ${taskId} è¿ç»­æŸ¥è¯¢å¤±è´¥ ${MAX_FAILURES} æ¬¡ï¼Œåœæ­¢è½®è¯¢`);
                    clearInterval(intervalId);
                    r2vPollingIntervals.delete(taskId);
                    
                    // åœ¨UIä¸Šæ ‡è®°ä¸ºæŸ¥è¯¢å¤±è´¥
                    const taskElement = document.getElementById(`task-${taskId}`);
                    if (taskElement) {
                        const statusSpan = taskElement.querySelector('.task-status');
                        if (statusSpan) {
                            statusSpan.className = 'task-status status-failed';
                            statusSpan.textContent = 'æŸ¥è¯¢å¤±è´¥';
                        }
                    }
                }
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error('æŸ¥è¯¢ä»»åŠ¡è¶…æ—¶:', taskId);
            } else {
                console.error('è½®è¯¢ä»»åŠ¡å¤±è´¥:', error);
            }
            
            consecutiveFailures++;
            if (consecutiveFailures >= MAX_FAILURES) {
                console.error(`ä»»åŠ¡ ${taskId} è¿ç»­æŸ¥è¯¢å¤±è´¥ ${MAX_FAILURES} æ¬¡ï¼Œåœæ­¢è½®è¯¢`);
                clearInterval(intervalId);
                r2vPollingIntervals.delete(taskId);
                
                // åœ¨UIä¸Šæ ‡è®°ä¸ºæŸ¥è¯¢å¤±è´¥
                const taskElement = document.getElementById(`task-${taskId}`);
                if (taskElement) {
                    const statusSpan = taskElement.querySelector('.task-status');
                    if (statusSpan) {
                        statusSpan.className = 'task-status status-failed';
                        statusSpan.textContent = 'æŸ¥è¯¢å¤±è´¥';
                    }
                }
            }
        }
    }, 5000); // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
    
    r2vPollingIntervals.set(taskId, intervalId);
}

// å¢é‡æ›´æ–°å•ä¸ªä»»åŠ¡çŠ¶æ€
function updateR2vTaskStatus(taskId, task) {
    const taskItem = document.getElementById(`task-${taskId}`);
    if (!taskItem) return;
    
    const statusSpan = taskItem.querySelector('.task-status');
    if (statusSpan) {
        statusSpan.className = 'task-status';
        statusSpan.classList.add(`status-${(task.task_status || 'unknown').toLowerCase()}`);
        statusSpan.textContent = getStatusText(task.task_status);
    }
    
    if (task.task_status === 'FAILED' && task.message) {
        const taskContent = taskItem.querySelector('.task-content');
        if (taskContent && !taskContent.querySelector('.error-message')) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `âš  é”™è¯¯ä¿¡æ¯: ${task.message}`;
            taskContent.appendChild(errorDiv);
        }
    }
}

// èŠ‚æµåˆ·æ–°
function throttledRefresh() {
    const now = Date.now();
    
    if (now - lastRefreshTime < REFRESH_THROTTLE_MS) {
        if (!pendingRefresh) {
            pendingRefresh = true;
            setTimeout(() => {
                pendingRefresh = false;
                lastRefreshTime = Date.now();
                loadR2vTasks();
            }, REFRESH_THROTTLE_MS - (now - lastRefreshTime));
        }
        return;
    }
    
    lastRefreshTime = now;
    loadR2vTasks();
}

function getStatusText(status) {
    const statusMap = {
        'PENDING': 'ç­‰å¾…ä¸­',
        'RUNNING': 'ç”Ÿæˆä¸­',
        'SUCCEEDED': 'å·²å®Œæˆ',
        'FAILED': 'å¤±è´¥',
        'CANCELED': 'å·²å–æ¶ˆ',
        'UNKNOWN': 'æœªçŸ¥'
    };
    return statusMap[status] || status;
}

function toggleBatchMode() {
    batchModeEnabled = !batchModeEnabled;
    const btn = document.getElementById('batchModeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const saveToAssetBtn = document.getElementById('saveToAssetBtn');
    
    if (batchModeEnabled) {
        btn.textContent = 'å–æ¶ˆé€‰æ‹©';
        downloadBtn.style.display = 'inline-block';
        saveToAssetBtn.style.display = 'inline-block';
    } else {
        btn.textContent = 'æ‰¹é‡é€‰æ‹©';
        downloadBtn.style.display = 'none';
        saveToAssetBtn.style.display = 'none';
        selectedVideos.clear();
        document.getElementById('selectedCount').textContent = '0';
    }
}

function downloadSelected() {
    if (selectedVideos.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„è§†é¢‘', 'error');
        return;
    }
    
    showAlert(`å¼€å§‹ä¸‹è½½ ${selectedVideos.size} ä¸ªè§†é¢‘...`, 'success');
    
    let downloadCount = 0;
    for (const videoId of selectedVideos) {
        const checkbox = document.querySelector(`.batch-checkbox[data-video-id="${videoId}"]`);
        if (checkbox && checkbox.dataset.videoUrl) {
            const videoUrl = checkbox.dataset.videoUrl;
            downloadVideo(videoUrl, `video_${videoId}.mp4`);
            downloadCount++;
        }
    }
    
    if (downloadCount > 0) {
        showAlert(`å·²å¯åŠ¨ ${downloadCount} ä¸ªè§†é¢‘ä¸‹è½½`, 'success');
    }
}

// ä¸‹è½½è§†é¢‘
function downloadVideo(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// æ›´æ–°é€‰ä¸­æ•°é‡
function updateSelectedCount() {
    selectedVideos.clear();
    document.querySelectorAll('.batch-checkbox:checked').forEach(checkbox => {
        selectedVideos.add(checkbox.dataset.videoId || checkbox.dataset.taskId);
    });
    document.getElementById('selectedCount').textContent = selectedVideos.size;
}

// åˆ‡æ¢è§†é¢‘å¤é€‰æ¡†ï¼ˆç›´æ¥ç‚¹å‡»å¤é€‰æ¡†æ—¶ï¼‰
function toggleVideoCheckbox(videoId) {
    const checkbox = document.querySelector(`.batch-checkbox[data-video-id="${videoId}"]`);
    if (!checkbox) return;
    
    if (checkbox.checked) {
        selectedVideos.add(videoId);
    } else {
        selectedVideos.delete(videoId);
    }
    
    const thumbnail = document.getElementById(`video-${videoId}`);
    if (thumbnail) {
        if (checkbox.checked) {
            thumbnail.classList.add('selected');
        } else {
            thumbnail.classList.remove('selected');
        }
    }
    
    updateSelectedCount();
}

// åˆ‡æ¢è§†é¢‘é€‰æ‹©çŠ¶æ€ï¼ˆç‚¹å‡»è§†é¢‘ç¼©ç•¥å›¾æ—¶ï¼‰
function toggleVideoSelection(videoId) {
    const checkbox = document.querySelector(`.batch-checkbox[data-video-id="${videoId}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        
        if (checkbox.checked) {
            selectedVideos.add(videoId);
        } else {
            selectedVideos.delete(videoId);
        }
        
        const thumbnail = document.getElementById(`video-${videoId}`);
        if (thumbnail) {
            if (checkbox.checked) {
                thumbnail.classList.add('selected');
            } else {
                thumbnail.classList.remove('selected');
            }
        }
        
        updateSelectedCount();
    }
}

// é‡æ–°ç”Ÿæˆå‚è€ƒç”Ÿè§†é¢‘ä»»åŠ¡
async function regenerateR2vTask(taskId) {
    if (!taskId) {
        showAlert('æ— æ•ˆçš„ä»»åŠ¡ID', 'error');
        return;
    }
    
    try {
        showAlert('æ­£åœ¨é‡æ–°ç”Ÿæˆä»»åŠ¡...', 'info');
        
        const response = await fetch('/api/regenerate-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                task_id: taskId,
                task_type: 'r2v'  // å‚è€ƒç”Ÿè§†é¢‘ä»»åŠ¡
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡', 'success');
            
            // å¯åŠ¨æ–°ä»»åŠ¡çš„è½®è¯¢
            if (data.tasks && data.tasks.length > 0) {
                data.tasks.forEach(task => {
                    if (task.task_id) {
                        startR2vPolling(task.task_id);
                    }
                });
            }
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°ä»»åŠ¡
            loadR2vTasks();
        } else {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥:', error);
        showAlert('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
    }
}

function openVideoModal(videoUrl) {
    const modal = document.getElementById('videoModal');
    const video = document.getElementById('modalVideo');
    video.src = videoUrl;
    modal.style.display = 'flex';
}

function closeVideoModal() {
    const modal = document.getElementById('videoModal');
    const video = document.getElementById('modalVideo');
    modal.style.display = 'none';
    video.pause();
    video.src = '';
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showAlert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    });
}

function saveSelectedToAssets() {
    if (selectedVideos.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¿å­˜çš„è§†é¢‘', 'error');
        return;
    }
    
    showAlert('ä¿å­˜åˆ°èµ„äº§åº“åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

// ========== ç¼©ç•¥å›¾å¿«é€Ÿå¯¼èˆªåŠŸèƒ½ ==========
// æ³¨æ„ï¼šå·²è¿ç§»åˆ° ThumbnailNav ç»„ä»¶ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹

function updateThumbnailNav() {
    // ä½¿ç”¨ ThumbnailNav ç»„ä»¶åˆ·æ–°ç¼©ç•¥å›¾
    if (typeof ThumbnailNav !== 'undefined' && ThumbnailNav.refresh) {
        ThumbnailNav.refresh();
    } else {
        console.warn('ThumbnailNav ç»„ä»¶æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ·æ–°ç¼©ç•¥å›¾');
    }
}

// ä¿ç•™æ—§çš„ scrollToTask å‡½æ•°ä»¥ä¿æŒå‘åå…¼å®¹æ€§
function scrollToTask(taskId) {
    // è°ƒç”¨ ThumbnailNav ç»„ä»¶çš„æ–¹æ³•
    if (typeof ThumbnailNav !== 'undefined' && ThumbnailNav.scrollToTaskByTaskId) {
        ThumbnailNav.scrollToTaskByTaskId(taskId);
    } else {
        console.warn('ThumbnailNav ç»„ä»¶æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ»šåŠ¨åˆ°æŒ‡å®šä»»åŠ¡');
    }
}
</script>
{% endblock %}
