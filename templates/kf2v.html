{% extends "base.html" %}

{% block title %}é€šä¹‰ä¸‡ç›¸ - é¦–å°¾å¸§ç”Ÿè§†é¢‘{% endblock %}

{% block extra_css %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
{% endblock %}

{% block body %}
<div class="workspace-container">
    <div class="workspace-header">
        <h1>ğŸ¬ é€šä¹‰ä¸‡ç›¸é¦–å°¾å¸§ç”Ÿè§†é¢‘</h1>
        <div>
            <button class="btn btn-secondary" onclick="window.location.href='/assets'" style="margin-right: 10px;">ğŸ“ èµ„äº§åº“</button>
            <button class="btn btn-secondary" onclick="window.location.href='/workspace'" style="margin-right: 10px;">å›¾ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2video'" style="margin-right: 10px;">æ–‡ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary active" style="margin-right: 10px;">é¦–å°¾å¸§ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/reference2video'" style="margin-right: 10px;">å‚è€ƒç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2image'" style="margin-right: 10px;">æ–‡ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/image2image'" style="margin-right: 10px;">å›¾ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/voice-clone'" style="margin-right: 10px;">è¯­éŸ³å¤åˆ»</button>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </div>
    </div>
    
    <div class="workspace-content">
        <!-- å·¦ä¾§ï¼šåˆ›å»ºä»»åŠ¡ -->
        <div class="create-panel">
            <h2>åˆ›å»ºæ–°ä»»åŠ¡</h2>
            
            <div class="form-section">
                <!-- é¦–å¸§ä¸Šä¼  -->
                <div class="form-group">
                    <label>é¦–å¸§å›¾ç‰‡ï¼ˆå¿…å¡«ï¼‰</label>
                    <div class="upload-area" id="firstFrameArea">
                        <input type="file" id="firstFrameInput" accept="image/*" style="display: none;">
                        <div class="upload-placeholder" id="firstFramePlaceholder">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ é¦–å¸§</p>
                            <small>æ”¯æŒ JPGã€PNGã€BMPã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MB</small>
                        </div>
                        <img id="firstFramePreview" style="display: none;">
                    </div>
                    <div class="upload-actions" style="margin-top: 8px; text-align: center;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="openAssetPicker({ title: 'é€‰æ‹©é¦–å¸§å›¾ç‰‡', targetType: 'kf2v', onSelect: (r) => handleAssetSelectForFrame(r, 'first') })">
                            ğŸ“ ä»èµ„äº§åº“é€‰æ‹©
                        </button>
                    </div>
                </div>
                
                <!-- å°¾å¸§ä¸Šä¼  -->
                <div class="form-group">
                    <label>å°¾å¸§å›¾ç‰‡ï¼ˆå¿…å¡«ï¼‰</label>
                    <div class="upload-area" id="lastFrameArea">
                        <input type="file" id="lastFrameInput" accept="image/*" style="display: none;">
                        <div class="upload-placeholder" id="lastFramePlaceholder">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å°¾å¸§</p>
                            <small>æ”¯æŒ JPGã€PNGã€BMPã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MB</small>
                        </div>
                        <img id="lastFramePreview" style="display: none;">
                    </div>
                    <div class="upload-actions" style="margin-top: 8px; text-align: center;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="openAssetPicker({ title: 'é€‰æ‹©å°¾å¸§å›¾ç‰‡', targetType: 'kf2v', onSelect: (r) => handleAssetSelectForFrame(r, 'last') })">
                            ğŸ“ ä»èµ„äº§åº“é€‰æ‹©
                        </button>
                    </div>
                </div>
                
                <!-- æç¤ºè¯ -->
                <div class="form-group">
                    <label>æç¤ºè¯ï¼ˆå¿…å¡«ï¼‰</label>
                    <textarea id="prompt" rows="4" placeholder="æè¿°è§†é¢‘å†…å®¹å’Œé•œå¤´è¿åŠ¨ï¼Œä¾‹å¦‚ï¼šå†™å®é£æ ¼ï¼Œä¸€åªé»‘è‰²å°çŒ«å¥½å¥‡åœ°çœ‹å‘å¤©ç©ºï¼Œé•œå¤´ä»å¹³è§†é€æ¸ä¸Šå‡ï¼Œæœ€åä¿¯æ‹å®ƒçš„å¥½å¥‡çš„çœ¼ç¥ã€‚"></textarea>
                </div>
                
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ¨¡å‹é€‰æ‹©</label>
                        <select id="model">
                            <option value="wan2.2-kf2v-flash">wan2.2-kf2v-flash (æ¨èï¼Œæé€Ÿç‰ˆ)</option>
                            <option value="wanx2.1-kf2v-plus">wanx2.1-kf2v-plus (ä¸“ä¸šç‰ˆ)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>åˆ†è¾¨ç‡</label>
                        <select id="resolution">
                            <option value="480P">480P</option>
                            <option value="720P">720P</option>
                            <option value="1080P">1080P</option>
                        </select>
                    </div>
                </div>
                
                <!-- åå‘æç¤ºè¯ -->
                <div class="form-group">
                    <label>åå‘æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="negativePrompt" placeholder="ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹...">
                </div>
                
                <div class="form-group">
                    <label>æ‰¹é‡ç”Ÿæˆæ•°é‡</label>
                    <select id="batchCount">
                        <option value="1" selected>1ä¸ªè§†é¢‘ï¼ˆæ¨èï¼‰</option>
                        <option value="2">2ä¸ªè§†é¢‘</option>
                        <option value="3">3ä¸ªè§†é¢‘</option>
                        <option value="4">4ä¸ªè§†é¢‘ï¼ˆæœ€å¤šï¼‰</option>
                    </select>
                    <small>ä¸€æ¬¡ç”Ÿæˆå¤šä¸ªç›¸åŒå‚æ•°çš„è§†é¢‘ï¼Œå¯ä»ä¸­æŒ‘é€‰æœ€ä½³æ•ˆæœ</small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="promptExtend" checked>
                        å¯ç”¨æ™ºèƒ½æ”¹å†™
                    </label>
                </div>
                
                <button class="btn btn-primary btn-large btn-generate" onclick="createKf2vTask()" id="createBtn">
                    <span class="btn-icon">âœ¨</span>
                    <span class="btn-text">å¼€å§‹ç”Ÿæˆ</span>
                </button>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šå†å²è®°å½• -->
        <div class="history-panel">
            <div class="history-header">
                <h2>å†å²è®°å½•</h2>
                <div class="history-actions">
                    <button class="btn btn-secondary btn-sm" onclick="toggleBatchMode()" id="batchModeBtn">
                        æ‰¹é‡é€‰æ‹©
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadSelected()" id="downloadBtn" style="display:none;">
                        ä¸‹è½½é€‰ä¸­ (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="saveSelectedToAssets()" id="saveToAssetBtn" style="display:none;">
                        ğŸ“ ä¿å­˜åˆ°èµ„äº§åº“
                    </button>
                </div>
            </div>
            <div class="history-panel-wrapper">
                <div class="task-list-container">
                    <div id="taskList" class="task-list">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <!-- å³ä¾§ç¼©ç•¥å›¾å¿«é€Ÿå¯¼èˆª -->
                <div class="thumbnail-nav" id="thumbnailNav">
                    <div class="thumbnail-nav-header">å¿«é€Ÿå¯¼èˆª (<span id="thumbNavCount">0</span>)</div>
                    <div class="thumbnail-nav-list" id="thumbnailNavList">
                        <div class="thumbnail-nav-empty">æš‚æ— å·²å®Œæˆ<br>çš„è§†é¢‘</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡æ”¾å¤§æµ®å±‚ -->
<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <div class="image-modal-content" onclick="event.stopPropagation()">
        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
        <img id="modalImage" alt="æ”¾å¤§å›¾ç‰‡">
    </div>
</div>

<!-- è§†é¢‘æ”¾å¤§æµ®å±‚ -->
<div class="video-modal" id="videoModal" onclick="closeVideoModal()">
    <div class="video-modal-content" onclick="event.stopPropagation()">
        <button class="video-modal-close" onclick="closeVideoModal()">&times;</button>
        <video id="modalVideo" controls autoplay></video>
    </div>
</div>

<!-- å›¾ç‰‡è£å‰ªæ¨¡æ€æ¡† -->
<div class="custom-cropper-modal" id="cropperModal">
    <div class="cropper-modal-content">
        <div class="cropper-toolbar">
            <h3>è£å‰ªå›¾ç‰‡</h3>
            <div class="aspect-ratio-group">
                <button class="aspect-ratio-btn" data-ratio="free">è‡ªå®šä¹‰</button>
                <button class="aspect-ratio-btn" data-ratio="16:9">16:9</button>
                <button class="aspect-ratio-btn" data-ratio="9:16">9:16</button>
                <button class="aspect-ratio-btn" data-ratio="4:3">4:3</button>
                <button class="aspect-ratio-btn" data-ratio="3:4">3:4</button>
                <button class="aspect-ratio-btn" data-ratio="1:1">1:1</button>
            </div>
        </div>
        <div class="cropper-container">
            <img id="cropperImage" src="" alt="å¾…è£å‰ªå›¾ç‰‡">
        </div>
        <div class="cropper-actions">
            <button class="btn btn-secondary" id="cropperCancelBtn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="cropperConfirmBtn">ç¡®è®¤è£å‰ª</button>
        </div>
    </div>
</div>

<style>
/* kf2v é¡µé¢ç‰¹æœ‰æ ·å¼ */
/* =================================
   ä¿®å¤åçš„è£å‰ªæ¨¡æ€æ¡†æ ·å¼
   ================================= */

/* 1. è‡ªå®šä¹‰å¼¹çª—å®¹å™¨ (å·²é‡å‘½åä»¥é¿å…å†²çª) */
.custom-cropper-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85); /* èƒŒæ™¯åŠ æ·±ï¼Œæ›´æ²‰æµ¸ */
    z-index: 10000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px); /* æ·»åŠ èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
}

.custom-cropper-modal.active {
    display: flex; /* JS åˆ‡æ¢ displayï¼Œä½†é…åˆ active ç±»ç®¡ç†æ›´å¥½ */
}

/* 2. å¼¹çª—ä¸»ä½“å†…å®¹å¡ç‰‡ */
.cropper-modal-content {
    background: #fff;
    border-radius: 12px;
    width: 90vw;
    max-width: 1100px;
    height: 85vh;
    max-height: 800px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

/* 3. é¡¶éƒ¨å·¥å…·æ  */
.cropper-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 25px;
    border-bottom: 1px solid #eee;
    background: #fff;
    z-index: 10;
}

.cropper-toolbar h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

/* 4. è£å‰ªå·¥ä½œåŒºå®¹å™¨ */
.cropper-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background-color: #2b2b2b; /* æ”¹ä¸ºæ·±è‰²èƒŒæ™¯ï¼Œçªå‡ºå›¾ç‰‡ */
    background-image: 
        linear-gradient(45deg, #333 25%, transparent 25%), 
        linear-gradient(-45deg, #333 25%, transparent 25%), 
        linear-gradient(45deg, transparent 75%, #333 75%), 
        linear-gradient(-45deg, transparent 75%, #333 75%);
    background-size: 20px 20px; /* æ·»åŠ æ·±è‰²æ£‹ç›˜æ ¼çº¹ç† */
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cropper-container img {
    max-width: 100%;
    max-height: 100%;
    display: block;
}

/* 5. åº•éƒ¨æ“ä½œæ  */
.cropper-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    padding: 15px 25px;
    border-top: 1px solid #eee;
    background: #fff;
    z-index: 10;
}

/* 6. çºµæ¨ªæ¯”æŒ‰é’®ç»„ */
.aspect-ratio-group {
    display: flex;
    gap: 8px;
    background: #f0f2f5;
    padding: 4px;
    border-radius: 8px;
}

.aspect-ratio-btn {
    padding: 6px 14px;
    border: none;
    background: transparent;
    color: #666;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
}

.aspect-ratio-btn:hover {
    background: rgba(0,0,0,0.05);
    color: #333;
}

.aspect-ratio-btn.active {
    background: white;
    color: #667eea;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    font-weight: 600;
}

/* =================================
   Cropper.js åº“æ ·å¼æ·±åº¦è¦†ç›– (ä¿®å¤æ“ä½œéš¾çš„é—®é¢˜)
   ================================= */

/* ä¿®å¤åº“å†…éƒ¨é®ç½© (å…³é”®ä¿®å¤ï¼šè¿™æ˜¯ä¹‹å‰çœ‹èµ·æ¥é€æ˜çš„åŸå› ) */
.cropper-modal {
    background-color: rgba(0, 0, 0, 0.65) !important; /* åŠ æ·±éé€‰ä¸­åŒºåŸŸçš„é»‘è‰² */
    opacity: 1 !important;
}

/* å¢å¼ºé€‰ä¸­æ¡†çš„è¾¹ç•Œ */
.cropper-view-box {
    outline: 2px solid #667eea !important;
    outline-offset: 0;
    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.35); /* é¢å¤–çš„è§†è§‰è¾…åŠ© */
}

/* è™šçº¿è¾…åŠ©çº¿ */
.cropper-dashed {
    border-color: rgba(255, 255, 255, 0.6) !important;
}

/* ä¸­å¿ƒåå­—çº¿ */
.cropper-center::before, 
.cropper-center::after {
    background-color: rgba(255, 255, 255, 0.8) !important;
}

/* æ”¾å¤§æ‹–æ‹½ç‚¹ï¼Œæ–¹ä¾¿é¼ æ ‡æ“ä½œ */
.cropper-point {
    width: 12px !important;
    height: 12px !important;
    background-color: #667eea !important;
    border-radius: 50%; /* åœ†å½¢æ‹–æ‹½ç‚¹ */
    opacity: 1 !important;
    border: 2px solid #fff !important;
    z-index: 1000 !important; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}

/* ç‰¹åˆ«æ”¾å¤§å››ä¸ªè§’çš„æ‹–æ‹½ç‚¹ */
.cropper-point.point-ne,
.cropper-point.point-nw,
.cropper-point.point-se,
.cropper-point.point-sw {
    width: 16px !important;
    height: 16px !important;
}

/* éšè—èƒŒæ™¯ç½‘æ ¼ (å¯é€‰ï¼Œå› ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰äº†å®¹å™¨èƒŒæ™¯) */
.cropper-bg {
    background: transparent !important;
}

/* å“åº”å¼é€‚é… */
@media (max-width: 768px) {
    .cropper-modal-content {
        width: 95vw;
    }
    
    .aspect-ratio-group {
        flex-wrap: wrap;
    }
    
    .aspect-ratio-btn {
        flex: 1;
        min-width: 60px;
    }
}

@media (max-width: 480px) {
    .cropper-modal-content {
        height: 95vh;
    }
    
    .cropper-toolbar {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .aspect-ratio-group {
        width: 100%;
    }
}

/* æ‰¹é‡ä»»åŠ¡IDæ˜¾ç¤ºæ ·å¼ */
.batch-task-ids {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 8px;
}

.batch-task-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 8px;
    border-radius: 6px;
    transition: background 0.15s;
}

.batch-task-row:hover {
    background: #f0f2ff;
}

.batch-task-row .task-index {
    font-size: 11px;
    font-weight: 600;
    color: #667eea;
    min-width: 24px;
}

.batch-task-row .task-id {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 11px;
    color: #555;
    cursor: pointer;
    padding: 2px 6px;
    background: #fff;
    border: 1px solid #e0e4ff;
    border-radius: 4px;
    transition: all 0.2s;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.batch-task-row .task-id:hover {
    background: #667eea;
    color: #fff;
    border-color: #667eea;
}

.batch-task-row .task-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    min-width: 50px;
    text-align: center;
}

/* é¦–å°¾å¸§å¹¶è¡Œæ˜¾ç¤ºæ ·å¼ */
.kf2v-frames-container {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
}

.kf2v-frame-item {
    flex: 1;
    max-width: 150px;
    text-align: center;
}

.kf2v-frame-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 6px;
    font-weight: 500;
}

.kf2v-frame-image {
    width: 100%;
    max-width: 150px;
    max-height: 150px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid #e0e0e0;
}

.kf2v-frame-image:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
</style>

<!-- Cropper.js åº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<!-- å›¾ç‰‡è£å‰ªæ¨¡å— -->
<script src="/static/image-cropper.js"></script>
<!-- æ‰¹é‡è§†é¢‘å¤„ç†è„šæœ¬ -->
<script src="/static/batch-video.js"></script>
<!-- èµ„äº§é€‰æ‹©å™¨ -->
<script src="/static/asset-picker.js"></script>
<!-- ç¼©ç•¥å›¾å¯¼èˆªç»„ä»¶ -->
<script src="/static/thumbnail-nav.js"></script>
<script>
// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
let currentFirstFrameFilename = null;
let currentLastFrameFilename = null;
let kf2vPollingIntervals = new Map();
let batchModeEnabled = false;
let selectedVideos = new Set();

// èµ„äº§åº“é€‰æ‹©å›è°ƒ - é¦–å°¾å¸§
 function handleAssetSelectForFrame(result, frameType) {
    if (result && result.filename && result.url) {
        if (frameType === 'first') {
            currentFirstFrameFilename = result.filename;
            const preview = document.getElementById('firstFramePreview');
            const placeholder = document.getElementById('firstFramePlaceholder');
            preview.src = result.url;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
            showAlert('å·²é€‰æ‹©é¦–å¸§å›¾ç‰‡', 'success');
        } else {
            currentLastFrameFilename = result.filename;
            const preview = document.getElementById('lastFramePreview');
            const placeholder = document.getElementById('lastFramePlaceholder');
            preview.src = result.url;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
            showAlert('å·²é€‰æ‹©å°¾å¸§å›¾ç‰‡', 'success');
        }
    }
}

// è§†é¢‘æ‡’åŠ è½½Intersection Observer
let videoObserver = null;

// ç”¨äºé˜²æ­¢é¢‘ç¹åˆ·æ–°çš„èŠ‚æµæ§åˆ¶
let pendingRefresh = false;
let lastRefreshTime = 0;
const REFRESH_THROTTLE_MS = 2000;

// ç¼“å­˜ä»»åŠ¡çŠ¶æ€
let taskStatusCache = new Map();

// åˆ†é¡µåŠ è½½çŠ¶æ€
let currentPage = 1;
let hasMoreTasks = true;
let isLoadingMore = false;
const TASKS_PER_PAGE = 10;
let loadedTaskIds = new Set();

// åˆå§‹åŒ–è§†é¢‘æ‡’åŠ è½½Observer
function initVideoLazyLoad() {
    if (videoObserver) {
        videoObserver.disconnect();
    }
    
    videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const video = entry.target;
                const dataSrc = video.getAttribute('data-src');
                if (dataSrc && video.src !== dataSrc) {
                    video.src = dataSrc;
                    video.load();
                    video.removeAttribute('data-src');
                }
                videoObserver.unobserve(video);
            }
        });
    }, {
        rootMargin: '100px',
        threshold: 0.1
    });
}

// è§‚å¯Ÿæ‰€æœ‰æ‡’åŠ è½½è§†é¢‘
function observeLazyVideos() {
    if (!videoObserver) {
        initVideoLazyLoad();
    }
    document.querySelectorAll('video[data-src]').forEach(video => {
        videoObserver.observe(video);
    });
}

// é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
window.addEventListener('load', function() {
    initVideoLazyLoad();
    initInfiniteScroll();
    loadKf2vTasks();
    
    // åˆå§‹åŒ–ç¼©ç•¥å›¾å¯¼èˆª
    ThumbnailNav.init({
        apiEndpoint: '/api/kf2v-thumbnails',
        mediaType: 'video',
        itemsPerPage: 50,
        enableBatchSupport: true
    });
});

// åˆå§‹åŒ–æ— é™æ»šåŠ¨
function initInfiniteScroll() {
    const taskList = document.getElementById('taskList');
    
    if (taskList) {
        taskList.addEventListener('scroll', function() {
            const scrollTop = taskList.scrollTop;
            const scrollHeight = taskList.scrollHeight;
            const clientHeight = taskList.clientHeight;
            const distanceToBottom = scrollHeight - scrollTop - clientHeight;
            
            if (distanceToBottom < 300 && hasMoreTasks && !isLoadingMore) {
                console.log('[DEBUG] è§¦å‘åŠ è½½æ›´å¤š KF2Vï¼Œè·ç¦»åº•éƒ¨:', distanceToBottom);
                loadMoreKf2vTasks();
            }
        });
        console.log('[DEBUG] KF2V æ— é™æ»šåŠ¨å·²åˆå§‹åŒ–');
    }
}

// åŠ è½½æ›´å¤šä»»åŠ¡
async function loadMoreKf2vTasks() {
    if (isLoadingMore || !hasMoreTasks) {
        console.log('[DEBUG] KF2V è·³è¿‡åŠ è½½: isLoadingMore=', isLoadingMore, 'hasMoreTasks=', hasMoreTasks);
        return;
    }
    
    isLoadingMore = true;
    currentPage++;
    
    console.log('[DEBUG] KF2V å¼€å§‹åŠ è½½ç¬¬', currentPage, 'é¡µ');
    
    try {
        const response = await fetch(`/api/kf2v-tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        console.log('[DEBUG] KF2V åŠ è½½ç»“æœ: success=', data.success, 'tasks=', data.tasks?.length, 'has_more=', data.has_more);
        
        if (data.success && data.tasks && data.tasks.length > 0) {
            appendKf2vTasks(data.tasks);
            hasMoreTasks = data.has_more;
            
            setTimeout(() => {
                observeLazyVideos();
            }, 100);
            
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startKf2vPolling(task.task_id);
                }
            });
        } else {
            hasMoreTasks = false;
        }
    } catch (error) {
        console.error('åŠ è½½æ›´å¤šä»»åŠ¡å¤±è´¥:', error);
        currentPage--;
    } finally {
        isLoadingMore = false;
    }
}

// å›¾ç‰‡ä¸Šä¼  - é¦–å¸§
const firstFrameArea = document.getElementById('firstFrameArea');
const firstFrameInput = document.getElementById('firstFrameInput');
const firstFramePreview = document.getElementById('firstFramePreview');
const firstFramePlaceholder = document.getElementById('firstFramePlaceholder');

firstFrameArea.addEventListener('click', () => firstFrameInput.click());

firstFrameArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    firstFrameArea.classList.add('dragover');
});

firstFrameArea.addEventListener('dragleave', () => {
    firstFrameArea.classList.remove('dragover');
});

firstFrameArea.addEventListener('drop', (e) => {
    e.preventDefault();
    firstFrameArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) {
        // æ‰“å¼€è£å‰ªç•Œé¢
        window.imageCropper.open(file, (croppedFile) => handleFrameUpload(croppedFile, 'first'));
    }
});

firstFrameInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        // æ‰“å¼€è£å‰ªç•Œé¢
        window.imageCropper.open(file, (croppedFile) => handleFrameUpload(croppedFile, 'first'));
    }
});

// å›¾ç‰‡ä¸Šä¼  - å°¾å¸§
const lastFrameArea = document.getElementById('lastFrameArea');
const lastFrameInput = document.getElementById('lastFrameInput');
const lastFramePreview = document.getElementById('lastFramePreview');
const lastFramePlaceholder = document.getElementById('lastFramePlaceholder');

lastFrameArea.addEventListener('click', () => lastFrameInput.click());

lastFrameArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    lastFrameArea.classList.add('dragover');
});

lastFrameArea.addEventListener('dragleave', () => {
    lastFrameArea.classList.remove('dragover');
});

lastFrameArea.addEventListener('drop', (e) => {
    e.preventDefault();
    lastFrameArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) {
        // æ‰“å¼€è£å‰ªç•Œé¢
        window.imageCropper.open(file, (croppedFile) => handleFrameUpload(croppedFile, 'last'));
    }
});

lastFrameInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        // æ‰“å¼€è£å‰ªç•Œé¢
        window.imageCropper.open(file, (croppedFile) => handleFrameUpload(croppedFile, 'last'));
    }
});

// å¤„ç†å›¾ç‰‡ä¸Šä¼ 
async function handleFrameUpload(file, frameType) {
    console.log('å¼€å§‹ä¸Šä¼ å›¾ç‰‡:', frameType, file.name, file.type, file.size);
    const formData = new FormData();
    formData.append('image', file);
    formData.append('frame_type', frameType);
    
    try {
        const response = await fetch('/api/upload-kf2v-image', {
            method: 'POST',
            body: formData
        });
        
        console.log('å“åº”çŠ¶æ€:', response.status);
        const data = await response.json();
        console.log('å“åº”æ•°æ®:', data);
        
        if (data.success) {
            if (frameType === 'first') {
                currentFirstFrameFilename = data.filename;
                const reader = new FileReader();
                reader.onload = (e) => {
                    firstFramePreview.src = e.target.result;
                    firstFramePreview.style.display = 'block';
                    firstFramePlaceholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                currentLastFrameFilename = data.filename;
                const reader = new FileReader();
                reader.onload = (e) => {
                    lastFramePreview.src = e.target.result;
                    lastFramePreview.style.display = 'block';
                    lastFramePlaceholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
            
            showAlert(`${frameType === 'first' ? 'é¦–å¸§' : 'å°¾å¸§'}å›¾ç‰‡ä¸Šä¼ æˆåŠŸ`, 'success');
        } else {
            showAlert(data.message || 'ä¸Šä¼ å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('ä¸Šä¼ é”™è¯¯:', error);
        showAlert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
    }
}

// åˆ›å»ºé¦–å°¾å¸§ä»»åŠ¡
async function createKf2vTask() {
    // éªŒè¯é¦–å¸§
    if (!currentFirstFrameFilename) {
        showAlert('è¯·å…ˆä¸Šä¼ é¦–å¸§å›¾ç‰‡', 'error');
        return;
    }
    
    // éªŒè¯å°¾å¸§
    if (!currentLastFrameFilename) {
        showAlert('è¯·å…ˆä¸Šä¼ å°¾å¸§å›¾ç‰‡', 'error');
        return;
    }
    
    // éªŒè¯æç¤ºè¯
    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt) {
        showAlert('è¯·è¾“å…¥æç¤ºè¯', 'error');
        return;
    }
    
    const requestBody = {
        first_frame_filename: currentFirstFrameFilename,
        last_frame_filename: currentLastFrameFilename,
        prompt: prompt,
        model: document.getElementById('model').value,
        resolution: document.getElementById('resolution').value,
        negative_prompt: document.getElementById('negativePrompt').value,
        prompt_extend: document.getElementById('promptExtend').checked,
        batch_count: parseInt(document.getElementById('batchCount').value)
    };
    
    const btn = document.getElementById('createBtn');
    const btnIcon = btn.querySelector('.btn-icon');
    const btnText = btn.querySelector('.btn-text');
    
    btn.disabled = true;
    btnIcon.textContent = 'â³';
    btnText.textContent = 'åˆ›å»ºä¸­...';
    
    try {
        const response = await fetch('/api/create-kf2v-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œè¾“å…¥å·²ä¿ç•™ä¾›ç»§ç»­ä½¿ç”¨', 'success');
            
            // ä¿ç•™è¾“å…¥å†…å®¹ï¼Œæ–¹ä¾¿ç”¨æˆ·åŸºäºç›¸åŒå‚æ•°å¤šæ¬¡ç”Ÿæˆ
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
            loadKf2vTasks();
            
            // ä¸ºæ‰¹é‡ä»»åŠ¡å¼€å§‹è½®è¯¢
            if (data.tasks) {
                data.tasks.forEach(task => {
                    startKf2vPolling(task.task_id);
                });
            }
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btnIcon.textContent = 'âœ¨';
        btnText.textContent = 'å¼€å§‹ç”Ÿæˆ';   
    }
}

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
async function loadKf2vTasks(reset = true) {
    try {
        // é‡ç½®åˆ†é¡µçŠ¶æ€
        if (reset) {
            currentPage = 1;
            hasMoreTasks = true;
            loadedTaskIds.clear();
        }
        
        const response = await fetch(`/api/kf2v-tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        if (data.success) {
            if (reset) {
                renderKf2vTasks(data.tasks);
            } else {
                appendKf2vTasks(data.tasks);
            }
            
            hasMoreTasks = data.has_more;
            
            // æ¸²æŸ“åå¯ç”¨æ‡’åŠ è½½
            setTimeout(() => {
                observeLazyVideos();
            }, 100);
            
            // æ›´æ–°ç¼©ç•¥å›¾å¯¼èˆª
            updateThumbnailNav();
            
            // ä¸ºè¿›è¡Œä¸­çš„ä»»åŠ¡å¯åŠ¨è½®è¯¢
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startKf2vPolling(task.task_id);
                }
            });
        }
    } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
    }
}

// æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
function renderKf2vTasks(tasks) {
    const taskList = document.getElementById('taskList');
    
    if (tasks.length === 0) {
        taskList.innerHTML = '<div class="loading">æš‚æ— å†å²è®°å½•</div>';
        return;
    }
    
    // è®°å½•å·²åŠ è½½çš„ä»»åŠ¡ID
    tasks.forEach(t => loadedTaskIds.add(t.task_id));
    
    // æŒ‰batch_idåˆ†ç»„
    const batchGroups = groupKf2vTasksByBatch(tasks);
    
    taskList.innerHTML = renderKf2vTaskGroups(batchGroups);
}

// è¿½åŠ ä»»åŠ¡
function appendKf2vTasks(tasks) {
    const taskList = document.getElementById('taskList');
    
    // è¿‡æ»¤å·²åŠ è½½çš„ä»»åŠ¡
    const newTasks = tasks.filter(t => !loadedTaskIds.has(t.task_id));
    if (newTasks.length === 0) return;
    
    // è®°å½•æ–°åŠ è½½çš„ä»»åŠ¡ID
    newTasks.forEach(t => loadedTaskIds.add(t.task_id));
    
    // æŒ‰batch_idåˆ†ç»„
    const batchGroups = groupKf2vTasksByBatch(newTasks);
    
    // è¿½åŠ åˆ°åˆ—è¡¨
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = renderKf2vTaskGroups(batchGroups);
    
    while (tempDiv.firstChild) {
        taskList.appendChild(tempDiv.firstChild);
    }
}

// æŒ‰batch_idåˆ†ç»„ä»»åŠ¡
function groupKf2vTasksByBatch(tasks) {
    const batchGroups = {};
    tasks.forEach(task => {
        const batchId = task.batch_id || task.task_id;
        if (!batchGroups[batchId]) {
            batchGroups[batchId] = [];
        }
        batchGroups[batchId].push(task);
    });
    return batchGroups;
}

// æ¸²æŸ“ä»»åŠ¡åˆ†ç»„ä¸ºHTML
function renderKf2vTaskGroups(batchGroups) {
    let html = '';
    Object.keys(batchGroups).forEach(batchId => {
        const groupTasks = batchGroups[batchId];
        const firstTask = groupTasks[0];
        const isBatch = groupTasks.length > 1;
        
        html += `<div class="task-item" id="task-${firstTask.task_id}" data-batch-id="${batchId}">`;
        
        // ä»»åŠ¡å¤´éƒ¨ - æ˜¾ç¤ºæ‰€æœ‰task_id
        html += '<div class="task-header">';
        html += '<div class="batch-task-ids">';
        groupTasks.forEach((task, idx) => {
            const statusClass = `status-${(task.task_status || 'PENDING').toLowerCase()}`;
            const statusText = getStatusText(task.task_status || 'PENDING');
            html += `<div class="batch-task-row">`;
            html += `<span class="task-index">#${idx + 1}</span>`;
            html += `<span class="task-id" onclick="copyToClipboard('${task.task_id}')" title="ç‚¹å‡»å¤åˆ¶">${task.task_id}</span>`;
            html += `<span class="task-status ${statusClass}">${statusText}</span>`;
            html += '</div>';
        });
        html += '</div>';
        html += '<div class="task-actions">';
        html += `<button class="btn btn-secondary btn-sm icon-only" onclick="event.stopPropagation(); regenerateKf2vTask('${firstTask.task_id}')" title="ä½¿ç”¨ç›¸åŒé…ç½®é‡æ–°ç”Ÿæˆ">ğŸ”„</button>`;
        html += '</div>';
        html += '</div>';
        
        // ä»»åŠ¡å†…å®¹
        html += '<div class="task-content">';
        
        // é¦–å°¾å¸§å¹¶è¡Œæ˜¾ç¤º
        if (firstTask.first_frame_url || firstTask.last_frame_url) {
            html += '<div class="kf2v-frames-container">';
            
            // é¦–å¸§
            if (firstTask.first_frame_url) {
                html += '<div class="kf2v-frame-item">';
                html += '<div class="kf2v-frame-label">é¦–å¸§</div>';
                html += `<img src="${firstTask.first_frame_url}" class="kf2v-frame-image" alt="é¦–å¸§" onclick="openImageModal('${firstTask.first_frame_url}')">`;
                html += '</div>';
            }
            
            // å°¾å¸§
            if (firstTask.last_frame_url) {
                html += '<div class="kf2v-frame-item">';
                html += '<div class="kf2v-frame-label">å°¾å¸§</div>';
                html += `<img src="${firstTask.last_frame_url}" class="kf2v-frame-image" alt="å°¾å¸§" onclick="openImageModal('${firstTask.last_frame_url}')">`;
                html += '</div>';
            }
            
            html += '</div>';
        }
        
        // ä»»åŠ¡ä¿¡æ¯
        html += '<div class="task-info">';
        html += `<p><strong>æ¨¡å‹:</strong> ${firstTask.model}</p>`;
        html += `<p><strong>åˆ†è¾¨ç‡:</strong> ${firstTask.resolution}</p>`;
        
        if (firstTask.prompt) {
            html += `<p><strong>æç¤ºè¯:</strong> ${firstTask.prompt}</p>`;
        }
        
        if (firstTask.created_at) {
            html += `<p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(firstTask.created_at).toLocaleString('zh-CN')}</p>`;
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (firstTask.task_status === 'FAILED' && firstTask.message) {
            html += `<div class="error-message">âš  é”™è¯¯ä¿¡æ¯: ${firstTask.message}</div>`;
        }
        
        html += '</div>';
        html += '</div>';
        
        // è§†é¢‘ç½‘æ ¼ï¼ˆæ‰¹é‡æˆ–å•ä¸ªï¼‰
        const succeededTasks = groupTasks.filter(t => t.task_status === 'SUCCEEDED' && t.local_video_path);
        if (succeededTasks.length > 0) {
            html += '<div class="video-grid" style="margin-top: 15px;">';
            succeededTasks.forEach((task, index) => {
                const videoId = `${task.task_id}_${index}`;
                const clickHandler = batchModeEnabled ? `toggleVideoSelection('${videoId}')` : `openVideoModal('${task.local_video_path}')`;
                const thumbnailClass = batchModeEnabled ? 'video-thumbnail batch-mode' : 'video-thumbnail';
                
                html += `<div class="${thumbnailClass}" id="video-${videoId}" onclick="${clickHandler}">`;
                
                // æ‰¹é‡æ¨¡å¼ä¸‹æ˜¾ç¤ºå¤é€‰æ¡†
                if (batchModeEnabled) {
                    const isChecked = selectedVideos.has(videoId) ? 'checked' : '';
                    html += `<input type="checkbox" 
                                    class="batch-checkbox" 
                                    data-video-id="${videoId}" 
                                    data-video-url="${task.local_video_path}"
                                    ${isChecked}
                                    onclick="event.stopPropagation(); toggleVideoCheckbox('${videoId}');">`;
                }
                
                html += `<div class="video-index">${isBatch ? index + 1 : ''}</div>`;
                const posterUrl = `/api/video-poster/{{ session.get('api_key_hash', '') }}/${task.task_id}`;
                html += `<img class="video-poster-img" src="${posterUrl}" alt="è§†é¢‘å°é¢" loading="lazy">`;
                html += '</div>';
            });
            html += '</div>';
        }
        
        html += '</div>';
    });
    
    return html;
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        'PENDING': 'ç­‰å¾…ä¸­',
        'RUNNING': 'å¤„ç†ä¸­',
        'SUCCEEDED': 'æˆåŠŸ',
        'FAILED': 'å¤±è´¥'
    };
    return statusMap[status] || status;
}

// å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
function startKf2vPolling(taskId) {
    if (kf2vPollingIntervals.has(taskId)) {
        return;
    }
    
    let consecutiveFailures = 0;  // è¿ç»­å¤±è´¥è®¡æ•°
    const MAX_FAILURES = 3;  // æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°
    
    const intervalId = setInterval(async () => {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);  // 8ç§’è¶…æ—¶
            
            const response = await fetch(`/api/kf2v-task/${taskId}`, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            const data = await response.json();
            
            if (data.success && data.task) {
                consecutiveFailures = 0;  // æˆåŠŸåé‡ç½®å¤±è´¥è®¡æ•°
                const task = data.task;
                const status = task.task_status;
                const oldStatus = taskStatusCache.get(taskId);
                
                // åªæœ‰çŠ¶æ€å˜åŒ–æ—¶æ‰æ›´æ–°UI
                if (oldStatus !== status) {
                    taskStatusCache.set(taskId, status);
                    updateKf2vTaskStatus(taskId, task);
                }
                
                // å¦‚æœä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢
                if (status === 'SUCCEEDED' || status === 'FAILED') {
                    clearInterval(intervalId);
                    kf2vPollingIntervals.delete(taskId);
                    
                    // ä»»åŠ¡å®Œæˆæ—¶æ‰åˆ·æ–°åˆ—è¡¨
                    throttledRefresh();
                }
            } else {
                consecutiveFailures++;
                if (consecutiveFailures >= MAX_FAILURES) {
                    console.error(`ä»»åŠ¡ ${taskId} è¿ç»­æŸ¥è¯¢å¤±è´¥ ${MAX_FAILURES} æ¬¡ï¼Œåœæ­¢è½®è¯¢`);
                    clearInterval(intervalId);
                    kf2vPollingIntervals.delete(taskId);
                    
                    // åœ¨UIä¸Šæ ‡è®°ä¸ºæŸ¥è¯¢å¤±è´¥
                    const taskElement = document.getElementById(`task-${taskId}`);
                    if (taskElement) {
                        const statusSpan = taskElement.querySelector('.task-status');
                        if (statusSpan) {
                            statusSpan.className = 'task-status status-failed';
                            statusSpan.textContent = 'æŸ¥è¯¢å¤±è´¥';
                        }
                    }
                }
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error('æŸ¥è¯¢ä»»åŠ¡è¶…æ—¶:', taskId);
            } else {
                console.error('è½®è¯¢ä»»åŠ¡å¤±è´¥:', error);
            }
            
            consecutiveFailures++;
            if (consecutiveFailures >= MAX_FAILURES) {
                console.error(`ä»»åŠ¡ ${taskId} è¿ç»­æŸ¥è¯¢å¤±è´¥ ${MAX_FAILURES} æ¬¡ï¼Œåœæ­¢è½®è¯¢`);
                clearInterval(intervalId);
                kf2vPollingIntervals.delete(taskId);
                
                // åœ¨UIä¸Šæ ‡è®°ä¸ºæŸ¥è¯¢å¤±è´¥
                const taskElement = document.getElementById(`task-${taskId}`);
                if (taskElement) {
                    const statusSpan = taskElement.querySelector('.task-status');
                    if (statusSpan) {
                        statusSpan.className = 'task-status status-failed';
                        statusSpan.textContent = 'æŸ¥è¯¢å¤±è´¥';
                    }
                }
            }
        }
    }, 5000); // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
    
    kf2vPollingIntervals.set(taskId, intervalId);
}

// å¢é‡æ›´æ–°å•ä¸ªä»»åŠ¡çŠ¶æ€
function updateKf2vTaskStatus(taskId, task) {
    const taskItem = document.getElementById(`task-${taskId}`);
    if (!taskItem) return;
    
    const statusSpan = taskItem.querySelector('.task-status');
    if (statusSpan) {
        statusSpan.className = 'task-status';
        statusSpan.classList.add(`status-${(task.task_status || 'unknown').toLowerCase()}`);
        statusSpan.textContent = getStatusText(task.task_status);
    }
    
    if (task.task_status === 'FAILED' && task.message) {
        const taskContent = taskItem.querySelector('.task-content');
        if (taskContent && !taskContent.querySelector('.error-message')) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `âš  é”™è¯¯ä¿¡æ¯: ${task.message}`;
            taskContent.appendChild(errorDiv);
        }
    }
}

// èŠ‚æµåˆ·æ–°
function throttledRefresh() {
    const now = Date.now();
    
    if (now - lastRefreshTime < REFRESH_THROTTLE_MS) {
        if (!pendingRefresh) {
            pendingRefresh = true;
            setTimeout(() => {
                pendingRefresh = false;
                lastRefreshTime = Date.now();
                loadKf2vTasks();
            }, REFRESH_THROTTLE_MS - (now - lastRefreshTime));
        }
        return;
    }
    
    lastRefreshTime = now;
    loadKf2vTasks();
}

// å¤åˆ¶åˆ°å‰ªè´´æ¿
// ä½¿ç”¨common.jsä¸­çš„é€šç”¨å‡½æ•°:
// - copyToClipboard(text)
// - openVideoModal(videoUrl)
// - closeVideoModal()
// - logout()
// - showAlert(message, type)
// - getStatusText(status)

// batch-video.jsä¸­çš„æ‰¹é‡æ“ä½œå‡½æ•°:
// - toggleBatchMode()
// - downloadSelected()

// æ›´æ–°é€‰ä¸­æ•°é‡
function updateSelectedCount() {
    selectedVideos.clear();
    document.querySelectorAll('.batch-checkbox:checked').forEach(checkbox => {
        selectedVideos.add(checkbox.dataset.videoId || checkbox.dataset.taskId);
    });
    document.getElementById('selectedCount').textContent = selectedVideos.size;
}

// åˆ‡æ¢è§†é¢‘å¤é€‰æ¡†ï¼ˆç›´æ¥ç‚¹å‡»å¤é€‰æ¡†æ—¶ï¼‰
function toggleVideoCheckbox(videoId) {
    const checkbox = document.querySelector(`.batch-checkbox[data-video-id="${videoId}"]`);
    if (!checkbox) return;
    
    if (checkbox.checked) {
        selectedVideos.add(videoId);
    } else {
        selectedVideos.delete(videoId);
    }
    
    const thumbnail = document.getElementById(`video-${videoId}`);
    if (thumbnail) {
        if (checkbox.checked) {
            thumbnail.classList.add('selected');
        } else {
            thumbnail.classList.remove('selected');
        }
    }
    
    updateSelectedCount();
}

// åˆ‡æ¢è§†é¢‘é€‰æ‹©çŠ¶æ€ï¼ˆç‚¹å‡»è§†é¢‘ç¼©ç•¥å›¾æ—¶ï¼‰
function toggleVideoSelection(videoId) {
    const checkbox = document.querySelector(`.batch-checkbox[data-video-id="${videoId}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        
        if (checkbox.checked) {
            selectedVideos.add(videoId);
        } else {
            selectedVideos.delete(videoId);
        }
        
        const thumbnail = document.getElementById(`video-${videoId}`);
        if (thumbnail) {
            if (checkbox.checked) {
                thumbnail.classList.add('selected');
            } else {
                thumbnail.classList.remove('selected');
            }
        }
        
        updateSelectedCount();
    }
}

// ä¸‹è½½è§†é¢‘
function downloadVideo(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// é‡æ–°ç”Ÿæˆé¦–å°¾å¸§ç”Ÿè§†é¢‘ä»»åŠ¡
async function regenerateKf2vTask(taskId) {
    if (!taskId) {
        showAlert('æ— æ•ˆçš„ä»»åŠ¡ID', 'error');
        return;
    }
    
    try {
        showAlert('æ­£åœ¨é‡æ–°ç”Ÿæˆä»»åŠ¡...', 'info');
        
        const response = await fetch('/api/regenerate-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                task_id: taskId,
                task_type: 'kf2v'  // é¦–å°¾å¸§ç”Ÿè§†é¢‘ä»»åŠ¡
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡', 'success');
            
            // å¯åŠ¨æ–°ä»»åŠ¡çš„è½®è¯¢
            if (data.tasks && data.tasks.length > 0) {
                data.tasks.forEach(task => {
                    if (task.task_id) {
                        startKf2vPolling(task.task_id);
                    }
                });
            }
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°ä»»åŠ¡
            loadKf2vTasks();
        } else {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥:', error);
        showAlert('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
    }
}

// ä¸‹è½½é€‰ä¸­çš„è§†é¢‘
async function downloadSelected() {
    if (selectedVideos.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„è§†é¢‘', 'error');
        return;
    }
    
    showAlert(`å¼€å§‹ä¸‹è½½ ${selectedVideos.size} ä¸ªè§†é¢‘...`, 'success');
    
    let downloadCount = 0;
    for (const videoId of selectedVideos) {
        const checkbox = document.querySelector(`.batch-checkbox[data-video-id="${videoId}"]`);
        if (checkbox && checkbox.dataset.videoUrl) {
            const videoUrl = checkbox.dataset.videoUrl;
            downloadVideo(videoUrl, `video_${videoId}.mp4`);
            downloadCount++;
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }
    
    if (downloadCount > 0) {
        showAlert(`å·²å¯åŠ¨ ${downloadCount} ä¸ªè§†é¢‘ä¸‹è½½`, 'success');
    }
}

// ESCé”®å…³é—­æµ®å±‚
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeVideoModal();
        closeImageModal();
    }
});

// ========== ç¼©ç•¥å›¾å¿«é€Ÿå¯¼èˆªåŠŸèƒ½ ==========

let thumbNavCurrentPage = 1;
const THUMB_NAV_ITEMS_PER_PAGE = 8;
let allCompletedTasks = [];

function updateThumbnailNav() {
    const taskItems = document.querySelectorAll('.task-item');
    allCompletedTasks = [];
    
    taskItems.forEach((item, index) => {
        const taskId = item.id.replace('task-', '');
        const videoGrid = item.querySelector('.video-grid');
        
        if (videoGrid) {
            const thumbnails = videoGrid.querySelectorAll('.video-thumbnail');
            thumbnails.forEach((thumb, thumbIdx) => {
                const posterImg = thumb.querySelector('.video-poster-img');
                if (posterImg) {
                    allCompletedTasks.push({
                        taskId: taskId,
                        type: 'video',
                        posterUrl: posterImg.src,
                        index: index,
                        subIndex: thumbIdx
                    });
                }
            });
        }
    });
    
    renderThumbnailNavPage();
}

function renderThumbnailNavPage() {
    const navList = document.getElementById('thumbnailNavList');
    const pageInfo = document.getElementById('thumbPageInfo');
    const prevBtn = document.getElementById('thumbPrevBtn');
    const nextBtn = document.getElementById('thumbNextBtn');
    
    if (!navList) return;
    
    const totalItems = allCompletedTasks.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / THUMB_NAV_ITEMS_PER_PAGE));
    thumbNavCurrentPage = Math.max(1, Math.min(thumbNavCurrentPage, totalPages));
    
    if (totalItems === 0) {
        navList.innerHTML = '<div class="thumbnail-nav-empty">æš‚æ— å·²å®Œæˆ<br>çš„è§†é¢‘</div>';
        pageInfo.textContent = '0/0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }
    
    const startIdx = (thumbNavCurrentPage - 1) * THUMB_NAV_ITEMS_PER_PAGE;
    const endIdx = Math.min(startIdx + THUMB_NAV_ITEMS_PER_PAGE, totalItems);
    const pageItems = allCompletedTasks.slice(startIdx, endIdx);
    
    navList.innerHTML = pageItems.map((item, idx) => {
        const globalIdx = startIdx + idx + 1;
        return `
            <div class="thumbnail-nav-item" 
                 data-task-id="${item.taskId}"
                 onclick="scrollToTask('${item.taskId}')">
                <img src="${item.posterUrl}" alt="ç¼©ç•¥å›¾" loading="lazy">
                <span class="thumb-index">${globalIdx}</span>
                <span class="thumb-type">è§†é¢‘</span>
            </div>
        `;
    }).join('');
    
    pageInfo.textContent = `${thumbNavCurrentPage}/${totalPages}`;
    prevBtn.disabled = thumbNavCurrentPage <= 1;
    nextBtn.disabled = thumbNavCurrentPage >= totalPages;
}

function thumbNavPrevPage() {
    if (thumbNavCurrentPage > 1) {
        thumbNavCurrentPage--;
        renderThumbnailNavPage();
    }
}

function thumbNavNextPage() {
    const totalPages = Math.ceil(allCompletedTasks.length / THUMB_NAV_ITEMS_PER_PAGE);
    if (thumbNavCurrentPage < totalPages) {
        thumbNavCurrentPage++;
        renderThumbnailNavPage();
    }
}

function scrollToTask(taskId) {
    const taskItem = document.getElementById(`task-${taskId}`);
    if (taskItem) {
        taskItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        taskItem.style.transition = 'box-shadow 0.3s, transform 0.3s';
        taskItem.style.boxShadow = '0 0 0 3px #1664ff, 0 4px 12px rgba(22, 100, 255, 0.3)';
        taskItem.style.transform = 'scale(1.01)';
        setTimeout(() => {
            taskItem.style.boxShadow = '';
            taskItem.style.transform = '';
        }, 1500);
        
        document.querySelectorAll('.thumbnail-nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-task-id') === taskId) {
                item.classList.add('active');
            }
        });
    }
}

</script>
{% endblock %}
