{% extends "base.html" %}

{% block title %}é€šä¹‰ä¸‡ç›¸ - æ–‡ç”Ÿå›¾{% endblock %}

{% block body %}
<div class="workspace-container">
    <div class="workspace-header">
        <h1>ğŸ¨ é€šä¹‰ä¸‡ç›¸æ–‡ç”Ÿå›¾</h1>
        <div>
            <button class="btn btn-secondary" onclick="window.location.href='/assets'" style="margin-right: 10px;">ğŸ“ èµ„äº§åº“</button>
            <button class="btn btn-secondary" onclick="window.location.href='/workspace'" style="margin-right: 10px;">å›¾ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2video'" style="margin-right: 10px;">æ–‡ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/kf2v'" style="margin-right: 10px;">é¦–å°¾å¸§ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/reference2video'" style="margin-right: 10px;">å‚è€ƒç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary active" style="margin-right: 10px;">æ–‡ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/image2image'" style="margin-right: 10px;">å›¾ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/voice-clone'" style="margin-right: 10px;">è¯­éŸ³å¤åˆ»</button>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </div>
    </div>
    
    <div class="workspace-content">
        <!-- å·¦ä¾§ï¼šåˆ›å»ºä»»åŠ¡ -->
        <div class="create-panel">
            <h2>åˆ›å»ºæ–°ä»»åŠ¡</h2>
            
            <div class="form-section">
                <div class="form-group">
                    <div class="prompt-label-wrapper">
                        <label>æç¤ºè¯ï¼ˆå¿…å¡«ï¼‰</label>
                        <button type="button" class="btn-optimize" onclick="openOptimizeModal()">
                            <span class="icon">âœ¨</span>
                            <span>æç¤ºè¯ä¼˜åŒ–</span>
                        </button>
                    </div>
                    <textarea id="prompt" rows="6" placeholder="æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡å†…å®¹ï¼Œä¾‹å¦‚ï¼šä¸€é—´æœ‰ç€ç²¾è‡´çª—æˆ·çš„èŠ±åº—ï¼Œæ¼‚äº®çš„æœ¨è´¨é—¨ï¼Œæ‘†æ”¾ç€èŠ±æœµ"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ¨¡å‹é€‰æ‹©</label>
                        <select id="model" onchange="updateSizeOptions()">
                            <option value="wan2.6-t2i">wan2.6-t2i (æœ€æ–°æ¨è)</option>
                            <option value="z-image-turbo">z-image-turbo (è½»é‡çº§å¿«é€Ÿç”Ÿå›¾)</option>
                            <option value="wan2.5-t2i-preview">wan2.5-t2i-preview</option>
                            <option value="qwen-image-plus">qwen-image-plus (é€šä¹‰åƒé—®)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å›¾ç‰‡å°ºå¯¸</label>
                        <select id="size">
                            <!-- åŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="batchCountGroup">
                    <label>ç”Ÿæˆæ•°é‡</label>
                    <select id="batchCount">
                        <option value="1" selected>1å¼ å›¾ç‰‡</option>
                        <option value="2">2å¼ å›¾ç‰‡</option>
                        <option value="3">3å¼ å›¾ç‰‡</option>
                        <option value="4">4å¼ å›¾ç‰‡ï¼ˆæœ€å¤šï¼‰</option>
                    </select>
                    <small id="batchCountHint">ä¸€æ¬¡ç”Ÿæˆå¤šå¼ å›¾ç‰‡ï¼Œå¯ä»ä¸­æŒ‘é€‰æœ€ä½³æ•ˆæœ</small>
                </div>
                
                <div class="form-group" id="negativePromptGroup">
                    <label>åå‘æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="negativePrompt" placeholder="ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹...">
                    <small id="negativePromptHint" style="display:none; color:#999;">å½“å‰æ¨¡å‹ä¸æ”¯æŒåå‘æç¤ºè¯</small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="promptExtend" checked>
                        å¯ç”¨æ™ºèƒ½æ”¹å†™
                    </label>
                    <small>è‡ªåŠ¨ä¼˜åŒ–æç¤ºè¯ä»¥è·å¾—æ›´å¥½æ•ˆæœï¼ˆå¯èƒ½å¢åŠ 3-4ç§’è€—æ—¶ï¼‰</small>
                </div>
                
                <div class="form-group" id="watermarkGroup">
                    <label>
                        <input type="checkbox" id="watermark">
                        æ·»åŠ æ°´å°
                    </label>
                    <small id="watermarkHint">åœ¨ç”Ÿæˆçš„å›¾ç‰‡ä¸Šæ·»åŠ æ°´å°æ ‡è¯†</small>
                    <small id="watermarkDisabledHint" style="display:none; color:#999;">å½“å‰æ¨¡å‹ä¸æ”¯æŒæ°´å°</small>
                </div>
                
                <button class="btn btn-primary btn-large btn-generate" onclick="createT2ITask()" id="createBtn">
                    <span class="btn-icon">âœ¨</span>
                    <span class="btn-text">å¼€å§‹ç”Ÿæˆ</span>
                </button>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šå†å²è®°å½• -->
        <div class="history-panel">
            <div class="history-header">
                <h2>å†å²è®°å½•</h2>
                <div class="history-actions">
                    <button class="btn btn-secondary btn-sm" onclick="toggleBatchMode()" id="batchModeBtn">
                        æ‰¹é‡é€‰æ‹©
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadSelected()" id="downloadBtn" style="display:none;">
                        ä¸‹è½½é€‰ä¸­ (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="saveSelectedImagesToAssets()" id="saveToAssetBtn" style="display:none;">
                        ğŸ“ ä¿å­˜åˆ°èµ„äº§åº“
                    </button>
                </div>
            </div>
            <div class="history-panel-wrapper">
                <div class="task-list-container">
                    <div id="taskList" class="task-list">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <!-- å³ä¾§ç¼©ç•¥å›¾å¿«é€Ÿå¯¼èˆª -->
                <div class="thumbnail-nav" id="thumbnailNav">
                    <div class="thumbnail-nav-header">å¿«é€Ÿå¯¼èˆª (<span id="thumbNavCount">0</span>)</div>
                    <div class="thumbnail-nav-list" id="thumbnailNavList">
                        <div class="thumbnail-nav-empty">æš‚æ— å·²å®Œæˆ<br>çš„å›¾ç‰‡</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡æ”¾å¤§æµ®å±‚ -->
<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <div class="image-modal-content" onclick="event.stopPropagation()">
        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
        <img id="modalImage" src="" alt="ç”Ÿæˆçš„å›¾ç‰‡">
    </div>
</div>

<style>
/* text2image é¡µé¢ç‰¹æœ‰æ ·å¼ */

/* æ‰¹é‡ä»»åŠ¡IDæ˜¾ç¤ºæ ·å¼ */
.batch-task-ids {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 8px;
}

.batch-task-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 8px;
    border-radius: 6px;
    transition: background 0.15s;
}

.batch-task-row:hover {
    background: #f0f2ff;
}

.batch-task-row .task-index {
    font-size: 11px;
    font-weight: 600;
    color: #667eea;
    min-width: 24px;
}

.batch-task-row .task-id {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 11px;
    color: #555;
    cursor: pointer;
    padding: 2px 6px;
    background: #fff;
    border: 1px solid #e0e4ff;
    border-radius: 4px;
    transition: all 0.2s;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.batch-task-row .task-id:hover {
    background: #667eea;
    color: #fff;
    border-color: #667eea;
}

.batch-task-row .task-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    min-width: 50px;
    text-align: center;
}
</style>

<script src="/static/thumbnail-nav.js"></script>
<script>
let t2iPollingIntervals = new Map();
let batchModeEnabled = false;
let selectedImages = new Set();
let taskStatusCache = new Map();
let currentPage = 1;
let hasMoreTasks = true;
let isLoadingMore = false;
const TASKS_PER_PAGE = 10;
let loadedTaskIds = new Set();

// ä¸åŒæ¨¡å‹æ”¯æŒçš„å°ºå¯¸é…ç½®
const modelSizeOptions = {
    'wan2.6-t2i': [
        { value: '1024*1024', label: '1024Ã—1024 (1:1 æ­£æ–¹å½¢)' },
        { value: '1280*1280', label: '1280Ã—1280 (1:1 å¤§æ­£æ–¹å½¢)' },
        { value: '800*1200', label: '800Ã—1200 (2:3 ç«–ç‰ˆ)' },
        { value: '1200*800', label: '1200Ã—800 (3:2 æ¨ªç‰ˆ)' },
        { value: '960*1280', label: '960Ã—1280 (3:4 ç«–ç‰ˆ)' },
        { value: '1280*960', label: '1280Ã—960 (4:3 æ¨ªç‰ˆ)' },
        { value: '720*1280', label: '720Ã—1280 (9:16 ç«–ç‰ˆ)' },
        { value: '1280*720', label: '1280Ã—720 (16:9 æ¨ªç‰ˆ)' },
        { value: '1344*576', label: '1344Ã—576 (21:9 è¶…å®½)' }
    ],
    'z-image-turbo': [
        // 1024*1024 æ€»åƒç´ çš„æ¨èåˆ†è¾¨ç‡
        { value: '1024*1024', label: '1024Ã—1024 (1:1 æ­£æ–¹å½¢)' },
        { value: '832*1248', label: '832Ã—1248 (2:3 ç«–ç‰ˆ)' },
        { value: '1248*832', label: '1248Ã—832 (3:2 æ¨ªç‰ˆ)' },
        { value: '864*1152', label: '864Ã—1152 (3:4 ç«–ç‰ˆ)' },
        { value: '1152*864', label: '1152Ã—864 (4:3 æ¨ªç‰ˆ)' },
        { value: '896*1152', label: '896Ã—1152 (7:9 ç«–ç‰ˆ)' },
        { value: '1152*896', label: '1152Ã—896 (9:7 æ¨ªç‰ˆ)' },
        { value: '720*1280', label: '720Ã—1280 (9:16 ç«–ç‰ˆ)' },
        { value: '1280*720', label: '1280Ã—720 (16:9 æ¨ªç‰ˆ)' },
        { value: '576*1344', label: '576Ã—1344 (9:21 ç«–ç‰ˆ)' },
        { value: '1344*576', label: '1344Ã—576 (21:9 è¶…å®½)' },
        // 1280*1280 æ€»åƒç´ çš„æ¨èåˆ†è¾¨ç‡
        { value: '1280*1280', label: '1280Ã—1280 (1:1 å¤§æ­£æ–¹å½¢)' },
        { value: '1024*1536', label: '1024Ã—1536 (2:3 ç«–ç‰ˆ)' },
        { value: '1536*1024', label: '1536Ã—1024 (3:2 æ¨ªç‰ˆ)' },
        { value: '1104*1472', label: '1104Ã—1472 (3:4 ç«–ç‰ˆ)' },
        { value: '1472*1104', label: '1472Ã—1104 (4:3 æ¨ªç‰ˆ)' },
        { value: '1120*1440', label: '1120Ã—1440 (7:9 ç«–ç‰ˆ)' },
        { value: '1440*1120', label: '1440Ã—1120 (9:7 æ¨ªç‰ˆ)' },
        { value: '864*1536', label: '864Ã—1536 (9:16 ç«–ç‰ˆ)' },
        { value: '1536*864', label: '1536Ã—864 (16:9 æ¨ªç‰ˆ)' },
        { value: '720*1680', label: '720Ã—1680 (9:21 ç«–ç‰ˆ)' },
        { value: '1680*720', label: '1680Ã—720 (21:9 è¶…å®½)' },
        // 1536*1536 æ€»åƒç´ çš„æ¨èåˆ†è¾¨ç‡
        { value: '1536*1536', label: '1536Ã—1536 (1:1 è¶…å¤§æ­£æ–¹å½¢)' },
        { value: '1248*1872', label: '1248Ã—1872 (2:3 ç«–ç‰ˆ)' },
        { value: '1872*1248', label: '1872Ã—1248 (3:2 æ¨ªç‰ˆ)' },
        { value: '1296*1728', label: '1296Ã—1728 (3:4 ç«–ç‰ˆ)' },
        { value: '1728*1296', label: '1728Ã—1296 (4:3 æ¨ªç‰ˆ)' },
        { value: '1344*1728', label: '1344Ã—1728 (7:9 ç«–ç‰ˆ)' },
        { value: '1728*1344', label: '1728Ã—1344 (9:7 æ¨ªç‰ˆ)' },
        { value: '1152*2048', label: '1152Ã—2048 (9:16 ç«–ç‰ˆ)' },
        { value: '2048*1152', label: '2048Ã—1152 (16:9 æ¨ªç‰ˆ)' },
        { value: '864*2016', label: '864Ã—2016 (9:21 ç«–ç‰ˆ)' },
        { value: '2016*864', label: '2016Ã—864 (21:9 è¶…å®½)' }
    ],
    'wan2.5-t2i-preview': [
        { value: '1024*1024', label: '1024Ã—1024 (1:1 æ­£æ–¹å½¢)' },
        { value: '1280*1280', label: '1280Ã—1280 (1:1 å¤§æ­£æ–¹å½¢)' },
        { value: '800*1200', label: '800Ã—1200 (2:3 ç«–ç‰ˆ)' },
        { value: '1200*800', label: '1200Ã—800 (3:2 æ¨ªç‰ˆ)' },
        { value: '960*1280', label: '960Ã—1280 (3:4 ç«–ç‰ˆ)' },
        { value: '1280*960', label: '1280Ã—960 (4:3 æ¨ªç‰ˆ)' },
        { value: '720*1280', label: '720Ã—1280 (9:16 ç«–ç‰ˆ)' },
        { value: '1280*720', label: '1280Ã—720 (16:9 æ¨ªç‰ˆ)' },
        { value: '1344*576', label: '1344Ã—576 (21:9 è¶…å®½)' }
    ],
    'qwen-image-plus': [
        { value: '1328*1328', label: '1328Ã—1328 (1:1 æ­£æ–¹å½¢)' },
        { value: '1664*928', label: '1664Ã—928 (16:9 æ¨ªç‰ˆ)' },
        { value: '928*1664', label: '928Ã—1664 (9:16 ç«–ç‰ˆ)' },
        { value: '1472*1140', label: '1472Ã—1140 (4:3 æ¨ªç‰ˆ)' },
        { value: '1140*1472', label: '1140Ã—1472 (3:4 ç«–ç‰ˆ)' }
    ]
};

// æ›´æ–°å°ºå¯¸é€‰é¡¹
function updateSizeOptions() {
    const modelSelect = document.getElementById('model');
    const sizeSelect = document.getElementById('size');
    const selectedModel = modelSelect.value;
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    sizeSelect.innerHTML = '';
    
    // è·å–å½“å‰æ¨¡å‹æ”¯æŒçš„å°ºå¯¸
    const options = modelSizeOptions[selectedModel] || modelSizeOptions['wan2.5-t2i-preview'];
    
    // æ·»åŠ æ–°é€‰é¡¹
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.label;
        sizeSelect.appendChild(optionElement);
    });
    
    // æ›´æ–°æ¨¡å‹ç›¸å…³å‚æ•°çš„å¯ç”¨æ€§
    updateModelOptions();
}

// æ ¹æ®æ¨¡å‹æ›´æ–°å‚æ•°å¯ç”¨æ€§
function updateModelOptions() {
    const selectedModel = document.getElementById('model').value;
    
    // z-image-turbo ä¸æ”¯æŒçš„å‚æ•°
    if (selectedModel === 'z-image-turbo') {
        // å¯ç”¨ç”Ÿæˆæ•°é‡é€‰æ‹©ï¼ˆæ”¯æŒ1-4å¼ ï¼Œé€šè¿‡ä¸²è¡Œç”Ÿæˆï¼‰
        const batchCountSelect = document.getElementById('batchCount');
        batchCountSelect.disabled = false;
        document.getElementById('batchCountHint').textContent = 'z-image-turbo é€šè¿‡ä¸²è¡Œè°ƒç”¨ç”Ÿæˆå¤šå¼ å›¾ç‰‡';
        document.getElementById('batchCountHint').style.color = '#666';
        
        // ç¦ç”¨åå‘æç¤ºè¯
        const negativePromptInput = document.getElementById('negativePrompt');
        negativePromptInput.disabled = true;
        negativePromptInput.value = '';
        negativePromptInput.placeholder = 'å½“å‰æ¨¡å‹ä¸æ”¯æŒåå‘æç¤ºè¯';
        document.getElementById('negativePromptHint').style.display = 'block';
        
        // ç¦ç”¨æ°´å°
        const watermarkCheckbox = document.getElementById('watermark');
        watermarkCheckbox.disabled = true;
        watermarkCheckbox.checked = false;
        document.getElementById('watermarkHint').style.display = 'none';
        document.getElementById('watermarkDisabledHint').style.display = 'block';
    } else {
        // å¯ç”¨æ‰€æœ‰å‚æ•°
        const batchCountSelect = document.getElementById('batchCount');
        batchCountSelect.disabled = false;
        document.getElementById('batchCountHint').textContent = 'ä¸€æ¬¡ç”Ÿæˆå¤šå¼ å›¾ç‰‡ï¼Œå¯ä»ä¸­æŒ‘é€‰æœ€ä½³æ•ˆæœ';
        document.getElementById('batchCountHint').style.color = '';
        
        const negativePromptInput = document.getElementById('negativePrompt');
        negativePromptInput.disabled = false;
        negativePromptInput.placeholder = 'ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹...';
        document.getElementById('negativePromptHint').style.display = 'none';
        
        const watermarkCheckbox = document.getElementById('watermark');
        watermarkCheckbox.disabled = false;
        document.getElementById('watermarkHint').style.display = 'block';
        document.getElementById('watermarkDisabledHint').style.display = 'none';
    }
}

window.addEventListener('load', function() {
    updateSizeOptions(); // åˆå§‹åŒ–å°ºå¯¸é€‰é¡¹
    initInfiniteScroll();
    loadT2ITasks();
    
    // åˆå§‹åŒ–ç¼©ç•¥å›¾å¯¼èˆª
    ThumbnailNav.init({
        apiEndpoint: '/api/t2i-thumbnails',
        mediaType: 'image',
        itemsPerPage: 50,
        enableBatchSupport: true,
        emptyText: 'æš‚æ— å·²å®Œæˆ<br>çš„å›¾ç‰‡',
        virtualScrollEnabled: false  // å›¾ç‰‡æ¨¡å—ä½¿ç”¨ä¼ ç»Ÿæ¸²æŸ“
    });
});

function initInfiniteScroll() {
    const taskList = document.getElementById('taskList');
    
    if (taskList) {
        taskList.addEventListener('scroll', function() {
            const scrollTop = taskList.scrollTop;
            const scrollHeight = taskList.scrollHeight;
            const clientHeight = taskList.clientHeight;
            const distanceToBottom = scrollHeight - scrollTop - clientHeight;
            
            if (distanceToBottom < 300 && hasMoreTasks && !isLoadingMore) {
                console.log('[DEBUG] è§¦å‘åŠ è½½æ›´å¤š T2Iï¼Œè·ç¦»åº•éƒ¨:', distanceToBottom);
                loadMoreT2ITasks();
            }
        });
        console.log('[DEBUG] T2I æ— é™æ»šåŠ¨å·²åˆå§‹åŒ–');
    }
}

async function loadMoreT2ITasks() {
    if (isLoadingMore || !hasMoreTasks) {
        console.log('[DEBUG] T2I è·³è¿‡åŠ è½½: isLoadingMore=', isLoadingMore, 'hasMoreTasks=', hasMoreTasks);
        return;
    }
    
    isLoadingMore = true;
    currentPage++;
    
    console.log('[DEBUG] T2I å¼€å§‹åŠ è½½ç¬¬', currentPage, 'é¡µ');
    
    try {
        const response = await fetch(`/api/t2i-tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        console.log('[DEBUG] T2I åŠ è½½ç»“æœ: success=', data.success, 'tasks=', data.tasks?.length, 'has_more=', data.has_more);
        
        if (data.success && data.tasks && data.tasks.length > 0) {
            appendT2ITasks(data.tasks);
            hasMoreTasks = data.has_more;
            
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startT2IPolling(task.task_id);
                }
            });
        } else {
            hasMoreTasks = false;
        }
    } catch (error) {
        console.error('åŠ è½½æ›´å¤šä»»åŠ¡å¤±è´¥:', error);
        currentPage--;
    } finally {
        isLoadingMore = false;
    }
}

async function createT2ITask() {
    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt) {
        showAlert('è¯·è¾“å…¥æç¤ºè¯', 'error');
        return;
    }
    
    const requestBody = {
        prompt: prompt,
        model: document.getElementById('model').value,
        size: document.getElementById('size').value,
        negative_prompt: document.getElementById('negativePrompt').value,
        n: parseInt(document.getElementById('batchCount').value),  // ç”Ÿæˆæ•°é‡å‚æ•°
        prompt_extend: document.getElementById('promptExtend').checked,
        watermark: document.getElementById('watermark').checked
    };
    
    const btn = document.getElementById('createBtn');
    const btnIcon = btn.querySelector('.btn-icon');
    const btnText = btn.querySelector('.btn-text');
    
    btn.disabled = true;
    btnIcon.textContent = 'â³';
    btnText.textContent = 'åˆ›å»ºä¸­...';
    
    try {
        const response = await fetch('/api/create-t2i-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'ä»»åŠ¡åˆ›å»ºæˆåŠŸ', 'success');
            loadT2ITasks();
            
            // åªå¯¹æœªå®Œæˆçš„ä»»åŠ¡å¯åŠ¨è½®è¯¢ï¼ˆwan2.6-t2iå’Œz-image-turboåœ¨åå°å¼‚æ­¥æ‰§è¡Œï¼Œä½†ä¼šå…ˆè¿”å›PENDINGçŠ¶æ€ï¼‰
            if (data.tasks) {
                data.tasks.forEach(task => {
                    if (task.task_status !== 'SUCCEEDED' && task.task_status !== 'FAILED') {
                        startT2IPolling(task.task_id);
                    }
                });
            }
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btnIcon.textContent = 'âœ¨';
        btnText.textContent = 'å¼€å§‹ç”Ÿæˆ';    
    }
}

async function loadT2ITasks(reset = true) {
    try {
        if (reset) {
            currentPage = 1;
            hasMoreTasks = true;
            loadedTaskIds.clear();
        }
        
        const response = await fetch(`/api/t2i-tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        if (data.success) {
            if (reset) {
                renderT2ITasks(data.tasks);
            } else {
                appendT2ITasks(data.tasks);
            }
            
            hasMoreTasks = data.has_more;
            
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startT2IPolling(task.task_id);
                }
            });
        }
    } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
    }
}

function renderT2ITasks(tasks) {
    const taskList = document.getElementById('taskList');
    
    if (tasks.length === 0) {
        taskList.innerHTML = '<div class="loading">æš‚æ— å†å²è®°å½•</div>';
        return;
    }
    
    tasks.forEach(t => loadedTaskIds.add(t.task_id));
    const batchGroups = groupT2ITasksByBatch(tasks);
    taskList.innerHTML = renderT2ITaskGroups(batchGroups);
}

function appendT2ITasks(tasks) {
    const taskList = document.getElementById('taskList');
    const newTasks = tasks.filter(t => !loadedTaskIds.has(t.task_id));
    if (newTasks.length === 0) return;
    
    newTasks.forEach(t => loadedTaskIds.add(t.task_id));
    const batchGroups = groupT2ITasksByBatch(newTasks);
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = renderT2ITaskGroups(batchGroups);
    
    while (tempDiv.firstChild) {
        taskList.appendChild(tempDiv.firstChild);
    }
}

function groupT2ITasksByBatch(tasks) {
    const batchGroups = {};
    tasks.forEach(task => {
        const batchId = task.batch_id || task.task_id;
        if (!batchGroups[batchId]) {
            batchGroups[batchId] = [];
        }
        batchGroups[batchId].push(task);
    });
    return batchGroups;
}

function renderT2ITaskGroups(batchGroups) {
    return Object.values(batchGroups).map(batch => {
        const mainTask = batch[0];
        const isBatch = batch.length > 1;
        
        // æ”¶é›†æ‰€æœ‰æˆåŠŸä»»åŠ¡çš„å›¾ç‰‡URLs - ä¿®å¤ç‰ˆæœ¬ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°URLï¼ˆä¸ä¼šè¿‡æœŸï¼‰
        const allImageUrls = [];
        batch.forEach(task => {
            // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
            if (task.task_status === 'SUCCEEDED') {
                // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°å›¾ç‰‡URLï¼ˆä¸ä¼šè¿‡æœŸï¼‰
                if (task.local_image_urls && Array.isArray(task.local_image_urls) && task.local_image_urls.length > 0) {
                    task.local_image_urls.forEach(url => {
                        allImageUrls.push({
                            url: url,
                            taskIndex: batch.indexOf(task),
                            taskId: task.task_id
                        });
                    });
                }
                // å…¶æ¬¡ä½¿ç”¨image_urlså­—æ®µï¼ˆé˜¿é‡Œäº‘ä¸´æ—¶URLï¼Œå¯èƒ½è¿‡æœŸï¼‰
                else if (task.image_urls && Array.isArray(task.image_urls) && task.image_urls.length > 0) {
                    task.image_urls.forEach(url => {
                        allImageUrls.push({
                            url: url,
                            taskIndex: batch.indexOf(task),
                            taskId: task.task_id
                        });
                    });
                }
                // å…¼å®¹resultså­—æ®µï¼ˆDashScope APIè¿”å›æ ¼å¼ï¼‰
                else if (task.results && Array.isArray(task.results)) {
                    task.results.forEach(result => {
                        if (result.url) {
                            allImageUrls.push({
                                url: result.url,
                                taskIndex: batch.indexOf(task),
                                taskId: task.task_id
                            });
                        }
                    });
                }
            }
        });
        
        console.log('[DEBUG] æ¸²æŸ“ä»»åŠ¡ç»„:', {
            taskId: mainTask.task_id,
            status: mainTask.task_status,
            batchSize: batch.length,
            totalImages: allImageUrls.length,
            imageUrls: allImageUrls.map(img => img.url),
            hasImageUrls: !!mainTask.image_urls,
            hasResults: !!mainTask.results
        });
        
        return `
        <div class="task-item" id="task-${mainTask.task_id}">
            <div class="task-header">
                <div class="batch-task-ids">
                    ${batch.map((task, idx) => `
                        <div class="batch-task-row">
                            <span class="task-index">#${idx + 1}</span>
                            <span class="task-id" onclick="copyToClipboard('${task.task_id}')" title="ç‚¹å‡»å¤åˆ¶">${task.task_id}</span>
                            <span class="task-status status-${(task.task_status || 'PENDING').toLowerCase()}">${getStatusText(task.task_status || 'PENDING')}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="task-actions">
                    <button class="btn btn-secondary btn-sm icon-only" onclick="event.stopPropagation(); regenerateT2ITask('${mainTask.task_id}')" title="ä½¿ç”¨ç›¸åŒé…ç½®é‡æ–°ç”Ÿæˆ">ğŸ”„</button>
                </div>
            </div>
            
            <div class="task-info">
                <p><strong>æç¤ºè¯:</strong> ${mainTask.prompt}</p>
                <p><strong>æ¨¡å‹:</strong> ${mainTask.model}</p>
                <p><strong>å°ºå¯¸:</strong> ${mainTask.size}</p>
                ${mainTask.created_at ? `<p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(mainTask.created_at).toLocaleString('zh-CN')}</p>` : ''}
                ${mainTask.task_status === 'FAILED' && mainTask.message ? 
                    `<div class="error-message">âš  é”™è¯¯ä¿¡æ¯: ${mainTask.message}</div>` : ''}
            </div>
            
            ${allImageUrls.length > 0 ? `
                <div class="image-grid">
                    ${allImageUrls.map((imgData, index) => {
                        const imageId = `${imgData.taskId}_${index}`;
                        const clickHandler = batchModeEnabled ? `toggleImageSelection('${imageId}')` : `openImageModal('${imgData.url}')`;
                        const thumbnailClass = batchModeEnabled ? 'image-thumbnail batch-mode' : 'image-thumbnail';
                        const isChecked = selectedImages.has(imageId) ? 'checked' : '';
                        
                        return `
                            <div class="${thumbnailClass}" id="image-${imageId}" onclick="${clickHandler}">
                                ${batchModeEnabled ? `
                                    <input type="checkbox" 
                                           class="batch-checkbox" 
                                           data-image-id="${imageId}" 
                                           data-image-url="${imgData.url}"
                                           ${isChecked}
                                           onclick="event.stopPropagation(); toggleImageCheckbox('${imageId}');">
                                ` : ''}
                                ${allImageUrls.length > 1 ? `<div class="image-index">#${index + 1}</div>` : ''}
                                <img src="${imgData.url}" alt="ç”Ÿæˆçš„å›¾ç‰‡" loading="lazy" onerror="handleImageError(this, '${imgData.url}')">
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : mainTask.task_status === 'SUCCEEDED' ? `
                <div class="loading">å›¾ç‰‡ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</div>
            ` : ''}
        </div>
        `;
    }).join('');
}

function getStatusText(status) {
    const statusMap = {
        'PENDING': 'ç­‰å¾…ä¸­',
        'RUNNING': 'å¤„ç†ä¸­',
        'SUCCEEDED': 'æˆåŠŸ',
        'FAILED': 'å¤±è´¥'
    };
    return statusMap[status] || status;
}

function startT2IPolling(taskId) {
    if (t2iPollingIntervals.has(taskId)) {
        return;
    }
    
    const intervalId = setInterval(async () => {
        try {
            const response = await fetch(`/api/t2i-task/${taskId}`);
            const data = await response.json();
            
            if (data.success && data.task) {
                const task = data.task;
                const status = task.task_status;
                const oldStatus = taskStatusCache.get(taskId);
                
                if (oldStatus !== status) {
                    taskStatusCache.set(taskId, status);
                    updateT2ITaskStatus(taskId, task);
                }
                
                if (status === 'SUCCEEDED' || status === 'FAILED') {
                    clearInterval(intervalId);
                    t2iPollingIntervals.delete(taskId);
                    loadT2ITasks();
                }
            }
        } catch (error) {
            console.error('è½®è¯¢ä»»åŠ¡å¤±è´¥:', error);
        }
    }, 5000);
    
    t2iPollingIntervals.set(taskId, intervalId);
}

function updateT2ITaskStatus(taskId, task) {
    const taskItem = document.getElementById(`task-${taskId}`);
    if (!taskItem) return;
    
    // æå–å›¾ç‰‡URLsï¼ˆä¼˜å…ˆä½¿ç”¨æœ¬åœ°URLï¼Œå…¼å®¹å¤šç§æ ¼å¼ï¼‰
    let imageUrls = [];
    // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°å›¾ç‰‡URLï¼ˆä¸ä¼šè¿‡æœŸï¼‰
    if (task.local_image_urls && Array.isArray(task.local_image_urls) && task.local_image_urls.length > 0) {
        imageUrls = task.local_image_urls;
    }
    // å…¶æ¬¡ä½¿ç”¨image_urlså­—æ®µï¼ˆé˜¿é‡Œäº‘ä¸´æ—¶URLï¼Œå¯èƒ½è¿‡æœŸï¼‰
    else if (task.image_urls && Array.isArray(task.image_urls)) {
        imageUrls = task.image_urls;
    }
    // å…¼å®¹resultså­—æ®µï¼ˆDashScope APIè¿”å›æ ¼å¼ï¼‰
    else if (task.results && Array.isArray(task.results)) {
        imageUrls = task.results.map(r => r.url).filter(url => url);
    }
    
    console.log('[DEBUG] æ›´æ–°ä»»åŠ¡çŠ¶æ€:', {
        taskId,
        status: task.task_status,
        hasImages: imageUrls.length > 0,
        imageUrls: imageUrls,
        rawTask: task
    });
    
    const statusSpan = taskItem.querySelector('.task-status');
    if (statusSpan) {
        statusSpan.className = 'task-status';
        statusSpan.classList.add(`status-${(task.task_status || 'unknown').toLowerCase()}`);
        statusSpan.textContent = getStatusText(task.task_status);
    }
    
    if (task.task_status === 'FAILED' && task.message) {
        const taskInfo = taskItem.querySelector('.task-info');
        if (taskInfo && !taskInfo.querySelector('.error-message')) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `âš  é”™è¯¯ä¿¡æ¯: ${task.message}`;
            taskInfo.appendChild(errorDiv);
        }
    }
    
    // å¦‚æœä»»åŠ¡æˆåŠŸä¸”æœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡å±•ç¤º
    if (task.task_status === 'SUCCEEDED' && imageUrls.length > 0) {
        // ç§»é™¤åŠ è½½æç¤º
        const loadingDiv = taskItem.querySelector('.loading');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        
        let imageGrid = taskItem.querySelector('.image-grid');
        if (!imageGrid) {
            imageGrid = document.createElement('div');
            imageGrid.className = 'image-grid';
            taskItem.appendChild(imageGrid);
            
            imageUrls.forEach((url, index) => {
                console.log('[DEBUG] åŠ¨æ€æ·»åŠ å›¾ç‰‡:', url);
                const thumbnail = document.createElement('div');
                thumbnail.className = 'image-thumbnail';
                thumbnail.onclick = () => openImageModal(url);
                
                if (imageUrls.length > 1) {
                    const indexDiv = document.createElement('div');
                    indexDiv.className = 'image-index';
                    indexDiv.textContent = `#${index + 1}`;
                    thumbnail.appendChild(indexDiv);
                }
                
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'ç”Ÿæˆçš„å›¾ç‰‡';
                img.loading = 'lazy';  // æ·»åŠ æ‡’åŠ è½½å±æ€§
                img.onerror = () => handleImageError(img, url);
                thumbnail.appendChild(img);
                
                imageGrid.appendChild(thumbnail);
            });
        }
    }
}

// ä½¿ç”¨common.jsä¸­çš„é€šç”¨å‡½æ•°:
// - copyToClipboard(text)
// - openImageModal(imageUrl)
// - closeImageModal()
// - handleImageError(imgElement, url)
// - logout()
// - showAlert(message, type)

// æ‰¹é‡é€‰æ‹©ç›¸å…³å‡½æ•°
function toggleBatchMode() {
    batchModeEnabled = !batchModeEnabled;
    const btn = document.getElementById('batchModeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const saveToAssetBtn = document.getElementById('saveToAssetBtn');
    
    if (batchModeEnabled) {
        btn.textContent = 'å–æ¶ˆé€‰æ‹©';
        btn.classList.add('active');
        downloadBtn.style.display = 'inline-block';
        if (saveToAssetBtn) saveToAssetBtn.style.display = 'inline-block';
    } else {
        btn.textContent = 'æ‰¹é‡é€‰æ‹©';
        btn.classList.remove('active');
        downloadBtn.style.display = 'none';
        if (saveToAssetBtn) saveToAssetBtn.style.display = 'none';
        selectedImages.clear();
    }
    
    loadT2ITasks(); // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
}

// ä¿å­˜é€‰ä¸­çš„å›¾ç‰‡åˆ°èµ„äº§åº“
function saveSelectedImagesToAssets() {
    if (selectedImages.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¿å­˜çš„å›¾ç‰‡', 'error');
        return;
    }
    
    // æ”¶é›†é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶ä¿¡æ¯
    const files = [];
    for (const imageId of selectedImages) {
        const checkbox = document.querySelector(`.batch-checkbox[data-image-id="${imageId}"]`);
        if (checkbox && checkbox.dataset.imageUrl) {
            const imageUrl = checkbox.dataset.imageUrl;
            // ä¼ é€’å®Œæ•´çš„URLï¼Œè€Œä¸æ˜¯ä»…ä»…æ˜¯æ–‡ä»¶å
            files.push({
                filename: imageUrl,  // ä¼ é€’å®Œæ•´URL
                source_type: 't2i',
                file_type: 'image'
            });
        }
    }
    
    if (files.length === 0) {
        showAlert('æ²¡æœ‰æ‰¾åˆ°å¯ä¿å­˜çš„å›¾ç‰‡', 'error');
        return;
    }
    
    openSaveToAssetModal({
        files: files,
        fileType: 'image',
        onComplete: (count) => {
            if (count > 0) {
                selectedImages.clear();
                updateSelectedCount();
            }
        }
    });
}

function updateSelectedCount() {
    selectedImages.clear();
    document.querySelectorAll('.batch-checkbox:checked').forEach(checkbox => {
        selectedImages.add(checkbox.dataset.imageId);
    });
    document.getElementById('selectedCount').textContent = selectedImages.size;
}

function toggleImageCheckbox(imageId) {
    const checkbox = document.querySelector(`.batch-checkbox[data-image-id="${imageId}"]`);
    if (!checkbox) return;
    
    if (checkbox.checked) {
        selectedImages.add(imageId);
    } else {
        selectedImages.delete(imageId);
    }
    
    const thumbnail = document.getElementById(`image-${imageId}`);
    if (thumbnail) {
        if (checkbox.checked) {
            thumbnail.classList.add('selected');
        } else {
            thumbnail.classList.remove('selected');
        }
    }
    
    updateSelectedCount();
}

function toggleImageSelection(imageId) {
    const checkbox = document.querySelector(`.batch-checkbox[data-image-id="${imageId}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        
        if (checkbox.checked) {
            selectedImages.add(imageId);
        } else {
            selectedImages.delete(imageId);
        }
        
        const thumbnail = document.getElementById(`image-${imageId}`);
        if (thumbnail) {
            if (checkbox.checked) {
                thumbnail.classList.add('selected');
            } else {
                thumbnail.classList.remove('selected');
            }
        }
        
        updateSelectedCount();
    }
}

function downloadImage(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

async function downloadSelected() {
    if (selectedImages.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„å›¾ç‰‡', 'error');
        return;
    }
    
    showAlert(`å¼€å§‹ä¸‹è½½ ${selectedImages.size} å¼ å›¾ç‰‡...`, 'success');
    
    let downloadCount = 0;
    for (const imageId of selectedImages) {
        const checkbox = document.querySelector(`.batch-checkbox[data-image-id="${imageId}"]`);
        if (checkbox && checkbox.dataset.imageUrl) {
            const imageUrl = checkbox.dataset.imageUrl;
            downloadImage(imageUrl, `image_${imageId}.jpg`);
            downloadCount++;
            await new Promise(resolve => setTimeout(resolve, 300));
        }
    }
    
    if (downloadCount > 0) {
        showAlert(`å·²å¯åŠ¨ ${downloadCount} å¼ å›¾ç‰‡ä¸‹è½½`, 'success');
    }
}

// é‡æ–°ç”Ÿæˆæ–‡ç”Ÿå›¾ä»»åŠ¡
async function regenerateT2ITask(taskId) {
    if (!taskId) {
        showAlert('æ— æ•ˆçš„ä»»åŠ¡ID', 'error');
        return;
    }
    
    try {
        showAlert('æ­£åœ¨é‡æ–°ç”Ÿæˆä»»åŠ¡...', 'info');
        
        const response = await fetch('/api/regenerate-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                task_id: taskId,
                task_type: 't2i'  // æ–‡ç”Ÿå›¾ä»»åŠ¡
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡', 'success');
            
            // å¯åŠ¨æ–°ä»»åŠ¡çš„è½®è¯¢
            if (data.tasks && data.tasks.length > 0) {
                data.tasks.forEach(task => {
                    if (task.task_id) {
                        startT2IPolling(task.task_id);
                    }
                });
            }
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°ä»»åŠ¡
            loadT2ITasks();
        } else {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥:', error);
        showAlert('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
    }
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
        closeOptimizeModal();
    }
});

// æç¤ºè¯ä¼˜åŒ–åŠŸèƒ½
function openOptimizeModal() {
    const promptInput = document.getElementById('prompt');
    const originalPrompt = promptInput.value.trim();

    if (!originalPrompt) {
        showAlert('è¯·å…ˆè¾“å…¥æç¤ºè¯', 'error');
        return;
    }

    // æ˜¾ç¤ºåŸå§‹æç¤ºè¯
    document.getElementById('originalPromptContent').textContent = originalPrompt;

    // æ˜¾ç¤ºæ‚¬æµ®çª—
    document.getElementById('optimizeModal').classList.add('active');

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const optimizedPromptDiv = document.querySelector('.optimized-prompt');
    const optimizedContent = document.getElementById('optimizedPromptContent');
    optimizedPromptDiv.classList.add('loading');
    optimizedContent.textContent = 'æ­£åœ¨ä¼˜åŒ–ä¸­...';

    // è°ƒç”¨åç«¯ API è¿›è¡Œæç¤ºè¯ä¼˜åŒ–
    fetch('/api/optimize-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prompt: originalPrompt,
            task_type: 'image'  // æ–‡ç”Ÿå›¾ä»»åŠ¡ç±»å‹
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
        }
        
        // å¤„ç†æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        // æ¸…ç©ºå†…å®¹ï¼Œå‡†å¤‡æ¥æ”¶æµå¼æ•°æ®
        optimizedContent.textContent = '';
        optimizedPromptDiv.classList.remove('loading');
        
        function readStream() {
            reader.read().then(({done, value}) => {
                if (done) {
                    return;
                }
                
                // è§£ç æ•°æ®
                buffer += decoder.decode(value, {stream: true});
                
                // æŒ‰è¡Œåˆ†å‰²
                const lines = buffer.split('\n');
                buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                
                // å¤„ç†æ¯ä¸€è¡Œ
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6);
                        
                        if (data === '[DONE]') {
                            return;
                        }
                        
                        try {
                            // å°è¯•è§£æä¸º JSONï¼ˆå¯èƒ½æ˜¯é”™è¯¯æˆ– usage ä¿¡æ¯ï¼‰
                            const jsonData = JSON.parse(data);
                            if (jsonData.type === 'error') {
                                optimizedPromptDiv.classList.remove('loading');
                                optimizedContent.textContent = `ä¼˜åŒ–å¤±è´¥: ${jsonData.message}`;
                                showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
                                return;
                            }
                            // å¿½ç•¥ usage ä¿¡æ¯
                        } catch (e) {
                            // ä¸æ˜¯ JSONï¼Œæ˜¯æ™®é€šæ–‡æœ¬ï¼Œç›´æ¥è¿½åŠ æ˜¾ç¤º
                            optimizedContent.textContent += data;
                        }
                    }
                }
                
                // ç»§ç»­è¯»å–
                readStream();
            }).catch(error => {
                console.error('æµå¼è¯»å–é”™è¯¯:', error);
                optimizedPromptDiv.classList.remove('loading');
                optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•';
                showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
            });
        }
        
        readStream();
    })
    .catch(error => {
        console.error('ä¼˜åŒ–æç¤ºè¯å¤±è´¥:', error);
        optimizedPromptDiv.classList.remove('loading');
        optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•';
        showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
    });
}

function closeOptimizeModal() {
    document.getElementById('optimizeModal').classList.remove('active');
}

function applyOptimizedPrompt() {
    const optimizedText = document.getElementById('optimizedPromptContent').textContent;
    if (optimizedText && optimizedText !== 'æ­£åœ¨ä¼˜åŒ–ä¸­...') {
        document.getElementById('prompt').value = optimizedText;
        closeOptimizeModal();
        showAlert('å·²åº”ç”¨ä¼˜åŒ–åçš„æç¤ºè¯', 'success');
    }
}

// é‡æ–°ç”Ÿæˆä¼˜åŒ–åçš„æç¤ºè¯
function regenerateOptimizedPrompt() {
    const originalPrompt = document.getElementById('originalPromptContent').textContent;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const optimizedPromptDiv = document.querySelector('.optimized-prompt');
    const optimizedContent = document.getElementById('optimizedPromptContent');
    optimizedPromptDiv.classList.add('loading');
    optimizedContent.textContent = 'æ­£åœ¨é‡æ–°ç”Ÿæˆ...';

    // è°ƒç”¨åç«¯ API è¿›è¡Œæç¤ºè¯ä¼˜åŒ–
    fetch('/api/optimize-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prompt: originalPrompt,
            task_type: 'image'  // æ–‡ç”Ÿå›¾ä»»åŠ¡ç±»å‹
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
        }
        
        // å¤„ç†æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        // æ¸…ç©ºå†…å®¹ï¼Œå‡†å¤‡æ¥æ”¶æµå¼æ•°æ®
        optimizedContent.textContent = '';
        optimizedPromptDiv.classList.remove('loading');
        
        function readStream() {
            reader.read().then(({done, value}) => {
                if (done) {
                    return;
                }
                
                // è§£ç æ•°æ®
                buffer += decoder.decode(value, {stream: true});
                
                // æŒ‰è¡Œåˆ†å‰²
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                // å¤„ç†æ¯ä¸€è¡Œ
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6);
                        
                        if (data === '[DONE]') {
                            return;
                        }
                        
                        try {
                            const jsonData = JSON.parse(data);
                            if (jsonData.type === 'error') {
                                optimizedPromptDiv.classList.remove('loading');
                                optimizedContent.textContent = `ä¼˜åŒ–å¤±è´¥: ${jsonData.message}`;
                                showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
                                return;
                            }
                        } catch (e) {
                            optimizedContent.textContent += data;
                        }
                    }
                }
                
                readStream();
            }).catch(error => {
                console.error('æµå¼è¯»å–é”™è¯¯:', error);
                optimizedPromptDiv.classList.remove('loading');
                optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•';
                showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
            });
        }
        
        readStream();
    })
    .catch(error => {
        console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
        optimizedPromptDiv.classList.remove('loading');
        optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•';
        showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
    });
}
</script>

<!-- æç¤ºè¯ä¼˜åŒ–æ‚¬æµ®çª— -->
<div id="optimizeModal" class="optimize-modal">
    <div class="optimize-modal-content">
        <div class="optimize-modal-header">
            <h3>AI æç¤ºè¯ä¼˜åŒ– <small style="font-size: 0.7em; color: #666; font-weight: normal;">å»ºè®®å…³é—­æ™ºèƒ½æ”¹å†™</small></h3>
            <button class="optimize-modal-close" onclick="closeOptimizeModal()">&times;</button>
        </div>
        <div class="optimize-modal-body">
            <div class="original-prompt">
                <h4>åŸå§‹æç¤ºè¯</h4>
                <div class="prompt-content" id="originalPromptContent"></div>
            </div>
            <div class="optimized-prompt">
                <h4>ä¼˜åŒ–åçš„æç¤ºè¯</h4>
                <div class="prompt-content" id="optimizedPromptContent"></div>
            </div>
        </div>
        <div class="optimize-modal-footer">
            <button class="btn btn-secondary" onclick="closeOptimizeModal()">å–æ¶ˆ</button>
            <button class="btn btn-regenerate" onclick="regenerateOptimizedPrompt()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
            <button class="btn btn-primary" onclick="applyOptimizedPrompt()">ç«‹å³ä½¿ç”¨</button>
        </div>
    </div>
</div>

{% endblock %}
