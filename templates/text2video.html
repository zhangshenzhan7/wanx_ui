{% extends "base.html" %}

{% block title %}é€šä¹‰ä¸‡ç›¸ - æ–‡ç”Ÿè§†é¢‘{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/common.css">
{% endblock %}

{% block body %}
<div class="workspace-container">
    <div class="workspace-header">
        <h1>ğŸ¥ é€šä¹‰ä¸‡ç›¸æ–‡ç”Ÿè§†é¢‘</h1>
        <div>
            <button class="btn btn-secondary" onclick="window.location.href='/assets'" style="margin-right: 10px;">ğŸ“ èµ„äº§åº“</button>
            <button class="btn btn-secondary" onclick="window.location.href='/workspace'" style="margin-right: 10px;">å›¾ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary active" style="margin-right: 10px;">æ–‡ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/kf2v'" style="margin-right: 10px;">é¦–å°¾å¸§ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/reference2video'" style="margin-right: 10px;">å‚è€ƒç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2image'" style="margin-right: 10px;">æ–‡ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/image2image'" style="margin-right: 10px;">å›¾ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/voice-clone'" style="margin-right: 10px;">è¯­éŸ³å¤åˆ»</button>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </div>
    </div>
    
    <div class="workspace-content">
        <!-- å·¦ä¾§ï¼šåˆ›å»ºä»»åŠ¡ -->
        <div class="create-panel">
            <h2>åˆ›å»ºæ–°ä»»åŠ¡</h2>
            
            <div class="form-section">
                <!-- æç¤ºè¯ -->
                <div class="form-group">
                    <div class="prompt-label-wrapper">
                        <label>æç¤ºè¯ï¼ˆå¿…å¡«ï¼‰</label>
                        <button type="button" class="btn-optimize" onclick="openOptimizeModal()">
                            <span class="icon">âœ¨</span>
                            <span>æç¤ºè¯ä¼˜åŒ–</span>
                        </button>
                    </div>
                    <textarea id="prompt" rows="4" placeholder="æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ¨¡å‹é€‰æ‹©</label>
                        <select id="model" onchange="updateModelOptions()">
                            <option value="wan2.6-t2v">ğŸŒŸ wan2.6-t2vï¼ˆæœ‰å£°+å¤šé•œå¤´ï¼‰</option>
                            <option value="wan2.5-t2v-preview">ğŸŒŸ wan2.5-t2v-previewï¼ˆæœ‰å£°ï¼‰</option>
                            <option value="wan2.2-t2v-plus">wan2.2-t2v-plusï¼ˆä¸“ä¸šç‰ˆï¼‰</option>
                            <option value="wanx2.1-t2v-turbo">wanx2.1-t2v-turboï¼ˆæé€Ÿç‰ˆï¼‰</option>
                            <option value="wanx2.1-t2v-plus">wanx2.1-t2v-plusï¼ˆä¸“ä¸šç‰ˆï¼‰</option>
                        </select>
                        <small id="modelDesc">æ”¯æŒè‡ªåŠ¨é…éŸ³ã€å¤šé•œå¤´å™äº‹ï¼Œ720P/1080Pï¼Œ5/10/15ç§’</small>
                    </div>
                    
                    <div class="form-group">
                        <label>åˆ†è¾¨ç‡</label>
                        <select id="resolution">
                            <option value="720P">720P (1280Ã—720)</option>
                            <option value="1080P">1080P (1920Ã—1080)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>è§†é¢‘æ—¶é•¿</label>
                        <select id="duration">
                            <option value="5">5ç§’</option>
                            <option value="10">10ç§’</option>
                            <option value="15">15ç§’</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="shotTypeGroup">
                        <label>é•œå¤´ç±»å‹ <span style="color: #ff6b6b; font-size: 12px;">(ä»…wan2.6æ”¯æŒ)</span></label>
                        <select id="shotType">
                            <option value="single">å•é•œå¤´</option>
                            <option value="multi">å¤šé•œå¤´</option>
                        </select>
                    </div>
                </div>
                
                <!-- éŸ³é¢‘è®¾ç½® -->
                <div class="form-group" id="audioGroup">
                    <label>éŸ³é¢‘è®¾ç½®ï¼ˆå¯é€‰ï¼‰ <span style="color: #ff6b6b; font-size: 12px;">(ä»…wan2.5+æ”¯æŒ)</span></label>
                    <div class="audio-options">
                        <!-- è‡ªåŠ¨é…éŸ³å¼€å…³ -->
                        <label>
                            <input type="checkbox" id="audioToggle">
                            å¯ç”¨è‡ªåŠ¨é…éŸ³
                        </label>
                        
                        <!-- æˆ–ä¸Šä¼ è‡ªå®šä¹‰éŸ³é¢‘ -->
                        <div class="custom-audio-upload" style="margin-top: 10px;">
                            <input type="file" id="audioFile" accept=".wav,.mp3" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('audioFile').click()">
                                ğŸ“ ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
                            </button>
                            <span id="audioFileName" style="margin-left: 10px; font-size: 13px; color: #666;"></span>
                            <input type="hidden" id="audioUrl" value="">
                        </div>
                    </div>
                    <small>æ”¯æŒ WAVã€MP3 æ ¼å¼ï¼Œ3-30ç§’ï¼Œæœ€å¤§ 15MB</small>
                </div>
                
                <!-- åå‘æç¤ºè¯ -->
                <div class="form-group">
                    <label>åå‘æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="negativePrompt" placeholder="ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹...">
                </div>
                
                <div class="form-group">
                    <label>æ‰¹é‡ç”Ÿæˆæ•°é‡</label>
                    <select id="batchCount">
                        <option value="1" selected>1ä¸ªè§†é¢‘ï¼ˆæ¨èï¼‰</option>
                        <option value="2">2ä¸ªè§†é¢‘</option>
                        <option value="3">3ä¸ªè§†é¢‘</option>
                        <option value="4">4ä¸ªè§†é¢‘ï¼ˆæœ€å¤šï¼‰</option>
                    </select>
                    <small>ä¸€æ¬¡ç”Ÿæˆå¤šä¸ªç›¸åŒå‚æ•°çš„è§†é¢‘ï¼Œå¯ä»ä¸­æŒ‘é€‰æœ€ä½³æ•ˆæœ</small>
                </div>
                
                <button class="btn btn-primary btn-large btn-generate" onclick="createT2VTask()" id="createBtn">
                    <span class="btn-icon">âœ¨</span>
                    <span class="btn-text">å¼€å§‹ç”Ÿæˆ</span>
                </button>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šå†å²è®°å½• -->
        <div class="history-panel">
            <div class="history-header">
                <h2>å†å²è®°å½•</h2>
                <div class="history-actions">
                    <button class="btn btn-secondary btn-sm" onclick="toggleBatchMode()" id="batchModeBtn">
                        æ‰¹é‡é€‰æ‹©
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadSelected()" id="downloadBtn" style="display:none;">
                        ä¸‹è½½é€‰ä¸­ (<span id="selectedCount">0</span>)
                    </button>
                </div>
            </div>
            <div class="history-panel-wrapper">
                <div class="task-list-container">
                    <div id="taskList" class="task-list">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <!-- å³ä¾§ç¼©ç•¥å›¾å¿«é€Ÿå¯¼èˆª -->
                <div class="thumbnail-nav" id="thumbnailNav">
                    <div class="thumbnail-nav-header">å¿«é€Ÿå¯¼èˆª (<span id="thumbNavCount">0</span>)</div>
                    <div class="thumbnail-nav-list" id="thumbnailNavList">
                        <div class="thumbnail-nav-empty">æš‚æ— å·²å®Œæˆ<br>çš„è§†é¢‘</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è§†é¢‘æ”¾å¤§æµ®å±‚ -->
<div class="video-modal" id="videoModal" onclick="closeVideoModal()">
    <div class="video-modal-content" onclick="event.stopPropagation()">
        <button class="video-modal-close" onclick="closeVideoModal()">&times;</button>
        <video id="modalVideo" controls autoplay></video>
    </div>
</div>

<!-- Batch video processing script -->
<script src="/static/batch-video.js"></script>
<script src="/static/common.js"></script>
<script src="/static/thumbnail-nav.js"></script>
<script>
// é¡µé¢çŠ¶æ€
let t2vPollingIntervals = new Map();
let batchModeEnabled = false;
let selectedVideos = new Set();

// ä¸åŒæ¨¡å‹çš„é…ç½®
const modelConfigs = {
    'wan2.6-t2v': {
        desc: 'æ”¯æŒè‡ªåŠ¨é…éŸ³ã€å¤šé•œå¤´å™äº‹ï¼Œ720P/1080Pï¼Œ5/10/15ç§’',
        resolutions: ['720P', '1080P'],
        durations: [5, 10, 15],
        supportAudio: true,
        supportMultiShot: true
    },
    'wan2.5-t2v-preview': {
        desc: 'æ”¯æŒè‡ªåŠ¨é…éŸ³ï¼Œ480P/720P/1080Pï¼Œ5/10ç§’',
        resolutions: ['480P', '720P', '1080P'],
        durations: [5, 10],
        supportAudio: true,
        supportMultiShot: false
    },
    'wan2.2-t2v-plus': {
        desc: 'ä¸“ä¸šç‰ˆï¼Œ480P/1080Pï¼Œ5ç§’ï¼Œé€Ÿåº¦æå‡50%',
        resolutions: ['480P', '1080P'],
        durations: [5],
        supportAudio: false,
        supportMultiShot: false
    },
    'wanx2.1-t2v-turbo': {
        desc: 'æé€Ÿç‰ˆï¼Œ480P/720Pï¼Œ5ç§’',
        resolutions: ['480P', '720P'],
        durations: [5],
        supportAudio: false,
        supportMultiShot: false
    },
    'wanx2.1-t2v-plus': {
        desc: 'ä¸“ä¸šç‰ˆï¼Œ720Pï¼Œ5ç§’',
        resolutions: ['720P'],
        durations: [5],
        supportAudio: false,
        supportMultiShot: false
    }
};

// æ ¹æ®æ¨¡å‹æ›´æ–°å¯ç”¨é€‰é¡¹
function updateModelOptions() {
    const model = document.getElementById('model').value;
    const config = modelConfigs[model];
    
    // æ›´æ–°æ¨¡å‹æè¿°
    document.getElementById('modelDesc').textContent = config.desc;
    
    // æ›´æ–°åˆ†è¾¨ç‡é€‰é¡¹
    const resolutionSelect = document.getElementById('resolution');
    const currentResolution = resolutionSelect.value;
    resolutionSelect.innerHTML = '';
    
    const resolutionLabels = {
        '480P': '480P (832Ã—480)',
        '720P': '720P (1280Ã—720)',
        '1080P': '1080P (1920Ã—1080)'
    };
    
    config.resolutions.forEach(res => {
        const option = document.createElement('option');
        option.value = res;
        option.textContent = resolutionLabels[res];
        resolutionSelect.appendChild(option);
    });
    
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼Œå¦‚æœä¸æ”¯æŒåˆ™é€‰ç¬¬ä¸€ä¸ª
    if (config.resolutions.includes(currentResolution)) {
        resolutionSelect.value = currentResolution;
    }
    
    // æ›´æ–°æ—¶é•¿é€‰é¡¹
    const durationSelect = document.getElementById('duration');
    const currentDuration = parseInt(durationSelect.value);
    durationSelect.innerHTML = '';
    
    config.durations.forEach(dur => {
        const option = document.createElement('option');
        option.value = dur;
        option.textContent = `${dur}ç§’`;
        durationSelect.appendChild(option);
    });
    
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
    if (config.durations.includes(currentDuration)) {
        durationSelect.value = currentDuration;
    }
    
    // æ˜¾ç¤º/éšè—éŸ³é¢‘è®¾ç½®
    const audioGroup = document.getElementById('audioGroup');
    if (config.supportAudio) {
        audioGroup.style.display = 'block';
    } else {
        audioGroup.style.display = 'none';
        // é‡ç½®éŸ³é¢‘è®¾ç½®
        document.getElementById('audioToggle').checked = false;
        document.getElementById('audioUrl').value = '';
        document.getElementById('audioFileName').textContent = '';
    }
    
    // æ˜¾ç¤º/éšè—é•œå¤´ç±»å‹
    const shotTypeGroup = document.getElementById('shotTypeGroup');
    if (config.supportMultiShot) {
        shotTypeGroup.style.display = 'block';
    } else {
        shotTypeGroup.style.display = 'none';
        // é‡ç½®ä¸ºå•é•œå¤´
        document.getElementById('shotType').value = 'single';
    }
}

// é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
window.addEventListener('load', function() {
    updateModelOptions(); // åˆå§‹åŒ–æ¨¡å‹é€‰é¡¹
    loadT2VTasks();
    
    // åˆå§‹åŒ–ç¼©ç•¥å›¾å¯¼èˆª
    ThumbnailNav.init({
        apiEndpoint: '/api/t2v-thumbnails',
        mediaType: 'video',
        itemsPerPage: 50,
        enableBatchSupport: true
    });
});

// éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤„ç†
document.getElementById('audioFile').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // éªŒè¯æ–‡ä»¶
    if (file.size > 15 * 1024 * 1024) {
        showAlert('éŸ³é¢‘æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ15MB', 'error');
        return;
    }
    
    const ext = file.name.split('.').pop().toLowerCase();
    if (!['wav', 'mp3'].includes(ext)) {
        showAlert('ä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼ï¼Œä»…æ”¯æŒ WAV å’Œ MP3', 'error');
        return;
    }
    
    // æ˜¾ç¤ºæ–‡ä»¶å
    document.getElementById('audioFileName').textContent = file.name;
    
    // ä¸Šä¼ æ–‡ä»¶
    const formData = new FormData();
    formData.append('audio', file);
    
    try {
        const response = await fetch('/api/upload-audio', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('audioUrl').value = data.oss_url;
            showAlert('éŸ³é¢‘ä¸Šä¼ æˆåŠŸ', 'success');
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
    }
});

// åˆ›å»ºT2Vä»»åŠ¡
async function createT2VTask() {
    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt) {
        showAlert('è¯·è¾“å…¥æç¤ºè¯', 'error');
        return;
    }
    
    const requestBody = {
        prompt: prompt,
        model: document.getElementById('model').value,
        resolution: document.getElementById('resolution').value,
        duration: parseInt(document.getElementById('duration').value),
        shot_type: document.getElementById('shotType').value,
        audio: document.getElementById('audioToggle').checked,
        audio_url: document.getElementById('audioUrl').value,
        negative_prompt: document.getElementById('negativePrompt').value,
        batch_count: parseInt(document.getElementById('batchCount').value)
    };
    
    const btn = document.getElementById('createBtn');
    const btnIcon = btn.querySelector('.btn-icon');
    const btnText = btn.querySelector('.btn-text');
    
    btn.disabled = true;
    btnIcon.textContent = 'â³';
    btnText.textContent = 'åˆ›å»ºä¸­...';
    
    try {
        const response = await fetch('/api/create-t2v-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'ä»»åŠ¡åˆ›å»ºæˆåŠŸ', 'success');
            loadT2VTasks();
            
            // ä¸ºæ‰¹é‡ä»»åŠ¡å¼€å§‹è½®è¯¢
            if (data.tasks) {
                data.tasks.forEach(task => {
                    startT2VPolling(task.task_id);
                });
            }
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btnIcon.textContent = 'âœ¨';
        btnText.textContent = 'å¼€å§‹ç”Ÿæˆ';   
    }
}

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
async function loadT2VTasks() {
    try {
        const response = await fetch('/api/t2v-tasks?page=1&limit=20');
        const data = await response.json();
        
        if (data.success) {
            renderT2VTasks(data.tasks);
            
            // æ›´æ–°ç¼©ç•¥å›¾å¯¼èˆª
            updateThumbnailNav();
            
            // ä¸ºè¿›è¡Œä¸­çš„ä»»åŠ¡å¯åŠ¨è½®è¯¢
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startT2VPolling(task.task_id);
                }
            });
        }
    } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
    }
}

// æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
function renderT2VTasks(tasks) {
    const taskList = document.getElementById('taskList');
    
    if (tasks.length === 0) {
        taskList.innerHTML = '<div class="loading">æš‚æ— å†å²è®°å½•</div>';
        return;
    }
    
    taskList.innerHTML = tasks.map(task => {
        const statusClass = `status-${(task.task_status || 'PENDING').toLowerCase()}`;
        const statusText = getStatusText(task.task_status || 'PENDING');
        
        return `
            <div class="task-item" id="task-${task.task_id}">
                <div class="task-header">
                    <span class="task-id" onclick="copyToClipboard('${task.task_id}')" title="ç‚¹å‡»å¤åˆ¶">${task.task_id}</span>
                    <div class="task-actions">
                        <span class="task-status ${statusClass}">${statusText}</span>
                        ${batchModeEnabled ? `
                            <input type="checkbox" class="batch-checkbox" data-task-id="${task.task_id}" 
                                   data-video-url="${task.local_video_path || ''}" 
                                   onchange="updateSelectedCount()">
                        ` : ''}
                    </div>
                </div>
                
                <div class="task-content">
                    <div class="task-info">
                        <p><strong>æ¨¡å‹:</strong> ${task.model}</p>
                        <p><strong>åˆ†è¾¨ç‡:</strong> ${task.resolution}</p>
                        <p><strong>æ—¶é•¿:</strong> ${task.duration}ç§’</p>
                        <p><strong>é•œå¤´:</strong> ${task.shot_type === 'single' ? 'å•é•œå¤´' : 'å¤šé•œå¤´'}</p>
                        ${task.prompt ? `<p><strong>æç¤ºè¯:</strong> ${task.prompt}</p>` : ''}
                        ${task.created_at ? `<p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(task.created_at).toLocaleString('zh-CN')}</p>` : ''}
                        ${task.task_status === 'FAILED' && task.message ? `<div class="error-message">âš  ${task.message}</div>` : ''}
                    </div>
                </div>
                
                ${task.task_status === 'SUCCEEDED' && task.local_video_path ? `
                    <div class="video-result">
                        <video src="${task.local_video_path}" controls onclick="openVideoModal('${task.local_video_path}')"></video>
                        <div class="video-actions">
                            <button class="btn btn-sm btn-secondary" onclick="regenerateT2VTask('${task.task_id}')" title="é‡æ–°ç”Ÿæˆ">
                                ğŸ”„ é‡æ–°ç”Ÿæˆ
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="downloadVideo('${task.local_video_path}', 'video_${task.task_id}.mp4')" title="ä¸‹è½½è§†é¢‘">
                                ğŸ’¾ ä¸‹è½½
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="saveToAssets('${task.task_id}', '${task.local_video_path}')" title="ä¿å­˜åˆ°èµ„äº§åº“">
                                ğŸ“ ä¿å­˜åˆ°èµ„äº§åº“
                            </button>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
function startT2VPolling(taskId) {
    if (t2vPollingIntervals.has(taskId)) {
        return;
    }
    
    let consecutiveFailures = 0;  // è¿ç»­å¤±è´¥è®¡æ•°
    const MAX_FAILURES = 3;  // æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°
    
    const intervalId = setInterval(async () => {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);  // 8ç§’è¶…æ—¶
            
            const response = await fetch(`/api/t2v-task/${taskId}`, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            const data = await response.json();
            
            if (data.success && data.task) {
                consecutiveFailures = 0;  // æˆåŠŸåé‡ç½®å¤±è´¥è®¡æ•°
                updateTaskStatus(taskId, data.task);
                
                if (data.task.task_status === 'SUCCEEDED' || data.task.task_status === 'FAILED') {
                    clearInterval(intervalId);
                    t2vPollingIntervals.delete(taskId);
                }
            } else {
                consecutiveFailures++;
                if (consecutiveFailures >= MAX_FAILURES) {
                    console.error(`ä»»åŠ¡ ${taskId} è¿ç»­æŸ¥è¯¢å¤±è´¥ ${MAX_FAILURES} æ¬¡ï¼Œåœæ­¢è½®è¯¢`);
                    clearInterval(intervalId);
                    t2vPollingIntervals.delete(taskId);
                    
                    // åœ¨UIä¸Šæ ‡è®°ä¸ºæŸ¥è¯¢å¤±è´¥
                    const taskElement = document.getElementById(`task-${taskId}`);
                    if (taskElement) {
                        const statusSpan = taskElement.querySelector('.task-status');
                        if (statusSpan) {
                            statusSpan.className = 'task-status status-failed';
                            statusSpan.textContent = 'æŸ¥è¯¢å¤±è´¥';
                        }
                    }
                }
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error('æŸ¥è¯¢ä»»åŠ¡è¶…æ—¶:', taskId);
            } else {
                console.error('è½®è¯¢ä»»åŠ¡å¤±è´¥:', error);
            }
            
            consecutiveFailures++;
            if (consecutiveFailures >= MAX_FAILURES) {
                console.error(`ä»»åŠ¡ ${taskId} è¿ç»­æŸ¥è¯¢å¤±è´¥ ${MAX_FAILURES} æ¬¡ï¼Œåœæ­¢è½®è¯¢`);
                clearInterval(intervalId);
                t2vPollingIntervals.delete(taskId);
                
                // åœ¨UIä¸Šæ ‡è®°ä¸ºæŸ¥è¯¢å¤±è´¥
                const taskElement = document.getElementById(`task-${taskId}`);
                if (taskElement) {
                    const statusSpan = taskElement.querySelector('.task-status');
                    if (statusSpan) {
                        statusSpan.className = 'task-status status-failed';
                        statusSpan.textContent = 'æŸ¥è¯¢å¤±è´¥';
                    }
                }
            }
        }
    }, 15000); // 15ç§’è½®è¯¢ä¸€æ¬¡
    
    t2vPollingIntervals.set(taskId, intervalId);
}

// æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆå¢é‡æ›´æ–°ï¼Œä¸åˆ·æ–°æ•´ä¸ªåˆ—è¡¨ï¼‰
function updateTaskStatus(taskId, taskData) {
    const taskElement = document.getElementById(`task-${taskId}`);
    if (!taskElement) return;
    
    // æ›´æ–°çŠ¶æ€æ ‡ç­¾
    const statusSpan = taskElement.querySelector('.task-status');
    if (statusSpan) {
        statusSpan.className = 'task-status';
        statusSpan.classList.add(`status-${(taskData.task_status || 'PENDING').toLowerCase()}`);
        statusSpan.textContent = getStatusText(taskData.task_status || 'PENDING');
    }
    
    // å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    if (taskData.task_status === 'FAILED' && taskData.message) {
        const taskInfo = taskElement.querySelector('.task-info');
        if (taskInfo && !taskInfo.querySelector('.error-message')) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `âš  ${taskData.message}`;
            taskInfo.appendChild(errorDiv);
        }
    }
    
    // å¦‚æœæˆåŠŸä¸”æœ‰è§†é¢‘ï¼Œæ·»åŠ è§†é¢‘é¢„è§ˆ
    if (taskData.task_status === 'SUCCEEDED' && taskData.local_video_path) {
        let videoResult = taskElement.querySelector('.video-result');
        if (!videoResult) {
            videoResult = document.createElement('div');
            videoResult.className = 'video-result';
            taskElement.appendChild(videoResult);
        }
        
        if (!videoResult.querySelector('video')) {
            videoResult.innerHTML = `
                <video src="${taskData.local_video_path}" 
                       controls 
                       onclick="openVideoModal('${taskData.local_video_path}')"></video>
            `;
        }
    }
}

function getStatusText(status) {
    const statusMap = {
        'PENDING': 'ç­‰å¾…ä¸­',
        'RUNNING': 'ç”Ÿæˆä¸­',
        'SUCCEEDED': 'å·²å®Œæˆ',
        'FAILED': 'å¤±è´¥',
        'CANCELED': 'å·²å–æ¶ˆ',
        'UNKNOWN': 'æœªçŸ¥'
    };
    return statusMap[status] || status;
}

function toggleBatchMode() {
    batchModeEnabled = !batchModeEnabled;
    const btn = document.getElementById('batchModeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    
    if (batchModeEnabled) {
        btn.textContent = 'å–æ¶ˆé€‰æ‹©';
        downloadBtn.style.display = 'inline-block';
    } else {
        btn.textContent = 'æ‰¹é‡é€‰æ‹©';
        downloadBtn.style.display = 'none';
        selectedVideos.clear();
        document.getElementById('selectedCount').textContent = '0';
    }
}

async function downloadSelected() {
    if (selectedVideos.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'error');
        return;
    }
    
    showAlert(`å¼€å§‹ä¸‹è½½ ${selectedVideos.size} ä¸ªè§†é¢‘...`, 'success');
    
    let downloadCount = 0;
    for (const taskId of selectedVideos) {
        const checkbox = document.querySelector(`.batch-checkbox[data-task-id="${taskId}"]`);
        if (checkbox && checkbox.dataset.videoUrl) {
            const videoUrl = checkbox.dataset.videoUrl;
            downloadVideo(videoUrl, `video_${taskId}.mp4`);
            downloadCount++;
            await new Promise(resolve => setTimeout(resolve, 500)); // å»¶è¿Ÿé¿å…æµè§ˆå™¨é™åˆ¶
        }
    }
    
    if (downloadCount > 0) {
        showAlert(`å·²å¯åŠ¨ ${downloadCount} ä¸ªè§†é¢‘ä¸‹è½½`, 'success');
    }
}

function downloadVideo(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function updateSelectedCount() {
    selectedVideos.clear();
    document.querySelectorAll('.batch-checkbox:checked').forEach(checkbox => {
        selectedVideos.add(checkbox.dataset.taskId);
    });
    document.getElementById('selectedCount').textContent = selectedVideos.size;
}

// é‡æ–°ç”Ÿæˆæ–‡ç”Ÿè§†é¢‘ä»»åŠ¡
async function regenerateT2VTask(taskId) {
    if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆæ­¤è§†é¢‘å—ï¼Ÿå°†ä½¿ç”¨ç›¸åŒçš„å‚æ•°åˆ›å»ºæ–°ä»»åŠ¡ã€‚')) {
        return;
    }
    
    try {
        const response = await fetch('/api/regenerate-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                task_id: taskId,
                task_type: 't2v'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡æˆåŠŸ', 'success');
            loadT2VTasks();
            
            // å¼€å§‹è½®è¯¢æ–°ä»»åŠ¡
            if (data.tasks) {
                data.tasks.forEach(task => {
                    startT2VPolling(task.task_id);
                });
            }
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
    }
}

// ä¿å­˜åˆ°èµ„äº§åº“
async function saveToAssets(taskId, videoPath) {
    try {
        const filename = videoPath.split('/').pop();
        
        const response = await fetch('/api/assets/save-from-output', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                source_type: 't2v',
                filename: filename,
                target_category: 'video',
                file_type: 'video'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('å·²ä¿å­˜åˆ°èµ„äº§åº“', 'success');
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
    }
}

function openVideoModal(videoUrl) {
    const modal = document.getElementById('videoModal');
    const video = document.getElementById('modalVideo');
    video.src = videoUrl;
    modal.style.display = 'flex';
}

function closeVideoModal() {
    const modal = document.getElementById('videoModal');
    const video = document.getElementById('modalVideo');
    modal.style.display = 'none';
    video.pause();
    video.src = '';
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showAlert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    });
}

// æç¤ºè¯ä¼˜åŒ–åŠŸèƒ½
function openOptimizeModal() {
    const promptInput = document.getElementById('prompt');
    const originalPrompt = promptInput.value.trim();

    if (!originalPrompt) {
        showAlert('è¯·å…ˆè¾“å…¥æç¤ºè¯', 'error');
        return;
    }

    // æ˜¾ç¤ºåŸå§‹æç¤ºè¯
    document.getElementById('originalPromptContent').textContent = originalPrompt;

    // æ˜¾ç¤ºæ‚¬æµ®çª—
    document.getElementById('optimizeModal').classList.add('active');

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const optimizedPromptDiv = document.querySelector('.optimized-prompt');
    const optimizedContent = document.getElementById('optimizedPromptContent');
    optimizedPromptDiv.classList.add('loading');
    optimizedContent.textContent = 'æ­£åœ¨ä¼˜åŒ–ä¸­...';

    // è°ƒç”¨åç«¯ API è¿›è¡Œæç¤ºè¯ä¼˜åŒ–
    fetch('/api/optimize-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prompt: originalPrompt,
            task_type: 'text2video'  // æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡ç±»å‹
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
        }
        
        // å¤„ç†æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        // æ¸…ç©ºå†…å®¹ï¼Œå‡†å¤‡æ¥æ”¶æµå¼æ•°æ®
        optimizedContent.textContent = '';
        optimizedPromptDiv.classList.remove('loading');
        
        function readStream() {
            reader.read().then(({done, value}) => {
                if (done) {
                    return;
                }
                
                // è§£ç æ•°æ®
                buffer += decoder.decode(value, {stream: true});
                
                // æŒ‰è¡Œåˆ†å‰²
                const lines = buffer.split('\n');
                buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                
                // å¤„ç†æ¯ä¸€è¡Œ
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6);
                        
                        if (data === '[DONE]') {
                            return;
                        }
                        
                        try {
                            // å°è¯•è§£æä¸º JSONï¼ˆå¯èƒ½æ˜¯é”™è¯¯æˆ– usage ä¿¡æ¯ï¼‰
                            const jsonData = JSON.parse(data);
                            if (jsonData.type === 'error') {
                                optimizedPromptDiv.classList.remove('loading');
                                optimizedContent.textContent = `ä¼˜åŒ–å¤±è´¥: ${jsonData.message}`;
                                showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
                                return;
                            }
                            // å¿½ç•¥ usage ä¿¡æ¯
                        } catch (e) {
                            // ä¸æ˜¯ JSONï¼Œæ˜¯æ™®é€šæ–‡æœ¬ï¼Œç›´æ¥è¿½åŠ æ˜¾ç¤º
                            optimizedContent.textContent += data;
                        }
                    }
                }
                
                // ç»§ç»­è¯»å–
                readStream();
            }).catch(error => {
                console.error('æµå¼è¯»å–é”™è¯¯:', error);
                optimizedPromptDiv.classList.remove('loading');
                optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•';
                showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
            });
        }
        
        readStream();
    })
    .catch(error => {
        console.error('ä¼˜åŒ–æç¤ºè¯å¤±è´¥:', error);
        optimizedPromptDiv.classList.remove('loading');
        optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•';
        showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
    });
}

function closeOptimizeModal() {
    document.getElementById('optimizeModal').classList.remove('active');
}

function applyOptimizedPrompt() {
    const optimizedText = document.getElementById('optimizedPromptContent').textContent;
    if (optimizedText && optimizedText !== 'æ­£åœ¨ä¼˜åŒ–ä¸­...') {
        document.getElementById('prompt').value = optimizedText;
        closeOptimizeModal();
        showAlert('å·²åº”ç”¨ä¼˜åŒ–åçš„æç¤ºè¯', 'success');
    }
}

// é‡æ–°ç”Ÿæˆä¼˜åŒ–åçš„æç¤ºè¯
function regenerateOptimizedPrompt() {
    const originalPrompt = document.getElementById('originalPromptContent').textContent;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const optimizedPromptDiv = document.querySelector('.optimized-prompt');
    const optimizedContent = document.getElementById('optimizedPromptContent');
    optimizedPromptDiv.classList.add('loading');
    optimizedContent.textContent = 'æ­£åœ¨é‡æ–°ç”Ÿæˆ...';

    // è°ƒç”¨åç«¯ API è¿›è¡Œæç¤ºè¯ä¼˜åŒ–
    fetch('/api/optimize-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prompt: originalPrompt,
            task_type: 'text2video'  // æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡ç±»å‹
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
        }
        
        // å¤„ç†æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        // æ¸…ç©ºå†…å®¹ï¼Œå‡†å¤‡æ¥æ”¶æµå¼æ•°æ®
        optimizedContent.textContent = '';
        optimizedPromptDiv.classList.remove('loading');
        
        function readStream() {
            reader.read().then(({done, value}) => {
                if (done) {
                    return;
                }
                
                // è§£ç æ•°æ®
                buffer += decoder.decode(value, {stream: true});
                
                // æŒ‰è¡Œåˆ†å‰²
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                // å¤„ç†æ¯ä¸€è¡Œ
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6);
                        
                        if (data === '[DONE]') {
                            return;
                        }
                        
                        try {
                            const jsonData = JSON.parse(data);
                            if (jsonData.type === 'error') {
                                optimizedPromptDiv.classList.remove('loading');
                                optimizedContent.textContent = `ä¼˜åŒ–å¤±è´¥: ${jsonData.message}`;
                                showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
                                return;
                            }
                        } catch (e) {
                            optimizedContent.textContent += data;
                        }
                    }
                }
                
                readStream();
            }).catch(error => {
                console.error('æµå¼è¯»å–é”™è¯¯:', error);
                optimizedPromptDiv.classList.remove('loading');
                optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•';
                showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
            });
        }
        
        readStream();
    })
    .catch(error => {
        console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
        optimizedPromptDiv.classList.remove('loading');
        optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•';
        showAlert('æç¤ºè¯ä¼˜åŒ–å¤±è´¥', 'error');
    });
}

// ========== ç¼©ç•¥å›¾å¿«é€Ÿå¯¼èˆªåŠŸèƒ½ ==========

let thumbNavCurrentPage = 1;
const THUMB_NAV_ITEMS_PER_PAGE = 8;
let allCompletedTasks = [];

function updateThumbnailNav() {
    const taskItems = document.querySelectorAll('.task-item');
    allCompletedTasks = [];
    
    taskItems.forEach((item, index) => {
        const taskId = item.id.replace('task-', '');
        const video = item.querySelector('.video-result video');
        
        if (video) {
            allCompletedTasks.push({
                taskId: taskId,
                type: 'video',
                posterUrl: video.src,
                mediaUrl: video.src,
                index: index
            });
        }
    });
    
    renderThumbnailNavPage();
}

function renderThumbnailNavPage() {
    const navList = document.getElementById('thumbnailNavList');
    const pageInfo = document.getElementById('thumbPageInfo');
    const prevBtn = document.getElementById('thumbPrevBtn');
    const nextBtn = document.getElementById('thumbNextBtn');
    
    if (!navList) return;
    
    const totalItems = allCompletedTasks.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / THUMB_NAV_ITEMS_PER_PAGE));
    thumbNavCurrentPage = Math.max(1, Math.min(thumbNavCurrentPage, totalPages));
    
    if (totalItems === 0) {
        navList.innerHTML = '<div class="thumbnail-nav-empty">æš‚æ— å·²å®Œæˆ<br>çš„è§†é¢‘</div>';
        pageInfo.textContent = '0/0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }
    
    const startIdx = (thumbNavCurrentPage - 1) * THUMB_NAV_ITEMS_PER_PAGE;
    const endIdx = Math.min(startIdx + THUMB_NAV_ITEMS_PER_PAGE, totalItems);
    const pageItems = allCompletedTasks.slice(startIdx, endIdx);
    
    navList.innerHTML = pageItems.map((item, idx) => {
        const globalIdx = startIdx + idx + 1;
        return `
            <div class="thumbnail-nav-item" 
                 data-task-id="${item.taskId}"
                 onclick="scrollToTask('${item.taskId}')">
                <video src="${item.mediaUrl}" muted preload="metadata"></video>
                <span class="thumb-index">${globalIdx}</span>
                <span class="thumb-type">è§†é¢‘</span>
            </div>
        `;
    }).join('');
    
    pageInfo.textContent = `${thumbNavCurrentPage}/${totalPages}`;
    prevBtn.disabled = thumbNavCurrentPage <= 1;
    nextBtn.disabled = thumbNavCurrentPage >= totalPages;
}

function thumbNavPrevPage() {
    if (thumbNavCurrentPage > 1) {
        thumbNavCurrentPage--;
        renderThumbnailNavPage();
    }
}

function thumbNavNextPage() {
    const totalPages = Math.ceil(allCompletedTasks.length / THUMB_NAV_ITEMS_PER_PAGE);
    if (thumbNavCurrentPage < totalPages) {
        thumbNavCurrentPage++;
        renderThumbnailNavPage();
    }
}

function scrollToTask(taskId) {
    const taskItem = document.getElementById(`task-${taskId}`);
    if (taskItem) {
        taskItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        taskItem.style.transition = 'box-shadow 0.3s, transform 0.3s';
        taskItem.style.boxShadow = '0 0 0 3px #1664ff, 0 4px 12px rgba(22, 100, 255, 0.3)';
        taskItem.style.transform = 'scale(1.01)';
        setTimeout(() => {
            taskItem.style.boxShadow = '';
            taskItem.style.transform = '';
        }, 1500);
        
        document.querySelectorAll('.thumbnail-nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-task-id') === taskId) {
                item.classList.add('active');
            }
        });
    }
}
</script>

<!-- æç¤ºè¯ä¼˜åŒ–æ‚¬æµ®çª— -->
<div id="optimizeModal" class="optimize-modal">
    <div class="optimize-modal-content">
        <div class="optimize-modal-header">
            <h3>AI æç¤ºè¯ä¼˜åŒ– <small style="font-size: 0.7em; color: #666; font-weight: normal;">å»ºè®®å…³é—­æ™ºèƒ½æ”¹å†™</small></h3>
            <button class="optimize-modal-close" onclick="closeOptimizeModal()">&times;</button>
        </div>
        <div class="optimize-modal-body">
            <div class="original-prompt">
                <h4>åŸå§‹æç¤ºè¯</h4>
                <div class="prompt-content" id="originalPromptContent"></div>
            </div>
            <div class="optimized-prompt">
                <h4>ä¼˜åŒ–åçš„æç¤ºè¯</h4>
                <div class="prompt-content" id="optimizedPromptContent"></div>
            </div>
        </div>
        <div class="optimize-modal-footer">
            <button class="btn btn-secondary" onclick="closeOptimizeModal()">å–æ¶ˆ</button>
            <button class="btn btn-regenerate" onclick="regenerateOptimizedPrompt()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
            <button class="btn btn-primary" onclick="applyOptimizedPrompt()">ç«‹å³ä½¿ç”¨</button>
        </div>
    </div>
</div>

{% endblock %}