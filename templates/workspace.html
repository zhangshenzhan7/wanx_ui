{% extends "base.html" %}

{% block title %}é€šä¹‰ä¸‡ç›¸ - å·¥ä½œåŒº{% endblock %}

{% block extra_css %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
{% endblock %}

{% block extra_js %}
<script src="/static/thumbnail-nav.js"></script>
{% endblock %}

{% block body %}
<div class="workspace-container">
    <div class="workspace-header">
        <h1>ğŸ¬ é€šä¹‰ä¸‡ç›¸å›¾ç”Ÿè§†é¢‘</h1>
        <div>
            <button class="btn btn-secondary" onclick="window.location.href='/assets'" style="margin-right: 10px;">ğŸ“ èµ„äº§åº“</button>
            <button class="btn btn-secondary active" style="margin-right: 10px;">å›¾ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2video'" style="margin-right: 10px;">æ–‡ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/kf2v'" style="margin-right: 10px;">é¦–å°¾å¸§ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/reference2video'" style="margin-right: 10px;">å‚è€ƒç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2image'" style="margin-right: 10px;">æ–‡ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/image2image'" style="margin-right: 10px;">å›¾ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/voice-clone'" style="margin-right: 10px;">è¯­éŸ³å¤åˆ»</button>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </div>
    </div>
    
    <div class="workspace-content">
        <!-- å·¦ä¾§ï¼šåˆ›å»ºä»»åŠ¡ -->
        <div class="create-panel">
            <h2>åˆ›å»ºæ–°ä»»åŠ¡</h2>
            
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <div class="upload-placeholder">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ é¦–å¸§å›¾ç‰‡</p>
                        <small>æ”¯æŒ JPGã€PNGã€BMPã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MB</small>
                    </div>
                    <img id="imagePreview" style="display: none;">
                </div>
                <div class="upload-actions" style="margin-top: 10px; text-align: center;">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="openAssetPicker({ title: 'ä»èµ„äº§åº“é€‰æ‹©å›¾ç‰‡', targetType: 'i2v', onSelect: handleAssetSelect })">
                        ğŸ“ ä»èµ„äº§åº“é€‰æ‹©
                    </button>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-group">
                    <label>æ¨¡å‹é€‰æ‹©</label>
                    <select id="model">
                        <option value="wan2.6-i2v">wan2.6-i2v (æ¨èï¼Œæ”¯æŒéŸ³é¢‘)</option>
                        <option value="wan2.5-i2v-preview">wan2.5-i2v-preview</option>
                        <option value="wan2.2-i2v-flash">wan2.2-i2v-flash (æé€Ÿç‰ˆ)</option>
                        <option value="wan2.2-i2v-plus">wan2.2-i2v-plus (ä¸“ä¸šç‰ˆ)</option>
                        <option value="wanx2.1-i2v-plus">wanx2.1-i2v-plus</option>
                        <option value="wanx2.1-i2v-turbo">wanx2.1-i2v-turbo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <div class="prompt-label-wrapper">
                        <label>æç¤ºè¯</label>
                        <button type="button" class="btn-optimize" id="optimizeBtn" onclick="openOptimizeModal()" disabled title="è¯·å…ˆä¸Šä¼ å›¾ç‰‡">
                            <span class="icon">âœ¨</span>
                            <span>æç¤ºè¯ä¼˜åŒ–</span>
                        </button>
                    </div>
                    <textarea id="prompt" rows="4" placeholder="æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆ†è¾¨ç‡</label>
                        <select id="resolution">
                            <option value="720P">720P</option>
                            <option value="1080P">1080P</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>æ—¶é•¿ï¼ˆç§’ï¼‰</label>
                        <select id="duration">
                            <option value="5">5ç§’</option>
                            <option value="10">10ç§’</option>
                            <option value="15">15ç§’</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="shotTypeGroup">
                    <label>é•œå¤´ç±»å‹ <span style="color: #ff6b6b; font-size: 12px;">(ä»… wan2.6-i2v ä¸”å¯ç”¨æ™ºèƒ½æ”¹å†™æ—¶ç”Ÿæ•ˆ)</span></label>
                    <select id="shotType">
                        <option value="single">å•é•œå¤´</option>
                        <option value="multi">å¤šé•œå¤´</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>æ‰¹é‡ç”Ÿæˆæ•°é‡</label>
                    <select id="batchCount">
                        <option value="1" selected>1ä¸ªè§†é¢‘ï¼ˆæ¨èï¼‰</option>
                        <option value="2">2ä¸ªè§†é¢‘</option>
                        <option value="3">3ä¸ªè§†é¢‘</option>
                        <option value="4">4ä¸ªè§†é¢‘ï¼ˆæœ€å¤šï¼‰</option>
                    </select>
                    <small>ä¸€æ¬¡ç”Ÿæˆå¤šä¸ªç›¸åŒå‚æ•°çš„è§†é¢‘ï¼Œå¯ä»ä¸­æŒ‘é€‰æœ€ä½³æ•ˆæœ</small>
                </div>
                
                <div class="form-group" id="audioUploadGroup">
                    <label>éŸ³é¢‘è®¾ç½®ï¼ˆå¯é€‰ï¼‰</label>
                    <div class="audio-upload-section">
                        <!-- éŸ³é¢‘æ–‡ä»¶ä¸Šä¼  -->
                        <div class="audio-upload-area">
                            <input type="file" id="audioFileInput" accept=".wav,.mp3" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('audioFileInput').click()">
                                ğŸ“ ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
                            </button>
                            <span id="audioFileName" class="audio-file-name"></span>
                        </div>
                        
                        <!-- åˆ†éš”çº¿ -->
                        <div class="audio-divider">
                            <span>æˆ–</span>
                        </div>
                        
                        <!-- å½•éŸ³åŠŸèƒ½ -->
                        <div class="audio-record-area">
                            <button type="button" class="btn btn-secondary" id="recordBtn" onclick="toggleRecording()">
                                <span id="recordIcon">ğŸ¤</span>
                                <span id="recordText">å¼€å§‹å½•éŸ³</span>
                            </button>
                            <span id="recordDuration" class="record-duration"></span>
                        </div>
                        
                        <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
                        <div id="audioPlayerArea" class="audio-player-area" style="display: none;">
                            <audio id="audioPlayer" controls></audio>
                            <button type="button" class="btn btn-danger btn-sm" onclick="clearAudio()">
                                âœ• æ¸…é™¤éŸ³é¢‘
                            </button>
                        </div>
                        
                        <!-- éšè—çš„éŸ³é¢‘URLå­—æ®µ -->
                        <input type="hidden" id="audioUrl" value="">
                    </div>
                    <small>æ”¯æŒ WAVã€MP3 æ ¼å¼ï¼Œ3-30ç§’ï¼Œæœ€å¤§ 15MBã€‚ä»… wan2.6-i2v å’Œ wan2.5-i2v-preview æ¨¡å‹æ”¯æŒ</small>
                </div>
                
                <div class="form-group" id="audioToggleGroup">
                    <label>
                        <input type="checkbox" id="audioToggle" >
                        å¯ç”¨è‡ªåŠ¨é…éŸ³
                    </label>
                    <small>ä»… wan2.6-i2v å’Œ wan2.5-i2v-preview æ¨¡å‹æ”¯æŒï¼Œå¦‚ä¸Šä¼ äº†éŸ³é¢‘URLåˆ™ä½¿ç”¨è‡ªå®šä¹‰éŸ³é¢‘</small>
                </div>
                
                <div class="form-group">
                    <label>åå‘æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="negativePrompt" placeholder="ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹...">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="promptExtend" >
                        å¯ç”¨æ™ºèƒ½æ”¹å†™
                    </label>
                </div>
                
                <button class="btn btn-primary btn-large btn-generate" onclick="createTask()" id="createBtn">
                    <span class="btn-icon">âœ¨</span>
                    <span class="btn-text">å¼€å§‹ç”Ÿæˆ</span>
                </button>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šå†å²è®°å½• -->
        <div class="history-panel">
            <div class="history-header">
                <h2>å†å²è®°å½•</h2>
                <div class="history-actions">
                    <button class="btn btn-secondary btn-sm" onclick="toggleBatchMode()" id="batchModeBtn">
                        æ‰¹é‡é€‰æ‹©
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadSelected()" id="downloadBtn" style="display:none;">
                        ä¸‹è½½é€‰ä¸­ (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="saveSelectedToAssets()" id="saveToAssetBtn" style="display:none;">
                        ğŸ“ ä¿å­˜åˆ°èµ„äº§åº“
                    </button>
                </div>
            </div>
            <div class="history-panel-wrapper">
                <div class="task-list-container">
                    <div id="taskList" class="task-list">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <!-- å³ä¾§ç¼©ç•¥å›¾å¿«é€Ÿå¯¼èˆª -->
                <div class="thumbnail-nav" id="thumbnailNav">
                    <div class="thumbnail-nav-header">å¿«é€Ÿå¯¼èˆª (<span id="thumbNavCount">0</span>)</div>
                    <div class="thumbnail-nav-list" id="thumbnailNavList">
                        <div class="thumbnail-nav-empty">æš‚æ— å·²å®Œæˆçš„è§†é¢‘</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è§†é¢‘æ”¾å¤§æµ®å±‚ -->
<div class="video-modal" id="videoModal" onclick="closeVideoModal()">
    <div class="video-modal-content" onclick="event.stopPropagation()">
        <button class="video-modal-close" onclick="closeVideoModal()">&times;</button>
        <video id="modalVideo" controls autoplay></video>
    </div>
</div>

<!-- å›¾ç‰‡è£å‰ªæ¨¡æ€æ¡† -->
<div class="custom-cropper-modal" id="cropperModal">
    <div class="cropper-modal-content">
        <div class="cropper-toolbar">
            <h3>è£å‰ªå›¾ç‰‡</h3>
            <div class="aspect-ratio-group">
                <button class="aspect-ratio-btn" data-ratio="free">è‡ªå®šä¹‰</button>
                <button class="aspect-ratio-btn" data-ratio="16:9">16:9</button>
                <button class="aspect-ratio-btn" data-ratio="9:16">9:16</button>
                <button class="aspect-ratio-btn" data-ratio="4:3">4:3</button>
                <button class="aspect-ratio-btn" data-ratio="3:4">3:4</button>
                <button class="aspect-ratio-btn" data-ratio="1:1">1:1</button>
            </div>
        </div>
        <div class="cropper-container">
            <img id="cropperImage" src="" alt="å¾…è£å‰ªå›¾ç‰‡">
        </div>
        <div class="cropper-actions">
            <button class="btn btn-secondary" id="cropperCancelBtn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="cropperConfirmBtn">ç¡®è®¤è£å‰ª</button>
        </div>
    </div>
</div>

<style>
/* workspace é¡µé¢ç‰¹æœ‰æ ·å¼ */
/* éŸ³é¢‘ä¸Šä¼ å’Œå½•éŸ³åŒºåŸŸæ ·å¼ */
.audio-upload-section {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 10px;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
}

.audio-upload-area,
.audio-record-area {
    display: flex;
    align-items: center;
    gap: 10px;
}

.audio-file-name {
    font-size: 13px;
    color: #666;
    font-style: italic;
}

.audio-divider {
    text-align: center;
    position: relative;
    margin: 5px 0;
}

.audio-divider::before,
.audio-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: #ddd;
}

.audio-divider::before {
    left: 0;
}

.audio-divider::after {
    right: 0;
}

.audio-divider span {
    background: #f9f9f9;
    padding: 0 10px;
    color: #999;
    font-size: 12px;
}

.record-duration {
    font-family: monospace;
    font-size: 14px;
    color: #666;
    min-width: 60px;
}

.audio-player-area {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: white;
    border-radius: 8px;
}

.audio-player-area audio {
    flex: 1;
    height: 30px;
}

#recordBtn.recording {
    background: #dc3545;
    border-color: #dc3545;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

.btn-large {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    margin-top: 10px;
}

/* ä¼˜åŒ–çš„ç”ŸæˆæŒ‰é’®æ ·å¼ - çº¯è‰²ç‰ˆæœ¬ */
.btn-generate {
    position: relative;
    background: #1664ff;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(22, 100, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-generate:hover {
    background: #0e4fc3;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(22, 100, 255, 0.4);
}

.btn-generate:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(22, 100, 255, 0.3);
}

.btn-generate:disabled {
    background: #94b8ff;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-generate .btn-icon {
    display: inline-block;
    font-size: 18px;
    animation: sparkle 2s ease-in-out infinite;
}

.btn-generate:disabled .btn-icon {
    animation: spin 1s linear infinite;
}

@keyframes sparkle {
    0%, 100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
    }
    50% {
        transform: scale(1.2) rotate(180deg);
        opacity: 0.8;
    }
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.task-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    height: calc(100vh - 250px);
    overflow-y: auto;
    padding-bottom: 20px;
}

/* åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨ */
.load-more-indicator {
    text-align: center;
    padding: 15px;
    color: #666;
    font-size: 14px;
}

.load-more-indicator.loading::after {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #ccc;
    border-top-color: #1664ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 8px;
    vertical-align: middle;
}

.task-item {
    border: 1px solid #e8eaed;
    border-radius: 8px;
    padding: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    background: #ffffff;
}

.task-item:hover {
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    border-color: #1664ff;
    transform: translateY(-2px);
}

.task-item.batch-mode {
    cursor: pointer;
}

.task-item.selected {
    border-color: #667eea;
    background-color: #f8f9ff;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
}

.batch-checkbox {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 20px;
    height: 20px;
    cursor: pointer;
    display: none;
    z-index: 10;
    accent-color: #667eea;
}

/* åªæœ‰å•ä¸ªè§†é¢‘æ‰æ˜¾ç¤ºå¡ç‰‡çº§åˆ«çš„å¤é€‰æ¡† */
.task-item.single-video.batch-mode .batch-checkbox {
    display: block;
    pointer-events: auto;
}

.batch-indicator {
    display: inline-block;
    background: #667eea;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-left: 8px;
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.task-status {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    line-height: 20px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.task-status::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
}

.status-pending { 
    background: #fff7e6; 
    color: #d46b08;
    border: 1px solid #ffd591;
}

.status-pending::before {
    background: #d46b08;
}

.status-running { 
    background: #e6f4ff; 
    color: #0958d9;
    border: 1px solid #91caff;
}

.status-running::before {
    background: #0958d9;
    animation: pulse 1.5s ease-in-out infinite;
}

.status-succeeded { 
    background: #f0f9ff; 
    color: #0e5e6f;
    border: 1px solid #b3e0ff;
}

.status-succeeded::before {
    background: #0e5e6f;
}

.status-failed { 
    background: #fff1f0; 
    color: #d32029;
    border: 1px solid #ffccc7;
}

.status-failed::before {
    background: #d32029;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

.task-content {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 15px;
}

.task-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
}

.task-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.task-info p {
    margin: 0;
    font-size: 14px;
    color: #666;
}

.task-info strong {
    color: #333;
}

.task-id {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    background: #f5f5f5;
    padding: 2px 6px;
    border-radius: 3px;
    color: #666;
    user-select: all;
    cursor: pointer;
    display: inline-block;
    max-width: 400px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: all 0.2s;
    position: relative;
}

.task-id:hover {
    background: #e9ecef;
    color: #333;
    transform: translateY(-1px);
}

.task-id::after {
    content: ' â˜';
    font-size: 10px;
    opacity: 0.5;
    margin-left: 4px;
}

.task-video {
    margin-top: 15px;
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s;
}

.task-video:hover {
    transform: scale(1.02);
}

.video-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-top: 15px;
    max-width: 100%;
}

@media (max-width: 768px) {
    .video-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.video-thumbnail {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    aspect-ratio: 16/9;
    background: #f0f0f0;
    transition: all 0.3s;
}

.video-thumbnail.selected {
    border: 3px solid #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
}

.video-thumbnail video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
}

/* è§†é¢‘å°é¢å›¾æ ·å¼ */
.video-poster-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
    background: #1a1a1a;
}

.video-thumbnail:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.video-checkbox {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    cursor: pointer;
    display: none;
    z-index: 20;
    accent-color: #667eea;
}

.batch-mode .video-checkbox {
    display: block;
}

.video-index {
    position: absolute;
    top: 5px;
    left: 5px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
}

/* è§†é¢‘æ”¾å¤§æµ®å±‚ */
.video-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

.video-modal.active {
    display: flex;
}

.video-modal-content {
    max-width: 90%;
    max-height: 90%;
    position: relative;
}

.video-modal-close {
    position: absolute;
    top: -40px;
    right: 0;
    color: white;
    font-size: 30px;
    cursor: pointer;
    background: none;
    border: none;
    padding: 5px 15px;
}

.video-modal video {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 8px;
}

.form-group small {
    display: block;
    color: #999;
    font-size: 12px;
    margin-top: 5px;
}

.form-group.hidden {
    display: none;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #999;
}

.error-message {
    color: #dc3545;
    background-color: #f8d7da;
    padding: 8px 12px;
    border-radius: 6px;
    margin-top: 8px;
    border-left: 3px solid #dc3545;
}

@media (max-width: 1200px) {
    .workspace-content {
        grid-template-columns: 1fr;
    }
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

/* =================================
   ä¿®å¤åçš„è£å‰ªæ¨¡æ€æ¡†æ ·å¼
   ================================= */

/* 1. è‡ªå®šä¹‰å¼¹çª—å®¹å™¨ (å·²é‡å‘½åä»¥é¿å…å†²çª) */
.custom-cropper-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85); /* èƒŒæ™¯åŠ æ·±ï¼Œæ›´æ²‰æµ¸ */
    z-index: 10000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px); /* æ·»åŠ èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
}

.custom-cropper-modal.active {
    display: flex; /* JS åˆ‡æ¢ displayï¼Œä½†é…åˆ active ç±»ç®¡ç†æ›´å¥½ */
}

/* 2. å¼¹çª—ä¸»ä½“å†…å®¹å¡ç‰‡ */
.cropper-modal-content {
    background: #fff;
    border-radius: 12px;
    width: 90vw;
    max-width: 1100px;
    height: 85vh;
    max-height: 800px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

/* 3. é¡¶éƒ¨å·¥å…·æ  */
.cropper-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 25px;
    border-bottom: 1px solid #eee;
    background: #fff;
    z-index: 10;
}

.cropper-toolbar h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

/* 4. è£å‰ªå·¥ä½œåŒºå®¹å™¨ */
.cropper-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background-color: #2b2b2b; /* æ”¹ä¸ºæ·±è‰²èƒŒæ™¯ï¼Œçªå‡ºå›¾ç‰‡ */
    background-image: 
        linear-gradient(45deg, #333 25%, transparent 25%), 
        linear-gradient(-45deg, #333 25%, transparent 25%), 
        linear-gradient(45deg, transparent 75%, #333 75%), 
        linear-gradient(-45deg, transparent 75%, #333 75%);
    background-size: 20px 20px; /* æ·»åŠ æ·±è‰²æ£‹ç›˜æ ¼çº¹ç† */
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cropper-container img {
    max-width: 100%;
    max-height: 100%;
    display: block;
}

/* 5. åº•éƒ¨æ“ä½œæ  */
.cropper-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    padding: 15px 25px;
    border-top: 1px solid #eee;
    background: #fff;
    z-index: 10;
}

/* 6. çºµæ¨ªæ¯”æŒ‰é’®ç»„ */
.aspect-ratio-group {
    display: flex;
    gap: 8px;
    background: #f0f2f5;
    padding: 4px;
    border-radius: 8px;
}

.aspect-ratio-btn {
    padding: 6px 14px;
    border: none;
    background: transparent;
    color: #666;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
}

.aspect-ratio-btn:hover {
    background: rgba(0,0,0,0.05);
    color: #333;
}

.aspect-ratio-btn.active {
    background: white;
    color: #667eea;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    font-weight: 600;
}

/* =================================
   Cropper.js åº“æ ·å¼æ·±åº¦è¦†ç›– (ä¿®å¤æ“ä½œéš¾çš„é—®é¢˜)
   ================================= */

/* ä¿®å¤åº“å†…éƒ¨é®ç½© (å…³é”®ä¿®å¤ï¼šè¿™æ˜¯ä¹‹å‰çœ‹èµ·æ¥é€æ˜çš„åŸå› ) */
.cropper-modal {
    background-color: rgba(0, 0, 0, 0.65) !important; /* åŠ æ·±éé€‰ä¸­åŒºåŸŸçš„é»‘è‰² */
    opacity: 1 !important;
}

/* å¢å¼ºé€‰ä¸­æ¡†çš„è¾¹ç•Œ */
.cropper-view-box {
    outline: 2px solid #667eea !important;
    outline-offset: 0;
    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.35); /* é¢å¤–çš„è§†è§‰è¾…åŠ© */
}

/* è™šçº¿è¾…åŠ©çº¿ */
.cropper-dashed {
    border-color: rgba(255, 255, 255, 0.6) !important;
}

/* ä¸­å¿ƒåå­—çº¿ */
.cropper-center::before, 
.cropper-center::after {
    background-color: rgba(255, 255, 255, 0.8) !important;
}

/* æ”¾å¤§æ‹–æ‹½ç‚¹ï¼Œæ–¹ä¾¿é¼ æ ‡æ“ä½œ */
.cropper-point {
    width: 12px !important;
    height: 12px !important;
    background-color: #667eea !important;
    border-radius: 50%; /* åœ†å½¢æ‹–æ‹½ç‚¹ */
    opacity: 1 !important;
    border: 2px solid #fff !important;
    z-index: 1000 !important; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}

/* ç‰¹åˆ«æ”¾å¤§å››ä¸ªè§’çš„æ‹–æ‹½ç‚¹ */
.cropper-point.point-ne,
.cropper-point.point-nw,
.cropper-point.point-se,
.cropper-point.point-sw {
    width: 16px !important;
    height: 16px !important;
}

/* éšè—èƒŒæ™¯ç½‘æ ¼ (å¯é€‰ï¼Œå› ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰äº†å®¹å™¨èƒŒæ™¯) */
.cropper-bg {
    background: transparent !important;
}

/* å“åº”å¼é€‚é… */
@media (max-width: 768px) {
    .cropper-modal-content {
        width: 95vw;
    }
    
    .aspect-ratio-group {
        flex-wrap: wrap;
    }
    
    .aspect-ratio-btn {
        flex: 1;
        min-width: 60px;
    }
}

@media (max-width: 480px) {
    .cropper-modal-content {
        height: 95vh;
    }
    
    .cropper-toolbar {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .aspect-ratio-group {
        width: 100%;
    }
}

/* æ‰¹é‡ä»»åŠ¡IDæ˜¾ç¤ºæ ·å¼ */
.batch-task-ids {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 8px;
}

.batch-task-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 8px;
    border-radius: 6px;
    transition: background 0.15s;
}

.batch-task-row:hover {
    background: #f0f2ff;
}

.batch-task-row .task-index {
    font-size: 11px;
    font-weight: 600;
    color: #667eea;
    min-width: 24px;
}

.batch-task-row .task-id {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 11px;
    color: #555;
    cursor: pointer;
    padding: 2px 6px;
    background: #fff;
    border: 1px solid #e0e4ff;
    border-radius: 4px;
    transition: all 0.2s;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.batch-task-row .task-id:hover {
    background: #667eea;
    color: #fff;
    border-color: #667eea;
}

.batch-task-row .task-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    min-width: 50px;
    text-align: center;
}
</style>

<!-- Cropper.js åº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<!-- å›¾ç‰‡è£å‰ªæ¨¡å— -->
<script src="/static/image-cropper.js"></script>
<!-- æ‰¹é‡è§†é¢‘å¤„ç†è„šæœ¬ -->
<script src="/static/batch-video.js"></script>
<!-- èµ„äº§é€‰æ‹©å™¨ -->
<script src="/static/asset-picker.js"></script>

<script>
// é€šç”¨å·¥å…·å‡½æ•°
function showAlert(message, type = 'info') {
    // åˆ›å»ºæµ®åŠ¨æç¤º
    const alertDiv = document.createElement('div');
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;
    
    // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
    const styles = {
        success: 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;',
        error: 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;',
        info: 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;'
    };
    
    alertDiv.style.cssText += styles[type] || styles.info;
    alertDiv.textContent = message;
    
    document.body.appendChild(alertDiv);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        alertDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

let currentImageFilename = null;
let pollingIntervals = new Map();
let batchModeEnabled = false;
let selectedVideos = new Set();

// èµ„äº§åº“é€‰æ‹©å›è°ƒ
function handleAssetSelect(result) {
    if (result && result.filename && result.url) {
        currentImageFilename = result.filename;
        const imagePreview = document.getElementById('imagePreview');
        const uploadPlaceholder = document.querySelector('#uploadArea .upload-placeholder');
        
        imagePreview.src = result.url;
        imagePreview.style.display = 'block';
        if (uploadPlaceholder) {
            uploadPlaceholder.style.display = 'none';
        }
        
        // å¯ç”¨æç¤ºè¯ä¼˜åŒ–æŒ‰é’®
        updateOptimizeButtonState();
        
        showAlert('å·²ä»èµ„äº§åº“é€‰æ‹©å›¾ç‰‡', 'success');
    }
}

// æ›´æ–°æç¤ºè¯ä¼˜åŒ–æŒ‰é’®çŠ¶æ€
function updateOptimizeButtonState() {
    const optimizeBtn = document.getElementById('optimizeBtn');
    if (optimizeBtn) {
        if (currentImageFilename) {
            optimizeBtn.disabled = false;
            optimizeBtn.title = 'ç‚¹å‡»ä¼˜åŒ–æç¤ºè¯';
        } else {
            optimizeBtn.disabled = true;
            optimizeBtn.title = 'è¯·å…ˆä¸Šä¼ å›¾ç‰‡';
        }
    }
}

// è§†é¢‘æ‡’åŠ è½½Intersection Observer
let videoObserver = null;

// ç”¨äºé˜²æ­¢é¢‘ç¹åˆ·æ–°çš„èŠ‚æµæ§åˆ¶
let pendingRefresh = false;
let lastRefreshTime = 0;
const REFRESH_THROTTLE_MS = 2000; // æœ€å°åˆ·æ–°é—´éš”2ç§’

// ç¼“å­˜ä»»åŠ¡çŠ¶æ€ï¼Œç”¨äºæ£€æµ‹å˜åŒ–
let taskStatusCache = new Map();

// åˆ†é¡µåŠ è½½çŠ¶æ€
let currentPage = 1;
let hasMoreTasks = true;
let isLoadingMore = false;
const TASKS_PER_PAGE = 10;

// å·²åŠ è½½çš„ä»»åŠ¡IDé›†åˆï¼ˆç”¨äºå»é‡ï¼‰
let loadedTaskIds = new Set();

// åˆå§‹åŒ–è§†é¢‘æ‡’åŠ è½½Observer
function initVideoLazyLoad() {
    if (videoObserver) {
        videoObserver.disconnect();
    }
    
    videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const video = entry.target;
                const dataSrc = video.getAttribute('data-src');
                if (dataSrc && !video.querySelector('source')?.src?.includes(dataSrc.split('#')[0])) {
                    // åˆ›å»ºsourceå…ƒç´ å¹¶åŠ è½½è§†é¢‘
                    const source = video.querySelector('source');
                    if (source) {
                        source.src = dataSrc;
                    } else {
                        const newSource = document.createElement('source');
                        newSource.src = dataSrc;
                        newSource.type = 'video/mp4';
                        video.appendChild(newSource);
                    }
                    video.load();
                    video.removeAttribute('data-src');
                }
                // åœæ­¢è§‚å¯Ÿè¯¥è§†é¢‘
                videoObserver.unobserve(video);
            }
        });
    }, {
        rootMargin: '100px', // æå‰100pxå¼€å§‹åŠ è½½
        threshold: 0.1
    });
}

// è§‚å¯Ÿæ‰€æœ‰æ‡’åŠ è½½è§†é¢‘
function observeLazyVideos() {
    if (!videoObserver) {
        initVideoLazyLoad();
    }
    
    // è§‚å¯Ÿæ‰€æœ‰å¸¦æœ‰data-srcå±æ€§çš„è§†é¢‘
    document.querySelectorAll('video[data-src]').forEach(video => {
        videoObserver.observe(video);
    });
}

// éŸ³é¢‘ç›¸å…³å˜é‡
let mediaRecorder = null;
let audioChunks = [];
let recordingStartTime = null;
let recordingTimer = null;
let currentAudioBlob = null;
let currentAudioOssUrl = null;

// é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
window.addEventListener('load', function() {
    initVideoLazyLoad(); // åˆå§‹åŒ–è§†é¢‘æ‡’åŠ è½½
    initInfiniteScroll(); // åˆå§‹åŒ–æ— é™æ»šåŠ¨
    loadTasks(); // åŠ è½½ç¬¬ä¸€é¡µ
    updateAudioOptionsVisibility(); // åˆå§‹åŒ–éŸ³é¢‘é€‰é¡¹æ˜¾ç¤º
    setupAudioUpload(); // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¼ 
});

// åˆå§‹åŒ–æ— é™æ»šåŠ¨
function initInfiniteScroll() {
    const taskList = document.getElementById('taskList');
    
    if (taskList) {
        // æ»šåŠ¨äº‹ä»¶ç»‘å®šåˆ° taskList ä¸Š
        taskList.addEventListener('scroll', function() {
            const scrollTop = taskList.scrollTop;
            const scrollHeight = taskList.scrollHeight;
            const clientHeight = taskList.clientHeight;
            const distanceToBottom = scrollHeight - scrollTop - clientHeight;
            
            // è·ç¦»åº•éƒ¨300pxæ—¶é¢„åŠ è½½ä¸‹ä¸€é¡µ
            if (distanceToBottom < 300 && hasMoreTasks && !isLoadingMore) {
                console.log('[DEBUG] è§¦å‘åŠ è½½æ›´å¤šï¼Œè·ç¦»åº•éƒ¨:', distanceToBottom);
                loadMoreTasks();
            }
        });
        
        console.log('[DEBUG] æ— é™æ»šåŠ¨å·²åˆå§‹åŒ–ï¼ŒscrollHeight:', taskList.scrollHeight, 'clientHeight:', taskList.clientHeight);
    } else {
        console.error('[ERROR] taskList å…ƒç´ æœªæ‰¾åˆ°!');
    }
}

// åŠ è½½æ›´å¤šä»»åŠ¡
async function loadMoreTasks() {
    if (isLoadingMore || !hasMoreTasks) {
        console.log('[DEBUG] è·³è¿‡åŠ è½½: isLoadingMore=', isLoadingMore, 'hasMoreTasks=', hasMoreTasks);
        return;
    }
    
    isLoadingMore = true;
    currentPage++;
    
    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
    showLoadingIndicator();
    
    console.log('[DEBUG] å¼€å§‹åŠ è½½ç¬¬', currentPage, 'é¡µ');
    
    try {
        const response = await fetch(`/api/tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        console.log('[DEBUG] åŠ è½½ç»“æœ: success=', data.success, 'tasks=', data.tasks?.length, 'has_more=', data.has_more);
        
        if (data.success && data.tasks && data.tasks.length > 0) {
            // è¿½åŠ æ¸²æŸ“æ–°ä»»åŠ¡
            appendTasks(data.tasks);
            hasMoreTasks = data.has_more;
            
            // å¯ç”¨æ‡’åŠ è½½
            setTimeout(() => {
                observeLazyVideos();
            }, 100);
            
            // ä¸ºè¿›è¡Œä¸­çš„ä»»åŠ¡å¯åŠ¨è½®è¯¢
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startPolling(task.task_id);
                }
            });
        } else {
            hasMoreTasks = false;
        }
    } catch (error) {
        console.error('åŠ è½½æ›´å¤šä»»åŠ¡å¤±è´¥:', error);
        currentPage--; // å›é€€é¡µç 
    } finally {
        isLoadingMore = false;
        hideLoadingIndicator();
    }
}

// æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
function showLoadingIndicator() {
    const taskList = document.getElementById('taskList');
    let indicator = document.getElementById('loadMoreIndicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'loadMoreIndicator';
        indicator.className = 'load-more-indicator loading';
        indicator.textContent = 'åŠ è½½æ›´å¤š...';
    }
    taskList.appendChild(indicator);
}

// éšè—åŠ è½½æŒ‡ç¤ºå™¨
function hideLoadingIndicator() {
    const indicator = document.getElementById('loadMoreIndicator');
    if (indicator) {
        indicator.remove();
    }
}

// æ¨¡å‹é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°éŸ³é¢‘é€‰é¡¹æ˜¾ç¤º
const modelSelect = document.getElementById('model');
if (modelSelect) {
    modelSelect.addEventListener('change', () => {
        updateAudioOptionsVisibility();
        updatePromptExtendLock();
    });
}
  
const shotTypeSelect = document.getElementById('shotType');
if (shotTypeSelect) {
    shotTypeSelect.addEventListener('change', updatePromptExtendLock);
}
  
// æ›´æ–°éŸ³é¢‘é€‰é¡¹çš„æ˜¾ç¤º/éšè—
function updateAudioOptionsVisibility() {
    const model = document.getElementById('model').value;
    const audioUploadGroup = document.getElementById('audioUploadGroup');
    const audioToggleGroup = document.getElementById('audioToggleGroup');
    const shotTypeGroup = document.getElementById('shotTypeGroup');
    
    // åªæœ‰ wan2.6-i2v å’Œ wan2.5-i2v-preview æ¨¡å‹æ‰æ˜¾ç¤ºéŸ³é¢‘é€‰é¡¹
    if (model === 'wan2.6-i2v' || model === 'wan2.5-i2v-preview') {
        audioUploadGroup.classList.remove('hidden');
        audioToggleGroup.classList.remove('hidden');
    } else {
        audioUploadGroup.classList.add('hidden');
        audioToggleGroup.classList.add('hidden');
    }
    
    // åªæœ‰ wan2.6-i2v æ”¯æŒé•œå¤´ç±»å‹å‚æ•°
    if (shotTypeGroup) {
        if (model === 'wan2.6-i2v') {
            shotTypeGroup.classList.remove('hidden');
        } else {
            shotTypeGroup.classList.add('hidden');
            const shotTypeSelect = document.getElementById('shotType');
            if (shotTypeSelect) {
                shotTypeSelect.value = 'single';
            }
        }
    }
}

function updatePromptExtendLock() {
    const modelSelect = document.getElementById('model');
    const shotTypeSelect = document.getElementById('shotType');
    const promptExtendCheckbox = document.getElementById('promptExtend');

    if (!modelSelect || !shotTypeSelect || !promptExtendCheckbox) {
        return;
    }

    const model = modelSelect.value;
    const shotType = shotTypeSelect.value;

    // å¤šé•œå¤´ + wan2.6-i2v æ—¶ï¼Œå¼ºåˆ¶å¼€å¯æ™ºèƒ½æ”¹å†™ä¸”ä¸å¯ä¿®æ”¹
    if (model === 'wan2.6-i2v' && shotType === 'multi') {
        promptExtendCheckbox.checked = true;
        promptExtendCheckbox.disabled = true;
    } else {
        promptExtendCheckbox.disabled = false;
    }
}

// ========== éŸ³é¢‘ä¸Šä¼ å’Œå½•éŸ³åŠŸèƒ½ ==========

// åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¼ 
function setupAudioUpload() {
    const audioFileInput = document.getElementById('audioFileInput');
    audioFileInput.addEventListener('change', handleAudioFileUpload);
}

// å¤„ç†éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ 
async function handleAudioFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // éªŒè¯æ–‡ä»¶å¤§å°
    const maxSize = 15 * 1024 * 1024; // 15MB
    if (file.size > maxSize) {
        showAlert('éŸ³é¢‘æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ15MB', 'error');
        event.target.value = '';
        return;
    }
    
    // éªŒè¯æ–‡ä»¶æ ¼å¼
    const ext = file.name.split('.').pop().toLowerCase();
    if (!['wav', 'mp3'].includes(ext)) {
        showAlert('ä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼ï¼Œä»…æ”¯æŒ WAV å’Œ MP3', 'error');
        event.target.value = '';
        return;
    }
    
    showAlert('æ­£åœ¨ä¸Šä¼ éŸ³é¢‘...', 'info');
    
    const formData = new FormData();
    formData.append('audio', file);
    
    try {
        const response = await fetch('/api/upload-audio', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentAudioOssUrl = data.oss_url;
            document.getElementById('audioUrl').value = data.oss_url;
            
            // æ˜¾ç¤ºæ–‡ä»¶å
            document.getElementById('audioFileName').textContent = file.name;
            
            // æ˜¾ç¤ºæ’­æ”¾å™¨ç”¨äºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = e.target.result;
                document.getElementById('audioPlayerArea').style.display = 'flex';
            };
            reader.readAsDataURL(file);
            
            showAlert(data.message, 'success');
        } else {
            showAlert(data.message, 'error');
            event.target.value = '';
        }
    } catch (error) {
        showAlert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
        event.target.value = '';
    }
}

// å¼€å§‹/åœæ­¢å½•éŸ³
async function toggleRecording() {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        await startRecording();
    } else {
        stopRecording();
    }
}

// å¼€å§‹å½•éŸ³
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            currentAudioBlob = audioBlob;
            
            // ä¸Šä¼ å½•éŸ³
            await uploadRecordedAudio(audioBlob);
            
            // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        // æ›´æ–°UI
        const recordBtn = document.getElementById('recordBtn');
        recordBtn.classList.add('recording');
        document.getElementById('recordIcon').textContent = 'â¹ï¸';
        document.getElementById('recordText').textContent = 'åœæ­¢å½•éŸ³';
        
        // å¼€å§‹è®¡æ—¶
        updateRecordingDuration();
        recordingTimer = setInterval(updateRecordingDuration, 1000);
        
        // 30ç§’åè‡ªåŠ¨åœæ­¢
        setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
        }, 30000);
        
    } catch (error) {
        showAlert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™', 'error');
        console.error('Error accessing microphone:', error);
    }
}

// åœæ­¢å½•éŸ³
function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        
        // åœæ­¢è®¡æ—¶å™¨
        if (recordingTimer) {
            clearInterval(recordingTimer);
            recordingTimer = null;
        }
        
        // æ›´æ–°UI
        const recordBtn = document.getElementById('recordBtn');
        recordBtn.classList.remove('recording');
        document.getElementById('recordIcon').textContent = 'ğŸ¤';
        document.getElementById('recordText').textContent = 'å¼€å§‹å½•éŸ³';
        document.getElementById('recordDuration').textContent = '';
    }
}

// æ›´æ–°å½•éŸ³æ—¶é•¿æ˜¾ç¤º
function updateRecordingDuration() {
    if (recordingStartTime) {
        const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        document.getElementById('recordDuration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// ä¸Šä¼ å½•éŸ³æ–‡ä»¶
async function uploadRecordedAudio(audioBlob) {
    // éªŒè¯å½•éŸ³æ—¶é•¿ï¼ˆ3-30ç§’ï¼‰
    const duration = (Date.now() - recordingStartTime) / 1000;
    if (duration < 3) {
        showAlert('å½•éŸ³æ—¶é—´å¤ªçŸ­ï¼Œè‡³å°‘éœ€3ç§’', 'error');
        return;
    }
    
    showAlert('æ­£åœ¨ä¸Šä¼ å½•éŸ³...', 'info');
    
    const formData = new FormData();
    const filename = `recording_${Date.now()}.wav`;
    formData.append('audio', audioBlob, filename);
    
    try {
        const response = await fetch('/api/upload-audio', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentAudioOssUrl = data.oss_url;
            document.getElementById('audioUrl').value = data.oss_url;
            
            // æ˜¾ç¤ºæ–‡ä»¶å
            document.getElementById('audioFileName').textContent = 'å½•éŸ³æ–‡ä»¶';
            
            // æ˜¾ç¤ºæ’­æ”¾å™¨
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = URL.createObjectURL(audioBlob);
            document.getElementById('audioPlayerArea').style.display = 'flex';
            
            showAlert(data.message, 'success');
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
    }
}

// æ¸…é™¤éŸ³é¢‘
function clearAudio() {
    try {
        currentAudioBlob = null;
        currentAudioOssUrl = null;
        
        const audioUrl = document.getElementById('audioUrl');
        const audioFileName = document.getElementById('audioFileName');
        const audioFileInput = document.getElementById('audioFileInput');
        const audioPlayerArea = document.getElementById('audioPlayerArea');
        const audioPlayer = document.getElementById('audioPlayer');
        
        if (audioUrl) audioUrl.value = '';
        if (audioFileName) audioFileName.textContent = '';
        if (audioFileInput) audioFileInput.value = '';
        if (audioPlayerArea) audioPlayerArea.style.display = 'none';
        if (audioPlayer) audioPlayer.src = '';
        
        // ä¸æ˜¾ç¤ºæ¸…é™¤æç¤ºï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
    } catch (error) {
        console.error('Error clearing audio:', error);
    }
}

// å›¾ç‰‡ä¸Šä¼ 
const uploadArea = document.getElementById('uploadArea');
const imageInput = document.getElementById('imageInput');
const imagePreview = document.getElementById('imagePreview');

uploadArea.addEventListener('click', () => imageInput.click());

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) {
        // æ‰“å¼€è£å‰ªç•Œé¢
        window.imageCropper.open(file, handleImageUpload);
    }
});

imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        // æ‰“å¼€è£å‰ªç•Œé¢
        window.imageCropper.open(file, handleImageUpload);
    }
});

async function handleImageUpload(file) {
    console.log('å¼€å§‹ä¸Šä¼ å›¾ç‰‡:', file.name, file.type, file.size);
    const formData = new FormData();
    formData.append('image', file);
    
    try {
        const response = await fetch('/api/upload-image', {
            method: 'POST',
            body: formData
        });
        
        console.log('å“åº”çŠ¶æ€:', response.status);
        const data = await response.json();
        console.log('å“åº”æ•°æ®:', data);
        
        if (data.success) {
            currentImageFilename = data.filename;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                uploadArea.querySelector('.upload-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            // å¯ç”¨æç¤ºè¯ä¼˜åŒ–æŒ‰é’®
            updateOptimizeButtonState();
            
            showAlert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
        } else {
            showAlert(data.message || 'ä¸Šä¼ å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('ä¸Šä¼ é”™è¯¯:', error);
        showAlert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
    }
}

async function createTask() {
    if (!currentImageFilename) {
        showAlert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'error');
        return;
    }
    
    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt) {
        showAlert('è¯·è¾“å…¥æç¤ºè¯', 'error');
        return;
    }
    
    const btn = document.getElementById('createBtn');
    const btnIcon = btn.querySelector('.btn-icon');
    const btnText = btn.querySelector('.btn-text');
    
    btn.disabled = true;
    btnIcon.textContent = 'â³';
    btnText.textContent = 'åˆ›å»ºä¸­...';
    
    try {
        const response = await fetch('/api/create-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_filename: currentImageFilename,
                model: document.getElementById('model').value,
                prompt: prompt,
                resolution: document.getElementById('resolution').value,
                duration: document.getElementById('duration').value,
                shot_type: document.getElementById('shotType').value,
                audio_url: document.getElementById('audioUrl').value,
                negative_prompt: document.getElementById('negativePrompt').value,
                prompt_extend: document.getElementById('promptExtend').checked,
                audio: document.getElementById('audioToggle').checked,
                batch_count: parseInt(document.getElementById('batchCount').value) // æ·»åŠ æ‰¹é‡æ•°é‡
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œè¾“å…¥å·²ä¿ç•™ä¾›ç»§ç»­ä½¿ç”¨', 'success');
            
            // ä¿ç•™è¾“å…¥å†…å®¹ï¼Œæ–¹ä¾¿ç”¨æˆ·åŸºäºç›¸åŒå‚æ•°å¤šæ¬¡ç”Ÿæˆ
            // åªæ¸…é™¤éŸ³é¢‘ï¼ˆå› ä¸ºéŸ³é¢‘é€šå¸¸åªç”¨ä¸€æ¬¡ï¼‰
            clearAudio();
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
            loadTasks();
            
            // ä¸ºæ‰¹é‡ä»»åŠ¡å¼€å§‹è½®è¯¢
            if (data.tasks) {
                data.tasks.forEach(task => {
                    startPolling(task.task_id);
                });
            } else if (data.task) {
                // å•ä¸ªä»»åŠ¡å…¼å®¹
                startPolling(data.task.task_id);
            }
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btnIcon.textContent = 'âœ¨';
        btnText.textContent = 'å¼€å§‹ç”Ÿæˆ';    
    }
}

async function loadTasks(reset = true) {
    try {
        // é‡ç½®åˆ†é¡µçŠ¶æ€
        if (reset) {
            currentPage = 1;
            hasMoreTasks = true;
            loadedTaskIds.clear();
        }
        
        const response = await fetch(`/api/tasks?page=${currentPage}&limit=${TASKS_PER_PAGE}`);
        const data = await response.json();
        
        if (data.success) {
            if (reset) {
                renderTasks(data.tasks);
            } else {
                appendTasks(data.tasks);
            }
            
            hasMoreTasks = data.has_more;
            
            // æ¸²æŸ“åå¯ç”¨æ‡’åŠ è½½
            setTimeout(() => {
                observeLazyVideos();
            }, 100);
            
            // æ›´æ–°ç¼©ç•¥å›¾å¯¼èˆª
            if (typeof ThumbnailNav !== 'undefined' && ThumbnailNav.refresh) {
                ThumbnailNav.refresh();
            } else {
                console.warn('ThumbnailNav ç»„ä»¶æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ·æ–°ç¼©ç•¥å›¾');
            }
            
            // ä¸ºè¿›è¡Œä¸­çš„ä»»åŠ¡å¯åŠ¨è½®è¯¢
            data.tasks.forEach(task => {
                if (task.task_status === 'PENDING' || task.task_status === 'RUNNING') {
                    startPolling(task.task_id);
                }
            });
        }
    } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
    }
}

function renderTasks(tasks) {
    const taskList = document.getElementById('taskList');
    
    if (tasks.length === 0) {
        taskList.innerHTML = '<div class="loading">æš‚æ— å†å²è®°å½•</div>';
        return;
    }
    
    // è®°å½•å·²åŠ è½½çš„ä»»åŠ¡ID
    tasks.forEach(t => loadedTaskIds.add(t.task_id));
    
    // æŒ‰batch_idåˆ†ç»„
    const batchGroups = groupTasksByBatch(tasks);
    
    taskList.innerHTML = renderTaskGroups(batchGroups);
}

// è¿½åŠ ä»»åŠ¡ï¼ˆç”¨äºæ— é™æ»šåŠ¨ï¼‰
function appendTasks(tasks) {
    const taskList = document.getElementById('taskList');
    
    // è¿‡æ»¤å·²åŠ è½½çš„ä»»åŠ¡
    const newTasks = tasks.filter(t => !loadedTaskIds.has(t.task_id));
    if (newTasks.length === 0) return;
    
    // è®°å½•æ–°åŠ è½½çš„ä»»åŠ¡ID
    newTasks.forEach(t => loadedTaskIds.add(t.task_id));
    
    // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦åˆå¹¶åˆ°ç°æœ‰æ‰¹æ¬¡çš„ä»»åŠ¡
    const tasksToMerge = [];
    const tasksToAppend = [];
    
    newTasks.forEach(task => {
        const batchId = task.batch_id;
        if (batchId) {
            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨åŒä¸€æ‰¹æ¬¡çš„ä»»åŠ¡å®¹å™¨
            const existingBatchContainer = findExistingI2VBatchContainer(batchId);
            if (existingBatchContainer) {
                tasksToMerge.push({ task, container: existingBatchContainer, batchId });
            } else {
                tasksToAppend.push(task);
            }
        } else {
            tasksToAppend.push(task);
        }
    });
    
    // åˆå¹¶åˆ°ç°æœ‰æ‰¹æ¬¡
    if (tasksToMerge.length > 0) {
        console.log('[DEBUG] å‘ç°éœ€è¦åˆå¹¶çš„æ‰¹æ¬¡ä»»åŠ¡:', tasksToMerge.map(t => t.task.task_id));
        tasksToMerge.forEach(({ task, container, batchId }) => {
            mergeI2VTaskIntoBatch(task, container, batchId);
        });
    }
    
    // è¿½åŠ æ–°çš„ç‹¬ç«‹ä»»åŠ¡æˆ–æ‰¹æ¬¡
    if (tasksToAppend.length > 0) {
        const batchGroups = groupTasksByBatch(tasksToAppend);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = renderTaskGroups(batchGroups);
        
        while (tempDiv.firstChild) {
            taskList.appendChild(tempDiv.firstChild);
        }
    }
}

// æŸ¥æ‰¾ç°æœ‰çš„æ‰¹æ¬¡å®¹å™¨ï¼ˆå›¾ç”Ÿè§†é¢‘ï¼‰
function findExistingI2VBatchContainer(batchId) {
    const taskItems = document.querySelectorAll('.task-item');
    for (const item of taskItems) {
        if (item.dataset.batchId === batchId) {
            return item;
        }
    }
    return null;
}

// åˆå¹¶ä»»åŠ¡åˆ°ç°æœ‰æ‰¹æ¬¡ï¼ˆå›¾ç”Ÿè§†é¢‘ï¼‰
function mergeI2VTaskIntoBatch(task, container, batchId) {
    console.log('[DEBUG] åˆå¹¶è§†é¢‘ä»»åŠ¡åˆ°æ‰¹æ¬¡:', { taskId: task.task_id, batchId });
    
    // 1. æ·»åŠ ä»»åŠ¡IDè¡Œåˆ°batch-task-ids
    const batchTaskIds = container.querySelector('.batch-task-ids');
    if (batchTaskIds) {
        const taskRow = document.createElement('div');
        taskRow.className = 'batch-task-row';
        const taskIndex = batchTaskIds.querySelectorAll('.batch-task-row').length + 1;
        taskRow.innerHTML = `
            <span class="task-index">#${taskIndex}</span>
            <span class="task-id" onclick="event.stopPropagation(); copyTaskId('${task.task_id}')" title="ç‚¹å‡»å¤åˆ¶">${task.task_id}</span>
            <span class="task-status status-${(task.task_status || 'PENDING').toLowerCase()}">${getStatusText(task.task_status || 'PENDING')}</span>
        `;
        batchTaskIds.appendChild(taskRow);
    }
    
    // 2. å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œæ·»åŠ è§†é¢‘åˆ°video-grid
    if (task.task_status === 'SUCCEEDED' && task.local_video_path) {
        let videoGrid = container.querySelector('.video-grid');
        
        // å¦‚æœåªæœ‰å•ä¸ªè§†é¢‘ï¼Œéœ€è¦å…ˆè½¬æ¢ä¸ºgridå¸ƒå±€
        const singleVideo = container.querySelector('.task-video');
        if (singleVideo && !videoGrid) {
            singleVideo.remove();
            videoGrid = document.createElement('div');
            videoGrid.className = 'video-grid';
            container.appendChild(videoGrid);
            
            // å°†åŸå•ä¸ªè§†é¢‘è½¬æ¢ä¸ºç¼©ç•¥å›¾å½¢å¼ï¼ˆéœ€è¦æ‰¾åˆ°å¯¹åº”çš„ä»»åŠ¡ä¿¡æ¯ï¼‰
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥åˆ›å»ºgridï¼ŒåŸè§†é¢‘ä¿¡æ¯ä¼šåœ¨é‡æ–°åŠ è½½æ—¶æ­£ç¡®æ˜¾ç¤º
        }
        
        if (!videoGrid) {
            videoGrid = document.createElement('div');
            videoGrid.className = 'video-grid';
            container.appendChild(videoGrid);
        }
        
        // è®¡ç®—å½“å‰å·²æœ‰çš„è§†é¢‘æ•°é‡
        const currentVideoCount = videoGrid.querySelectorAll('.video-thumbnail').length;
        const videoId = task.task_id;
        const posterUrl = `/api/video-poster/{{ session.get('api_key_hash', '') }}/${task.task_id}`;
        
        const videoDiv = document.createElement('div');
        videoDiv.className = 'video-thumbnail';
        videoDiv.id = `video-${videoId}`;
        videoDiv.setAttribute('data-video-id', videoId);
        videoDiv.setAttribute('data-video-url', task.local_video_path);
        videoDiv.setAttribute('onclick', `event.stopPropagation(); openVideoModal('${task.local_video_path}')`);
        videoDiv.innerHTML = `
            <span class="video-index">#${currentVideoCount + 1}</span>
            <img class="video-poster-img" src="${posterUrl}" alt="è§†é¢‘å°é¢" loading="lazy">
        `;
        videoGrid.appendChild(videoDiv);
        
        // ç§»é™¤single-video class
        container.classList.remove('single-video');
    }
}

// æŒ‰batch_idåˆ†ç»„ä»»åŠ¡
function groupTasksByBatch(tasks) {
    const batchGroups = {};
    tasks.forEach(task => {
        const batchId = task.batch_id || task.task_id;
        if (!batchGroups[batchId]) {
            batchGroups[batchId] = [];
        }
        batchGroups[batchId].push(task);
    });
    return batchGroups;
}

// æ¸²æŸ“ä»»åŠ¡åˆ†ç»„ä¸ºHTML
function renderTaskGroups(batchGroups) {
    return Object.values(batchGroups).map(batch => {
        const mainTask = batch[0];
        const isBatch = batch.length > 1;
        const batchId = mainTask.batch_id || mainTask.task_id;
        const succeededVideos = batch.filter(t => t.task_status === 'SUCCEEDED' && t.local_video_path);
        const canSelect = succeededVideos.length > 0;
        const isSingleVideo = succeededVideos.length === 1;
        
        return `
        <div class="task-item ${isSingleVideo ? 'single-video' : ''} ${batchModeEnabled && canSelect && isSingleVideo ? 'batch-mode' : ''}" 
             id="task-${mainTask.task_id}" 
             data-task-id="${mainTask.task_id}"
             data-batch-id="${batchId}"
             ${batchModeEnabled && canSelect && isSingleVideo ? 'onclick="toggleTaskSelection(event, \''+mainTask.task_id+'\')"' : ''}>
            ${batchModeEnabled && canSelect && isSingleVideo ? 
                `<input type="checkbox" 
                        class="batch-checkbox" 
                        data-task-id="${mainTask.task_id}" 
                        data-video-url="${succeededVideos[0].local_video_path}"
                        ${selectedVideos.has(mainTask.task_id) ? 'checked' : ''}
                        onclick="event.stopPropagation(); toggleTaskCheckbox('${mainTask.task_id}');">` : ''}
            <div class="task-header">
                <div class="batch-task-ids">
                    ${batch.map((task, idx) => `
                        <div class="batch-task-row">
                            <span class="task-index">#${idx + 1}</span>
                            <span class="task-id" onclick="event.stopPropagation(); copyTaskId('${task.task_id}')" title="ç‚¹å‡»å¤åˆ¶">${task.task_id}</span>
                            <span class="task-status status-${(task.task_status || 'PENDING').toLowerCase()}">${getStatusText(task.task_status || 'PENDING')}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="task-actions">
                    <button class="btn btn-secondary btn-sm icon-only" onclick="event.stopPropagation(); regenerateTask('${mainTask.task_id}')" title="ä½¿ç”¨ç›¸åŒé…ç½®é‡æ–°ç”Ÿæˆ">ğŸ”„</button>
                </div>
            </div>
            <div class="task-content">
                ${mainTask.image_url ? `<img src="${mainTask.image_url}" class="task-image" alt="é¦–å¸§å›¾ç‰‡">` : ''}
                <div class="task-info">
                    <p><strong>æç¤ºè¯ï¼š</strong>${mainTask.prompt || 'æ— '}</p>
                    <p><strong>æ¨¡å‹ï¼š</strong>${mainTask.model || 'æœªçŸ¥'}</p>
                    <p><strong>é…ç½®ï¼š</strong>${mainTask.resolution || ''} / ${mainTask.duration || ''}ç§’${mainTask.shot_type ? ' / ' + (mainTask.shot_type === 'multi' ? 'å¤šé•œå¤´' : 'å•é•œå¤´') : ''}</p>
                    ${mainTask.end_time ? `<p><strong>å®Œæˆæ—¶é—´ï¼š</strong>${formatDate(mainTask.end_time)}</p>` : ''}
                    ${mainTask.task_status === 'FAILED' && mainTask.message ? 
                        `<p class="error-message"><strong>å¤±è´¥åŸå› ï¼š</strong>${mainTask.message}</p>` : ''}
                </div>
            </div>
            ${succeededVideos.length === 1 ? `
                <video class="task-video" 
                       controls 
                       preload="none"
                       data-src="${succeededVideos[0].local_video_path}"
                       poster="/api/video-poster/{{ session.get('api_key_hash', '') }}/${succeededVideos[0].task_id}"
                       onclick="event.stopPropagation(); openVideoModal('${succeededVideos[0].local_video_path}')">
                    <source src="" type="video/mp4">
                </video>
            ` : succeededVideos.length > 1 ? `
                <div class="video-grid ${batchModeEnabled ? 'batch-mode' : ''}">
                    ${succeededVideos.map((video, index) => {
                        const videoId = `${video.task_id}`;
                        const isSelected = selectedVideos.has(videoId);
                        const posterUrl = `/api/video-poster/{{ session.get('api_key_hash', '') }}/${video.task_id}`;
                        return `
                        <div class="video-thumbnail ${isSelected ? 'selected' : ''}" 
                             id="video-${videoId}"
                             data-video-id="${videoId}"
                             data-video-url="${video.local_video_path}"
                             onclick="${batchModeEnabled ? 'event.stopPropagation(); toggleVideoSelection(\''+videoId+'\', \''+video.local_video_path+'\')' : 'event.stopPropagation(); openVideoModal(\''+video.local_video_path+'\')'}">
                            ${batchModeEnabled ? `
                                <input type="checkbox" 
                                       class="video-checkbox" 
                                       data-video-id="${videoId}"
                                       data-video-url="${video.local_video_path}"
                                       ${isSelected ? 'checked' : ''}
                                       onclick="event.stopPropagation(); toggleVideoCheckbox('${videoId}');">` : ''}
                            <span class="video-index">#${index + 1}</span>
                            <img class="video-poster-img" src="${posterUrl}" alt="è§†é¢‘å°é¢" loading="lazy">
                        </div>
                    `}).join('')}
                </div>
            ` : ''}
        </div>
    `}).join('');
}

function getStatusText(status) {
    const statusMap = {
        'PENDING': 'æ’é˜Ÿä¸­',
        'RUNNING': 'ç”Ÿæˆä¸­',
        'SUCCEEDED': 'å·²å®Œæˆ',
        'FAILED': 'å¤±è´¥',
        'CANCELED': 'å·²å–æ¶ˆ',
        'UNKNOWN': 'æœªçŸ¥'
    };
    return statusMap[status] || status;
}

function startPolling(taskId) {
    // é¿å…é‡å¤è½®è¯¢
    if (pollingIntervals.has(taskId)) {
        return;
    }
    
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`/api/task/${taskId}`);
            const data = await response.json();
            
            if (data.success) {
                const task = data.task;
                const status = task.task_status;
                const oldStatus = taskStatusCache.get(taskId);
                
                // åªæœ‰çŠ¶æ€å˜åŒ–æ—¶æ‰æ›´æ–°UI
                if (oldStatus !== status) {
                    taskStatusCache.set(taskId, status);
                    
                    // å¢é‡æ›´æ–°å•ä¸ªä»»åŠ¡ï¼Œè€Œä¸æ˜¯åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
                    updateTaskItemStatus(taskId, task);
                }
                
                // å¦‚æœä»»åŠ¡å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                if (status === 'SUCCEEDED' || status === 'FAILED' || status === 'CANCELED') {
                    clearInterval(interval);
                    pollingIntervals.delete(taskId);
                    
                    // ä»»åŠ¡å®Œæˆæ—¶æ‰åˆ·æ–°åˆ—è¡¨ï¼ˆä¸ºäº†æ˜¾ç¤ºè§†é¢‘ï¼‰
                    throttledRefresh();
                }
            }
        } catch (error) {
            console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
        }
    }, 5000); // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
    
    pollingIntervals.set(taskId, interval);
}

// å¢é‡æ›´æ–°å•ä¸ªä»»åŠ¡çš„çŠ¶æ€ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ï¼‰
function updateTaskItemStatus(taskId, task) {
    const taskItem = document.getElementById(`task-${taskId}`);
    if (!taskItem) return;
    
    // æ›´æ–°çŠ¶æ€æ ‡ç­¾
    const statusSpan = taskItem.querySelector('.task-status');
    if (statusSpan) {
        // ç§»é™¤æ—§çš„çŠ¶æ€class
        statusSpan.className = 'task-status';
        statusSpan.classList.add(`status-${(task.task_status || 'unknown').toLowerCase()}`);
        statusSpan.textContent = getStatusText(task.task_status);
    }
    
    // å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    if (task.task_status === 'FAILED' && task.message) {
        const taskInfo = taskItem.querySelector('.task-info');
        if (taskInfo && !taskInfo.querySelector('.error-message')) {
            const errorP = document.createElement('p');
            errorP.className = 'error-message';
            errorP.innerHTML = `<strong>å¤±è´¥åŸå› ï¼š</strong>${task.message}`;
            taskInfo.appendChild(errorP);
        }
    }
}

// èŠ‚æµåˆ·æ–° - é¿å…é¢‘ç¹åˆ·æ–°é¡µé¢
function throttledRefresh() {
    const now = Date.now();
    
    // å¦‚æœè·ç¦»ä¸Šæ¬¡åˆ·æ–°ä¸è¶³é˜ˆå€¼ï¼Œå»¶è¿Ÿåˆ·æ–°
    if (now - lastRefreshTime < REFRESH_THROTTLE_MS) {
        if (!pendingRefresh) {
            pendingRefresh = true;
            setTimeout(() => {
                pendingRefresh = false;
                lastRefreshTime = Date.now();
                loadTasks();
            }, REFRESH_THROTTLE_MS - (now - lastRefreshTime));
        }
        return;
    }
    
    lastRefreshTime = now;
    loadTasks();
}

async function logout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
        try {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        } catch (error) {
            showAlert('é€€å‡ºå¤±è´¥', 'error');
        }
    }
}

// é¡µé¢å¸è½½æ—¶æ¸…ç†è½®è¯¢
window.addEventListener('beforeunload', () => {
    pollingIntervals.forEach(interval => clearInterval(interval));
});

// æ‰¹é‡è§†é¢‘ç®¡ç†åŠŸèƒ½
// åˆ‡æ¢æ‰¹é‡é€‰æ‹©æ¨¡å¼
function toggleBatchMode() {
    batchModeEnabled = !batchModeEnabled;
    const btn = document.getElementById('batchModeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const saveToAssetBtn = document.getElementById('saveToAssetBtn');
    
    if (batchModeEnabled) {
        btn.textContent = 'å–æ¶ˆé€‰æ‹©';
        downloadBtn.style.display = 'inline-block';
        if (saveToAssetBtn) saveToAssetBtn.style.display = 'inline-block';
    } else {
        btn.textContent = 'æ‰¹é‡é€‰æ‹©';
        downloadBtn.style.display = 'none';
        if (saveToAssetBtn) saveToAssetBtn.style.display = 'none';
        selectedVideos.clear();
        updateSelectedCount();
    }
    
    loadTasks();
}

// ä¿å­˜é€‰ä¸­çš„è§†é¢‘åˆ°èµ„äº§åº“
function saveSelectedToAssets() {
    if (selectedVideos.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¿å­˜çš„è§†é¢‘', 'error');
        return;
    }
    
    // æ”¶é›†é€‰ä¸­çš„è§†é¢‘æ–‡ä»¶ä¿¡æ¯
    const files = [];
    for (const id of selectedVideos) {
        // å°è¯•ä»ä»»åŠ¡çº§åˆ«å¤é€‰æ¡†è·å–
        let checkbox = document.querySelector(`.batch-checkbox[data-task-id="${id}"]`);
        
        // å¦‚æœä¸å­˜åœ¨ï¼Œå°è¯•ä»è§†é¢‘çº§åˆ«å¤é€‰æ¡†è·å–
        if (!checkbox) {
            checkbox = document.querySelector(`.video-checkbox[data-video-id="${id}"]`);
        }
        
        if (checkbox && checkbox.dataset.videoUrl) {
            // ä»video URLæå–æ–‡ä»¶å
            const videoUrl = checkbox.dataset.videoUrl;
            const filename = videoUrl.split('/').pop();
            
            files.push({
                filename: filename,
                source_type: 'i2v',
                file_type: 'video'
            });
        }
    }
    
    if (files.length === 0) {
        showAlert('æ²¡æœ‰æ‰¾åˆ°å¯ä¿å­˜çš„è§†é¢‘', 'error');
        return;
    }
    
    openSaveToAssetModal({
        files: files,
        fileType: 'video',
        onComplete: (count) => {
            if (count > 0) {
                // ä¿å­˜æˆåŠŸåæ¸…ç©ºé€‰æ‹©
                selectedVideos.clear();
                updateSelectedCount();
            }
        }
    });
}

// æ›´æ–°é€‰ä¸­æ•°é‡ï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼Œä¸ä¿®æ”¹selectedVideosï¼‰
function updateSelectedCount() {
    document.getElementById('selectedCount').textContent = selectedVideos.size;
}

// åˆ‡æ¢ä»»åŠ¡å¤é€‰æ¡†ï¼ˆç›´æ¥ç‚¹å‡»å¤é€‰æ¡†æ—¶ï¼‰
function toggleTaskCheckbox(taskId) {
    const checkbox = document.querySelector(`.batch-checkbox[data-task-id="${taskId}"]`);
    if (!checkbox) return;
    
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    if (checkbox.checked) {
        selectedVideos.add(taskId);
    } else {
        selectedVideos.delete(taskId);
    }
    
    // æ›´æ–°è§†è§‰åé¦ˆ
    const taskItem = document.getElementById(`task-${taskId}`);
    if (taskItem) {
        if (checkbox.checked) {
            taskItem.classList.add('selected');
        } else {
            taskItem.classList.remove('selected');
        }
    }
    
    // æ›´æ–°è®¡æ•°
    updateSelectedCount();
}

// åˆ‡æ¢ä»»åŠ¡é€‰æ‹©çŠ¶æ€ï¼ˆå•ä¸ªè§†é¢‘ï¼‰
function toggleTaskSelection(event, taskId) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†æœ¬èº«ï¼Œä¸å¤„ç†
    if (event.target.type === 'checkbox') return;
    
    const checkbox = document.querySelector(`.batch-checkbox[data-task-id="${taskId}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        
        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        if (checkbox.checked) {
            selectedVideos.add(taskId);
        } else {
            selectedVideos.delete(taskId);
        }
        
        // æ›´æ–°è§†è§‰åé¦ˆ
        const taskItem = document.getElementById(`task-${taskId}`);
        if (taskItem) {
            if (checkbox.checked) {
                taskItem.classList.add('selected');
            } else {
                taskItem.classList.remove('selected');
            }
        }
        
        updateSelectedCount();
    }
}

// åˆ‡æ¢è§†é¢‘å¤é€‰æ¡†ï¼ˆç›´æ¥ç‚¹å‡»å¤é€‰æ¡†æ—¶ï¼‰
function toggleVideoCheckbox(videoId) {
    const checkbox = document.querySelector(`.video-checkbox[data-video-id="${videoId}"]`);
    if (!checkbox) return;
    
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    if (checkbox.checked) {
        selectedVideos.add(videoId);
    } else {
        selectedVideos.delete(videoId);
    }
    
    // æ›´æ–°è§†è§‰åé¦ˆ
    const thumbnail = document.getElementById(`video-${videoId}`);
    if (thumbnail) {
        if (checkbox.checked) {
            thumbnail.classList.add('selected');
        } else {
            thumbnail.classList.remove('selected');
        }
    }
    
    // æ›´æ–°è®¡æ•°
    document.getElementById('selectedCount').textContent = selectedVideos.size;
}

// åˆ‡æ¢è§†é¢‘é€‰æ‹©çŠ¶æ€ï¼ˆæ‰¹é‡è§†é¢‘ä¸­çš„å•ä¸ªï¼‰
function toggleVideoSelection(videoId, videoUrl) {
    const checkbox = document.querySelector(`.video-checkbox[data-video-id="${videoId}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        
        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        if (checkbox.checked) {
            selectedVideos.add(videoId);
        } else {
            selectedVideos.delete(videoId);
        }
        
        // æ›´æ–°è§†è§‰åé¦ˆ
        const thumbnail = document.getElementById(`video-${videoId}`);
        if (thumbnail) {
            if (checkbox.checked) {
                thumbnail.classList.add('selected');
            } else {
                thumbnail.classList.remove('selected');
            }
        }
        
        updateSelectedCount();
    }
}

// å¤åˆ¶ä»»åŠ¡ID
function copyTaskId(taskId) {
    if (!taskId || taskId === 'æœªçŸ¥') {
        showAlert('æ— æ•ˆçš„ä»»åŠ¡ID', 'error');
        return;
    }
    
    // ä½¿ç”¨ Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(taskId)
            .then(() => {
                showAlert('ä»»åŠ¡IDå·²å¤åˆ¶ï¼', 'success');
            })
            .catch(err => {
                // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyTaskId(taskId);
            });
    } else {
        // ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
        fallbackCopyTaskId(taskId);
    }
}

// ä¼ ç»Ÿå¤åˆ¶æ–¹æ³•ï¼ˆå‘åå…¼å®¹ï¼‰
function fallbackCopyTaskId(taskId) {
    const textarea = document.createElement('textarea');
    textarea.value = taskId;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    
    try {
        document.execCommand('copy');
        showAlert('ä»»åŠ¡IDå·²å¤åˆ¶ï¼', 'success');
    } catch (err) {
        showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', 'error');
    } finally {
        document.body.removeChild(textarea);
    }
}

// ä¸‹è½½é€‰ä¸­çš„è§†é¢‘
async function downloadSelected() {
    if (selectedVideos.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„è§†é¢‘', 'error');
        return;
    }
    
    showAlert(`å¼€å§‹ä¸‹è½½ ${selectedVideos.size} ä¸ªè§†é¢‘...`, 'success');
    
    let downloadCount = 0;
    for (const id of selectedVideos) {
        // å°è¯•ä»ä»»åŠ¡çº§åˆ«å¤é€‰æ¡†è·å–
        let checkbox = document.querySelector(`.batch-checkbox[data-task-id="${id}"]`);
        
        // å¦‚æœä¸å­˜åœ¨ï¼Œå°è¯•ä»è§†é¢‘çº§åˆ«å¤é€‰æ¡†è·å–
        if (!checkbox) {
            checkbox = document.querySelector(`.video-checkbox[data-video-id="${id}"]`);
        }
        
        if (checkbox && checkbox.dataset.videoUrl) {
            const videoUrl = checkbox.dataset.videoUrl;
            downloadVideo(videoUrl, `video_${id}.mp4`);
            downloadCount++;
            await new Promise(resolve => setTimeout(resolve, 500)); // å»¶è¿Ÿé¿å…æµè§ˆå™¨é™åˆ¶
        }
    }
    
    if (downloadCount > 0) {
        showAlert(`å·²å¯åŠ¨ ${downloadCount} ä¸ªè§†é¢‘ä¸‹è½½`, 'success');
    }
}

function downloadVideo(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// ä½¿ç”¨common.jsä¸­çš„é€šç”¨å‡½æ•°:
// - openVideoModal(videoUrl)
// - closeVideoModal()
// - showAlert(message, type)
// - logout()

// é‡æ–°ç”Ÿæˆä»»åŠ¡
async function regenerateTask(taskId) {
    if (!taskId) {
        showAlert('æ— æ•ˆçš„ä»»åŠ¡ID', 'error');
        return;
    }
    
    try {
        showAlert('æ­£åœ¨é‡æ–°ç”Ÿæˆä»»åŠ¡...', 'info');
        
        const response = await fetch('/api/regenerate-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ task_id: taskId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡', 'success');
            
            // å¯åŠ¨æ–°ä»»åŠ¡çš„è½®è¯¢
            if (data.tasks && data.tasks.length > 0) {
                data.tasks.forEach(task => {
                    if (task.task_id) {
                        startPolling(task.task_id);
                    }
                });
            }
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°ä»»åŠ¡
            loadTasks();
        } else {
            showAlert(data.message || 'é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥:', error);
        showAlert('é‡æ–°ç”Ÿæˆä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
    }
}

// ESCé”®å…³é—­æµ®å±‚
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeVideoModal();
        closeOptimizeModal();
    }
});

// æç¤ºè¯ä¼˜åŒ–åŠŸèƒ½
function openOptimizeModal() {
    const promptInput = document.getElementById('prompt');
    const originalPrompt = promptInput.value.trim();

    if (!originalPrompt) {
        showAlert('è¯·å…ˆè¾“å…¥æç¤ºè¯', 'error');
        return;
    }

    // æ˜¾ç¤ºåŸå§‹æç¤ºè¯
    document.getElementById('originalPromptContent').textContent = originalPrompt;

    // æ˜¾ç¤ºæ‚¬æµ®çª—
    document.getElementById('optimizeModal').classList.add('active');

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const optimizedPromptDiv = document.querySelector('.optimized-prompt');
    optimizedPromptDiv.classList.add('loading');
    const optimizedContent = document.getElementById('optimizedPromptContent');
    optimizedContent.textContent = 'æ­£åœ¨è§£æå›¾ç‰‡å†…å®¹...';

    // ä½¿ç”¨fetchè¿›è¡Œæµå¼è¯·æ±‚
    fetch('/api/optimize-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prompt: originalPrompt,
            task_type: 'video',
            image_filename: currentImageFilename  // ä¼ é€’å›¾ç‰‡æ–‡ä»¶å
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('ç½‘ç»œå“åº”å¤±è´¥');
        }
        
        // ç§»é™¤åŠ è½½çŠ¶æ€ï¼Œæ¸…ç©ºå†…å®¹
        optimizedPromptDiv.classList.remove('loading');
        optimizedContent.textContent = '';
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        // é€’å½’è¯»å–æµå¼æ•°æ®
        function readStream() {
            reader.read().then(({done, value}) => {
                if (done) {
                    return;
                }
                
                // è§£ç æ•°æ®
                buffer += decoder.decode(value, {stream: true});
                
                // æŒ‰è¡Œåˆ†å‰²
                const lines = buffer.split('\n');
                buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                
                // å¤„ç†æ¯ä¸€è¡Œ
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6); // ç§»é™¤ 'data: ' å‰ç¼€
                        
                        if (data === '[DONE]') {
                            // æµç»“æŸ
                            return;
                        }
                        
                        try {
                            // å°è¯•è§£æä¸ºJSONï¼ˆç”¨äºusageç­‰ä¿¡æ¯ï¼‰
                            const jsonData = JSON.parse(data);
                            if (jsonData.type === 'error') {
                                optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼š' + jsonData.message;
                                showAlert(jsonData.message, 'error');
                                return;
                            }
                            // å¿½ç•¥usageä¿¡æ¯
                        } catch (e) {
                            // ä¸æ˜¯JSONï¼Œå°±æ˜¯æ™®é€šæ–‡æœ¬å†…å®¹
                            optimizedContent.textContent += data;
                        }
                    }
                }
                
                // ç»§ç»­è¯»å–
                readStream();
            }).catch(error => {
                console.error('è¯»å–æµå¤±è´¥:', error);
                optimizedPromptDiv.classList.remove('loading');
                optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                showAlert('ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // å¼€å§‹è¯»å–æµ
        readStream();
    })
    .catch(error => {
        optimizedPromptDiv.classList.remove('loading');
        optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
        console.error('ä¼˜åŒ–æç¤ºè¯å¤±è´¥:', error);
        showAlert('ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    });
}

function closeOptimizeModal() {
    document.getElementById('optimizeModal').classList.remove('active');
}

function applyOptimizedPrompt() {
    const optimizedText = document.getElementById('optimizedPromptContent').textContent;
    if (optimizedText && optimizedText !== 'æ­£åœ¨è§£æå›¾ç‰‡å†…å®¹...') {
        document.getElementById('prompt').value = optimizedText;
        closeOptimizeModal();
        showAlert('å·²åº”ç”¨ä¼˜åŒ–åçš„æç¤ºè¯', 'success');
    }
}

function regenerateOptimizedPrompt() {
    // è·å–åŸå§‹æç¤ºè¯
    const originalPrompt = document.getElementById('originalPromptContent').textContent;
    
    if (!originalPrompt) {
        showAlert('æ‰¾ä¸åˆ°åŸå§‹æç¤ºè¯', 'error');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const optimizedPromptDiv = document.querySelector('.optimized-prompt');
    optimizedPromptDiv.classList.add('loading');
    const optimizedContent = document.getElementById('optimizedPromptContent');
    optimizedContent.textContent = 'æ­£åœ¨é‡æ–°ç”Ÿæˆ...';
    
    // ä½¿ç”¨fetchè¿›è¡Œæµå¼è¯·æ±‚
    fetch('/api/optimize-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prompt: originalPrompt,
            task_type: 'video',
            image_filename: currentImageFilename  // ä¼ é€’å›¾ç‰‡æ–‡ä»¶å
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('ç½‘ç»œå“åº”å¤±è´¥');
        }
        
        // ç§»é™¤åŠ è½½çŠ¶æ€ï¼Œæ¸…ç©ºå†…å®¹
        optimizedPromptDiv.classList.remove('loading');
        optimizedContent.textContent = '';
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        // é€’å½’è¯»å–æµå¼æ•°æ®
        function readStream() {
            reader.read().then(({done, value}) => {
                if (done) {
                    return;
                }
                
                // è§£ç æ•°æ®
                buffer += decoder.decode(value, {stream: true});
                
                // æŒ‰è¡Œåˆ†å‰²
                const lines = buffer.split('\n');
                buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                
                // å¤„ç†æ¯ä¸€è¡Œ
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6); // ç§»é™¤ 'data: ' å‰ç¼€
                        
                        if (data === '[DONE]') {
                            // æµç»“æŸ
                            return;
                        }
                        
                        try {
                            // å°è¯•è§£æä¸ºJSONï¼ˆç”¨äºusageç­‰ä¿¡æ¯ï¼‰
                            const jsonData = JSON.parse(data);
                            if (jsonData.type === 'error') {
                                optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼š' + jsonData.message;
                                showAlert(jsonData.message, 'error');
                                return;
                            }
                            // å¿½ç•¥usageä¿¡æ¯
                        } catch (e) {
                            // ä¸æ˜¯JSONï¼Œå°±æ˜¯æ™®é€šæ–‡æœ¬å†…å®¹
                            optimizedContent.textContent += data;
                        }
                    }
                }
                
                // ç»§ç»­è¯»å–
                readStream();
            }).catch(error => {
                console.error('è¯»å–æµå¤±è´¥:', error);
                optimizedPromptDiv.classList.remove('loading');
                optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                showAlert('ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // å¼€å§‹è¯»å–æµ
        readStream();
    })
    .catch(error => {
        optimizedPromptDiv.classList.remove('loading');
        optimizedContent.textContent = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
        console.error('ä¼˜åŒ–æç¤ºè¯å¤±è´¥:', error);
        showAlert('ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    });
}

// æ³¨æ„ï¼šç¼©ç•¥å›¾å¯¼èˆªåŠŸèƒ½å·²è¿ç§»åˆ° ThumbnailNav ç»„ä»¶ä¸­
// è¯·å‹¿åœ¨æ­¤å¤„æ·»åŠ é‡å¤çš„å®ç°ï¼Œä»¥å…é€ æˆå†²çª

// æ ¹æ® task_id æ»šåŠ¨åˆ°ä»»åŠ¡ï¼ˆæ”¯æŒä»»åŠ¡ä¸åœ¨ DOM ä¸­æ—¶è‡ªåŠ¨åŠ è½½ï¼‰
// æ³¨æ„ï¼šæ­¤åŠŸèƒ½å·²æ•´åˆåˆ° ThumbnailNav ç»„ä»¶ä¸­ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹
async function scrollToTaskByTaskId(taskId) {
    // è°ƒç”¨ ThumbnailNav ç»„ä»¶çš„æ–¹æ³•
    if (typeof ThumbnailNav !== 'undefined' && ThumbnailNav.scrollToTaskByTaskId) {
        ThumbnailNav.scrollToTaskByTaskId(taskId);
    } else {
        console.warn('ThumbnailNav ç»„ä»¶æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ»šåŠ¨åˆ°æŒ‡å®šä»»åŠ¡');
    }
}

// åŠ è½½æ‰€æœ‰ä»»åŠ¡ä»¥æ”¯æŒå¯¼èˆªï¼ˆä¸€æ¬¡æ€§åŠ è½½åˆ°é¡µé¢åº•éƒ¨ï¼‰
// æ³¨æ„ï¼šæ­¤åŠŸèƒ½å·²æ•´åˆåˆ° ThumbnailNav ç»„ä»¶ä¸­ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹
let isLoadingAllTasks = false;
async function loadAllTasksForNavigation() {
    // ThumbnailNav ç»„ä»¶æœ‰è‡ªå·±çš„ä»»åŠ¡åŠ è½½æœºåˆ¶ï¼Œæ­¤å¤„ä¸å†é‡å¤å®ç°
    console.warn('loadAllTasksForNavigation å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ ThumbnailNav ç»„ä»¶');
    return Promise.resolve();
}

// é«˜äº®å¹¶æ»šåŠ¨åˆ°æŒ‡å®šä»»åŠ¡
// æ³¨æ„ï¼šæ­¤åŠŸèƒ½å·²æ•´åˆåˆ° ThumbnailNav ç»„ä»¶ä¸­ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹
function highlightAndScrollToTask(taskItem, taskId) {
    // ThumbnailNav ç»„ä»¶æœ‰è‡ªå·±çš„é«˜äº®æœºåˆ¶ï¼Œæ­¤å¤„ä¸å†é‡å¤å®ç°
    console.warn('highlightAndScrollToTask å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ ThumbnailNav ç»„ä»¶');
}

// å…¼å®¹æ—§çš„ scrollToTaskItem è°ƒç”¨
// æ³¨æ„ï¼šæ­¤åŠŸèƒ½å·²æ•´åˆåˆ° ThumbnailNav ç»„ä»¶ä¸­ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹
function scrollToTaskItem(itemId, videoElementId) {
    const taskId = videoElementId || itemId.replace('task-', '');
    scrollToTaskByTaskId(taskId);
}

// ç›‘å¬ä»»åŠ¡åˆ—è¡¨æ»šåŠ¨ï¼ŒåŒæ­¥æ›´æ–°ç¼©ç•¥å›¾å¯¼èˆªçš„æ¿€æ´»çŠ¶æ€
// æ³¨æ„ï¼šæ­¤åŠŸèƒ½å·²æ•´åˆåˆ° ThumbnailNav ç»„ä»¶ä¸­ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹
function initThumbnailNavSync() {
    // ThumbnailNav ç»„ä»¶æœ‰è‡ªå·±çš„åŒæ­¥æœºåˆ¶ï¼Œæ­¤å¤„ä¸å†é‡å¤å®ç°
    console.warn('initThumbnailNavSync å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ ThumbnailNav ç»„ä»¶');
}

// åŒæ­¥ç¼©ç•¥å›¾å¯¼èˆªæ¿€æ´»çŠ¶æ€
// æ³¨æ„ï¼šæ­¤åŠŸèƒ½å·²æ•´åˆåˆ° ThumbnailNav ç»„ä»¶ä¸­ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹
function syncThumbnailNavActive() {
    // ThumbnailNav ç»„ä»¶æœ‰è‡ªå·±çš„åŒæ­¥æœºåˆ¶ï¼Œæ­¤å¤„ä¸å†é‡å¤å®ç°
    console.warn('syncThumbnailNavActive å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ ThumbnailNav ç»„ä»¶');
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç¼©ç•¥å›¾å¯¼èˆª
document.addEventListener('DOMContentLoaded', function() {
    // æ˜¾ç¤ºéª¨æ¶å±
    showTaskListSkeleton('taskList', 3);
    showThumbnailSkeleton('thumbnailNavList', 5);

    // ä½¿ç”¨åˆ†é˜¶æ®µåŠ è½½ç­–ç•¥
    stageLoadPage({
        // é˜¶æ®µ1ï¼šå…³é”®æ•°æ®ï¼ˆ0-500msï¼‰
        stage1: async function() {
            // åŠ è½½é¦–å±ä»»åŠ¡åˆ—è¡¨
            await loadTasks();
        },
        
        // é˜¶æ®µ2ï¼šç¼©ç•¥å›¾æ•°æ®ï¼ˆ500-1000msï¼‰
        stage2: async function() {
            // åˆå§‹åŒ–ç¼©ç•¥å›¾å¯¼èˆªï¼ˆç¦ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼‰
            ThumbnailNav.init({
                apiEndpoint: '/api/video-thumbnails',
                mediaType: 'video',
                itemsPerPage: 50,
                virtualScrollEnabled: false, // ç¦ç”¨è™šæ‹Ÿæ»šåŠ¨
                itemHeight: 120,
                bufferSize: 5,
                preloadDistance: 1.5,
                maxConcurrentLoads: 6
            });
        },
        
        // é˜¶æ®µ3ï¼šæ¬¡è¦åŠŸèƒ½ï¼ˆ1000msåï¼‰
        stage3: async function() {
            // æ³¨å†Œå…¶ä»–åŠŸèƒ½ï¼ˆå¦‚æœæœ‰ï¼‰
            console.log('[INFO] é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ');
        }
    });
});
</script>

<!-- æç¤ºè¯ä¼˜åŒ–æ‚¬æµ®çª— -->
<div id="optimizeModal" class="optimize-modal">
    <div class="optimize-modal-content">
        <div class="optimize-modal-header">
            <h3>AI æç¤ºè¯ä¼˜åŒ– <small style="font-size: 0.7em; color: #666; font-weight: normal;">å»ºè®®å…³é—­æ™ºèƒ½æ”¹å†™</small></h3>
            <button class="optimize-modal-close" onclick="closeOptimizeModal()">&times;</button>
        </div>
        <div class="optimize-modal-body">
            <div class="original-prompt">
                <h4>åŸå§‹æç¤ºè¯</h4>
                <div class="prompt-content" id="originalPromptContent"></div>
            </div>
            <div class="optimized-prompt">
                <h4>ä¼˜åŒ–åçš„æç¤ºè¯</h4>
                <div class="prompt-content" id="optimizedPromptContent"></div>
            </div>
        </div>
        <div class="optimize-modal-footer">
            <button class="btn btn-secondary" onclick="closeOptimizeModal()">å–æ¶ˆ</button>
            <button class="btn btn-regenerate" onclick="regenerateOptimizedPrompt()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
            <button class="btn btn-primary" onclick="applyOptimizedPrompt()">ç«‹å³ä½¿ç”¨</button>
        </div>
    </div>
</div>

{% endblock %}
