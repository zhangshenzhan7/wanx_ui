{% extends "base.html" %}

{% block title %}é€šä¹‰ä¸‡ç›¸ - èµ„äº§åº“{% endblock %}

{% block body %}
<div class="workspace-container">
    <div class="workspace-header">
        <h1>ğŸ“ èµ„äº§åº“</h1>
        <div>
            <button class="btn btn-secondary active" style="margin-right: 10px;">ğŸ“ èµ„äº§åº“</button>
            <button class="btn btn-secondary" onclick="window.location.href='/workspace'" style="margin-right: 10px;">å›¾ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2video'" style="margin-right: 10px;">æ–‡ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/kf2v'" style="margin-right: 10px;">é¦–å°¾å¸§ç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/reference2video'" style="margin-right: 10px;">å‚è€ƒç”Ÿè§†é¢‘</button>
            <button class="btn btn-secondary" onclick="window.location.href='/text2image'" style="margin-right: 10px;">æ–‡ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/image2image'" style="margin-right: 10px;">å›¾ç”Ÿå›¾</button>
            <button class="btn btn-secondary" onclick="window.location.href='/voice-clone'" style="margin-right: 10px;">è¯­éŸ³å¤åˆ»</button>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </div>
    </div>
    
    <div class="assets-content">
        <!-- å·¦ä¾§ï¼šåˆ†ç±»æ ‡ç­¾å’Œä¸Šä¼  -->
        <div class="assets-sidebar">
            <div class="category-tabs">
                <button class="category-tab active" data-category="storyboard" onclick="switchCategory('storyboard')">
                    ğŸ¬ åˆ†é•œåº“
                </button>
                <button class="category-tab" data-category="artwork" onclick="switchCategory('artwork')">
                    ğŸ¨ åŸç”»åº“
                </button>
                <button class="category-tab" data-category="video" onclick="switchCategory('video')">
                    ğŸ¥ è§†é¢‘åº“
                </button>
            </div>
            
            <div class="upload-section">
                <h3>ä¸Šä¼ èµ„äº§</h3>
                <div class="upload-preset">
                    <div class="preset-row">
                        <label>é¡¹ç›®</label>
                        <select id="uploadProjectSelect" class="preset-select" onchange="onUploadProjectChange()">
                            <option value="">ä¸æŒ‡å®š</option>
                        </select>
                    </div>
                    <div class="preset-row">
                        <label>åˆ†é›†</label>
                        <select id="uploadEpisodeSelect" class="preset-select">
                            <option value="">ä¸æŒ‡å®š</option>
                        </select>
                    </div>
                </div>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept="image/*,video/*" style="display: none;" multiple>
                    <div class="upload-placeholder" onclick="document.getElementById('fileInput').click()">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p id="uploadHint">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶</p>
                        <small id="uploadTip">æ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼Œå¯åŒæ—¶é€‰æ‹©å¤šä¸ªæ–‡ä»¶</small>
                    </div>
                </div>
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span id="progressText">ä¸Šä¼ ä¸­...</span>
                </div>
            </div>
            
            <div class="category-info">
                <div id="categoryDescription">
                    <h4>åˆ†é•œåº“</h4>
                    <p>ç”¨äºå­˜å‚¨åˆ†é•œå›¾ç‰‡ï¼Œå¯åœ¨å›¾ç”Ÿè§†é¢‘ã€é¦–å°¾å¸§ç”Ÿè§†é¢‘ç­‰æ¨¡å—ä¸­ä½¿ç”¨ã€‚</p>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šèµ„äº§åˆ—è¡¨ -->
        <div class="assets-main">
            <div class="assets-header">
                <h2 id="categoryTitle">åˆ†é•œåº“</h2>
                <div class="assets-filters">
                    <select id="projectFilter" class="filter-select" onchange="onProjectFilterChange()">
                        <option value="">å…¨éƒ¨é¡¹ç›®</option>
                    </select>
                    <select id="episodeFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">å…¨éƒ¨åˆ†é›†</option>
                    </select>
                </div>
                <div class="assets-actions">
                    <span id="assetCount">0 ä¸ªèµ„äº§</span>
                    <button class="btn btn-secondary btn-sm" onclick="openProjectManageModal()" title="ç®¡ç†é¡¹ç›®å’Œåˆ†é›†">é¡¹ç›®ç®¡ç†</button>
                    <button class="btn btn-secondary btn-sm" onclick="toggleSelectMode()" id="selectModeBtn">
                        æ‰¹é‡é€‰æ‹©
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="openBatchTagModal()" id="batchTagBtn" style="display:none;">
                        è®¾ç½®æ ‡ç­¾ (<span id="tagCount">0</span>)
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadSelected()" id="downloadSelectedBtn" style="display:none;">
                        ä¸‹è½½é€‰ä¸­ (<span id="downloadCount">0</span>)
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSelected()" id="deleteSelectedBtn" style="display:none;">
                        åˆ é™¤é€‰ä¸­ (<span id="selectedCount">0</span>)
                    </button>
                </div>
            </div>
            
            <div id="assetList" class="asset-grid">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            
            <div id="loadMore" class="load-more" style="display: none;">
                <button class="btn btn-secondary" onclick="loadMoreAssets()">åŠ è½½æ›´å¤š</button>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡/è§†é¢‘é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="preview-modal" id="previewModal" onclick="closePreviewModal()">
    <div class="preview-modal-content" onclick="event.stopPropagation()">
        <button class="preview-modal-close" onclick="closePreviewModal()">&times;</button>
        <img id="previewImage" style="display: none;">
        <video id="previewVideo" controls style="display: none;"></video>
    </div>
</div>

<!-- æ ‡ç­¾ç¼–è¾‘å¼¹çª— -->
<div class="tag-modal" id="tagModal" onclick="closeTagModal()">
    <div class="tag-modal-content" onclick="event.stopPropagation()">
        <div class="tag-modal-header">
            <h3 id="tagModalTitle">ç¼–è¾‘èµ„äº§</h3>
            <button class="tag-modal-close" onclick="closeTagModal()">&times;</button>
        </div>
        <div class="tag-modal-body">
            <div class="tag-form-group" id="renameFormGroup">
                <label>åç§°</label>
                <input type="text" id="tagNameInput" class="tag-input" placeholder="è¾“å…¥åç§°" style="width: 100%;">
            </div>
            <div class="tag-form-group">
                <label>é¡¹ç›®</label>
                <select id="tagProjectSelect" class="tag-select" onchange="onProjectChange()" style="width: 100%;">
                    <option value="">æœªåˆ†é…</option>
                </select>
            </div>
            <div class="tag-form-group">
                <label>åˆ†é›†</label>
                <select id="tagEpisodeSelect" class="tag-select" style="width: 100%;">
                    <option value="">æœªåˆ†é…</option>
                </select>
            </div>
        </div>
        <div class="tag-modal-footer">
            <button class="btn btn-secondary" onclick="closeTagModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveTagChanges()" id="saveTagBtn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- é¡¹ç›®ç®¡ç†å¼¹çª— -->
<div class="project-manage-modal" id="projectManageModal" onclick="closeProjectManageModal()">
    <div class="project-manage-content" onclick="event.stopPropagation()">
        <div class="project-manage-header">
            <h3>é¡¹ç›®ä¸åˆ†é›†ç®¡ç†</h3>
            <button class="project-manage-close" onclick="closeProjectManageModal()">&times;</button>
        </div>
        <div class="project-manage-body">
            <div class="project-list-section">
                <div class="section-header">
                    <span>é¡¹ç›®åˆ—è¡¨</span>
                    <button class="btn btn-primary btn-sm" onclick="showAddProjectForm()">ï¼‹ æ–°å»ºé¡¹ç›®</button>
                </div>
                <div id="addProjectForm" class="add-form" style="display:none;">
                    <input type="text" id="addProjectNameInput" class="add-form-input" placeholder="è¾“å…¥é¡¹ç›®åç§°">
                    <button class="btn btn-primary btn-sm" onclick="confirmAddProject()">æ·»åŠ </button>
                    <button class="btn btn-secondary btn-sm" onclick="hideAddProjectForm()">å–æ¶ˆ</button>
                </div>
                <div id="projectListContainer" class="project-tree">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        <div class="project-manage-footer">
            <button class="btn btn-secondary" onclick="closeProjectManageModal()">å…³é—­</button>
        </div>
    </div>
</div>

<style>
.assets-content {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
    padding: 24px;
    min-height: calc(100vh - 80px);
}

.assets-sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.category-tabs {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: var(--bg-primary);
    padding: 16px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
}

.category-tab {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    text-align: left;
}

.category-tab:hover {
    background: var(--bg-tertiary);
    border-color: var(--primary-color);
}

.category-tab.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.upload-section {
    background: var(--bg-primary);
    padding: 16px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
}

.upload-section h3 {
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 600;
}

.upload-preset {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
}

.preset-row {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.preset-row label {
    font-size: 12px;
    color: var(--text-secondary);
}

.preset-select {
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    font-size: 12px;
    cursor: pointer;
}

.preset-select:focus {
    outline: none;
    border-color: var(--primary-color);
}

.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.upload-area:hover, .upload-area.dragover {
    border-color: var(--primary-color);
    background: rgba(22, 100, 255, 0.05);
}

.upload-placeholder svg {
    color: var(--text-tertiary);
    margin-bottom: 12px;
}

.upload-placeholder p {
    color: var(--text-secondary);
    margin: 0 0 8px 0;
    font-size: 14px;
}

.upload-placeholder small {
    color: var(--text-tertiary);
    font-size: 12px;
}

.upload-progress {
    margin-top: 12px;
}

.progress-bar {
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--primary-color);
    width: 0%;
    transition: width 0.3s;
}

.category-info {
    background: var(--bg-primary);
    padding: 16px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
}

.category-info h4 {
    margin: 0 0 8px 0;
    font-size: 14px;
    font-weight: 600;
}

.category-info p {
    margin: 0;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.6;
}

.assets-main {
    background: var(--bg-primary);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.assets-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-light);
}

.assets-header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.assets-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

#assetCount {
    color: var(--text-secondary);
    font-size: 14px;
}

.asset-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
    flex: 1;
    overflow-y: auto;
    max-height: calc(100vh - 300px);
}

.asset-item {
    position: relative;
    border-radius: var(--radius-md);
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
    background: var(--bg-tertiary);
    aspect-ratio: 1;
}

.asset-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-color);
}

.asset-item.selected {
    border-color: #dc3545;
    box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.3);
}

.asset-item img, .asset-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.asset-item .asset-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    padding: 30px 10px 10px;
    color: white;
}

.asset-item .asset-name {
    font-size: 12px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.asset-item .asset-checkbox {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 22px;
    height: 22px;
    display: none;
    z-index: 10;
    accent-color: #dc3545;
}

.asset-item.select-mode .asset-checkbox {
    display: block;
}

.asset-item .video-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    z-index: 5;
}

/* è§†é¢‘å°é¢å›¾æ ·å¼ */
.video-poster-preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #1a1a1a;
}

/* è§†é¢‘æ’­æ”¾æŒ‰é’®è§†è§‰æç¤º */
.asset-item:has(.video-poster-preview)::before {
    content: 'â–¶';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 44px;
    height: 44px;
    background: rgba(0,0,0,0.6);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    z-index: 5;
    pointer-events: none;
    transition: all 0.2s;
}

.asset-item:has(.video-poster-preview):hover::before {
    background: rgba(22, 100, 255, 0.9);
    transform: translate(-50%, -50%) scale(1.1);
}

.asset-item .delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
}

.asset-item:hover .delete-btn {
    display: flex;
}

.asset-item.select-mode .delete-btn {
    display: none;
}

.load-more {
    text-align: center;
    padding: 20px;
}

.loading {
    text-align: center;
    padding: 60px;
    color: var(--text-tertiary);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-tertiary);
}

.empty-state svg {
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state p {
    margin: 0;
    font-size: 14px;
}

/* é¢„è§ˆæ¨¡æ€æ¡† */
.preview-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

.preview-modal.active {
    display: flex;
}

.preview-modal-content {
    max-width: 90%;
    max-height: 90%;
    position: relative;
}

.preview-modal-content img, .preview-modal-content video {
    max-width: 100%;
    max-height: 85vh;
    border-radius: 8px;
}

.preview-modal-close {
    position: absolute;
    top: -40px;
    right: 0;
    color: white;
    font-size: 30px;
    cursor: pointer;
    background: none;
    border: none;
    padding: 5px 15px;
}

@media (max-width: 900px) {
    .assets-content {
        grid-template-columns: 1fr;
    }
    
    .assets-sidebar {
        flex-direction: row;
        flex-wrap: wrap;
    }
    
    .category-tabs {
        flex-direction: row;
        flex: 1;
    }
    
    .upload-section, .category-info {
        flex: 1;
        min-width: 200px;
    }
}

/* ç­›é€‰ä¸‹æ‹‰æ¡† */
.assets-filters {
    display: flex;
    gap: 8px;
    align-items: center;
}

.filter-select {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    font-size: 13px;
    cursor: pointer;
    min-width: 100px;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* èµ„äº§æ ‡ç­¾å¾½ç«  */
.asset-tags {
    position: absolute;
    top: 8px;
    left: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    z-index: 6;
}

.asset-tag {
    display: inline-block;
    padding: 2px 6px;
    background: rgba(22, 100, 255, 0.9);
    color: white;
    font-size: 10px;
    border-radius: 3px;
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.asset-tag.episode {
    background: rgba(40, 167, 69, 0.9);
}

.asset-item .edit-tag-btn {
    position: absolute;
    top: 8px;
    right: 36px;
    width: 28px;
    height: 28px;
    background: rgba(22, 100, 255, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.2s;
}

.asset-item:hover .edit-tag-btn {
    display: flex;
}

.asset-item.select-mode .edit-tag-btn {
    display: none;
}

/* æ ‡ç­¾ç¼–è¾‘å¼¹çª— */
.tag-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10001;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(3px);
}

.tag-modal.active {
    display: flex;
}

.tag-modal-content {
    background: var(--bg-primary);
    border-radius: 12px;
    width: 90vw;
    max-width: 400px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4);
}

.tag-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-light);
}

.tag-modal-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.tag-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0 8px;
}

.tag-modal-body {
    padding: 20px;
}

.tag-form-group {
    margin-bottom: 16px;
}

.tag-form-group:last-child {
    margin-bottom: 0;
}

.tag-form-group label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.tag-input-row {
    display: flex;
    gap: 8px;
}

.tag-select, .tag-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    font-size: 14px;
}

.tag-select:focus, .tag-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.tag-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 16px 20px;
    border-top: 1px solid var(--border-light);
    background: var(--bg-secondary);
    border-radius: 0 0 12px 12px;
}

/* é¡¹ç›®ç®¡ç†å¼¹çª—æ ·å¼ */
.project-manage-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10002;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(3px);
}

.project-manage-modal.active {
    display: flex;
}

.project-manage-content {
    background: var(--bg-primary);
    border-radius: 12px;
    width: 90vw;
    max-width: 550px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4);
}

.project-manage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-light);
}

.project-manage-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.project-manage-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0 8px;
}

.project-manage-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
}

.project-manage-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 16px 20px;
    border-top: 1px solid var(--border-light);
    background: var(--bg-secondary);
    border-radius: 0 0 12px 12px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.section-header span {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
}

.add-form {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    padding: 10px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
}

.add-form-input {
    flex: 1;
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    font-size: 13px;
}

.add-form-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.project-tree {
    max-height: 400px;
    overflow-y: auto;
}

.project-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
    overflow: hidden;
}

.project-header {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    transition: background 0.2s;
}

.project-header:hover {
    background: var(--bg-tertiary);
}

.project-expand-icon {
    width: 20px;
    font-size: 10px;
    color: var(--text-tertiary);
    transition: transform 0.2s;
}

.project-item.expanded .project-expand-icon {
    transform: rotate(90deg);
}

.project-icon {
    margin-right: 8px;
}

.project-name {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
}

.project-name-input {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    padding: 2px 6px;
    border: 1px solid var(--primary-color);
    border-radius: 4px;
    background: var(--bg-primary);
    outline: none;
    min-width: 100px;
}

.project-count {
    font-size: 12px;
    color: var(--text-tertiary);
    margin-right: 8px;
}

.project-actions {
    display: flex;
    gap: 4px;
}

.project-action-btn {
    background: none;
    border: none;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    color: var(--text-secondary);
    border-radius: 4px;
    transition: all 0.2s;
}

.project-action-btn:hover {
    background: var(--bg-primary);
    color: var(--primary-color);
}

.project-action-btn.danger:hover {
    color: #dc3545;
}

.episode-list {
    display: none;
    padding: 8px 12px 8px 32px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-light);
}

.project-item.expanded .episode-list {
    display: block;
}

.episode-item {
    display: flex;
    align-items: center;
    padding: 6px 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    margin-bottom: 6px;
}

.episode-item:last-child {
    margin-bottom: 0;
}

.episode-icon {
    margin-right: 8px;
    font-size: 12px;
}

.episode-name {
    flex: 1;
    font-size: 13px;
}

.episode-name-input {
    flex: 1;
    font-size: 13px;
    padding: 2px 6px;
    border: 1px solid var(--primary-color);
    border-radius: 4px;
    background: var(--bg-primary);
    outline: none;
    min-width: 80px;
}

.episode-actions {
    display: flex;
    gap: 4px;
}

.add-episode-btn {
    display: flex;
    align-items: center;
    padding: 6px 8px;
    background: transparent;
    border: 1px dashed var(--border-color);
    border-radius: 4px;
    margin-top: 8px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text-tertiary);
    transition: all 0.2s;
}

.add-episode-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.add-episode-form {
    display: flex;
    gap: 6px;
    margin-top: 8px;
}

.add-episode-input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-secondary);
    font-size: 12px;
}

.empty-projects {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-tertiary);
}

.empty-projects p {
    margin: 8px 0 0 0;
    font-size: 14px;
}

.edit-input {
    padding: 4px 8px;
    border: 1px solid var(--primary-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--bg-primary);
}
</style>

<script>
// å½“å‰åˆ†ç±»
let currentCategory = 'storyboard';
let currentPage = 1;
let hasMore = false;
let isSelectMode = false;
let selectedAssets = new Set();

// é¡¹ç›®å’Œç­›é€‰ç›¸å…³
let projectsList = [];
let currentFilterProject = '';
let currentFilterEpisode = '';
let editingAsset = null;  // å½“å‰æ­£åœ¨ç¼–è¾‘æ ‡ç­¾çš„èµ„äº§
let isBatchTagMode = false;  // æ˜¯å¦ä¸ºæ‰¹é‡æ ‡ç­¾æ¨¡å¼

// åˆ†ç±»ä¿¡æ¯
const categoryInfo = {
    storyboard: {
        title: 'åˆ†é•œåº“',
        icon: 'ğŸ¬',
        description: 'ç”¨äºå­˜å‚¨åˆ†é•œå›¾ç‰‡ï¼Œå¯åœ¨å›¾ç”Ÿè§†é¢‘ã€é¦–å°¾å¸§ç”Ÿè§†é¢‘ç­‰æ¨¡å—ä¸­ä½¿ç”¨ã€‚',
        accept: 'image/*',
        tip: 'æ”¯æŒ JPGã€PNGã€BMPã€WEBPã€GIF æ ¼å¼'
    },
    artwork: {
        title: 'åŸç”»åº“',
        icon: 'ğŸ¨',
        description: 'ç”¨äºå­˜å‚¨åŸç”»å’Œè§’è‰²è®¾è®¡å›¾ï¼Œå¯åœ¨å›¾ç”Ÿè§†é¢‘ã€å›¾ç”Ÿå›¾ç­‰æ¨¡å—ä¸­ä½¿ç”¨ã€‚',
        accept: 'image/*',
        tip: 'æ”¯æŒ JPGã€PNGã€BMPã€WEBPã€GIF æ ¼å¼'
    },
    video: {
        title: 'è§†é¢‘åº“',
        icon: 'ğŸ¥',
        description: 'ç”¨äºå­˜å‚¨å‚è€ƒè§†é¢‘ç´ æï¼Œä¾¿äºç®¡ç†å’ŒæŸ¥çœ‹ã€‚',
        accept: 'video/*',
        tip: 'æ”¯æŒ MP4ã€MOVã€AVIã€WEBM æ ¼å¼'
    }
};

// åˆ‡æ¢åˆ†ç±»
function switchCategory(category) {
    currentCategory = category;
    currentPage = 1;
    selectedAssets.clear();
    updateSelectedCount();
    
    // æ›´æ–°æ ‡ç­¾æ ·å¼
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.category === category);
    });
    
    // æ›´æ–°ä¿¡æ¯
    const info = categoryInfo[category];
    document.getElementById('categoryTitle').textContent = info.title;
    document.getElementById('categoryDescription').innerHTML = `
        <h4>${info.title}</h4>
        <p>${info.description}</p>
    `;
    document.getElementById('uploadHint').textContent = 'ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶';
    document.getElementById('uploadTip').textContent = `${info.tip}ï¼Œæ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼Œå¯åŒæ—¶é€‰æ‹©å¤šä¸ªæ–‡ä»¶`;
    document.getElementById('fileInput').accept = info.accept;
    
    // åŠ è½½èµ„äº§
    loadAssets();
}

// åŠ è½½èµ„äº§
async function loadAssets(append = false) {
    const assetList = document.getElementById('assetList');
    
    if (!append) {
        assetList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    }
    
    try {
        // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼ŒåŒ…å«ç­›é€‰æ¡ä»¶
        let url = `/api/assets/list?category=${currentCategory}&page=${currentPage}&limit=20`;
        if (currentFilterProject) {
            url += `&project=${encodeURIComponent(currentFilterProject)}`;
        }
        if (currentFilterEpisode) {
            url += `&episode=${encodeURIComponent(currentFilterEpisode)}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            if (!append) {
                assetList.innerHTML = '';
            }
            
            if (data.assets.length === 0 && !append) {
                assetList.innerHTML = `
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <p>æš‚æ— èµ„äº§ï¼Œç‚¹å‡»ä¸Šæ–¹åŒºåŸŸä¸Šä¼ </p>
                    </div>
                `;
            } else {
                data.assets.forEach(asset => {
                    assetList.appendChild(createAssetItem(asset));
                });
            }
            
            hasMore = data.has_more;
            document.getElementById('loadMore').style.display = hasMore ? 'block' : 'none';
            document.getElementById('assetCount').textContent = `${data.total} ä¸ªèµ„äº§`;
        }
    } catch (error) {
        console.error('åŠ è½½èµ„äº§å¤±è´¥:', error);
        assetList.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p></div>';
    }
}

// åˆ›å»ºèµ„äº§é¡¹
function createAssetItem(asset) {
    const div = document.createElement('div');
    div.className = 'asset-item' + (isSelectMode ? ' select-mode' : '');
    div.dataset.filename = asset.filename;
    div.dataset.category = asset.category;
    div.dataset.url = asset.url;  // æ·»åŠ URLç”¨äºä¸‹è½½
    div.dataset.project = asset.project || '';
    div.dataset.episode = asset.episode || '';
    
    const isVideo = asset.file_type === 'video';
    
    // è§†é¢‘ä½¿ç”¨å°é¢å›¾ï¼Œé¿å…ç›´æ¥åŠ è½½è§†é¢‘å¯¼è‡´å¸¦å®½è¿‡å¤§
    let mediaContent;
    if (isVideo) {
        // ä½¿ç”¨å°é¢å›¾æ›¿ä»£videoæ ‡ç­¾ï¼Œå¤§å¹…å‡å°‘åŠ è½½é‡
        const posterUrl = asset.poster_url || '';
        mediaContent = `<img src="${posterUrl}" alt="${asset.original_filename}" loading="lazy" class="video-poster-preview" onerror="this.style.background='#333'">`;
    } else {
        mediaContent = `<img src="${asset.url}" alt="${asset.original_filename}" loading="lazy">`;
    }
    
    // æ„å»ºæ ‡ç­¾å¾½ç« HTML
    let tagsHtml = '';
    if (asset.project || asset.episode) {
        tagsHtml = '<div class="asset-tags">';
        if (asset.project) {
            tagsHtml += `<span class="asset-tag" title="${asset.project}">${asset.project}</span>`;
        }
        if (asset.episode) {
            tagsHtml += `<span class="asset-tag episode" title="${asset.episode}">${asset.episode}</span>`;
        }
        tagsHtml += '</div>';
    }
    
    div.innerHTML = `
        <input type="checkbox" class="asset-checkbox" onclick="event.stopPropagation(); toggleSelect('${asset.filename}')">
        ${isVideo ? '<span class="video-badge">ğŸ¬ è§†é¢‘</span>' : ''}
        ${tagsHtml}
        ${mediaContent}
        <div class="asset-overlay">
            <div class="asset-name" title="${asset.original_filename}">${asset.original_filename}</div>
        </div>
        <button class="edit-tag-btn" onclick="event.stopPropagation(); openTagModal('${asset.category}', '${asset.filename}', '${asset.project || ''}', '${asset.episode || ''}', '${escapeQuotes(asset.original_filename)}')" title="ç¼–è¾‘">âœ</button>
        <button class="delete-btn" onclick="event.stopPropagation(); deleteAsset('${asset.category}', '${asset.filename}')" title="åˆ é™¤">Ã—</button>
    `;
    
    div.onclick = () => {
        if (isSelectMode) {
            toggleSelect(asset.filename);
        } else {
            previewAsset(asset);
        }
    };
    
    return div;
}

// åŠ è½½æ›´å¤š
function loadMoreAssets() {
    currentPage++;
    loadAssets(true);
}

// ä¸Šä¼ æ–‡ä»¶
const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');

fileInput.addEventListener('change', handleFileSelect);

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

function handleFileSelect(e) {
    handleFiles(e.target.files);
    e.target.value = '';
}

async function handleFiles(files) {
    const progressDiv = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    progressDiv.style.display = 'block';
    
    let uploaded = 0;
    const total = files.length;
    
    // æ˜¾ç¤ºæ€»æ–‡ä»¶æ•°
    progressText.textContent = `å‡†å¤‡ä¸Šä¼  ${total} ä¸ªæ–‡ä»¶...`;
    
    try {
        // æ‰¹é‡ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('file', files[i]);
        }
        formData.append('category', currentCategory);
        
        progressText.textContent = `æ­£åœ¨ä¸Šä¼  ${total} ä¸ªæ–‡ä»¶...`;
        progressFill.style.width = '50%';
        
        const response = await fetch('/api/assets/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success && data.files) {
            uploaded = data.files.length;
            progressFill.style.width = '100%';
            progressText.textContent = `ä¸Šä¼ å®Œæˆ (${uploaded}/${total})`;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é¢„è®¾çš„é¡¹ç›®/åˆ†é›†ï¼Œå¦‚æœæœ‰åˆ™è‡ªåŠ¨è®¾ç½®æ ‡ç­¾
            const presetProject = document.getElementById('uploadProjectSelect')?.value || '';
            const presetEpisode = document.getElementById('uploadEpisodeSelect')?.value || '';
            
            if (presetProject && data.files && data.files.length > 0) {
                // æ‰¹é‡è®¾ç½®æ ‡ç­¾
                const assets = data.files.map(f => ({
                    category: f.category || currentCategory,
                    filename: f.filename
                }));
                
                try {
                    await fetch('/api/assets/batch-tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            assets,
                            project: presetProject,
                            episode: presetEpisode
                        })
                    });
                    progressText.textContent = `ä¸Šä¼ å¹¶æ ‡è®°å®Œæˆ`;
                } catch (e) {
                    console.error('è®¾ç½®æ ‡ç­¾å¤±è´¥:', e);
                }
            }
            
            // åˆ·æ–°åˆ—è¡¨
            currentPage = 1;
            loadAssets();
            loadProjects();  // åˆ·æ–°é¡¹ç›®åˆ—è¡¨
            
            // æ˜¾ç¤ºä¸Šä¼ ç»“æœé€šçŸ¥
            showAlert(data.message || `æˆåŠŸä¸Šä¼  ${uploaded} ä¸ªæ–‡ä»¶`, 'success');
        } else {
            throw new Error(data.message || 'ä¸Šä¼ å¤±è´¥');
        }
    } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        progressFill.style.width = '100%';
        progressText.textContent = 'ä¸Šä¼ å¤±è´¥';
        showAlert(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
    
    setTimeout(() => {
        progressDiv.style.display = 'none';
        progressFill.style.width = '0%';
    }, 2000);
}

async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('category', currentCategory);
    
    const response = await fetch('/api/assets/upload', {
        method: 'POST',
        body: formData
    });
    
    const data = await response.json();
    
    if (!data.success) {
        throw new Error(data.message);
    }
    
    // è¿”å›ç¬¬ä¸€ä¸ªä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯ï¼ˆä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ï¼‰
    return data.files && data.files.length > 0 ? data.files[0] : data;
}

// åˆ é™¤èµ„äº§
async function deleteAsset(category, filename) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèµ„äº§å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch('/api/assets/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ category, filename })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('åˆ é™¤æˆåŠŸ', 'success');
            currentPage = 1;
            loadAssets();
        } else {
            showAlert(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('åˆ é™¤å¤±è´¥', 'error');
    }
}

// æ‰¹é‡é€‰æ‹©æ¨¡å¼
function toggleSelectMode() {
    isSelectMode = !isSelectMode;
    selectedAssets.clear();
    updateSelectedCount();
    
    document.getElementById('selectModeBtn').textContent = isSelectMode ? 'å–æ¶ˆé€‰æ‹©' : 'æ‰¹é‡é€‰æ‹©';
    document.getElementById('deleteSelectedBtn').style.display = isSelectMode ? 'inline-flex' : 'none';
    document.getElementById('downloadSelectedBtn').style.display = isSelectMode ? 'inline-flex' : 'none';
    document.getElementById('batchTagBtn').style.display = isSelectMode ? 'inline-flex' : 'none';
    
    document.querySelectorAll('.asset-item').forEach(item => {
        item.classList.toggle('select-mode', isSelectMode);
        item.querySelector('.asset-checkbox').checked = false;
    });
}

function toggleSelect(filename) {
    if (selectedAssets.has(filename)) {
        selectedAssets.delete(filename);
    } else {
        selectedAssets.add(filename);
    }
    
    const item = document.querySelector(`.asset-item[data-filename="${filename}"]`);
    if (item) {
        item.classList.toggle('selected', selectedAssets.has(filename));
        item.querySelector('.asset-checkbox').checked = selectedAssets.has(filename);
    }
    
    updateSelectedCount();
}

function updateSelectedCount() {
    document.getElementById('selectedCount').textContent = selectedAssets.size;
    document.getElementById('downloadCount').textContent = selectedAssets.size;
    document.getElementById('tagCount').textContent = selectedAssets.size;
}

// ä¸‹è½½é€‰ä¸­çš„èµ„äº§
async function downloadSelected() {
    if (selectedAssets.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„èµ„äº§', 'info');
        return;
    }
    
    showAlert(`å¼€å§‹ä¸‹è½½ ${selectedAssets.size} ä¸ªæ–‡ä»¶...`, 'success');
    
    let downloadCount = 0;
    for (const filename of selectedAssets) {
        const item = document.querySelector(`.asset-item[data-filename="${filename}"]`);
        if (item) {
            const url = item.dataset.url;
            const category = item.dataset.category;
            
            if (url) {
                try {
                    // ä½¿ç”¨fetchä¸‹è½½æ–‡ä»¶
                    const response = await fetch(url);
                    const blob = await response.blob();
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    
                    downloadCount++;
                    
                    // å»¶è¿Ÿä¸€ä¸‹é¿å…æµè§ˆå™¨é™åˆ¶
                    await new Promise(resolve => setTimeout(resolve, 300));
                } catch (error) {
                    console.error('ä¸‹è½½å¤±è´¥:', filename, error);
                }
            }
        }
    }
    
    if (downloadCount > 0) {
        showAlert(`å·²ä¸‹è½½ ${downloadCount} ä¸ªæ–‡ä»¶`, 'success');
    }
}

async function deleteSelected() {
    if (selectedAssets.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„èµ„äº§', 'info');
        return;
    }
    
    if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedAssets.size} ä¸ªèµ„äº§å—ï¼Ÿ`)) return;
    
    for (const filename of selectedAssets) {
        const item = document.querySelector(`.asset-item[data-filename="${filename}"]`);
        const category = item?.dataset.category || currentCategory;
        
        try {
            await fetch('/api/assets/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category, filename })
            });
        } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', filename);
        }
    }
    
    showAlert('åˆ é™¤å®Œæˆ', 'success');
    selectedAssets.clear();
    currentPage = 1;
    loadAssets();
    toggleSelectMode();
}

// é¢„è§ˆèµ„äº§
function previewAsset(asset) {
    const modal = document.getElementById('previewModal');
    const img = document.getElementById('previewImage');
    const video = document.getElementById('previewVideo');
    
    if (asset.file_type === 'video') {
        img.style.display = 'none';
        video.style.display = 'block';
        video.src = asset.url;
        video.play();
    } else {
        video.style.display = 'none';
        img.style.display = 'block';
        img.src = asset.url;
    }
    
    modal.classList.add('active');
}

function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    const video = document.getElementById('previewVideo');
    
    video.pause();
    video.src = '';
    modal.classList.remove('active');
}

// ========== é¡¹ç›®/æ ‡ç­¾ç®¡ç†åŠŸèƒ½ ==========

// åŠ è½½é¡¹ç›®åˆ—è¡¨
async function loadProjects() {
    try {
        const response = await fetch('/api/assets/projects');
        const data = await response.json();
        if (data.success) {
            projectsList = data.projects || [];
            updateProjectFilterOptions();
            updateTagProjectOptions();
            updateUploadProjectOptions();  // æ›´æ–°ä¸Šä¼ é¢„è®¾é€‰é¡¹
        }
    } catch (error) {
        console.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ›´æ–°ä¸Šä¼ é¢„è®¾ä¸‹æ‹‰æ¡†çš„é¡¹ç›®é€‰é¡¹
function updateUploadProjectOptions() {
    const select = document.getElementById('uploadProjectSelect');
    if (!select) return;
    const currentValue = select.value;
    select.innerHTML = '<option value="">ä¸æŒ‡å®š</option>';
    projectsList.forEach(project => {
        const option = document.createElement('option');
        option.value = project.name;
        option.textContent = project.name;
        select.appendChild(option);
    });
    select.value = currentValue;
}

// æ›´æ–°ä¸Šä¼ é¢„è®¾çš„åˆ†é›†é€‰é¡¹
function updateUploadEpisodeOptions() {
    const projectName = document.getElementById('uploadProjectSelect').value;
    const select = document.getElementById('uploadEpisodeSelect');
    if (!select) return;
    select.innerHTML = '<option value="">ä¸æŒ‡å®š</option>';
    
    if (projectName) {
        const project = projectsList.find(p => p.name === projectName);
        if (project && project.episodes) {
            project.episodes.forEach(episode => {
                const option = document.createElement('option');
                option.value = episode;
                option.textContent = episode;
                select.appendChild(option);
            });
        }
    }
}

// ä¸Šä¼ é¢„è®¾é¡¹ç›®å˜åŒ–æ—¶æ›´æ–°åˆ†é›†é€‰é¡¹
function onUploadProjectChange() {
    updateUploadEpisodeOptions();
}

// æ›´æ–°ç­›é€‰ä¸‹æ‹‰æ¡†çš„é¡¹ç›®é€‰é¡¹
function updateProjectFilterOptions() {
    const select = document.getElementById('projectFilter');
    select.innerHTML = '<option value="">å…¨éƒ¨é¡¹ç›®</option>';
    projectsList.forEach(project => {
        const option = document.createElement('option');
        option.value = project.name;
        option.textContent = project.name;
        if (project.name === currentFilterProject) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

// æ›´æ–°åˆ†é›†ç­›é€‰é€‰é¡¹
function updateEpisodeFilterOptions() {
    const select = document.getElementById('episodeFilter');
    select.innerHTML = '<option value="">å…¨éƒ¨åˆ†é›†</option>';
    
    if (currentFilterProject) {
        const project = projectsList.find(p => p.name === currentFilterProject);
        if (project && project.episodes) {
            project.episodes.forEach(episode => {
                const option = document.createElement('option');
                option.value = episode;
                option.textContent = episode;
                if (episode === currentFilterEpisode) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
    }
}

// åº”ç”¨ç­›é€‰
function applyFilters() {
    currentFilterProject = document.getElementById('projectFilter').value;
    currentFilterEpisode = document.getElementById('episodeFilter').value;
    
    // é‡æ–°åŠ è½½èµ„äº§
    currentPage = 1;
    loadAssets();
}

// å¿«æ·åˆ›å»ºåˆ†é›†
async function quickCreateEpisode() {
    if (!currentFilterProject) {
        showAlert('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'info');
        return;
    }
    
    const name = prompt('è¯·è¾“å…¥æ–°åˆ†é›†åç§°:');
    if (!name || !name.trim()) return;
    
    try {
        const response = await fetch(`/api/assets/projects/${encodeURIComponent(currentFilterProject)}/episodes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name.trim() })
        });
        
        const data = await response.json();
        if (data.success) {
            showAlert('åˆ†é›†åˆ›å»ºæˆåŠŸ', 'success');
            await loadProjects();
            updateEpisodeFilterOptions();
            // è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„åˆ†é›†
            currentFilterEpisode = name.trim();
            document.getElementById('episodeFilter').value = name.trim();
            currentPage = 1;
            loadAssets();
        } else {
            showAlert(data.message || 'åˆ›å»ºå¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥', 'error');
    }
}

// æ¸…é™¤ç­›é€‰
function clearFilters() {
    currentFilterProject = '';
    currentFilterEpisode = '';
    document.getElementById('projectFilter').value = '';
    document.getElementById('episodeFilter').value = '';
    updateEpisodeFilterOptions();
    currentPage = 1;
    loadAssets();
}

// æ›´æ–°æ ‡ç­¾ç¼–è¾‘å¼¹çª—ä¸­çš„é¡¹ç›®é€‰é¡¹
function updateTagProjectOptions() {
    const select = document.getElementById('tagProjectSelect');
    const currentValue = select.value;  // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
    select.innerHTML = '<option value="">æœªåˆ†é…</option>';
    projectsList.forEach(project => {
        const option = document.createElement('option');
        option.value = project.name;
        option.textContent = project.name;
        select.appendChild(option);
    });
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
    if (currentValue) {
        select.value = currentValue;
    }
}

// æ›´æ–°æ ‡ç­¾ç¼–è¾‘å¼¹çª—ä¸­çš„åˆ†é›†é€‰é¡¹
function updateTagEpisodeOptions() {
    const projectName = document.getElementById('tagProjectSelect').value;
    const select = document.getElementById('tagEpisodeSelect');
    const currentValue = select.value;  // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
    select.innerHTML = '<option value="">æœªåˆ†é…</option>';
    
    if (projectName) {
        const project = projectsList.find(p => p.name === projectName);
        if (project && project.episodes) {
            project.episodes.forEach(episode => {
                const option = document.createElement('option');
                option.value = episode;
                option.textContent = episode;
                select.appendChild(option);
            });
        }
    }
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
    if (currentValue) {
        select.value = currentValue;
    }
}

// é¡¹ç›®é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°åˆ†é›†é€‰é¡¹
function onProjectChange() {
    updateTagEpisodeOptions();
}

// æ‰“å¼€æ ‡ç­¾ç¼–è¾‘å¼¹çª—ï¼ˆå•ä¸ªèµ„äº§ï¼‰
function openTagModal(category, filename, project, episode, currentName) {
    editingAsset = { category, filename, currentName };
    isBatchTagMode = false;
    
    document.getElementById('tagModalTitle').textContent = 'ç¼–è¾‘èµ„äº§';
    
    // æ˜¾ç¤ºé‡å‘½åè¾“å…¥æ¡†
    document.getElementById('renameFormGroup').style.display = 'block';
    document.getElementById('tagNameInput').value = currentName || '';
    
    // è®¾ç½®å½“å‰å€¼
    updateTagProjectOptions();
    document.getElementById('tagProjectSelect').value = project || '';
    updateTagEpisodeOptions();
    document.getElementById('tagEpisodeSelect').value = episode || '';
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('tagModal').classList.add('active');
}

// æ‰“å¼€æ‰¹é‡æ ‡ç­¾è®¾ç½®å¼¹çª—
function openBatchTagModal() {
    if (selectedAssets.size === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦è®¾ç½®æ ‡ç­¾çš„èµ„äº§', 'info');
        return;
    }
    
    editingAsset = null;
    isBatchTagMode = true;
    
    document.getElementById('tagModalTitle').textContent = `æ‰¹é‡è®¾ç½®æ ‡ç­¾ (${selectedAssets.size} ä¸ªèµ„äº§)`;
    
    // éšè—é‡å‘½åè¾“å…¥æ¡†ï¼ˆæ‰¹é‡æ¨¡å¼ä¸æ”¯æŒé‡å‘½åï¼‰
    document.getElementById('renameFormGroup').style.display = 'none';
    
    // é‡ç½®é€‰é¡¹
    updateTagProjectOptions();
    document.getElementById('tagProjectSelect').value = '';
    updateTagEpisodeOptions();
    document.getElementById('tagEpisodeSelect').value = '';
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('tagModal').classList.add('active');
}

// å…³é—­æ ‡ç­¾ç¼–è¾‘å¼¹çª—
function closeTagModal() {
    document.getElementById('tagModal').classList.remove('active');
}

// ä¿å­˜æ ‡ç­¾ä¿®æ”¹
async function saveTagChanges() {
    const project = document.getElementById('tagProjectSelect').value;
    const episode = document.getElementById('tagEpisodeSelect').value;
    const newName = document.getElementById('tagNameInput')?.value.trim();
    
    const saveBtn = document.getElementById('saveTagBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'ä¿å­˜ä¸­...';
    
    try {
        if (isBatchTagMode) {
            // æ‰¹é‡æ›´æ–°
            const assets = [];
            for (const filename of selectedAssets) {
                const item = document.querySelector(`.asset-item[data-filename="${filename}"]`);
                if (item) {
                    assets.push({
                        category: item.dataset.category,
                        filename: filename
                    });
                }
            }
            
            const response = await fetch('/api/assets/batch-tags', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ assets, project, episode })
            });
            
            const data = await response.json();
            if (data.success) {
                showAlert(data.message || 'æ ‡ç­¾æ›´æ–°æˆåŠŸ', 'success');
                closeTagModal();
                toggleSelectMode();  // é€€å‡ºé€‰æ‹©æ¨¡å¼
                currentPage = 1;
                loadAssets();
                loadProjects();  // åˆ·æ–°é¡¹ç›®åˆ—è¡¨
            } else {
                showAlert(data.message || 'æ›´æ–°å¤±è´¥', 'error');
            }
        } else {
            // å•ä¸ªæ›´æ–° - åŒæ—¶æ›´æ–°æ ‡ç­¾å’Œåç§°
            // å…ˆæ›´æ–°æ ‡ç­¾
            const tagResponse = await fetch('/api/assets/update-tags', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category: editingAsset.category,
                    filename: editingAsset.filename,
                    project,
                    episode
                })
            });
            
            const tagData = await tagResponse.json();
            if (!tagData.success) {
                showAlert(tagData.message || 'æ ‡ç­¾æ›´æ–°å¤±è´¥', 'error');
                return;
            }
            
            // å¦‚æœåç§°æœ‰å˜åŒ–ï¼Œæ›´æ–°åç§°
            if (newName && newName !== editingAsset.currentName) {
                const renameResponse = await fetch('/api/assets/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category: editingAsset.category,
                        filename: editingAsset.filename,
                        new_name: newName
                    })
                });
                
                const renameData = await renameResponse.json();
                if (!renameData.success) {
                    showAlert(renameData.message || 'é‡å‘½åå¤±è´¥', 'error');
                    return;
                }
            }
            
            showAlert('ä¿å­˜æˆåŠŸ', 'success');
            closeTagModal();
            currentPage = 1;
            loadAssets();
            loadProjects();  // åˆ·æ–°é¡¹ç›®åˆ—è¡¨
        }
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        showAlert('ä¿å­˜å¤±è´¥', 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ä¿å­˜';
    }
}

// è½¬ä¹‰å¼•å·
function escapeQuotes(str) {
    return (str || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// ESCå…³é—­å¼¹çª—
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closePreviewModal();
        closeTagModal();
        closeProjectManageModal();
    }
});

// ========== é¡¹ç›®ç®¡ç†å¼¹çª—åŠŸèƒ½ ==========

// æ‰“å¼€é¡¹ç›®ç®¡ç†å¼¹çª—
function openProjectManageModal() {
    document.getElementById('projectManageModal').classList.add('active');
    renderProjectTree();
}

// å…³é—­é¡¹ç›®ç®¡ç†å¼¹çª—
function closeProjectManageModal() {
    document.getElementById('projectManageModal').classList.remove('active');
    hideAddProjectForm();
}

// æ¸²æŸ“é¡¹ç›®æ ‘åˆ—è¡¨
function renderProjectTree() {
    const container = document.getElementById('projectListContainer');
    
    if (projectsList.length === 0) {
        container.innerHTML = `
            <div class="empty-projects">
                <span style="font-size: 40px;">ğŸ“</span>
                <p>æš‚æ— é¡¹ç›®ï¼Œç‚¹å‡»ä¸Šæ–¹â€œæ–°å»ºé¡¹ç›®â€æŒ‰é’®åˆ›å»º</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    projectsList.forEach(project => {
        const episodes = project.episodes || [];
        html += `
            <div class="project-item" data-project="${escapeHtml(project.name)}">
                <div class="project-header" onclick="toggleProjectExpand(this)">
                    <span class="project-expand-icon">â–¶</span>
                    <span class="project-icon">ğŸ“</span>
                    <span class="project-name" id="projectName_${escapeHtml(project.name).replace(/\s/g, '_')}">${escapeHtml(project.name)}</span>
                    <input type="text" class="project-name-input" id="projectNameInput_${escapeHtml(project.name).replace(/\s/g, '_')}" style="display:none;" value="${escapeHtml(project.name)}" onclick="event.stopPropagation()" onkeydown="handleProjectRenameKey(event, '${escapeQuotes(project.name)}')" onblur="saveProjectRename('${escapeQuotes(project.name)}')">
                    <span class="project-count">${episodes.length} ä¸ªåˆ†é›†</span>
                    <div class="project-actions" onclick="event.stopPropagation()">
                        <button class="project-action-btn" onclick="startProjectRename('${escapeQuotes(project.name)}')" title="é‡å‘½å">âœï¸</button>
                        <button class="project-action-btn danger" onclick="deleteProjectPrompt('${escapeQuotes(project.name)}')" title="åˆ é™¤">ğŸ—‘</button>
                    </div>
                </div>
                <div class="episode-list">
                    ${episodes.map(ep => `
                        <div class="episode-item" data-episode="${escapeHtml(ep)}">
                            <span class="episode-icon">ğŸ¬</span>
                            <span class="episode-name" id="episodeName_${escapeHtml(project.name).replace(/\s/g, '_')}_${escapeHtml(ep).replace(/\s/g, '_')}">${escapeHtml(ep)}</span>
                            <input type="text" class="episode-name-input" id="episodeNameInput_${escapeHtml(project.name).replace(/\s/g, '_')}_${escapeHtml(ep).replace(/\s/g, '_')}" style="display:none;" value="${escapeHtml(ep)}" onkeydown="handleEpisodeRenameKey(event, '${escapeQuotes(project.name)}', '${escapeQuotes(ep)}')" onblur="saveEpisodeRename('${escapeQuotes(project.name)}', '${escapeQuotes(ep)}')">
                            <div class="episode-actions">
                                <button class="project-action-btn" onclick="startEpisodeRename('${escapeQuotes(project.name)}', '${escapeQuotes(ep)}')" title="é‡å‘½å">âœï¸</button>
                                <button class="project-action-btn danger" onclick="deleteEpisodePrompt('${escapeQuotes(project.name)}', '${escapeQuotes(ep)}')" title="åˆ é™¤">ğŸ—‘</button>
                            </div>
                        </div>
                    `).join('')}
                    <div id="addEpisodeForm_${escapeHtml(project.name).replace(/\s/g, '_')}" class="add-episode-form" style="display:none;">
                        <input type="text" class="add-episode-input" placeholder="è¾“å…¥åˆ†é›†åç§°" onkeydown="if(event.key==='Enter') confirmAddEpisode('${escapeQuotes(project.name)}')">
                        <button class="btn btn-primary btn-sm" onclick="confirmAddEpisode('${escapeQuotes(project.name)}')">æ·»åŠ </button>
                        <button class="btn btn-secondary btn-sm" onclick="hideAddEpisodeForm('${escapeQuotes(project.name)}')">å–æ¶ˆ</button>
                    </div>
                    <button class="add-episode-btn" onclick="showAddEpisodeForm('${escapeQuotes(project.name)}')">
                        ï¼‹ æ·»åŠ åˆ†é›†
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// å±•å¼€/æ”¶èµ·é¡¹ç›®
function toggleProjectExpand(header) {
    const projectItem = header.closest('.project-item');
    projectItem.classList.toggle('expanded');
}

// æ˜¾ç¤ºæ·»åŠ é¡¹ç›®è¡¨å•
function showAddProjectForm() {
    document.getElementById('addProjectForm').style.display = 'flex';
    document.getElementById('addProjectNameInput').focus();
}

// éšè—æ·»åŠ é¡¹ç›®è¡¨å•
function hideAddProjectForm() {
    document.getElementById('addProjectForm').style.display = 'none';
    document.getElementById('addProjectNameInput').value = '';
}

// ç¡®è®¤æ·»åŠ é¡¹ç›®
async function confirmAddProject() {
    const input = document.getElementById('addProjectNameInput');
    const name = input.value.trim();
    
    if (!name) {
        showAlert('è¯·è¾“å…¥é¡¹ç›®åç§°', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/assets/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        
        const data = await response.json();
        if (data.success) {
            showAlert('é¡¹ç›®åˆ›å»ºæˆåŠŸ', 'success');
            await loadProjects();
            renderProjectTree();
            hideAddProjectForm();
        } else {
            showAlert(data.message || 'åˆ›å»ºå¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥', 'error');
    }
}

// å¼€å§‹é¡¹ç›®é‡å‘½åï¼ˆå†…è”ç¼–è¾‘ï¼‰
function startProjectRename(projectName) {
    event.stopPropagation();
    const safeId = projectName.replace(/\s/g, '_');
    const nameSpan = document.getElementById('projectName_' + safeId);
    const nameInput = document.getElementById('projectNameInput_' + safeId);
    
    if (nameSpan && nameInput) {
        nameSpan.style.display = 'none';
        nameInput.style.display = 'inline-block';
        nameInput.value = projectName;
        nameInput.focus();
        nameInput.select();
    }
}

// å¤„ç†é¡¹ç›®é‡å‘½åæŒ‰é”®
function handleProjectRenameKey(event, projectName) {
    if (event.key === 'Enter') {
        event.preventDefault();
        event.target.blur();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        cancelProjectRename(projectName);
    }
}

// å–æ¶ˆé¡¹ç›®é‡å‘½å
function cancelProjectRename(projectName) {
    const safeId = projectName.replace(/\s/g, '_');
    const nameSpan = document.getElementById('projectName_' + safeId);
    const nameInput = document.getElementById('projectNameInput_' + safeId);
    
    if (nameSpan && nameInput) {
        nameInput.value = projectName;
        nameInput.style.display = 'none';
        nameSpan.style.display = 'inline';
    }
}

// ä¿å­˜é¡¹ç›®é‡å‘½å
let isProjectRenaming = false;
async function saveProjectRename(projectName) {
    if (isProjectRenaming) return;
    
    const safeId = projectName.replace(/\s/g, '_');
    const nameSpan = document.getElementById('projectName_' + safeId);
    const nameInput = document.getElementById('projectNameInput_' + safeId);
    
    if (!nameInput) return;
    
    const newName = nameInput.value.trim();
    
    // å¦‚æœåç§°æ²¡å˜åŒ–æˆ–ä¸ºç©ºï¼Œå–æ¶ˆç¼–è¾‘
    if (!newName || newName === projectName) {
        if (nameSpan) {
            nameInput.style.display = 'none';
            nameSpan.style.display = 'inline';
        }
        return;
    }
    
    isProjectRenaming = true;
    
    try {
        const response = await fetch(`/api/assets/projects/${encodeURIComponent(projectName)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName })
        });
        
        const data = await response.json();
        if (data.success) {
            showAlert(data.message || 'é‡å‘½åæˆåŠŸ', 'success');
            await loadProjects();
            renderProjectTree();
            // å¦‚æœå½“å‰ç­›é€‰çš„æ˜¯è¿™ä¸ªé¡¹ç›®ï¼Œæ›´æ–°ç­›é€‰
            if (currentFilterProject === projectName) {
                currentFilterProject = newName;
                document.getElementById('projectFilter').value = newName;
            }
        } else {
            showAlert(data.message || 'é‡å‘½åå¤±è´¥', 'error');
            // æ¢å¤åŸæ¥çš„æ˜¾ç¤º
            if (nameSpan) {
                nameInput.style.display = 'none';
                nameSpan.style.display = 'inline';
            }
        }
    } catch (error) {
        showAlert('é‡å‘½åå¤±è´¥', 'error');
        if (nameSpan) {
            nameInput.style.display = 'none';
            nameSpan.style.display = 'inline';
        }
    } finally {
        isProjectRenaming = false;
    }
}

// åˆ é™¤é¡¹ç›®æç¤º
async function deleteProjectPrompt(projectName) {
    // å…ˆè·å–é¡¹ç›®å…³è”çš„èµ„äº§æ•°é‡
    let assetCount = 0;
    try {
        const response = await fetch(`/api/assets/projects/${encodeURIComponent(projectName)}/asset-count`);
        const data = await response.json();
        if (data.success) {
            assetCount = data.count;
        }
    } catch (e) {}
    
    let message = `ç¡®å®šè¦åˆ é™¤é¡¹ç›®â€œ${projectName}â€å—ï¼Ÿ`;
    if (assetCount > 0) {
        message += `\n\nâš ï¸ è¯¥é¡¹ç›®ä¸‹æœ‰ ${assetCount} ä¸ªèµ„äº§ï¼Œåˆ é™¤åè¿™äº›èµ„äº§çš„é¡¹ç›®æ ‡ç­¾å°†è¢«æ¸…ç©ºã€‚`;
    }
    
    if (!confirm(message)) return;
    
    try {
        const response = await fetch(`/api/assets/projects/${encodeURIComponent(projectName)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            showAlert('åˆ é™¤æˆåŠŸ', 'success');
            await loadProjects();
            renderProjectTree();
            // å¦‚æœå½“å‰ç­›é€‰çš„æ˜¯è¿™ä¸ªé¡¹ç›®ï¼Œæ¸…é™¤ç­›é€‰
            if (currentFilterProject === projectName) {
                clearFilters();
            }
        } else {
            showAlert(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('åˆ é™¤å¤±è´¥', 'error');
    }
}

// æ˜¾ç¤ºæ·»åŠ åˆ†é›†è¡¨å•
function showAddEpisodeForm(projectName) {
    const formId = `addEpisodeForm_${projectName.replace(/\s/g, '_')}`;
    const form = document.getElementById(formId);
    if (form) {
        form.style.display = 'flex';
        form.querySelector('input').focus();
    }
}

// éšè—æ·»åŠ åˆ†é›†è¡¨å•
function hideAddEpisodeForm(projectName) {
    const formId = `addEpisodeForm_${projectName.replace(/\s/g, '_')}`;
    const form = document.getElementById(formId);
    if (form) {
        form.style.display = 'none';
        form.querySelector('input').value = '';
    }
}

// ç¡®è®¤æ·»åŠ åˆ†é›†
async function confirmAddEpisode(projectName) {
    const formId = `addEpisodeForm_${projectName.replace(/\s/g, '_')}`;
    const form = document.getElementById(formId);
    const input = form.querySelector('input');
    const episodeName = input.value.trim();
    
    if (!episodeName) {
        showAlert('è¯·è¾“å…¥åˆ†é›†åç§°', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/assets/projects/${encodeURIComponent(projectName)}/episodes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: episodeName })
        });
        
        const data = await response.json();
        if (data.success) {
            showAlert('åˆ†é›†æ·»åŠ æˆåŠŸ', 'success');
            await loadProjects();
            renderProjectTree();
            // ä¿æŒå±•å¼€çŠ¶æ€
            const projectItem = document.querySelector(`.project-item[data-project="${projectName}"]`);
            if (projectItem) {
                projectItem.classList.add('expanded');
            }
        } else {
            showAlert(data.message || 'æ·»åŠ å¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('æ·»åŠ å¤±è´¥', 'error');
    }
}

// å¼€å§‹åˆ†é›†é‡å‘½åï¼ˆå†…è”ç¼–è¾‘ï¼‰
function startEpisodeRename(projectName, episodeName) {
    event.stopPropagation();
    const safeId = projectName.replace(/\s/g, '_') + '_' + episodeName.replace(/\s/g, '_');
    const nameSpan = document.getElementById('episodeName_' + safeId);
    const nameInput = document.getElementById('episodeNameInput_' + safeId);
    
    if (nameSpan && nameInput) {
        nameSpan.style.display = 'none';
        nameInput.style.display = 'inline-block';
        nameInput.value = episodeName;
        nameInput.focus();
        nameInput.select();
    }
}

// å¤„ç†åˆ†é›†é‡å‘½åæŒ‰é”®
function handleEpisodeRenameKey(event, projectName, episodeName) {
    if (event.key === 'Enter') {
        event.preventDefault();
        event.target.blur();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        cancelEpisodeRename(projectName, episodeName);
    }
}

// å–æ¶ˆåˆ†é›†é‡å‘½å
function cancelEpisodeRename(projectName, episodeName) {
    const safeId = projectName.replace(/\s/g, '_') + '_' + episodeName.replace(/\s/g, '_');
    const nameSpan = document.getElementById('episodeName_' + safeId);
    const nameInput = document.getElementById('episodeNameInput_' + safeId);
    
    if (nameSpan && nameInput) {
        nameInput.value = episodeName;
        nameInput.style.display = 'none';
        nameSpan.style.display = 'inline';
    }
}

// ä¿å­˜åˆ†é›†é‡å‘½å
let isEpisodeRenaming = false;
async function saveEpisodeRename(projectName, episodeName) {
    if (isEpisodeRenaming) return;
    
    const safeId = projectName.replace(/\s/g, '_') + '_' + episodeName.replace(/\s/g, '_');
    const nameSpan = document.getElementById('episodeName_' + safeId);
    const nameInput = document.getElementById('episodeNameInput_' + safeId);
    
    if (!nameInput) return;
    
    const newName = nameInput.value.trim();
    
    // å¦‚æœåç§°æ²¡å˜åŒ–æˆ–ä¸ºç©ºï¼Œå–æ¶ˆç¼–è¾‘
    if (!newName || newName === episodeName) {
        if (nameSpan) {
            nameInput.style.display = 'none';
            nameSpan.style.display = 'inline';
        }
        return;
    }
    
    isEpisodeRenaming = true;
    
    try {
        const response = await fetch(`/api/assets/projects/${encodeURIComponent(projectName)}/episodes/${encodeURIComponent(episodeName)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName })
        });
        
        const data = await response.json();
        if (data.success) {
            showAlert(data.message || 'é‡å‘½åæˆåŠŸ', 'success');
            await loadProjects();
            renderProjectTree();
            // ä¿æŒå±•å¼€çŠ¶æ€
            const projectItem = document.querySelector(`.project-item[data-project="${projectName}"]`);
            if (projectItem) {
                projectItem.classList.add('expanded');
            }
            // å¦‚æœå½“å‰ç­›é€‰çš„æ˜¯è¿™ä¸ªåˆ†é›†ï¼Œæ›´æ–°ç­›é€‰
            if (currentFilterEpisode === episodeName) {
                currentFilterEpisode = newName;
                document.getElementById('episodeFilter').value = newName;
            }
        } else {
            showAlert(data.message || 'é‡å‘½åå¤±è´¥', 'error');
            if (nameSpan) {
                nameInput.style.display = 'none';
                nameSpan.style.display = 'inline';
            }
        }
    } catch (error) {
        showAlert('é‡å‘½åå¤±è´¥', 'error');
        if (nameSpan) {
            nameInput.style.display = 'none';
            nameSpan.style.display = 'inline';
        }
    } finally {
        isEpisodeRenaming = false;
    }
}

// åˆ é™¤åˆ†é›†æç¤º
async function deleteEpisodePrompt(projectName, episodeName) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†é›†â€œ${episodeName}â€å—ï¼Ÿ\n\nåˆ é™¤åï¼Œä½¿ç”¨è¯¥åˆ†é›†çš„èµ„äº§å°†å˜ä¸ºæœªåˆ†é…åˆ†é›†ã€‚`)) return;
    
    try {
        const response = await fetch(`/api/assets/projects/${encodeURIComponent(projectName)}/episodes/${encodeURIComponent(episodeName)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            showAlert('åˆ é™¤æˆåŠŸ', 'success');
            await loadProjects();
            renderProjectTree();
            // ä¿æŒå±•å¼€çŠ¶æ€
            const projectItem = document.querySelector(`.project-item[data-project="${projectName}"]`);
            if (projectItem) {
                projectItem.classList.add('expanded');
            }
            // å¦‚æœå½“å‰ç­›é€‰çš„æ˜¯è¿™ä¸ªåˆ†é›†ï¼Œæ¸…é™¤ç­›é€‰
            if (currentFilterEpisode === episodeName) {
                currentFilterEpisode = '';
                document.getElementById('episodeFilter').value = '';
                loadAssets();
            }
        } else {
            showAlert(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('åˆ é™¤å¤±è´¥', 'error');
    }
}

// HTMLè½¬ä¹‰
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// é¡¹ç›®ç­›é€‰å˜åŒ–æ—¶çš„å¤„ç†
function onProjectFilterChange() {
    const select = document.getElementById('projectFilter');
    currentFilterProject = select.value;
    currentFilterEpisode = '';  // é‡ç½®åˆ†é›†ç­›é€‰
    updateEpisodeFilterOptions();
    currentPage = 1;
    loadAssets();
}

// å¿«æ·åˆ›å»ºé¡¹ç›®
async function quickCreateProject() {
    const name = prompt('è¯·è¾“å…¥æ–°é¡¹ç›®åç§°:');
    if (!name || !name.trim()) return;
    
    try {
        const response = await fetch('/api/assets/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name.trim() })
        });
        
        const data = await response.json();
        if (data.success) {
            showAlert('é¡¹ç›®åˆ›å»ºæˆåŠŸ', 'success');
            await loadProjects();
            // è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„é¡¹ç›®
            currentFilterProject = name.trim();
            document.getElementById('projectFilter').value = name.trim();
            updateEpisodeFilterOptions();
            currentPage = 1;
            loadAssets();
        } else {
            showAlert(data.message || 'åˆ›å»ºå¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥', 'error');
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadProjects();  // åŠ è½½é¡¹ç›®åˆ—è¡¨
    loadAssets();
});
</script>
{% endblock %}
